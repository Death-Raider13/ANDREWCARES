<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-on-1 Mentorship - Andrew Cares Village</title>

    <!-- External Libraries -->
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script
      src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>

    <style>
        :root {
            --background-color: #F4F2ED;
            --text-primary: #333333;
            --text-secondary: #555555;
            --color-primary: #B38B00;
            --color-secondary: #001F3F;
            --card-bg: #FFFFFF;
            --border-color: #EAEAEA;
            --hover-bg: #F9F9F9;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --chat-bg: #f8f9fa;
            --message-sent: #007bff;
            --message-received: #e9ecef;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .hidden { display: none !important; }

        /* Header */
        .main-header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        /* Main Layout - CORRECTED: Main content left, sidebar right */
        .mentorship-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 8rem);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

       
        /* Dashboard Headers */
        .dashboard-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .dashboard-header h1 {
            font-family: 'Cinzel', serif;
            margin: 0;
            font-size: 2.5rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background-color: var(--color-primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards and Grids */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--color-secondary);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: #9c7a00; }
        .btn-secondary { background-color: var(--text-secondary); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(179, 139, 0, 0.2);
        }

     /* ------ Professional Chat Sidebar ------ */
.chat-sidebar{
  width: 100%;
  max-width: 420px;
  height: 100vh;
  position: fixed;
  top: 0;
  right: -420px;
  background: #ffffff;
  box-shadow: -4px 0 24px rgba(0, 0, 0, 0.12);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border-left: 1px solid #e5e7eb;
  -webkit-backdrop-filter:blur(10px);
  backdrop-filter: blur(10px);
}

.chat-sidebar.active {
  right: 0;
}

@media (min-width: 768px) {
  .chat-sidebar {
    width: 420px;
    right: -420px;
  }
  
  .chat-sidebar.active {
    right: 0;
  }
}

@media (max-width: 767px) {
  .chat-sidebar {
    width: 90vw;
    max-width: 350px;
    right: -90vw;
  }
}
.chat-sidebar-header{
  padding: 1.5rem 1.25rem;
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
  color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

.header-meta {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1;
}

.header-meta .avatar {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: grid;
  place-items: center;
  font-weight: 600;
  font-size: 1.2rem;
  background: rgba(255, 255, 255, 0.2);
  border: 2px solid rgba(255, 255, 255, 0.3);
  transition: all 0.3s ease;
}

.header-meta .avatar:hover {
  transform: scale(1.05);
  background: rgba(255, 255, 255, 0.25);
}

.partner-name {
  margin: 0 0 0.25rem 0;
  font-weight: 600;
  font-size: 1.1rem;
  line-height: 1.2;
}

.status-container {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.status-dot {
  width: 10px;
  height: 10px;
  background: #10b981;
  border-radius: 50%;
  display: inline-block;
  animation: pulse 2s infinite;
  box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
  }
  70% {
    box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
  }
}

.status-text {
  font-size: 0.8rem;
  opacity: 0.9;
  font-weight: 500;
}

.header-actions {
  display: flex;
  gap: 0.5rem;
}

.header-actions button {
  background: rgba(255, 255, 255, 0.15);
  border: 0;
  color: #ffffff;
  width: 36px;
  height: 36px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  -webkit-backdrop-filter:blur(10px);
  backdrop-filter: blur(10px);
}

.header-actions button:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.conversation-list {
  flex-shrink: 0;
  padding: 0.75rem;
  border-bottom: 1px solid #f1f5f9;
  max-height: 60px;
  overflow: hidden;
  background: #fafbfc;
  transition: max-height 0.3s ease;
}

.conversation-list.expanded {
  max-height: 200px;
  overflow-y: auto;
}

.conversation-list::-webkit-scrollbar {
  width: 4px;
}

.conversation-list::-webkit-scrollbar-track {
  background: transparent;
}

.conversation-list::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 2px;
}

.conversation-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 0.25rem;
  border: 1px solid transparent;
}

.conversation-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem;
  cursor: pointer;
  background: #f8fafc;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  font-size: 0.85rem;
  font-weight: 600;
  color: #64748b;
}

.conversation-toggle:hover {
  background: #e2e8f0;
}

.conversation-toggle i {
  transition: transform 0.3s ease;
}

.conversation-list.expanded .conversation-toggle i {
  transform: rotate(180deg);
}

.conversation-item:hover {
  background: #ffffff;
  border-color: #e2e8f0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transform: translateY(-1px);
}

.conversation-item:last-child {
  margin-bottom: 0;
}

.conversation-item img {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  object-fit: cover;
  border: 1px solid #e2e8f0;
  flex-shrink: 0;
}

.conversation-item .conversation-info {
  flex: 1;
  min-width: 0;
}

.conversation-item .conversation-name {
  font-weight: 600;
  font-size: 0.8rem;
  color: #1e293b;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.conversation-item .conversation-preview {
  font-size: 0.7rem;
  color: #64748b;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.chat-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #ffffff;
  min-height: 0; /* Important for flex child to shrink */
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  scroll-behavior: smooth;
  /* Remove max-height to allow proper flex behavior */
}

.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: #f8fafc;
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

@media (max-width: 767px) {
  .chat-messages {
    padding: 1rem;
    max-height: calc(100vh - 220px);
  }
}

.empty-state {
  text-align: center;
  margin: auto;
  color: #64748b;
  padding: 2rem;
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.6;
  color: var(--color-primary);
}

.empty-state p {
  font-size: 1.1rem;
  font-weight: 500;
  margin: 0;
}

.empty-state small {
  display: block;
  margin-top: 0.5rem;
  font-size: 0.9rem;
  opacity: 0.7;
}

/* ---- Enhanced Contract / Payment Strips ---- */
.contract-strip {
  padding: 1.25rem;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-top: 1px solid #e2e8f0;
  flex-shrink: 0;
  display: flex;
  gap: 0.875rem;
  align-items: center;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
}

.payment-strip {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  padding: 1.25rem;
  border-top: 1px solid #bae6fd;
}

.pay-btn {
  width: 100%;
  background: linear-gradient(135deg, var(--color-primary) 0%, #d4af37 100%);
  color: #ffffff;
  border: 0;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(179, 139, 0, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.pay-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(179, 139, 0, 0.4);
}

.pay-btn:active {
  transform: translateY(0);
}

.chat-input-bar {
  padding: 1.25rem;
  background: #ffffff;
  border-top: 1px solid #e2e8f0;
  flex-shrink: 0;
  display: flex;
  gap: 0.875rem;
  align-items: center;
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  position: sticky;
  bottom: 0;
  z-index: 10;
}

@media (max-width: 767px) {
  .chat-input-bar {
    padding: 1rem;
    gap: 0.75rem;
  }
}

.chat-input-bar input {
  flex: 1;
  border: 2px solid #e2e8f0;
  border-radius: 24px;
  padding: 0.875rem 1.25rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  background: #f8fafc;
}

.chat-input-bar input:focus {
  outline: none;
  border-color: var(--color-primary);
  background: #ffffff;
  box-shadow: 0 0 0 3px rgba(179, 139, 0, 0.1);
}

.chat-input-bar input::placeholder {
  color: #94a3b8;
  font-weight: 400;
}

.chat-input-bar button {
  background: var(--color-primary);
  color: #ffffff;
  border: 0;
  width: 44px;
  height: 44px;
  border-radius: 22px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(179, 139, 0, 0.3);
}

.chat-input-bar button:hover {
  background: #9c7a00;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(179, 139, 0, 0.4);
}

.chat-input-bar button:active {
  transform: translateY(0);
}
        /* Responsive Design */
        @media (max-width: 1024px) {
            .mentorship-container {
                flex-direction: column;
                height: auto;
            }
            
            .main-content {
                width: 100%;
                height: auto;
                min-height: 70vh;
            }
            
            
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .tab-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }
        }
/* Enhanced Agreement Strip Styles */
.agreement-strip {
    padding: 1rem;
    border-top: 1px solid var(--border-color);
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    font-size: 0.9rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.agreement-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.agreement-content.success {
    color: var(--success-color);
}

.agreement-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.agreement-summary {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.25rem;
}

.agreement-summary p {
    margin: 0.1rem 0;
}

.agreement-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.download-strip {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-color: var(--success-color);
}

/* Loading dots animation */
.loading-dots {
    display: flex;
    gap: 0.25rem;
}

.loading-dots span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #d97706;
    animation: loading-dot 1.4s infinite ease-in-out both;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes loading-dot {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

/* Notification styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem;
    border-radius: 8px;
    color: white;
    z-index: 10000;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.notification.success { background-color: var(--success-color); }
.notification.error { background-color: var(--error-color); }
.notification.info { background-color: var(--info-color); }
.notification.warning { background-color: var(--warning-color); }

.notification-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.notification-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Professional Agreement Modal Styles */
.agreement-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    animation: fadeIn 0.3s ease-out;
}

.agreement-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.modal-content {
    position: relative;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease-out;
}

.modal-header {
    background: linear-gradient(135deg, #b45309 0%, #d97706 100%);
    color: white;
    padding: 2rem;
    text-align: center;
    position: relative;
    border-radius: 16px 16px 0 0;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 1px;
}

.modal-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    font-size: 1rem;
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.modal-body {
    padding: 2rem;
}

.agreement-form h3 {
    margin: 0 0 0.5rem 0;
    color: #b45309;
    font-size: 1.4rem;
}

.form-subtitle {
    color: #6b7280;
    margin-bottom: 2rem;
    font-size: 0.95rem;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.form-group {
    position: relative;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s ease;
}

.form-input:focus {
    outline: none;
    border-color: #d97706;
    box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
}

.form-unit {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-size: 0.9rem;
    pointer-events: none;
}

.total-display {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    border: 2px solid #d1d5db;
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 1.2rem;
    font-weight: 700;
    color: #059669;
    text-align: center;
}

.form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
    transition: all 0.2s ease;
}

.form-textarea:focus {
    outline: none;
    border-color: #d97706;
    box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
}

.agreement-summary-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.agreement-summary-card h3 {
    margin: 0 0 1rem 0;
    color: #b45309;
    font-size: 1.3rem;
}

.summary-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0.75rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-item label {
    font-weight: 600;
    color: #374151;
    min-width: 120px;
    flex-shrink: 0;
}

.summary-item span {
    color: #1f2937;
    text-align: right;
    word-break: break-word;
}

.total-highlight {
    font-weight: 700;
    color: #059669;
    font-size: 1.1rem;
}

.objectives-card, .terms-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.objectives-card h4, .terms-card h4 {
    margin: 0 0 1rem 0;
    color: #b45309;
    font-size: 1.1rem;
}

.objectives-content {
    color: #374151;
    line-height: 1.5;
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #d97706;
}

.terms-list {
    margin: 0;
    padding-left: 1.5rem;
    color: #374151;
}

.terms-list li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.modal-footer {
    padding: 1.5rem 2rem;
    background: #f8fafc;
    border-radius: 0 0 16px 16px;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    border-top: 1px solid #e2e8f0;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to { 
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .summary-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95%;
        margin: 1rem;
    }
    
    .modal-header {
        padding: 1.5rem;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem;
        flex-direction: column;
    }
}
/* download strip – shown only after both signed */
.download-strip{
  padding:1rem;
  border-top:1px solid var(--border-color);
  background:#f0f9ff;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.download-strip button{
  background:var(--info-color);
  color:#fff;
  border:none;
  padding:.5rem 1rem;
  border-radius:6px;
  cursor:pointer;
}

    </style>
  </head>

  <body>
    <!-- Error Handler (must load first) -->
    <script src="js/error-handler.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Header -->
    <header class="main-header">
      <a href="home.html"
        style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--color-secondary); text-decoration: none;">
        Andrew Cares Village
      </a>
    </header>

    <!-- Main Container -->
    <div class="mentorship-container">
      <!-- Main Content Area -->
      <div class="main-content">
        <!-- Member View -->
        <div id="memberView" class="hidden">
          <div class="dashboard-header">
            <h1><i class="fas fa-graduation-cap"></i> Mentorship Portal</h1>
            <p>Connect with expert mentors for personalized guidance</p>
          </div>

          <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('browse')">
              <i class="fas fa-search"></i> Browse Mentors
            </button>
            <button class="tab-btn" onclick="switchTab('my-sessions')">
              <i class="fas fa-calendar-alt"></i> My Sessions
            </button>
          </div>

          <div id="browse-tab" class="tab-content active">
            <div class="grid-2">
              <div class="card">
                <h2 class="section-title">Available Mentors</h2>
                <div id="memberInstructorList">
                  <p>Loading mentors...</p>
                </div>
              </div>
              <div class="card">
                <h2 class="section-title" id="memberBookingTitle">Select a
                  Mentor to Begin</h2>
                <div id="memberCalendar"></div>
              </div>
            </div>
          </div>

          <div id="my-sessions-tab" class="tab-content">
            <div class="card">
              <h2 class="section-title">My Mentorship Sessions</h2>
              <div id="memberSessionsList">
                <p>You have no sessions yet.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Instructor View -->
        <div id="instructorView" class="hidden">
          <div class="dashboard-header">
            <h1><i class="fas fa-chalkboard-teacher"></i> Mentor Dashboard</h1>
            <p>Manage your mentorship sessions and availability</p>
          </div>

          <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('availability')">
              <i class="fas fa-clock"></i> Set Availability
            </button>
            <button class="tab-btn" onclick="switchTab('bookings')">
              <i class="fas fa-calendar-check"></i> Bookings
            </button>
            <button class="tab-btn" onclick="switchTab('completed')">
              <i class="fas fa-trophy"></i> Completed
            </button>
          </div>

          <div id="availability-tab" class="tab-content active">
            <div class="card">
              <h2 class="section-title">Set Your Availability</h2>
              <div class="form-group">
                <label for="availabilityDate">Select Date:</label>
                <input type="date" id="availabilityDate" class="form-control">
              </div>
              <div class="form-group">
                <label for="hourlyRate">Hourly Rate (₦):</label>
                <input type="number" id="hourlyRate" class="form-control"
                  placeholder="e.g., 5000" min="1000">
                <small>Minimum rate: ₦1,000 per hour</small>
              </div>
              <button class="btn btn-primary" onclick="saveAvailability()">
                <i class="fas fa-save"></i> Save Availability
              </button>
            </div>
          </div>

          <div id="bookings-tab" class="tab-content">
            <div class="card">
              <h2 class="section-title">Pending & Confirmed Bookings</h2>
              <div id="instructorBookingsList">
                <p>No bookings yet.</p>
              </div>
            </div>
          </div>

          <div id="completed-tab" class="tab-content">
            <div class="card">
              <h2 class="section-title">Completed Sessions</h2>
              <div id="completedSessionsList">
                <p>No completed sessions yet.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="hidden">
          <div class="dashboard-header">
            <h1><i class="fas fa-chart-line"></i> Admin Dashboard</h1>
            <p>Monitor platform performance and commission earnings</p>
          </div>

          <div class="card">
            <h2 class="section-title">Platform Statistics</h2>
            <div id="adminStats">
              <p>Loading statistics...</p>
            </div>
          </div>
        </div>

        <!-- Goal-Based Mentor Matching Section -->
        <div class="section" id="memberSection" style="display: none;">
          <div class="container">
            <h2
              style="text-align: center; margin-bottom: 1rem; color: var(--color-secondary);">
              <i class="fas fa-users"></i> Find Your Perfect Mentor
            </h2>

            <!-- Goal Selection Interface -->
            <div
              style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05)); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(102, 126, 234, 0.2);">
              <h3
                style="text-align: center; margin-bottom: 1.5rem; color: #334155; font-weight: 600;">What
                are your mentorship goals?</h3>
              <div id="goalSelection"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="goal-card" data-goal="career"
                  onclick="selectGoal('career')"
                  style="padding: 1.5rem; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
                  <div
                    style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-chart-line"
                      style="color: white; font-size: 1.5rem;"></i>
                  </div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #334155;">Career
                    Growth</h4>
                  <p
                    style="margin: 0; color: #64748b; font-size: 0.9rem;">Advance
                    your career and leadership skills</p>
                </div>

                <div class="goal-card" data-goal="tech"
                  onclick="selectGoal('tech')"
                  style="padding: 1.5rem; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
                  <div
                    style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-code"
                      style="color: white; font-size: 1.5rem;"></i>
                  </div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #334155;">Tech &
                    Engineering</h4>
                  <p
                    style="margin: 0; color: #64748b; font-size: 0.9rem;">Master
                    technical skills and system design</p>
                </div>

                <div class="goal-card" data-goal="business"
                  onclick="selectGoal('business')"
                  style="padding: 1.5rem; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
                  <div
                    style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-rocket"
                      style="color: white; font-size: 1.5rem;"></i>
                  </div>
                  <h4
                    style="margin: 0 0 0.5rem 0; color: #334155;">Entrepreneurship</h4>
                  <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Build
                    and scale successful businesses</p>
                </div>

                <div class="goal-card" data-goal="academic"
                  onclick="selectGoal('academic')"
                  style="padding: 1.5rem; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
                  <div
                    style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-graduation-cap"
                      style="color: white; font-size: 1.5rem;"></i>
                  </div>
                  <h4 style="margin: 0 0 0.5rem 0; color: #334155;">Academic
                    Research</h4>
                  <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Excel
                    in research and publications</p>
                </div>
              </div>

              <div style="text-align: center;">
                <button id="clearGoalsBtn" onclick="clearGoalSelection()"
                  style="padding: 0.75rem 1.5rem; background: rgba(100, 116, 139, 0.1); color: #64748b; border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; cursor: pointer; font-weight: 500; display: none;">
                  <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                  Clear Selection
                </button>
              </div>
            </div>

            <div id="memberInstructorList"
              style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
              <!-- Mentors will be loaded here -->
            </div>
          </div>
        </div>

        <!-- Access Denied View -->
        <div id="accessDeniedView" class="hidden">
          <div class="dashboard-header">
            <h1><i class="fas fa-lock"></i> Access Restricted</h1>
            <p>This mentorship platform is available to registered members,
              instructors, and admins only.</p>
          </div>
          <div class="container">
            <div class="card" style="text-align: center; padding: 3rem;">
              <i class="fas fa-lock"
                style="font-size: 4rem; color: var(--warning-color); margin-bottom: 1rem;"></i>
              <h2>Access Restricted</h2>
              <p>This mentorship platform is available to registered members,
                instructors, and admins only.</p>
              <a href="contact.html" class="btn btn-primary">
                <i class="fas fa-envelope"></i> Contact Support
              </a>
            </div>
          </div>
        </div>

        <!-- Professional Chat Sidebar -->
        <!--  Professional Chat Sidebar  -->
        <div class="chat-sidebar" id="chatSidebar" style="display:none;">
          <!--  Header  -->
          <div class="chat-sidebar-header">
            <div class="header-meta">
              <div class="avatar"
                style="background:var(--color-primary)">U</div>
              <div>
                <p class="partner-name">Professional Chat</p>
                <div class="status-container">
                  <span class="status-dot"></span>
                  <small class="status-text">Active session</small>
                </div>
              </div>
            </div>
            <div class="header-actions">
              <button onclick="minimizeChat()" aria-label="Minimise"><i
                  class="fas fa-minus"></i></button>
              <button onclick="closeChatSidebar()" aria-label="Close"><i
                  class="fas fa-times"></i></button>
            </div>
          </div>

          <!--  Conversation List  -->
          <div class="conversation-list" id="sidebarConversations">
            <div class="conversation-toggle" onclick="toggleConversationList()">
              <span>Conversations</span>
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>

          <!--  Message Area  -->
          <div class="chat-body">
            <div class="chat-messages" id="chatMessages">
              <div class="empty-state">
                <i class="fas fa-comments"></i>
                <p>Start the conversation</p>
                <small>Send a message to begin your mentorship session</small>
              </div>
            </div>
            
            <!--  Contract / Payment Strip  -->
            <div id="contractStrip" class="contract-strip" style="display:none;">
              <div class="strip-content">
                <i class="fas fa-file-contract"></i>
                <span id="stripText">Contract pending signature</span>
              </div>
            </div>

            <!--  Payment Button (student only)  -->
            <div id="paymentStrip" class="payment-strip" style="display:none;">
              <button id="payBtn" class="pay-btn">
                <i class="fas fa-lock"></i> Pay ₦<span id="payAmount">0</span>
              </button>
            </div>

            <!--  Input Area  -->
            <div class="chat-input-bar">
              <input id="chatInput" type="text" placeholder="Type a message…"
                onkeypress="if(event.key==='Enter') sendChatMessage()">
              <button onclick="attachFile()" aria-label="Attach file"><i
                  class="fas fa-paperclip"></i></button>
              <button onclick="sendChatMessage()" aria-label="Send"><i
                  class="fas fa-paper-plane"></i></button>
            </div>
          </div>
        </div>

        <!--  Contract Modal  -->
        <div id="contractModal" class="modal-overlay" style="display:none;">
          <div class="modal-box">
            <h3>Mentorship Agreement</h3>
            <form id="contractForm">
              <label>Session length (hours)</label>
              <input type="number" id="hours" min="1" max="8" value="1"
                required>

              <label>Hourly rate (₦)</label>
              <input type="number" id="rate" readonly>

              <label>Total amount (₦)</label>
              <input type="number" id="total" readonly>

              <label>Main objectives</label>
              <textarea id="objectives" rows="3" required
                placeholder="What do you want to achieve?"></textarea>

              <label class="chk-label">
                <input type="checkbox" id="agreeChk" required>
                I accept the terms & conditions
              </label>

              <div class="modal-actions">
                <button type="button" onclick="closeContract()">Cancel</button>
                <button type="submit">Sign & Continue</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Professional Agreement Modals -->
        <!-- Instructor Signing Modal -->
        <div id="instructorSignModal" class="agreement-modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>MENTORSHIP AGREEMENT</h2>
                    <p>Andrew Cares Village Hub</p>
                    <button class="modal-close" onclick="closeInstructorSignModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="agreement-form">
                        <h3>Create Agreement Terms</h3>
                        <p class="form-subtitle">Please specify the session details for this mentorship agreement</p>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="sessionDuration">Duration</label>
                                <input type="number" id="sessionDuration" min="1" max="8" value="1" class="form-input">
                                <span class="form-unit">hour(s)</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="sessionRate">Rate</label>
                                <input type="number" id="sessionRate" min="1000" value="5000" class="form-input">
                                <span class="form-unit">₦/hour</span>
                            </div>
                            
                            <div class="form-group">
                                <label>Total Amount</label>
                                <div class="total-display" id="totalAmount">₦5,000</div>
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="sessionObjectives">Session Objectives</label>
                            <textarea id="sessionObjectives" class="form-textarea" placeholder="Describe the learning objectives and goals for this mentorship session..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeInstructorSignModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmInstructorSign()">
                        <i class="fas fa-pen"></i> Sign Agreement
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Review Modal -->
        <div id="studentReviewModal" class="agreement-modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>MENTORSHIP AGREEMENT</h2>
                    <p>Andrew Cares Village Hub</p>
                    <button class="modal-close" onclick="closeStudentReviewModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="agreement-summary-card">
                        <h3>Agreement Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <label>Instructor:</label>
                                <span id="reviewInstructorName">Loading...</span>
                            </div>
                            <div class="summary-item">
                                <label>Student:</label>
                                <span id="reviewStudentName">Loading...</span>
                            </div>
                            <div class="summary-item">
                                <label>Duration:</label>
                                <span id="reviewDuration">Loading...</span>
                            </div>
                            <div class="summary-item">
                                <label>Rate:</label>
                                <span id="reviewRate">Loading...</span>
                            </div>
                            <div class="summary-item">
                                <label>Total Amount:</label>
                                <span id="reviewTotal" class="total-highlight">Loading...</span>
                            </div>
                            <div class="summary-item">
                                <label>Session Date:</label>
                                <span id="reviewDate">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="objectives-card">
                        <h4>Session Objectives</h4>
                        <div id="reviewObjectives" class="objectives-content">Loading...</div>
                    </div>
                    
                    <div class="terms-card">
                        <h4>Terms and Conditions</h4>
                        <ul class="terms-list">
                            <li>Both parties agree to the terms specified above</li>
                            <li> Payment must be made before the start of the mentorship session</li>
                            <li>Either party may reschedule with 24 hours notice</li>
                            <li>This agreement is legally binding upon digital signature by both parties</li>
                        </ul>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-warning" onclick="requestRenegotiation()">
                        <i class="fas fa-redo"></i> Renegotiate
                    </button>
                    <button class="btn btn-success" onclick="confirmStudentSign()">
                        <i class="fas fa-check"></i> Sign & Accept
                    </button>
                </div>
            </div>
        </div>

        <!-- Production Paystack Integration with Development Fallback -->
        <script>
        // Check if we're in production (not localhost)
        const isProduction = !window.location.hostname.includes('localhost') && 
                            !window.location.hostname.includes('127.0.0.1') &&
                            !window.location.hostname.includes('file://');
        
        if (isProduction) {
            // Load real Paystack in production
            const script = document.createElement('script');
            script.src = 'https://js.paystack.co/v1/inline.js';
            script.onload = function() {
                console.log('Production Paystack loaded successfully');
            };
            script.onerror = function() {
                console.error('Failed to load Paystack in production');
                // Fallback to custom implementation
                loadCustomPaystack();
            };
            document.head.appendChild(script);
        } else {
            // Use custom implementation in development
            console.log('Development mode detected - using custom Paystack implementation');
            loadCustomPaystack();
        }
        
        function loadCustomPaystack() {
            // Custom Paystack implementation for development/fallback
            window.PaystackPop = {
                setup: function(config) {
                    return {
                        openIframe: function() {
                            // Create custom payment modal
                            const modal = document.createElement('div');
                            modal.id = 'paystack-modal';
                            modal.style.cssText = `
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0,0,0,0.8);
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                z-index: 10000;
                                font-family: 'Montserrat', sans-serif;
                            `;
                            
                            modal.innerHTML = `
                                <div style="
                                    background: white;
                                    padding: 2rem;
                                    border-radius: 12px;
                                    max-width: 400px;
                                    width: 90%;
                                    text-align: center;
                                    position: relative;
                                ">
                                    <button onclick="closePaystackModal()" 
                                            style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
                                    
                                    <h3 style="color: #333; margin-bottom: 1rem;">Development Payment</h3>
                                    <p style="color: #666; margin-bottom: 1.5rem;" id="payment-amount">Amount: ₦${(config.amount / 100).toLocaleString()}</p>
                                    
                                    <button onclick="simulatePaymentSuccess()" style="
                                        background: #00C851;
                                        color: white;
                                        border: none;
                                        padding: 12px 24px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        margin: 5px;
                                        font-size: 16px;
                                    ">Simulate Success</button>
                                    
                                    <button onclick="closePaystackModal()" style="
                                        background: #ff4444;
                                        color: white;
                                        border: none;
                                        padding: 12px 24px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        margin: 5px;
                                        font-size: 16px;
                                    ">Cancel</button>
                                </div>
                            `;
                            
                            document.body.appendChild(modal);
                            
                            // Store config globally for button handlers
                            window.currentPaystackConfig = config;
                        }
                    };
                }
            };
        }
        
        // Global functions for Paystack modal buttons
        function closePaystackModal() {
            const modal = document.getElementById('paystack-modal');
            if (modal) {
                modal.remove();
                if (window.currentPaystackConfig && typeof window.currentPaystackConfig.onClose === 'function') {
                    window.currentPaystackConfig.onClose();
                }
            }
        }
        
        function simulatePaymentSuccess() {
            const modal = document.getElementById('paystack-modal');
            if (modal) {
                modal.remove();
                if (window.currentPaystackConfig && typeof window.currentPaystackConfig.callback === 'function') {
                    window.currentPaystackConfig.callback({
                        status: 'success',
                        reference: 'dev_' + Date.now(),
                        transaction: Date.now()
                    });
                }
            }
        }
        
        console.log('Custom Paystack implementation loaded - no external dependencies');
        </script>
        
        <script>
        // Toggle conversation list functionality
        function toggleConversationList() {
            const conversationList = document.getElementById('sidebarConversations');
            if (conversationList) {
                conversationList.classList.toggle('expanded');
            }
        }

        // Auto-collapse conversation list when chat is opened
        function autoCollapseConversations() {
            const conversationList = document.getElementById('sidebarConversations');
            if (conversationList && conversationList.classList.contains('expanded')) {
                conversationList.classList.remove('expanded');
            }
        }

        // Open learning dashboard
        function openLearningDashboard(sessionId) {
            localStorage.setItem('currentSession', sessionId);
            window.open(`learning-dashboard.html?session=${sessionId}`, '_blank');
        }

        // Open instructor content management
        function openInstructorContent(sessionId) {
            window.open(`instructor-content.html?session=${sessionId}`, '_blank');
        }

        // Handle session renewal from URL parameters
        function handleRenewalFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const renewSessionId = urlParams.get('renew');
            const reuseTerms = urlParams.get('reuse') === 'true';
            
            if (renewSessionId) {
                if (reuseTerms) {
                    // Create new booking with same terms
                    db.collection('bookings').doc(renewSessionId).get().then(snap => {
                        if (!snap.exists) return;
                        
                        const oldBooking = snap.data();
                        const newBooking = {
                            ...oldBooking,
                            status: 'negotiating',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            renewedFrom: renewSessionId,
                            reuseTerms: true
                        };
                        
                        // Remove old booking ID fields
                        delete newBooking.id;
                        
                        db.collection('bookings').add(newBooking).then(docRef => {
                            showNotification('Session renewal request sent with same terms!', 'success');
                            // Clear URL parameters
                            window.history.replaceState({}, document.title, window.location.pathname);
                            // Open chat for new session
                            setTimeout(() => {
                                openChat(docRef.id, newBooking.instructorId, newBooking.instructorName);
                            }, 1000);
                        });
                    });
                } else {
                    // Show instructor selection for new terms
                    showNotification('Select an instructor to negotiate new terms', 'info');
                    // Clear URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // Call handleRenewalFromURL after Firebase is initialized - will be handled in main auth listener
        </script>

        <script>
        // Paystack Configuration
        const PAYSTACK_PUBLIC_KEY = 'pk_test_4f982216f23d912048d00f1a9c9f77a7b54647bc';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
            authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
            projectId: "andrew-cares-village-f4cb6",
            storageBucket: "andrew-cares-village-f4cb6.firebasestorage.app",
            messagingSenderId: "255087116955",
            appId: "1:255087116955:web:84360ee1f13888f9b83c3e"
        };

        // Initialize Firebase with comprehensive error handling
        let auth, db;
        let firebaseInitialized = false;
        
        try {
            // Check if Firebase is available
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            // Initialize Firebase app
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            auth = firebase.auth();
            db = firebase.firestore();
            
            // Configure Firestore settings first to reduce connection timeouts
            try {
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                    ignoreUndefinedProperties: true,
                    experimentalForceLongPolling: false, // Use WebSocket for better performance
                    merge: true
                });
                console.log('✅ Firestore settings configured');
            } catch (settingsError) {
                console.warn('⚠️ Firestore settings already configured:', settingsError.message);
            }

            // Enable offline persistence with simpler configuration
            db.enablePersistence({ synchronizeTabs: false }).then(() => {
                console.log('✅ Firebase persistence enabled');
                
                // Settings already configured above
                
                // Test Firebase connection
                return db.collection('users').limit(1).get();
            }).then(() => {
                console.log('✅ Firebase connected successfully');
            }).catch((err) => {
                console.warn('⚠️ Persistence error:', err.message);
                if (err.code == 'failed-precondition') {
                    console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code == 'unimplemented') {
                    console.log('The current browser does not support all of the features required to enable persistence');
                }
                
                // Test connection without persistence
                return db.collection('users').limit(1).get();
            }).then(() => {
                console.log('✅ Firebase connected successfully');
                firebaseInitialized = true;
                if (currentUserData && currentUserData.role === 'member') {
                    loadAvailableMentors();
                }
            }).catch((connError) => {
                console.warn('⚠️ Firebase connection failed, entering offline mode:', connError);
                firebaseInitialized = false;
                showNotification('Working offline - limited functionality available', 'info');
                
                // Load cached data for offline mode
                const cachedMentors = localStorage.getItem('cachedMentors');
                if (cachedMentors && currentUserData && currentUserData.role === 'member') {
                    try {
                        const mentors = JSON.parse(cachedMentors);
                        displayMentors(mentors);
                        console.log('📋 Loaded cached mentors for offline viewing');
                    } catch (e) {
                        console.warn('Failed to parse cached mentors');
                    }
                }
            });
            
        } catch (error) {
            console.error('❌ Firebase initialization failed:', error);
            
            // Create mock Firebase objects for offline development
            auth = {
                onAuthStateChanged: (callback) => {
                    console.log('🔧 Using mock auth - redirecting to login');
                    setTimeout(() => callback(null), 1000);
                },
                signOut: () => Promise.resolve()
            };
            
            // Create proper mock snapshot objects
            const createMockSnapshot = (docs = []) => ({
                empty: docs.length === 0,
                docs: docs,
                forEach: (callback) => docs.forEach(callback),
                size: docs.length
            });

            db = {
                collection: () => ({
                    where: (field, operator, value) => ({
                        get: () => Promise.resolve(createMockSnapshot([])),
                        onSnapshot: (callback) => callback(createMockSnapshot([])),
                        where: (field2, operator2, value2) => ({
                            get: () => Promise.resolve(createMockSnapshot([])),
                            onSnapshot: (callback) => callback(createMockSnapshot([])),
                            orderBy: () => ({
                                get: () => Promise.resolve(createMockSnapshot([])),
                                onSnapshot: (callback) => callback(createMockSnapshot([]))
                            })
                        }),
                        orderBy: () => ({
                            get: () => Promise.resolve(createMockSnapshot([])),
                            onSnapshot: (callback) => callback(createMockSnapshot([]))
                        })
                    }),
                    get: () => Promise.resolve(createMockSnapshot([])),
                    onSnapshot: (callback) => callback(createMockSnapshot([])),
                    add: () => Promise.resolve({ id: 'mock-id' }),
                    doc: () => ({
                        get: () => Promise.resolve({ exists: false, data: () => null }),
                        set: () => Promise.resolve(),
                        update: () => Promise.resolve(),
                        delete: () => Promise.resolve()
                    }),
                    orderBy: () => ({
                        get: () => Promise.resolve(createMockSnapshot([])),
                        onSnapshot: (callback) => callback(createMockSnapshot([]))
                    })
                })
            };
            
            firebaseInitialized = false;
        }

        // Global State
        let currentUser = null;
        let currentUserData = null;
        let calendar = null;
        let selectedInstructorId = null;
        
        let currentChatPartner = {};
       

        // Add sample data to Firestore for testing
        async function addSampleData() {
            if (!firebaseInitialized) {
                console.log('⚠️ Firebase not initialized, skipping sample data');
                return;
            }

            try {
                // Add sample mentors
                const sampleMentors = [
                    {
                        name: 'Dr. Sarah Johnson',
                        email: 'sarah.johnson@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Career Development & Leadership',
                        bio: 'Former tech executive with 15+ years experience helping professionals advance their careers. Specializes in leadership development, career transitions, and executive coaching.',
                        hourlyRate: 75,
                        rating: 4.9,
                        totalSessions: 127,
                        profileImage: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face',
                        availability: ['Monday', 'Tuesday', 'Wednesday', 'Thursday'],
                        timeSlots: ['09:00', '10:00', '11:00', '14:00', '15:00'],
                        createdAt: new Date()
                    },
                    {
                        name: 'Prof. Michael Chen',
                        email: 'michael.chen@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Academic Research & PhD Guidance',
                        bio: 'University professor and research supervisor with expertise in data science, machine learning, and academic writing. Published 50+ peer-reviewed papers.',
                        hourlyRate: 60,
                        rating: 4.8,
                        totalSessions: 89,
                        profileImage: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face',
                        availability: ['Tuesday', 'Wednesday', 'Thursday', 'Friday'],
                        timeSlots: ['10:00', '11:00', '13:00', '14:00', '16:00'],
                        createdAt: new Date()
                    },
                    {
                        name: 'Emily Rodriguez',
                        email: 'emily.rodriguez@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Entrepreneurship & Startup Strategy',
                        bio: 'Serial entrepreneur who founded 3 successful startups. Now mentoring the next generation of founders in business strategy, fundraising, and scaling operations.',
                        hourlyRate: 85,
                        rating: 4.7,
                        totalSessions: 156,
                        profileImage: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face',
                        availability: ['Monday', 'Wednesday', 'Friday', 'Saturday'],
                        timeSlots: ['09:00', '10:00', '15:00', '16:00', '17:00'],
                        createdAt: new Date()
                    }
                ];

                // Check if mentors already exist
                const existingMentors = await db.collection('users').where('role', '==', 'instructor').get();
                
                if (existingMentors.empty) {
                    console.log('📝 Adding sample mentors to Firestore...');
                    
                    for (const mentor of sampleMentors) {
                        await db.collection('users').add(mentor);
                    }
                    
                    console.log('✅ Sample mentors added successfully!');
                } else {
                    console.log('ℹ️ Mentors already exist in database');
                }

            } catch (error) {
                console.error('❌ Error adding sample data:', error);
            }
        }

        // Load available mentors with error handling
        async function loadAvailableMentors() {
            try {
                const result = await window.errorHandler.executeFirebaseOperation(
                    () => db.collection('users').where('role', '==', 'instructor').get(),
                    'Load mentors'
                );
                
                if (result.empty) {
                    // Add sample data if no mentors exist
                    await addSampleData();
                    const newResult = await window.errorHandler.executeFirebaseOperation(
                        () => db.collection('users').where('role', '==', 'instructor').get(),
                        'Load mentors after sample data'
                    );
                    const mentors = newResult.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayMentors(mentors);
                    window.errorHandler.cacheData('mentors', mentors);
                } else {
                    const mentors = result.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayMentors(mentors);
                    window.errorHandler.cacheData('mentors', mentors);
                }
            } catch (error) {
                if (error.message === 'OFFLINE_MODE') {
                    // Load cached mentors
                    const cachedMentors = window.errorHandler.getCachedData('mentors');
                    if (cachedMentors) {
                        displayMentors(cachedMentors);
                        window.errorHandler.showNotification('Showing cached mentors (offline)', 'info');
                    } else {
                        window.errorHandler.showNotification('No mentors available offline', 'warning');
                    }
                } else {
                    console.error('Error loading mentors:', error);
                    window.errorHandler.showNotification('Error loading mentors. Please try again.', 'error');
                }
            }
        }

        // Authentication State Management - prioritize Firestore connection
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Real authenticated user - prioritize this
                console.log('👤 Real user authenticated:', user.email);
                currentUser = user;
                
                // Fetch user data from Firestore to get correct role
                try {
                    const userDoc = await db.collection("users").doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                    } else {
                        // Create new user document with default role
                        currentUserData = {
                            name: user.displayName || user.email?.split('@')[0] || 'User',
                            email: user.email,
                            role: 'member' // Default role for new users
                        };
                        await db.collection("users").doc(user.uid).set(currentUserData);
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Fallback to default user data
                    currentUserData = {
                        name: user.displayName || user.email?.split('@')[0] || 'User',
                        email: user.email,
                        role: 'member'
                    };
                }
                
                // Handle session renewal from URL parameters first
                handleRenewalFromURL();
                
                // Initialize the appropriate view based on user role
                initializeView();
                
                // Load appropriate data based on role
                if (currentUserData.role === 'member') {
                    loadMemberSessions();
                    loadMentorsForMember();
                } else if (currentUserData.role === 'instructor') {
                    loadInstructorBookings();
                }
                
                // Load conversations for chat sidebar - handled by existing functions
            } else {
                console.log('❌ No authenticated user');
                // Redirect to login if no user
                window.location.href = 'login.html';
            }
        });

        function initializeView() {
            const userRole = currentUserData?.role;

            // Helper function to safely hide/show elements
            function safeToggleElement(elementId, show = false) {
                const element = document.getElementById(elementId);
                if (element) {
                    if (show) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                } else {
                    console.warn(`Element with ID '${elementId}' not found`);
                }
            }

            // Hide all views first
            safeToggleElement('memberView', false);
            safeToggleElement('instructorView', false);
            safeToggleElement('adminView', false);
            safeToggleElement('accessDeniedView', false);

            // Show appropriate view
            if (userRole === 'member') {
                safeToggleElement('memberView', true);
                updateSidebarConversations();
                loadMemberSessions();
                loadAvailableMentors(); // Load mentors when member view is shown
                initializeMemberCalendar(); // Initialize calendar when member view is shown
            } else if (userRole === 'instructor') {
                safeToggleElement('instructorView', true);
                initializeInstructor();
            } else if (userRole === 'admin') {
                safeToggleElement('adminView', true);
                initializeAdmin();
            } else {
                safeToggleElement('accessDeniedView', true);
            }

            updateSidebarConversations();
        }

        // Tab Management
        window.switchTab = function(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
        };

        // Member Functions
        function initializeMember() {
            initializeMemberCalendar();
            loadMentorsForMember();
            loadMemberSessions();
        }

        function initializeMemberCalendar() {
            if (calendar) {
                calendar.destroy();
            }
            
            try {
                const calendarEl = document.getElementById('memberCalendar');
                if (!calendarEl) {
                    console.error('❌ Calendar element not found');
                    return;
                }
                
                console.log('📅 Initializing member calendar...');
                
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    slotMinTime: '08:00:00',
                    slotMaxTime: '20:00:00',
                    height: 'auto',
                    events: [],
                    eventClick: function(info) {
                        if (info.event.extendedProps.available) {
                            bookSession(info.event.extendedProps.timeSlot, info.event.start);
                        }
                    }
                });
                
                calendar.render();
                console.log('✅ Calendar initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing calendar:', error);
                document.getElementById('memberCalendar').innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Calendar unavailable. Please refresh the page.</p>';
            }
        }

        async function loadMentorsForMember() {
            const instructorList = document.getElementById('memberInstructorList');
            instructorList.innerHTML = '<p>Loading mentors...</p>';
            
            try {
                const snapshot = await db.collection("users").where("role", "==", "instructor").get();
                instructorList.innerHTML = '';
                
                for (const docSnap of snapshot.docs) {
                    const instructor = { id: docSnap.id, ...docSnap.data() };
                    
                    const card = document.createElement('div');
                    card.className = 'instructor-card';
                    card.dataset.instructorId = instructor.id;
                    card.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        padding: 1rem;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 1px solid transparent;
                        margin-bottom: 1rem;
                    `;
                    
                    const avatarUrl = instructor.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(instructor.name)}`;
                    
                    card.innerHTML = `
                        <img src="${avatarUrl}" 
                             alt="${instructor.name}" 
                             style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;"
                             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(instructor.name)}'">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-weight: 600;">${instructor.name}</h4>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
                                ${instructor.expertise?.join(', ') || 'General Mentorship'}
                            </p>
                            <small>From ₦${instructor.hourlyRate || 5000}/hour</small>
                        </div>
                    `;
                    
                    card.onclick = () => selectMentorForMember(instructor.id, instructor.name, card);
                    card.onmouseover = () => {
                        card.style.backgroundColor = 'var(--hover-bg)';
                        card.style.transform = 'translateX(5px)';
                    };
                    card.onmouseout = () => {
                        if (!card.classList.contains('active')) {
                            card.style.backgroundColor = '';
                            card.style.transform = '';
                        }
                    };
                    
                    instructorList.appendChild(card);
                }
            } catch (error) {
                console.error('Error loading mentors:', error);
                instructorList.innerHTML = '<p>Error loading mentors. Please refresh the page.</p>';
            }
        }

        async function selectMentorForMember(instructorId, instructorName, cardElement) {
            selectedInstructorId = instructorId;
            
            // Update UI
            document.querySelectorAll('.instructor-card').forEach(c => {
                c.classList.remove('active');
                c.style.backgroundColor = '';
                c.style.borderColor = 'transparent';
                c.style.transform = '';
            });
            cardElement.classList.add('active');
            cardElement.style.backgroundColor = 'var(--hover-bg)';
            cardElement.style.borderColor = 'var(--color-primary)';
            cardElement.style.boxShadow = '0 2px 10px rgba(179, 139, 0, 0.2)';
            
            document.getElementById('memberBookingTitle').textContent = `Booking with ${instructorName}`;

            // Load instructor's available slots
            try {
                console.log('🔍 Loading slots for instructor:', instructorId);
                
                // For testing, create mock availability data if Firebase fails
                if (!firebaseInitialized) {
                    console.log('📅 Using mock availability data');
                    const mockEvents = [
                        {
                            id: 'mock-1',
                            title: 'Available',
                            start: new Date().toISOString().split('T')[0] + 'T09:00:00',
                            backgroundColor: '#28a745',
                            borderColor: '#28a745',
                            extendedProps: { available: true, timeSlot: '09:00' }
                        },
                        {
                            id: 'mock-2', 
                            title: 'Available',
                            start: new Date().toISOString().split('T')[0] + 'T14:00:00',
                            backgroundColor: '#28a745',
                            borderColor: '#28a745',
                            extendedProps: { available: true, timeSlot: '14:00' }
                        }
                    ];
                    
                    if (calendar) {
                        calendar.removeAllEvents();
                        calendar.addEventSource(mockEvents);
                    }
                    return;
                }
                
                const snapshot = await db.collection("mentorshipSlots")
                    .where("instructorId", "==", instructorId)
                    .get();
                
                let events = [];
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.timeSlots && Array.isArray(data.timeSlots)) {
                        data.timeSlots.forEach(timeSlot => {
                            events.push({
                                id: `${docSnap.id}_${timeSlot.time}`,
                                title: `Available - ₦${timeSlot.rate}/hr`,
                                start: `${data.date}T${timeSlot.time}`,
                                end: new Date(new Date(`${data.date}T${timeSlot.time}`).getTime() + 45 * 60000).toISOString(),
                                extendedProps: { 
                                    slotDocId: docSnap.id, 
                                    timeSlot: timeSlot.time, 
                                    instructorName,
                                    hourlyRate: timeSlot.rate
                                }
                            });
                        });
                    }
                });

                // Filter out already booked sessions
                const bookingsSnapshot = await db.collection("bookings")
                    .where("instructorId", "==", instructorId)
                    .get();
                const bookedSlots = new Set(
                    bookingsSnapshot.docs.map(d => `${d.data().slotDocId}_${d.data().timeSlot}`)
                );
                
                const availableEvents = events.filter(event => !bookedSlots.has(event.id));

                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(availableEvents);
                }
            } catch (error) {
                console.error('Error loading mentor availability:', error);
            }
        }

        async function handleMemberEventClick(info) {
            const { slotDocId, timeSlot, instructorName, hourlyRate } = info.event.extendedProps;
            const startTime = info.event.start;

            // Simple booking for now - will add agreement modal later
            if (confirm(`Book session with ${instructorName} at ${startTime.toLocaleString()} for ₦${hourlyRate}/hour?`)) {
                try {
                    await db.collection("bookings").add({
                        studentId: currentUser.uid,
                        studentName: currentUserData.name,
                        instructorId: selectedInstructorId,
                        instructorName: instructorName,
                        slotDocId: slotDocId,
                        timeSlot: timeSlot,
                        startTime: firebase.firestore.Timestamp.fromDate(startTime),
                        hourlyRate: hourlyRate,
                        status: 'negotiating',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Booking request sent! The instructor will review and confirm.');
                    
                    // Refresh calendar
                    selectMentorForMember(selectedInstructorId, instructorName, 
                        document.querySelector(`[data-instructor-id="${selectedInstructorId}"]`));
                } catch (error) {
                    console.error('Error creating booking:', error);
                    alert('Failed to create booking. Please try again.');
                }
            }
        }

        function loadMemberSessions() {
            const sessionsList = document.getElementById('memberSessionsList');
            
            if (!currentUser) return;
            
            try {
                let q = db.collection("bookings").where("studentId", "==", currentUser.uid);
                
                // Try to add orderBy if available (real Firebase)
                if (firebaseInitialized && typeof q.orderBy === 'function') {
                    q = q.orderBy("createdAt", "desc");
                }
                
                q.onSnapshot((snapshot) => {
                    sessionsList.innerHTML = snapshot.empty ? '<p>You have no sessions yet.</p>' : '';
                    
                    snapshot.forEach(docSnap => {
                        const session = { id: docSnap.id, ...docSnap.data() };
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'session-card';
                        sessionEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        // Handle mock data vs real Firebase data
                        const sessionDate = session.startTime?.toDate ? session.startTime.toDate() : new Date();
                        const statusClass = `status-${session.status || 'pending'}`;
                        
                        sessionEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${session.instructorName || 'Instructor'}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Rate: ₦${session.hourlyRate || 5000}/hour</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="session-status ${statusClass}" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    ${session.status || 'pending'}
                                </span>
                                <button class="btn btn-info btn-sm" onclick="openChat('${session.id}', '${session.instructorId}', '${session.instructorName}')">
                                    <i class="fas fa-comments"></i> Chat
                                </button>
                                ${(session.studentSignedAt && session.instructorSignedAt && session.paymentCompleted) ? `
                                <button class="btn btn-success btn-sm" onclick="openLearningDashboard('${session.id}')">
                                    <i class="fas fa-graduation-cap"></i> Learning
                                </button>
                                ` : ''}
                                ${session.instructorId === currentUser?.uid ? `
                                <button class="btn btn-warning btn-sm" onclick="openInstructorContent('${session.id}')">
                                    <i class="fas fa-cog"></i> Manage
                                </button>
                                ` : ''}
                            </div>
                        `;
                        sessionsList.appendChild(sessionEl);
                    });
                });
            } catch (error) {
                console.error('Error loading member sessions:', error);
                sessionsList.innerHTML = '<p>Error loading sessions. Please refresh the page.</p>';
            }
        }

        // Instructor Functions
        function initializeInstructor() {
            generateTimeSlots();
            loadInstructorBookings();
            loadCompletedSessions();
        }

        function generateTimeSlots() {
            const grid = document.getElementById('timeSlotGrid');
            if (!grid) {
                // Create time slot grid if it doesn't exist
                const availabilityTab = document.getElementById('availability-tab');
                const saveButton = availabilityTab.querySelector('.btn-primary');
                const timeSlotContainer = document.createElement('div');
                timeSlotContainer.innerHTML = `
                    <div class="form-group">
                        <label>Available Time Slots:</label>
                        <div class="availability-grid" id="timeSlotGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <!-- Time slots will be generated here -->
                        </div>
                    </div>
                `;
                saveButton.parentNode.insertBefore(timeSlotContainer, saveButton);
            }
            
            const timeSlotGrid = document.getElementById('timeSlotGrid');
            const timeSlots = [
                '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', 
                '15:00', '16:00', '17:00', '18:00', '19:00'
            ];
            
            timeSlotGrid.innerHTML = '';
            timeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                slot.dataset.time = time;
                slot.style.cssText = `
                    padding: 0.8rem;
                    border: 2px dashed var(--border-color);
                    border-radius: 8px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                `;
                slot.onclick = () => toggleTimeSlot(slot);
                slot.onmouseover = () => {
                    if (!slot.classList.contains('selected')) {
                        slot.style.borderColor = 'var(--color-primary)';
                        slot.style.backgroundColor = 'var(--hover-bg)';
                    }
                };
                slot.onmouseout = () => {
                    if (!slot.classList.contains('selected')) {
                        slot.style.borderColor = 'var(--border-color)';
                        slot.style.backgroundColor = '';
                    }
                };
                timeSlotGrid.appendChild(slot);
            });
        }

        function toggleTimeSlot(slot) {
            slot.classList.toggle('selected');
            if (slot.classList.contains('selected')) {
                slot.style.borderColor = 'var(--color-primary)';
                slot.style.backgroundColor = 'rgba(179, 139, 0, 0.1)';
            } else {
                slot.style.borderColor = 'var(--border-color)';
                slot.style.backgroundColor = '';
            }
        }

        function loadInstructorBookings() {
            console.log('🔍 Loading instructor bookings for:', currentUser?.uid);
            const bookingsList = document.getElementById('instructorBookingsList');
            
            if (!currentUser) {
                console.log('❌ No current user for instructor bookings');
                return;
            }
            
            if (!bookingsList) {
                console.log('❌ instructorBookingsList element not found');
                return;
            }
            
            try {
                // Query directly for this instructor's bookings (no need to get all first)
                let q = db.collection("bookings").where("instructorId", "==", currentUser.uid);
                
                console.log('🎯 Querying bookings for instructor:', currentUser.uid);
                
                q.onSnapshot((snapshot) => {
                    console.log(`📋 Found ${snapshot.size} bookings for instructor`);
                    
                    if (snapshot.empty) {
                        bookingsList.innerHTML = '<p>No bookings yet.</p>';
                        console.log('📝 No bookings found for this instructor');
                        return;
                    }
                    
                    bookingsList.innerHTML = '';
                    
                    snapshot.forEach(docSnap => {
                        const booking = { id: docSnap.id, ...docSnap.data() };
                        console.log('✅ Processing booking:', booking);
                        
                        const bookingEl = document.createElement('div');
                        bookingEl.className = 'session-card';
                        bookingEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        const sessionDate = booking.sessionDate?.toDate ? booking.sessionDate.toDate() : 
                                          booking.startTime?.toDate ? booking.startTime.toDate() : 
                                          booking.createdAt?.toDate ? booking.createdAt.toDate() : new Date();
                        const statusClass = `status-${booking.status || 'negotiating'}`;
                        
                        bookingEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${booking.studentName || 'Student'}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Rate: ₦${booking.hourlyRate || 5000}/hour</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">Time: ${booking.timeSlot || 'TBD'}</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <span class="session-status ${statusClass}" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    ${booking.status || 'negotiating'}
                                </span>
                                <button class="btn btn-info btn-sm" onclick="openChat('${booking.id}', '${booking.studentId}', '${booking.studentName || 'Student'}')" style="background: linear-gradient(45deg, #667eea, #764ba2); border: none; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                                    <i class="fas fa-comments"></i> Chat
                                </button>
                                ${(booking.status === 'negotiating' || !booking.status) ? `
                                    <button class="btn btn-success btn-sm" onclick="confirmBooking('${booking.id}')">
                                        <i class="fas fa-check"></i> Confirm
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectBooking('${booking.id}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                ` : ''}
                                ${booking.status === 'confirmed' ? `
                                    <button class="btn btn-success btn-sm" onclick="markSessionComplete('${booking.id}')">
                                        <i class="fas fa-check-circle"></i> Complete
                                    </button>
                                ` : ''}
                            </div>
                        `;
                        bookingsList.appendChild(bookingEl);
                    });
                });
            } catch (error) {
                console.error('Error loading instructor bookings:', error);
                bookingsList.innerHTML = '<p>Error loading bookings. Please refresh the page.</p>';
            }
        }

        // Booking management functions for instructors
        window.confirmBooking = async function(bookingId) {
            try {
                await db.collection("bookings").doc(bookingId).update({
                    status: 'confirmed',
                    confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Booking confirmed successfully!', 'success');
                
                // Send system message to chat
                const booking = await db.collection("bookings").doc(bookingId).get();
                if (booking.exists) {
                    const bookingData = booking.data();
                    await db.collection("chats").add({
                        sessionId: bookingId,
                        senderId: 'system',
                        senderName: 'System',
                        text: `✅ Session confirmed by instructor. Looking forward to our mentorship session!`,
                        messageType: 'system',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Error confirming booking:', error);
                showNotification('Failed to confirm booking. Please try again.', 'error');
            }
        };

        window.rejectBooking = async function(bookingId) {
            try {
                await db.collection("bookings").doc(bookingId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    chatEnabled: true // Keep chat open after rejection
                });
                
                showNotification('Booking rejected. Chat remains open for discussion.', 'info');
                
                // Send system message to chat explaining rejection but keeping communication open
                const booking = await db.collection("bookings").doc(bookingId).get();
                if (booking.exists) {
                    await db.collection("messages").add({
                        sessionId: bookingId,
                        senderId: 'system',
                        message: 'This booking request has been declined by the instructor. However, you can continue chatting to discuss alternative arrangements, different time slots, or modified terms.',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'system'
                    });
                }
            } catch (error) {
                console.error('Error rejecting booking:', error);
                showNotification('Failed to reject booking. Please try again.', 'error');
            }
        };

        window.markSessionComplete = async function(bookingId) {
            try {
                await db.collection("bookings").doc(bookingId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Session marked as completed!', 'success');
                
                // Send system message to chat
                await db.collection("chats").add({
                    sessionId: bookingId,
                    senderId: 'system',
                    senderName: 'System',
                    text: `🎉 Session completed successfully! Thank you for the mentorship.`,
                    messageType: 'system',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error completing session:', error);
                showNotification('Failed to mark session as complete. Please try again.', 'error');
            }
        };

        function loadCompletedSessions() {
            const completedList = document.getElementById('completedSessionsList');
            
            if (!currentUser) return;
            
            try {
                let q = db.collection("bookings").where("instructorId", "==", currentUser.uid);
                
                if (firebaseInitialized) {
                    q = q.where("status", "==", "completed");
                    if (typeof q.orderBy === 'function') {
                        q = q.orderBy("completedAt", "desc");
                    }
                }
                
                q.onSnapshot((snapshot) => {
                    completedList.innerHTML = snapshot.empty ? '<p>No completed sessions yet.</p>' : '';
                    
                    snapshot.forEach(docSnap => {
                        const session = { id: docSnap.id, ...docSnap.data() };
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'session-card';
                        sessionEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        const sessionDate = session.startTime?.toDate ? session.startTime.toDate() : new Date();
                        const finalAmount = session.finalAmount || session.hourlyRate || 5000;
                        const earnings = Math.round(finalAmount * 0.9); // 90% after platform fee
                        
                        sessionEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${session.studentName || 'Student'}</p>
                                <p style="margin: 0; color: var(--success-color); font-size: 0.9rem; font-weight: 600;">Earned: ₦${earnings.toLocaleString()}</p>
                                <div style="color: var(--warning-color); font-size: 0.8rem;">
                                    Rating: ${'★'.repeat(session.rating || 5)} ${session.rating || 5}/5
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="session-status status-completed" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    Completed
                                </span>
                            </div>
                        `;
                        completedList.appendChild(sessionEl);
                    });
                });
            } catch (error) {
                console.error('Error loading completed sessions:', error);
                completedList.innerHTML = '<p>Error loading completed sessions. Please refresh the page.</p>';
            }
        }

        function initializeAdmin() {
            loadAdminStatistics();
            loadAllTransactions();
            loadAllMentors();
        }

        async function loadAdminStatistics() {
            try {
                // Get all completed bookings
                const completedSnapshot = await db.collection("bookings")
                    .where("status", "==", "completed")
                    .get();
                
                let totalCommission = 0;
                completedSnapshot.forEach(doc => {
                    const booking = doc.data();
                    totalCommission += Math.round((booking.finalAmount || booking.hourlyRate) * 0.1); // 10% commission
                });
                
                // Get pending sessions
                const pendingSnapshot = await db.collection("bookings")
                    .where("status", "in", ["negotiating", "confirmed"])
                    .get();
                
                // Update admin stats display
                const statsContainer = document.getElementById('adminStats');
                statsContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--color-primary), #d4af37); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">₦${totalCommission.toLocaleString()}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Commission Earned</p>
                        </div>
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--info-color), #20c997); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">${completedSnapshot.size}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Sessions Completed</p>
                        </div>
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--warning-color), #f39c12); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">${pendingSnapshot.size}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Pending Sessions</p>
                        </div>
                    </div>
                    
                    <div class="tab-nav" style="margin-bottom: 2rem;">
                        <button class="tab-btn active" onclick="switchAdminTab('transactions')">
                            <i class="fas fa-money-bill-wave"></i> Transactions
                        </button>
                        <button class="tab-btn" onclick="switchAdminTab('mentors')">
                            <i class="fas fa-users"></i> Mentors
                        </button>
                    </div>
                    
                    <div id="admin-transactions-tab" class="admin-tab-content active">
                        <h3 style="color: var(--color-secondary); margin-bottom: 1rem;">All Transactions</h3>
                        <div id="adminTransactionsList">
                            <p>Loading transactions...</p>
                        </div>
                    </div>
                    
                    <div id="admin-mentors-tab" class="admin-tab-content" style="display: none;">
                        <h3 style="color: var(--color-secondary); margin-bottom: 1rem;">Mentor Management</h3>
                        <div id="adminMentorsList">
                            <p>Loading mentors...</p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading admin statistics:', error);
            }
        }

        function loadAvailableMentors() {
            console.log('🔍 Loading mentors, Firebase initialized:', firebaseInitialized);
            const mentorsGrid = document.getElementById('memberInstructorList');
            if (!mentorsGrid) {
                console.error('❌ memberInstructorList element not found');
                return;
            }

            // Enhanced demo data with professional mentors and expertise tags
            const demoMentors = [
                {
                    id: 'demo1',
                    name: 'Dr. Sarah Johnson',
                    expertise: 'Career Development & Leadership',
                    bio: 'Former Fortune 500 executive with 15+ years experience in leadership development and C-suite transitions.',
                    rating: 4.9,
                    sessions: 127,
                    hourlyRate: 75,
                    avatar: 'https://ui-avatars.com/api/?name=Sarah+Johnson&background=667eea&color=fff&size=150',
                    expertiseTags: ['Leadership', 'Career Growth', 'Executive Coaching', 'Team Management', 'Performance Review'],
                    languages: ['English', 'Spanish'],
                    availability: 'Mon-Fri 9AM-5PM EST',
                    responseTime: '< 2 hours',
                    totalReviews: 142,
                    achievements: ['Top 1% Mentor', 'Leadership Expert', 'Career Catalyst'],
                    publications: ['The Executive Mindset', 'Career Acceleration Strategies']
                },
                {
                    id: 'demo2',
                    name: 'Michael Chen',
                    expertise: 'Tech & Software Engineering',
                    bio: 'Senior Software Architect at Google, specializing in system design and career growth in tech.',
                    rating: 4.8,
                    sessions: 89,
                    hourlyRate: 85,
                    avatar: 'https://ui-avatars.com/api/?name=Michael+Chen&background=10b981&color=fff&size=150',
                    expertiseTags: ['System Design', 'Software Architecture', 'Tech Career', 'Code Review', 'Team Leadership'],
                    languages: ['English', 'Mandarin'],
                    availability: 'Tue-Thu 2PM-8PM EST',
                    responseTime: '< 4 hours',
                    totalReviews: 76,
                    achievements: ['Tech Excellence', 'System Design Expert', 'Code Mentor'],
                    publications: ['Scalable System Design', 'The Tech Career Guide']
                },
                {
                    id: 'demo3',
                    name: 'Emily Rodriguez',
                    expertise: 'Business Strategy & Entrepreneurship',
                    bio: 'Serial entrepreneur and business consultant, helped launch 20+ successful startups with $50M+ exits.',
                    rating: 4.9,
                    sessions: 156,
                    hourlyRate: 95,
                    avatar: 'https://ui-avatars.com/api/?name=Emily+Rodriguez&background=f59e0b&color=fff&size=150',
                    expertiseTags: ['Startup Strategy', 'Fundraising', 'Product-Market Fit', 'Scaling', 'Exit Strategy'],
                    languages: ['English', 'Portuguese'],
                    availability: 'Mon-Wed 10AM-6PM EST',
                    responseTime: '< 1 hour',
                    totalReviews: 187,
                    achievements: ['Startup Unicorn', 'Funding Expert', 'Exit Specialist'],
                    publications: ['Zero to Unicorn Playbook', 'Fundraising Secrets']
                }
            ];

            function displayMentors(mentors, source = 'demo') {
                mentorsGrid.innerHTML = mentors.map(mentor => `
                    <div class="mentor-card" onclick="selectMentor('${mentor.id}')" style="
                        background: white;
                        border: 1px solid #e0e0e0;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 16px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <img src="${mentor.avatar}" alt="${mentor.name}" style="
                                width: 50px;
                                height: 50px;
                                border-radius: 50%;
                                margin-right: 15px;
                                object-fit: cover;
                            ">
                            <div>
                                <h3 style="margin: 0; color: #1a1a1a; font-size: 18px; font-weight: 600;">${mentor.name}</h3>
                                <p style="margin: 4px 0 0 0; color: #6366f1; font-size: 14px; font-weight: 500;">${mentor.expertise}</p>
                            </div>
                        </div>
                        <p style="margin: 0 0 12px 0; color: #666; font-size: 14px; line-height: 1.4;">${mentor.bio}</p>
                        
                        ${mentor.expertiseTags ? `
                        <div style="margin-bottom: 12px;">
                            ${mentor.expertiseTags.slice(0, 3).map(tag => `
                                <span style="
                                    display: inline-block;
                                    background: linear-gradient(135deg, #667eea, #764ba2);
                                    color: white;
                                    padding: 4px 8px;
                                    border-radius: 12px;
                                    font-size: 11px;
                                    font-weight: 500;
                                    margin-right: 6px;
                                    margin-bottom: 4px;
                                ">${tag}</span>
                            `).join('')}
                            ${mentor.expertiseTags.length > 3 ? `<span style="color: #888; font-size: 11px;">+${mentor.expertiseTags.length - 3} more</span>` : ''}
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px; font-size: 12px;">
                                <span style="color: #f59e0b;">⭐ ${mentor.rating}</span>
                                <span style="color: #888;">${mentor.totalReviews || mentor.sessions} reviews</span>
                                ${mentor.responseTime ? `<span style="color: #10b981;">🕒 ${mentor.responseTime}</span>` : ''}
                            </div>
                            <span style="color: #10b981; font-weight: 600; font-size: 14px;">₦${mentor.hourlyRate * 100}/hr</span>
                        </div>
                        
                        ${mentor.achievements ? `
                        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                            ${mentor.achievements.slice(0, 2).map(achievement => `
                                <span style="
                                    background: rgba(16, 185, 129, 0.1);
                                    color: #059669;
                                    padding: 2px 6px;
                                    border-radius: 8px;
                                    font-size: 10px;
                                    font-weight: 600;
                                ">🏆 ${achievement}</span>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${mentor.languages ? `
                        <div style="font-size: 11px; color: #666; margin-top: 8px;">
                            <span>🌐 ${mentor.languages.join(', ')}</span>
                            ${mentor.availability ? `<span style="margin-left: 12px;">📅 ${mentor.availability}</span>` : ''}
                        </div>
                        ` : ''}
                    </div>
                `).join('');
                console.log(`📋 Displaying ${mentors.length} mentors from ${source}`);
            }

            // Always show demo data first for immediate UI feedback
            displayMentors(demoMentors, 'demo (loading...)');

            // Then try to load real data if Firebase is available
            if (firebaseInitialized && db) {
                console.log('🔥 Loading mentors from Firestore...');
                
                // First try to get all users and filter for instructors
                db.collection("users").get()
                    .then(snapshot => {
                        console.log(`📊 Found ${snapshot.size} total users in database`);
                        
                        if (!snapshot.empty) {
                            const mentors = [];
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                console.log(`👤 User ${doc.id}:`, data);
                                
                                // Check if user is an instructor (flexible field checking)
                                const isInstructor = data.role === 'instructor' || 
                                                   data.userType === 'instructor' || 
                                                   data.type === 'instructor' ||
                                                   data.accountType === 'instructor';
                                
                                if (isInstructor) {
                                    console.log(`✅ Found instructor: ${data.name || data.displayName || doc.id}`);
                                    mentors.push({
                                        id: doc.id,
                                        name: data.name || data.displayName || data.firstName || 'Unknown Mentor',
                                        expertise: data.expertise || data.specialization || data.skills || 'General Mentoring',
                                        bio: data.bio || data.description || data.about || 'Experienced mentor ready to help you grow.',
                                        rating: data.rating || 4.5,
                                        sessions: data.completedSessions || data.totalSessions || 0,
                                        hourlyRate: data.hourlyRate || data.rate || 50,
                                        avatar: data.avatar || data.photoURL || data.profileImage || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2MzY2RjEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K'
                                    });
                                }
                            });
                            
                            if (mentors.length > 0) {
                                console.log(`🎯 Found ${mentors.length} instructors to display`);
                                displayMentors(mentors, 'Firestore');
                            } else {
                                console.log('📝 No instructors found in users collection, keeping demo data');
                                displayMentors(demoMentors, 'demo (no instructors found)');
                            }
                        } else {
                            console.log('📝 No users found in Firestore, keeping demo data');
                            displayMentors(demoMentors, 'demo (no users data)');
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error loading users from Firestore:', error);
                        displayMentors(demoMentors, 'demo (Firestore error)');
                    });
            } else {
                console.log('📝 Firebase not initialized, keeping demo data');
            }
        }

        // Add selectMentor function
        window.selectMentor = async function(mentorId) {
            console.log('🎯 Selected mentor:', mentorId);
            
            // Store selected mentor ID globally for booking
            window.selectedMentorId = mentorId;
            
            try {
                // Check if instructor has available mentorship slots
                const slotsQuery = await db.collection("mentorshipSlots")
                    .where("instructorId", "==", mentorId)
                    .get();
                
                if (slotsQuery.empty) {
                    showNotification('Instructor is not available for now. Try again later.', 'warning');
                    return;
                }
                
                // Load mentor's available time slots into calendar
                const events = [];
                slotsQuery.forEach(doc => {
                    const slotData = doc.data();
                    if (slotData.timeSlots && Array.isArray(slotData.timeSlots)) {
                        slotData.timeSlots.forEach(slot => {
                            const eventDate = new Date(slotData.date + 'T' + slot.time);
                            events.push({
                                title: `Available - $${slot.rate}/hr`,
                                start: eventDate,
                                end: new Date(eventDate.getTime() + 60 * 60 * 1000), // 1 hour
                                backgroundColor: '#10b981',
                                borderColor: '#059669',
                                extendedProps: {
                                    available: true,
                                    mentorId: mentorId,
                                    timeSlot: slot,
                                    rate: slot.rate
                                }
                            });
                        });
                    }
                });
                
                if (events.length === 0) {
                    showNotification('Instructor has no available time slots. Try again later.', 'warning');
                    return;
                }
                
                // Update calendar with mentor's availability
                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                    showNotification(`Showing ${events.length} available slots for this instructor`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading mentor availability:', error);
                showNotification('Error loading instructor availability. Try again later.', 'error');
            }
        };

        // Add notification system
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.slide-notification');
            if (existing) existing.remove();
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'slide-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${type === 'success' ? '✅' : type === 'warning' ? '⚠️' : type === 'error' ? '❌' : 'ℹ️'}</span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: -400px;
                width: 350px;
                background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#6366f1'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                transition: right 0.3s ease;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            notification.querySelector('.notification-content').style.cssText = `
                display: flex;
                align-items: center;
                padding: 16px;
                gap: 12px;
            `;
            
            notification.querySelector('.notification-message').style.cssText = `
                flex: 1;
                font-size: 14px;
                font-weight: 500;
            `;
            
            notification.querySelector('.notification-close').style.cssText = `
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background-color 0.2s;
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.style.right = '20px';
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.right = '-400px';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Enhanced booking system that allows multiple concurrent bookings
        window.bookSession = async function(timeSlot, eventStart) {
            console.log('📅 Booking session:', timeSlot, eventStart);
            
            try {
                // Get proper student name from user data
                const studentName = currentUserData?.displayName || 
                                  currentUserData?.name || 
                                  currentUserData?.email?.split('@')[0] || 
                                  'Student';
                
                // Generate unique booking ID for this specific request
                const bookingId = `${timeSlot.mentorId || window.selectedMentorId}_${eventStart.getTime()}_${currentUser.uid}_${Date.now()}`;
                
                // Create booking request with unique identifier
                const bookingData = {
                    bookingId: bookingId,
                    studentId: currentUser.uid,
                    studentName: studentName,
                    instructorId: timeSlot.mentorId || window.selectedMentorId || 'unknown',
                    sessionDate: eventStart,
                    timeSlot: timeSlot.time,
                    hourlyRate: timeSlot.rate || 50,
                    status: 'negotiating',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    message: 'I would like to book this mentorship session.',
                    slotId: `${timeSlot.mentorId || window.selectedMentorId}_${eventStart.getTime()}` // For tracking multiple bookings on same slot
                };
                
                // Add booking to Firestore (allows multiple bookings for same time slot)
                const bookingRef = await db.collection("bookings").add(bookingData);
                console.log('📋 Booking created with ID:', bookingRef.id, 'Data:', bookingData);
                
                showNotification('Session booking request sent! The instructor can accept multiple students for this time slot.', 'success');
                
                // Update calendar to show booking status without querying (to avoid permissions issues)
                if (calendar) {
                    const events = calendar.getEvents();
                    events.forEach(event => {
                        if (event.start.getTime() === eventStart.getTime()) {
                            // Get current pending count from event properties
                            const currentPending = event.extendedProps.pendingBookings || 0;
                            const newPendingCount = currentPending + 1;
                            
                            // Update title to show booking count
                            const baseTitle = event.title.replace(/ \(\d+ pending\)| \(\d+ booked\)/g, '');
                            event.setProp('title', `${baseTitle} (${newPendingCount} pending)`);
                            
                            // Color coding based on booking count
                            if (newPendingCount === 1) {
                                event.setProp('backgroundColor', '#f59e0b'); // Orange for 1 booking
                                event.setProp('borderColor', '#d97706');
                            } else if (newPendingCount >= 2) {
                                event.setProp('backgroundColor', '#ef4444'); // Red for multiple bookings
                                event.setProp('borderColor', '#dc2626');
                            }
                            
                            // Keep slot available for more bookings
                            event.setExtendedProp('pendingBookings', newPendingCount);
                            event.setExtendedProp('available', true); // Always keep available
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error booking session:', error);
                showNotification('Failed to book session. Please try again.', 'error');
            }
        };

function loadCompletedSessions() {
    const completedList = document.getElementById('completedSessionsList');

    if (!currentUser) return;

    try {
        let q = db.collection("bookings").where("instructorId", "==", currentUser.uid);

        if (firebaseInitialized) {
            q = q.where("status", "==", "completed");
            if (typeof q.orderBy === 'function') {
                q = q.orderBy("completedAt", "desc");
            }
        }
        
        q.onSnapshot((snapshot) => {
            completedList.innerHTML = snapshot.empty ? '<p>No completed sessions yet.</p>' : '';
            
            snapshot.forEach(docSnap => {
                const session = { id: docSnap.id, ...docSnap.data() };
                const sessionEl = document.createElement('div');
                sessionEl.className = 'session-card';
                sessionEl.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 1.5rem;
                    border: 1px solid var(--border-color);
                    border-radius: 12px;
                    margin-bottom: 1rem;
                    transition: all 0.3s;
                `;
                
                const completedDate = session.completedAt?.toDate ? session.completedAt.toDate() : new Date();
                const finalAmount = session.finalAmount || session.hourlyRate || 5000;
                
                sessionEl.innerHTML = `
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">Session with ${session.studentName || 'Student'}</h4>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Completed: ${completedDate.toLocaleString()}</p>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">Earned: ₦${Math.round(finalAmount * 0.9).toLocaleString()}</p>
                    </div>
                    <div style="text-align: right;">
                        <span class="session-status status-completed" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                            Completed
                        </span>
                    </div>
                `;
                completedList.appendChild(sessionEl);
            });
        });
    } catch (error) {
        console.error('Error loading completed sessions:', error);
        completedList.innerHTML = '<p>Error loading sessions. Please refresh the page.</p>';
    }
}

        async function loadAllMentors() {
            const mentorsList = document.getElementById('adminMentorsList');
            
            try {
                const snapshot = await db.collection("users").where("role", "==", "instructor").get();
                mentorsList.innerHTML = '';
                
                for (const docSnap of snapshot.docs) {
                    const mentor = { id: docSnap.id, ...docSnap.data() };
                    
                    // Get mentor statistics
                    const sessionsSnap = await db.collection("bookings")
                        .where("instructorId", "==", mentor.id)
                        .where("status", "==", "completed")
                        .get();
                    
                    let totalEarnings = 0;
                    sessionsSnap.forEach(doc => {
                        const finalAmount = doc.data().finalAmount || doc.data().hourlyRate;
                        totalEarnings += Math.round(finalAmount * 0.9);
                    });
                    
                    const mentorEl = document.createElement('div');
                    mentorEl.className = 'session-card';
                    mentorEl.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.5rem;
                        border: 1px solid var(--border-color);
                        border-radius: 12px;
                        margin-bottom: 1rem;
                        transition: all 0.3s;
                    `;
                    
                    mentorEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <img src="${mentor.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(mentor.name)}`}" 
                                 alt="${mentor.name}" 
                                 style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${mentor.name}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${mentor.email}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Expertise: ${mentor.expertise?.join(', ') || 'Not specified'}</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Completed Sessions: ${sessionsSnap.size}</p>
                            <p style="margin: 0; color: var(--success-color); font-size: 0.9rem; font-weight: 600;">Total Earnings: ₦${totalEarnings.toLocaleString()}</p>
                            <button class="btn btn-info btn-sm" onclick="viewMentorDetails('${mentor.id}')" style="margin-top: 0.5rem;">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    `;
                    mentorsList.appendChild(mentorEl);
                }
            } catch (error) {
                console.error('Error loading mentors:', error);
                mentorsList.innerHTML = '<p>Error loading mentors. Please refresh the page.</p>';
            }
        }

        window.switchAdminTab = function(tabName) {
            // Update active tab button
            document.querySelectorAll('#adminStats .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all admin tab contents
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(`admin-${tabName}-tab`);
            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
            }
        };

        window.viewMentorDetails = function(mentorId) {
            console.log('Viewing mentor details for:', mentorId);
            // Could open a detailed modal or navigate to mentor profile
        };

        function updateSidebarConversations() {
            const sidebarConversations = document.getElementById('sidebarConversations');
            
            if (!currentUser || !currentUserData) return;
            
            // Query for active sessions/conversations
            const q = db.collection("bookings")
                .where(currentUserData.role === 'instructor' ? "instructorId" : "studentId", "==", currentUser.uid)
                .where("status", "in", ["confirmed", "negotiating", "completed"]);
            
            q.onSnapshot((snapshot) => {
                // Preserve toggle element
                const toggleElement = sidebarConversations.querySelector('.conversation-toggle');
                sidebarConversations.innerHTML = '';
                if (toggleElement) {
                    sidebarConversations.appendChild(toggleElement);
                }
                
                if (snapshot.empty) {
                    const noChatsEl = document.createElement('div');
                    noChatsEl.className = 'conversation-item';
                    noChatsEl.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=No+Chat&background=ddd&color=999&size=32" alt="Avatar" class="conversation-avatar">
                        <div class="conversation-info">
                            <p class="conversation-name">No active chats</p>
                            <p class="conversation-preview">Start a session to begin chatting</p>
                        </div>
                    `;
                    sidebarConversations.appendChild(noChatsEl);
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const session = { id: docSnap.id, ...docSnap.data() };
                    const isInstructor = currentUserData.role === 'instructor';
                    const partnerName = isInstructor ? session.studentName : session.instructorName;
                    
                    const conversationEl = document.createElement('div');
                    conversationEl.className = 'conversation-item';
                    conversationEl.onclick = () => openChat(session.id, isInstructor ? session.studentId : session.instructorId, partnerName);
                    
                    conversationEl.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(partnerName)}&size=32" alt="${partnerName}" class="conversation-avatar">
                        <div class="conversation-info">
                            <p class="conversation-name">${partnerName}</p>
                            <p class="conversation-preview">Mentorship Session</p>
                        </div>
                    `;
                    
                    sidebarConversations.appendChild(conversationEl);
                });
            });
        }

        window.saveAvailability = async function() {
            const date = document.getElementById('availabilityDate').value;
            const hourlyRate = parseInt(document.getElementById('hourlyRate').value);
            const selectedSlots = document.querySelectorAll('.time-slot.selected');
            
            if (!date || !hourlyRate || selectedSlots.length === 0) {
                alert('Please fill all fields and select at least one time slot.');
                return;
            }

            if (hourlyRate < 1000) {
                alert('Minimum hourly rate is ₦1,000.');
                return;
            }

            const timeSlots = Array.from(selectedSlots).map(slot => ({
                time: slot.dataset.time,
                rate: hourlyRate
            }));

            try {
                await db.collection("mentorshipSlots").doc(`${currentUser.uid}_${date}`).set({
                    instructorId: currentUser.uid,
                    date: date,
                    timeSlots: timeSlots,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Availability saved successfully!');
                
                // Reset form
                document.getElementById('availabilityDate').value = '';
                document.getElementById('hourlyRate').value = '';
                selectedSlots.forEach(slot => {
                    slot.classList.remove('selected');
                    slot.style.borderColor = 'var(--border-color)';
                    slot.style.backgroundColor = '';
                });
                
            } catch (error) {
                console.error('Error saving availability:', error);
                alert('Failed to save availability. Please try again.');
            }
        };

        window.confirmBooking = async function(bookingId) {
            if (confirm('Confirm this booking?')) {
                try {
                    await db.collection("bookings").doc(bookingId).update({
                        status: 'confirmed',
                        confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Booking confirmed!');
                } catch (error) {
                    console.error('Error confirming booking:', error);
                    alert('Failed to confirm booking.');
                }
            }
        };

        window.rejectBooking = async function(bookingId) {
            if (confirm('Reject this booking? This action cannot be undone.')) {
                try {
                    await db.collection("bookings").doc(bookingId).update({
  status: 'rejected',
  rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
});                    alert('Booking rejected and removed.');
                } catch (error) {
                    console.error('Error rejecting booking:', error);
                    alert('Failed to reject booking.');
                }
            }
        };

        window.markSessionComplete = async function(bookingId) {
            if (confirm('Mark this session as completed?')) {
                try {
                    const bookingDoc = await db.collection("bookings").doc(bookingId).get();
                    const bookingData = bookingDoc.data();
                    
                    await db.collection("bookings").doc(bookingId).update({
                        status: 'completed',
                        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        finalAmount: bookingData.hourlyRate, // 1 hour session
                        rating: 5 // Default rating, can be updated by student later
                    });
                    alert('Session marked as completed!');
                } catch (error) {
                    console.error('Error completing session:', error);
                    alert('Failed to complete session.');
                }
            }
        };

        function openChat(sessionId, partnerId, partnerName) {
            console.log('Opening chat:', sessionId, partnerId, partnerName);
            
            // Show chat sidebar
            const chatSidebar = document.getElementById('chatSidebar');
            const chatMessages = document.getElementById('chatMessages');
            
            if (!chatSidebar) {
                console.error('❌ Chat sidebar not found');
                return;
            }
            
            if (!chatMessages) {
                console.error('❌ Chat messages container not found');
                return;
            }
            
            // Show chat sidebar using CSS classes
            chatSidebar.style.display = 'flex';
            chatSidebar.classList.add('active');
            
            // Update active conversation in sidebar
            updateActiveConversation(partnerName);
            
            // Update chat header with partner info
            const partnerNameElement = document.querySelector('.partner-name');
            const headerAvatar = document.querySelector('.header-meta .avatar');
            
            if (partnerNameElement) {
                partnerNameElement.textContent = partnerName || 'User';
            }
            
            if (headerAvatar) {
                const initials = (partnerName || 'U').split(' ').map(n => n[0]).join('').toUpperCase();
                headerAvatar.textContent = initials;
            }
            
            // Load chat messages
            loadChatMessages(sessionId);
            
            // Set current chat session
            window.currentChatSession = sessionId;
            window.currentChatPartner = { id: partnerId, name: partnerName || 'User' };
            
            // Auto-collapse conversation list
            autoCollapseConversations();
            
            // Check for agreement button
            checkForAgreementButton(sessionId);
            
            // Focus on input
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if (chatInput) chatInput.focus();
            }, 300);
             setupAgreementListener(window.currentChatSession);
        }
        
        // Update active conversation in sidebar
        function updateActiveConversation(partnerName) {
            const conversationItem = document.querySelector('.conversation-item');
            if (conversationItem) {
                const nameElement = conversationItem.querySelector('h4');
                const messageElement = conversationItem.querySelector('p');
                const avatar = conversationItem.querySelector('img');
                
                if (nameElement) nameElement.textContent = partnerName || 'Professional Support';
                if (messageElement) messageElement.textContent = 'Active mentorship session';
                if (avatar) {
                    const initials = (partnerName || 'Support').split(' ').map(n => n[0]).join('');
                    avatar.src = `https://ui-avatars.com/api/?name=${initials}&background=667eea&color=fff&size=45&rounded=true`;
                }
            }
        }
        
        // Helper function for random colors
        function getRandomColor() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function loadChatMessages(sessionId) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            // Listen for real-time chat messages
            db.collection("chats")
                .where("sessionId", "==", sessionId)
                .orderBy("timestamp", "asc")
                .onSnapshot((snapshot) => {
                    chatMessages.innerHTML = '';
                    
                    if (snapshot.empty) {
                        chatMessages.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #666;">
                                <i class="fas fa-comments" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                                <p style="margin: 0; font-size: 1.1rem; font-weight: 500;">No messages yet</p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #999;">Start the conversation!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let lastDate = null;
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const isCurrentUser = message.senderId === currentUser.uid;
                        const timestamp = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
                        const messageDate = timestamp.toDateString();
                        
                        // Add date separator if needed
                        if (lastDate !== messageDate) {
                            const dateSeparator = document.createElement('div');
                            dateSeparator.style.cssText = `
                                text-align: center;
                                margin: 1.5rem 0;
                                position: relative;
                            `;
                            dateSeparator.innerHTML = `
                                <span style="
                                    background: rgba(255,255,255,0.9);
                                    padding: 0.3rem 1rem;
                                    border-radius: 15px;
                                    font-size: 0.8rem;
                                    color: #666;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                ">${messageDate === new Date().toDateString() ? 'Today' : messageDate}</span>
                            `;
                            chatMessages.appendChild(dateSeparator);
                            lastDate = messageDate;
                        }
                        
                        const messageEl = document.createElement('div');
                        messageEl.className = `message-bubble ${isCurrentUser ? 'message-sent' : 'message-received'}`;
                        
                        const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const senderName = isCurrentUser ? 'You' : (message.senderName || 'User');
                        
                        messageEl.innerHTML = `
                            <div style="font-size: 0.9rem; line-height: 1.4;">${message.text}</div>
                            <div class="message-time" style="${isCurrentUser ? 'text-align: right;' : 'text-align: left;'}">
                                ${senderName} • ${timeString}
                            </div>
                            ${isCurrentUser ? '<div class="message-status"><i class="fas fa-check" style="color: rgba(255,255,255,0.7);"></i></div>' : ''}
                        `;
                        
                        chatMessages.appendChild(messageEl);
                    });
                    
                    // Smooth scroll to bottom
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                });
        }

        function checkForAgreementButton(sessionId) {
            // This function is now disabled - using new bilateral agreement system
            return;
        }

   /*  Create / insert the agreement strip  */
function insertAgreementStrip() {
  const chatInput = document.getElementById('chatInput');
  if (!chatInput) return;                  //  guard: element not ready

  //  Don’t add twice
  if (document.querySelector('.agreement-button')) return;

  const agreementBtn = document.createElement('div');
  agreementBtn.className = 'agreement-button';
  agreementBtn.innerHTML = `
    <button onclick="openContract()" style="
      width:100%; padding:.6rem; border:0; border-radius:8px;
      background:linear-gradient(135deg,var(--color-primary),#d4af37);
      color:#fff; font-weight:600; cursor:pointer;">
      <i class="fas fa-file-contract"></i>  Sign Contract
    </button>`;
  chatInput.parentNode.insertBefore(agreementBtn, chatInput);
}

        window.openAgreementForm = function(sessionId) {
            // Create agreement modal
            const modal = document.createElement('div');
            modal.className = 'agreement-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeAgreementModal()"></div>
                <div class="modal-content" style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 16px;
                    padding: 2rem;
                    width: 90%;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
                    z-index: 10001;
                ">
                    <h2 style="margin: 0 0 1.5rem 0; color: #1a1a1a;">Mentorship Agreement</h2>
                    
                    <form id="agreementForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Session Duration (hours):</label>
                            <input type="number" id="sessionDuration" min="1" max="8" value="1" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 1rem;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Total Amount (₦):</label>
                            <input type="number" id="totalAmount" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 1rem;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Session Objectives:</label>
                            <textarea id="sessionObjectives" rows="3" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 1rem;
                                resize: vertical;
                            " placeholder="What do you hope to achieve in this session?"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="agreeTerms" required>
                                <span>I agree to the terms and conditions of this mentorship session</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button type="button" onclick="closeAgreementModal()" style="
                                flex: 1;
                                padding: 0.75rem;
                                border: 1px solid #e0e0e0;
                                background: white;
                                border-radius: 8px;
                                cursor: pointer;
                            ">Cancel</button>
                            <button type="submit" style="
                                flex: 1;
                                padding: 0.75rem;
                                background: #10b981;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">Sign Agreement</button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10000;
            `;
            
            modal.querySelector('.modal-overlay').style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('agreementForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await signAgreement(sessionId);
            });
        };

        window.closeAgreementModal = function() {
            const modal = document.querySelector('.agreement-modal');
            if (modal) modal.remove();
        };

        async function signAgreement(sessionId) {
            try {
                const duration = document.getElementById('sessionDuration').value;
                const amount = document.getElementById('totalAmount').value;
                const objectives = document.getElementById('sessionObjectives').value;
                
                // Update booking with agreement details
                await db.collection("bookings").doc(sessionId).update({
                    agreementSigned: true,
                    sessionDuration: parseInt(duration),
                    finalAmount: parseInt(amount),
                    sessionObjectives: objectives,
                    agreementDate: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'agreed'
                });
                
                // Add system message to chat
                await db.collection("chats").add({
                    sessionId: sessionId,
                    senderId: 'system',
                    senderName: 'System',
                    text: `📋 Agreement signed! Session duration: ${duration}h, Amount: ₦${parseInt(amount).toLocaleString()}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'system'
                });
                
                closeAgreementModal();
                showNotification('Agreement signed successfully! Session is now finalized.', 'success');
                
            } catch (error) {
                console.error('Error signing agreement:', error);
                showNotification('Failed to sign agreement. Please try again.', 'error');
            }
        }

        // Send chat message function with price detection
        window.sendChatMessage = function() {
            const messageInput = document.getElementById('chatInput');
            const message = messageInput.value.trim();
            
            if (!message || !window.currentChatSession) return;
            
            // Add visual feedback
            const sendButton = document.querySelector('[onclick="sendChatMessage()"]');
            const originalContent = sendButton.innerHTML;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            sendButton.disabled = true;
            
            // Clear input immediately for better UX
            messageInput.value = '';
            
            // Check for price agreement in message
            const priceMatch = message.match(/(?:₦|\$|USD|NGN)\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i) || 
                             message.match(/(\d+(?:,\d{3})*(?:\.\d{2})?)\s*(?:₦|naira|dollars?|USD|NGN)/i);
            
            let messageType = 'text';
            let agreedPrice = null;
            
            if (priceMatch && (message.toLowerCase().includes('agree') || message.toLowerCase().includes('accept') || message.toLowerCase().includes('deal'))) {
                messageType = 'price_agreement';
                agreedPrice = priceMatch[1].replace(/,/g, '');
            }
            
            db.collection("chats").add({
                sessionId: window.currentChatSession,
                senderId: currentUser.uid,
                senderName: currentUserData?.displayName || currentUserData?.name || currentUserData?.email?.split('@')[0] || 'User',
                text: message,
                messageType: messageType,
                agreedPrice: agreedPrice,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'sent'
            }).then(() => {
                // Reset button
                sendButton.innerHTML = originalContent;
                sendButton.disabled = false;
                
                // Show payment section if price agreed
                if (messageType === 'price_agreement') {
                    showPaymentSection(agreedPrice);
                    showNotification('Price agreement detected! Payment option available.', 'success');
                } else {
                    showNotification('Message sent!', 'success');
                }
            }).catch(error => {
                console.error('Error sending message:', error);
                // Restore message if failed
                messageInput.value = message;
                sendButton.innerHTML = originalContent;
                sendButton.disabled = false;
                showNotification('Failed to send message. Please try again.', 'error');
            });
        };
        
        // Show payment section when price is agreed
        function showPaymentSection(agreedPrice) {
            const paymentSection = document.getElementById('paymentSection');
            const agreedRateElement = document.getElementById('agreedRate');
            
            if (paymentSection && agreedRateElement) {
                agreedRateElement.textContent = `₦${agreedPrice}/hour`;
                paymentSection.style.display = 'block';
                
                // Store agreed price globally
                window.agreedPrice = agreedPrice;
            }
        }
        
        // Initiate payment process
        window.initiatePayment = function() {
            if (!window.agreedPrice) {
                showNotification('No agreed price found', 'error');
                return;
            }
            
            // Here you would integrate with Paystack or your payment provider
            showNotification('Redirecting to payment gateway...', 'info');
            
            // Placeholder for Paystack integration
            setTimeout(() => {
                showNotification('Payment feature will be integrated with Paystack', 'info');
            }, 1000);
        };

        // Goal-based mentor matching functionality
        let selectedGoals = [];

        window.selectGoal = function(goalType) {
            const goalCard = document.querySelector(`[data-goal="${goalType}"]`);
            const clearBtn = document.getElementById('clearGoalsBtn');
            
            if (selectedGoals.includes(goalType)) {
                // Deselect goal
                selectedGoals = selectedGoals.filter(g => g !== goalType);
                goalCard.style.border = '2px solid #e2e8f0';
                goalCard.style.background = 'white';
                goalCard.style.transform = 'scale(1)';
            } else {
                // Select goal
                selectedGoals.push(goalType);
                goalCard.style.border = '2px solid #667eea';
                goalCard.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05))';
                goalCard.style.transform = 'scale(1.02)';
            }
            
            // Show/hide clear button
            clearBtn.style.display = selectedGoals.length > 0 ? 'inline-flex' : 'none';
            
            // Filter mentors based on selected goals
            filterMentorsByGoals();
        };

        window.clearGoalSelection = function() {
            selectedGoals = [];
            document.querySelectorAll('.goal-card').forEach(card => {
                card.style.border = '2px solid #e2e8f0';
                card.style.background = 'white';
                card.style.transform = 'scale(1)';
            });
            document.getElementById('clearGoalsBtn').style.display = 'none';
            
            // Show all mentors
            filterMentorsByGoals();
        };

        function filterMentorsByGoals() {
            const mentorsGrid = document.getElementById('memberInstructorList');
            if (!mentorsGrid) return;
            
            // Get current mentors data
            const demoMentors = [
                {
                    id: 'demo1',
                    name: 'Dr. Sarah Johnson',
                    expertise: 'Career Development & Leadership',
                    bio: 'Former Fortune 500 executive with 15+ years experience in leadership development and C-suite transitions.',
                    rating: 4.9,
                    sessions: 127,
                    hourlyRate: 75,
                    avatar: 'https://ui-avatars.com/api/?name=Sarah+Johnson&background=667eea&color=fff&size=150',
                    expertiseTags: ['Leadership', 'Career Growth', 'Executive Coaching', 'Team Management', 'Performance Review'],
                    languages: ['English', 'Spanish'],
                    availability: 'Mon-Fri 9AM-5PM EST',
                    responseTime: '< 2 hours',
                    totalReviews: 142,
                    achievements: ['Top 1% Mentor', 'Leadership Expert', 'Career Catalyst'],
                    publications: ['The Executive Mindset', 'Career Acceleration Strategies'],
                    goalCategories: ['career']
                },
                {
                    id: 'demo2',
                    name: 'Michael Chen',
                    expertise: 'Tech & Software Engineering',
                    bio: 'Senior Software Architect at Google, specializing in system design and career growth in tech.',
                    rating: 4.8,
                    sessions: 89,
                    hourlyRate: 85,
                    avatar: 'https://ui-avatars.com/api/?name=Michael+Chen&background=10b981&color=fff&size=150',
                    expertiseTags: ['System Design', 'Software Architecture', 'Tech Career', 'Code Review', 'Team Leadership'],
                    languages: ['English', 'Mandarin'],
                    availability: 'Tue-Thu 2PM-8PM EST',
                    responseTime: '< 4 hours',
                    totalReviews: 76,
                    achievements: ['Tech Excellence', 'System Design Expert', 'Code Mentor'],
                    publications: ['Scalable System Design', 'The Tech Career Guide'],
                    goalCategories: ['tech', 'career']
                },
                {
                    id: 'demo3',
                    name: 'Emily Rodriguez',
                    expertise: 'Business Strategy & Entrepreneurship',
                    bio: 'Serial entrepreneur and business consultant, helped launch 20+ successful startups with $50M+ exits.',
                    rating: 4.9,
                    sessions: 156,
                    hourlyRate: 95,
                    avatar: 'https://ui-avatars.com/api/?name=Emily+Rodriguez&background=f59e0b&color=fff&size=150',
                    expertiseTags: ['Startup Strategy', 'Fundraising', 'Product-Market Fit', 'Scaling', 'Exit Strategy'],
                    languages: ['English', 'Portuguese'],
                    availability: 'Mon-Wed 10AM-6PM EST',
                    responseTime: '< 1 hour',
                    totalReviews: 187,
                    achievements: ['Startup Unicorn', 'Funding Expert', 'Exit Specialist'],
                    publications: ['Zero to Unicorn Playbook', 'Fundraising Secrets'],
                    goalCategories: ['business', 'career']
                }
            ];
            
            // Filter mentors based on selected goals
            let filteredMentors = demoMentors;
            if (selectedGoals.length > 0) {
                filteredMentors = demoMentors.filter(mentor => 
                    mentor.goalCategories && mentor.goalCategories.some(cat => selectedGoals.includes(cat))
                );
            }
            
            // Display filtered mentors
            displayFilteredMentors(filteredMentors);
            
            // Show notification
            if (selectedGoals.length > 0) {
                const goalNames = selectedGoals.map(g => {
                    const goalMap = {
                        'career': 'Career Growth',
                        'tech': 'Tech & Engineering', 
                        'business': 'Entrepreneurship',
                        'academic': 'Academic Research'
                    };
                    return goalMap[g];
                }).join(', ');
                showNotification(`Showing ${filteredMentors.length} mentors for: ${goalNames}`, 'info');
            }
        }

        function displayFilteredMentors(mentors) {
            const mentorsGrid = document.getElementById('memberInstructorList');
            if (!mentorsGrid) return;
            
            mentorsGrid.innerHTML = mentors.map(mentor => `
                <div class="mentor-card" onclick="selectMentor('${mentor.id}')" style="
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 12px;
                    padding: 20px;
                    margin-bottom: 16px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <img src="${mentor.avatar}" alt="${mentor.name}" style="
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            margin-right: 15px;
                            object-fit: cover;
                        ">
                        <div>
                            <h3 style="margin: 0; color: #1a1a1a; font-size: 18px; font-weight: 600;">${mentor.name}</h3>
                            <p style="margin: 4px 0 0 0; color: #6366f1; font-size: 14px; font-weight: 500;">${mentor.expertise}</p>
                        </div>
                    </div>
                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px; line-height: 1.4;">${mentor.bio}</p>
                    
                    ${mentor.expertiseTags ? `
                    <div style="margin-bottom: 12px;">
                        ${mentor.expertiseTags.slice(0, 3).map(tag => `
                            <span style="
                                display: inline-block;
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                padding: 4px 8px;
                                border-radius: 12px;
                                font-size: 11px;
                                font-weight: 500;
                                margin-right: 6px;
                                margin-bottom: 4px;
                            ">${tag}</span>
                        `).join('')}
                        ${mentor.expertiseTags.length > 3 ? `<span style="color: #888; font-size: 11px;">+${mentor.expertiseTags.length - 3} more</span>` : ''}
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px; font-size: 12px;">
                            <span style="color: #f59e0b;">⭐ ${mentor.rating}</span>
                            <span style="color: #888;">${mentor.totalReviews || mentor.sessions} reviews</span>
                            ${mentor.responseTime ? `<span style="color: #10b981;">🕒 ${mentor.responseTime}</span>` : ''}
                        </div>
                        <span style="color: #10b981; font-weight: 600; font-size: 14px;">₦${mentor.hourlyRate * 100}/hr</span>
                    </div>
                    
                    ${mentor.achievements ? `
                    <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                        ${mentor.achievements.slice(0, 2).map(achievement => `
                            <span style="
                                background: rgba(16, 185, 129, 0.1);
                                color: #059669;
                                padding: 2px 6px;
                                border-radius: 8px;
                                font-size: 10px;
                                font-weight: 600;
                            ">🏆 ${achievement}</span>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${mentor.languages ? `
                    <div style="font-size: 11px; color: #666; margin-top: 8px;">
                        <span>🌐 ${mentor.languages.join(', ')}</span>
                        ${mentor.availability ? `<span style="margin-left: 12px;">📅 ${mentor.availability}</span>` : ''}
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Close chat sidebar function
        window.closeChatSidebar = function() {
            const chatSidebar = document.getElementById('chatSidebar');
            if (chatSidebar) {
                chatSidebar.classList.remove('active');
                setTimeout(() => {
                    chatSidebar.style.display = 'none';
                }, 300);
            }
        };

        // Minimize chat function
        window.minimizeChat = function() {
            const chatSidebar = document.getElementById('chatSidebar');
            if (chatSidebar) {
                chatSidebar.style.height = '60px';
                chatSidebar.style.overflow = 'hidden';
                setTimeout(() => {
                    chatSidebar.style.height = '100vh';
                    chatSidebar.style.overflow = 'hidden';
                }, 2000);
            }
        };
        
        // Cloudinary configuration
        const CLOUDINARY_CONFIG = {
            cloudName: 'dkd6x857p',
            uploadPreset: 'Andrew Cares Village Hub'
        };

        // Attach file function with Cloudinary upload
        window.attachFile = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            input.multiple = false;
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('File size must be less than 10MB', 'error');
                    return;
                }
                
                // Show upload progress
                const uploadNotification = showUploadProgress('Uploading file...');
                
                try {
                    const uploadResult = await uploadToCloudinary(file, (progress) => {
                        updateUploadProgress(uploadNotification, progress);
                    });
                    
                    // Remove upload notification
                    uploadNotification.remove();
                    
                    // Send file message
                    await sendFileMessage(uploadResult);
                    
                    showNotification('File uploaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    uploadNotification.remove();
                    showNotification('Failed to upload file. Please try again.', 'error');
                }
            };
            
            input.click();
        };

        // Upload to Cloudinary
        async function uploadToCloudinary(file, onProgress) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                
                const fileExtension = file.name.split('.').pop().toLowerCase();
                let resourceType = 'auto';
                
                // Determine resource type
                if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExtension)) {
                    resourceType = 'image';
                } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(fileExtension)) {
                    resourceType = 'video';
                } else if (['mp3', 'wav', 'ogg', 'aac'].includes(fileExtension)) {
                    resourceType = 'video'; // Cloudinary uses 'video' for audio
                }
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable && onProgress) {
                        const progress = Math.round((e.loaded / e.total) * 100);
                        onProgress(progress);
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        resolve({
                            url: response.secure_url,
                            publicId: response.public_id,
                            resourceType: response.resource_type,
                            format: response.format,
                            originalFilename: file.name,
                            fileSize: file.size
                        });
                    } else {
                        reject(new Error('Upload failed'));
                    }
                });
                
                xhr.addEventListener('error', () => reject(new Error('Upload failed')));
                
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/${resourceType}/upload`);
                xhr.send(formData);
            });
        }
        /*  open / close contract  */
window.openContract = () => {
  const m = document.getElementById('contractModal');
  m.style.display = 'grid';
  const rate = Number(document.getElementById('agreedRate')?.textContent.replace(/[₦,]/g,'') || 5000);
  document.getElementById('rate').value = rate;
  document.getElementById('hours').value = 1;
  document.getElementById('total').value = rate;
};
document.getElementById('hours').oninput = e => {
  const total = Number(document.getElementById('rate').value) * Number(e.target.value);
  document.getElementById('total').value = total;
};
window.closeContract = () => document.getElementById('contractModal').style.display = 'none';

/*  handle contract signature  */
document.getElementById('contractForm').onsubmit = async e => {
  e.preventDefault();
  const data = {
    hours: Number(document.getElementById('hours').value),
    rate:  Number(document.getElementById('rate').value),
    total: Number(document.getElementById('total').value),
    objectives: document.getElementById('objectives').value,
    signedAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'signed'
  };
  await db.collection('bookings').doc(window.currentChatSession).update(data);
  await db.collection('chats').add({
    sessionId: window.currentChatSession,
    senderId: 'system',
    text: `📄 Contract signed – ${data.hours} h × ₦${data.rate} = ₦${data.total}`,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  closeContract();
};

/*  BOTH must sign before we call it final  */
db.collection('bookings').doc(window.currentChatSession)
  .onSnapshot(snap => {
    if (!snap.exists) { hideBoth(); return; }

    const d = snap.data();
    const strip   = document.getElementById('contractStrip');
    const payStrip= document.getElementById('paymentStrip');
    const stripText=document.getElementById('stripText');

    /*  who is looking?  */
    const meStudent = currentUserData.role === 'member';
    const meInstructor = currentUserData.role === 'instructor';

    /*  signature flags  */
    const studentSigned = d.studentSignedAt;
    const instructorSigned = d.instructorSignedAt;

    /*  contract still open ?  */
    if (!studentSigned || !instructorSigned) {
      strip.style.display   = 'block';
      payStrip.style.display= 'none';
      stripText.innerHTML =
        !studentSigned && meStudent ? '<i class="fas fa-edit"></i> Sign Contract' :
        !studentSigned && meInstructor ? '<i class="fas fa-clock"></i> Waiting for student' :
        !instructorSigned && meInstructor ? '<i class="fas fa-edit"></i> Sign Contract' :
        '<i class="fas fa-clock"></i> Waiting for instructor';
      return;
    }

    /*  both signed  */
    strip.style.display = 'none';
    if (meStudent && d.status === 'agreed') {
      payStrip.style.display = 'block';
      document.getElementById('payAmount').textContent = (d.total || 0).toLocaleString();
    } else {
      payStrip.style.display = 'none';
    }
  });

function hideBoth() {
  document.getElementById('contractStrip').style.display = 'none';
  document.getElementById('paymentStrip').style.display = 'none';
}

        // Send file message
        async function sendFileMessage(uploadResult) {
            const fileType = uploadResult.resourceType;
            let messageContent = '';
            
            if (fileType === 'image') {
                messageContent = `<div class="file-message image-message">
                    <img src="${uploadResult.url}" alt="${uploadResult.originalFilename}" style="max-width: 250px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="window.open('${uploadResult.url}', '_blank')">
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; opacity: 0.8;">${uploadResult.originalFilename}</p>
                </div>`;
            } else if (fileType === 'video') {
                messageContent = `<div class="file-message video-message">
                    <video controls style="max-width: 250px; max-height: 200px; border-radius: 8px;">
                        <source src="${uploadResult.url}" type="video/${uploadResult.format}">
                        Your browser does not support the video tag.
                    </video>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; opacity: 0.8;">${uploadResult.originalFilename}</p>
                </div>`;
            } else {
                messageContent = `<div class="file-message document-message" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer;" onclick="window.open('${uploadResult.url}', '_blank')">
                    <i class="fas fa-file-alt" style="font-size: 2rem; color: #667eea;"></i>
                    <div>
                        <p style="margin: 0; font-weight: 500;">${uploadResult.originalFilename}</p>
                        <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">${(uploadResult.fileSize / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                    <i class="fas fa-download" style="margin-left: auto; opacity: 0.6;"></i>
                </div>`;
            }
            
            return db.collection("chats").add({
                sessionId: window.currentChatSession,
                senderId: currentUser.uid,
                senderName: currentUserData?.displayName || currentUserData?.name || currentUserData?.email?.split('@')[0] || 'User',
                text: messageContent,
                fileUrl: uploadResult.url,
                fileName: uploadResult.originalFilename,
                fileType: fileType,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'sent',
                isFile: true
            });
        }

        // Show upload progress notification
        function showUploadProgress(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                z-index: 1001;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                backdrop-filter: blur(10px);
                min-width: 250px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: 500;">${message}</p>
                        <div style="background: rgba(255,255,255,0.3); height: 4px; border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
                            <div class="upload-progress-bar" style="background: white; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            return notification;
        }

        // Update upload progress
        function updateUploadProgress(notification, progress) {
            const progressBar = notification.querySelector('.upload-progress-bar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }

        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });

        // Add status styles
        const statusStyles = document.createElement('style');
        statusStyles.textContent = `
            .status-pending { background-color: var(--warning-color); color: white; }
            .status-confirmed { background-color: var(--success-color); color: white; }
            .status-completed { background-color: var(--info-color); color: white; }
            .status-negotiating { background-color: var(--color-primary); color: white; }
        `;
        document.head.appendChild(statusStyles);

/*  NEW – injects the correct action strip depending on state  */
function insertAgreementStrip(){
  const chatInputBar = document.querySelector('.chat-input-bar');
  if(!chatInputBar) return;

  /*  remove any previous strip  */
  document.querySelectorAll('.agreement-strip, .download-strip').forEach(el=>el.remove());

  const strip = document.createElement('div');
  strip.className = 'agreement-strip';
  strip.id        = 'agreementStrip';
  chatInputBar.parentNode.insertBefore(strip, chatInputBar);
}

/*  Enhanced bilateral agreement listener  */
function setupAgreementListener(sessionId) {
    db.collection('bookings').doc(sessionId).onSnapshot(async (snap) => {
        if (!snap.exists) {
            hideAgreementStrips();
            return;
        }

        const booking = snap.data();
        const isStudent = currentUserData.role === 'member';
        const isInstructor = currentUserData.role === 'instructor';

        const instructorSigned = booking.instructorSignedAt;
        const studentSigned = booking.studentSignedAt;

        // Remove existing strips
        hideAgreementStrips();

        // Both parties signed - show download and payment options
        if (instructorSigned && studentSigned) {
            if (isStudent && !booking.paymentCompleted) {
                showPaymentStrip(booking);
            } else if (booking.paymentCompleted) {
                showDownloadStrip(booking);
                // Enable instructor features after payment
                if (isInstructor) {
                    showInstructorDashboard(booking);
                }
                // Show instructor dashboard buttons in chat
                if (isInstructor && booking.paymentCompleted) {
                    showInstructorButtons();
                }
                // Check if session is over for student review
                checkSessionCompletion(booking);
            }
            return;
        }

        // Instructor needs to sign first
        if (!instructorSigned && isInstructor) {
            showInstructorSignStrip();
            return;
        }

        // Student waiting for instructor
        if (!instructorSigned && isStudent) {
            showWaitingForInstructorStrip();
            return;
        }

        // Instructor signed, student needs to review and sign
        if (instructorSigned && !studentSigned && isStudent) {
            showStudentReviewStrip(booking);
            return;
        }

        // Instructor waiting for student
        if (instructorSigned && !studentSigned && isInstructor) {
            showWaitingForStudentStrip();
            return;
        }
    });
}

// Show instructor sign modal
function showInstructorSignStrip() {
    const strip = createAgreementStrip();
    if (!strip) return;
    strip.innerHTML = `
        <div class="agreement-content">
            <i class="fas fa-file-signature"></i>
            <span>Ready to create the mentorship agreement</span>
        </div>
        <button class="btn btn-primary" onclick="openInstructorSignModal()">
            <i class="fas fa-pen"></i> Create Agreement
        </button>
    `;
}

// Open instructor signing modal
function openInstructorSignModal() {
    const modal = document.getElementById('instructorSignModal');
    modal.classList.add('active');
    
    // Set up real-time total calculation
    const durationInput = document.getElementById('sessionDuration');
    const rateInput = document.getElementById('sessionRate');
    const totalDisplay = document.getElementById('totalAmount');
    
    function updateTotal() {
        const duration = parseInt(durationInput.value) || 1;
        const rate = parseInt(rateInput.value) || 5000;
        const total = duration * rate;
        totalDisplay.textContent = `₦${total.toLocaleString()}`;
    }
    
    durationInput.addEventListener('input', updateTotal);
    rateInput.addEventListener('input', updateTotal);
    updateTotal();
}

// Close instructor signing modal
function closeInstructorSignModal() {
    const modal = document.getElementById('instructorSignModal');
    modal.classList.remove('active');
}

// Show waiting for instructor strip
function showWaitingForInstructorStrip() {
    const strip = createAgreementStrip();
    if (!strip) return;
    strip.innerHTML = `
        <div class="agreement-content">
            <i class="fas fa-clock"></i>
            <span>Waiting for instructor to sign the agreement...</span>
        </div>
        <div class="loading-dots">
            <span></span><span></span><span></span>
        </div>
    `;
}

// Show student review strip
function showStudentReviewStrip(booking) {
    const strip = createAgreementStrip();
    if (!strip) return;
    strip.innerHTML = `
        <div class="agreement-content">
            <i class="fas fa-file-contract"></i>
            <span>Instructor has signed the agreement - Review required</span>
        </div>
        <button class="btn btn-primary" onclick="openStudentReviewModal()">
            <i class="fas fa-eye"></i> Review Agreement
        </button>
    `;
}

// Open student review modal
function openStudentReviewModal() {
    const modal = document.getElementById('studentReviewModal');
    modal.classList.add('active');
    
    // Load booking data into modal
    if (window.currentChatSession) {
        db.collection('bookings').doc(window.currentChatSession).get().then(snap => {
            if (snap.exists) {
                const booking = snap.data();
                
                // Get instructor name from users collection if not in booking
                let instructorName = booking.instructorName || 'Loading...';
                if (!booking.instructorName && booking.instructorId) {
                    db.collection('users').doc(booking.instructorId).get().then(userSnap => {
                        if (userSnap.exists) {
                            const userData = userSnap.data();
                            instructorName = userData.displayName || userData.name || userData.email?.split('@')[0] || 'Unknown';
                            document.getElementById('reviewInstructorName').textContent = instructorName;
                        }
                    });
                }
                
                // Populate agreement summary
                document.getElementById('reviewInstructorName').textContent = instructorName;
                document.getElementById('reviewStudentName').textContent = booking.studentName || 'Unknown';
                document.getElementById('reviewDuration').textContent = `${booking.hours} hour(s)`;
                document.getElementById('reviewRate').textContent = `₦${booking.rate?.toLocaleString()}/hour`;
                document.getElementById('reviewTotal').textContent = `₦${booking.total?.toLocaleString()}`;
                document.getElementById('reviewDate').textContent = booking.sessionDate?.toDate?.().toDateString() || 'To be determined';
                document.getElementById('reviewObjectives').textContent = booking.objectives || 'As discussed in chat';
            }
        }).catch(error => {
            console.error('Error loading booking data:', error);
        });
    }
}

// Close student review modal
function closeStudentReviewModal() {
    const modal = document.getElementById('studentReviewModal');
    modal.classList.remove('active');
}

// Show waiting for student strip
function showWaitingForStudentStrip() {
    const strip = createAgreementStrip();
    if (!strip) return;
    strip.innerHTML = `
        <div class="agreement-content">
            <i class="fas fa-hourglass-half"></i>
            <span>Waiting for student to review and sign the agreement...</span>
        </div>
        <div class="loading-dots">
            <span></span><span></span><span></span>
        </div>
    `;
}

/*  ----------  Enhanced bilateral agreement actions  ----------  */
// Confirm instructor signing from modal
async function confirmInstructorSign(){
  try {
    const hours = parseInt(document.getElementById('sessionDuration').value);
    const rate = parseInt(document.getElementById('sessionRate').value);
    const objectives = document.getElementById('sessionObjectives').value.trim();
    
    if (!hours || hours < 1) {
      showNotification('Please enter a valid duration', 'error');
      return;
    }
    
    if (!rate || rate < 1000) {
      showNotification('Please enter a valid rate', 'error');
      return;
    }

    const total = rate * hours;

    await db.collection('bookings').doc(window.currentChatSession).update({
      instructorSignedAt: firebase.firestore.FieldValue.serverTimestamp(),
      hours: hours,
      rate: rate,
      total: total,
      objectives: objectives || 'As discussed in chat',
      status: 'pending_student_signature'
    });

    closeInstructorSignModal();
    showNotification('Agreement signed successfully! Waiting for student to review and sign.', 'success');
  } catch (error) {
    console.error('Error signing agreement:', error);
    showNotification('Error signing agreement', 'error');
  }
}

// Confirm student signing from modal
async function confirmStudentSign(){
  try {
    await db.collection('bookings').doc(window.currentChatSession).update({
      studentSignedAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'confirmed'
    });

    closeStudentReviewModal();
    showNotification('Agreement signed successfully! Both parties have now signed the agreement.', 'success');
  } catch (error) {
    console.error('Error signing agreement:', error);
    showNotification('Error signing agreement', 'error');
  }
}

// Request renegotiation from modal
async function requestRenegotiation(){
  try {
    await db.collection('bookings').doc(window.currentChatSession).update({
      status: 'negotiating',
      instructorSignedAt: null,
      studentSignedAt: null,
      renegotiationRequested: firebase.firestore.FieldValue.serverTimestamp(),
      renegotiationRequestedBy: currentUserData.id
    });

    closeStudentReviewModal();
    showNotification('Agreement sent back for renegotiation', 'info');
  } catch (error) {
    console.error('Error requesting renegotiation:', error);
    showNotification('Error requesting renegotiation', 'error');
  }
}

/*  ----------  payment and download  ----------  */
function showPaymentStrip(booking) {
    // Add payment button directly to chat messages area
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    // Check if payment message already exists
    if (document.querySelector('.payment-message')) return;
    
    const paymentMessage = document.createElement('div');
    paymentMessage.className = 'message system-message payment-message';
    paymentMessage.innerHTML = `
        <div class="message-content">
            <div class="payment-card">
                <div class="payment-header">
                    <i class="fas fa-credit-card"></i>
                    <h4>Complete Payment</h4>
                </div>
                <div class="payment-details">
                    <p>Agreement signed by both parties. Complete payment to start your session.</p>
                    <div class="payment-amount">₦${booking.total?.toLocaleString()}</div>
                </div>
                <button class="btn btn-primary payment-btn" onclick="processPayment()">
                    <i class="fas fa-credit-card"></i> Pay Now
                </button>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(paymentMessage);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showDownloadStrip(B){
  const existing = document.querySelector('.download-strip');
  if(existing) return;

  const strip = document.createElement('div');
  strip.className = 'download-strip agreement-strip';
  strip.innerHTML=`
    <div class="agreement-content">
        <i class="fas fa-check-circle text-success"></i>
        <span>Agreement completed! Download your copy</span>
    </div>
    <button class="btn btn-success" onclick="downloadAgreement()">
      <i class="fas fa-download"></i> Download Agreement
    </button>`;
  
  // Insert at the top of chat messages instead of bottom
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) {
      chatMessages.insertBefore(strip, chatMessages.firstChild);
  }
}

function processPayment() {
    if (!window.currentChatSession) return;
    
    db.collection('bookings').doc(window.currentChatSession).get().then(snap => {
        if (!snap.exists) return;
        
        const booking = snap.data();
        const amount = booking.total * 100; // Convert to kobo for Paystack
        
        // Validate required fields before payment
        if (!currentUserData.email || !booking.total || booking.total <= 0) {
            showNotification('Payment error: Missing required information', 'error');
            return;
        }

        const handler = PaystackPop.setup({
            key: PAYSTACK_PUBLIC_KEY,
            email: currentUserData.email,
            amount: amount,
            currency: 'NGN',
            ref: `session_${window.currentChatSession}_${Date.now()}`,
            channels: ['card', 'bank', 'ussd', 'qr', 'mobile_money', 'bank_transfer'],
            metadata: {
                sessionId: window.currentChatSession,
                instructorId: booking.instructorId,
                studentId: booking.studentId,
                custom_fields: [
                    {
                        display_name: "Session Type",
                        variable_name: "session_type",
                        value: "Mentorship Session"
                    }
                ]
            },
            callback: function(response) {
                // Payment successful
                showNotification('Payment successful! Verifying...', 'success');
                
                // Update booking with payment info
                db.collection('bookings').doc(window.currentChatSession).update({
                    paymentCompleted: true,
                    paymentCompletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    paymentReference: response.reference,
                    status: 'confirmed'
                }).then(() => {
                    showNotification('Payment verified! Session confirmed.', 'success');
                    // Remove payment message and enable features
                    document.querySelector('.payment-message')?.remove();
                    // Enable instructor dashboard
                    enableInstructorFeatures();
                }).catch(error => {
                    console.error('Error updating payment status:', error);
                    showNotification('Payment verification failed', 'error');
                });
            },
            onClose: function() {
                showNotification('Payment cancelled', 'info');
            }
        });
        
        try {
            handler.openIframe();
        } catch (error) {
            console.error('Paystack error:', error);
            showNotification('Payment system error. Please try again.', 'error');
        }
    });
}

async function downloadAgreement(){
  if (!window.currentChatSession) return;
  
  try {
    const bookingSnap = await db.collection('bookings').doc(window.currentChatSession).get();
    if (!bookingSnap.exists) return;

    const booking = bookingSnap.data();
    
    // Get instructor name if not already in booking
    if (!booking.instructorName && booking.instructorId) {
      const instructorSnap = await db.collection('users').doc(booking.instructorId).get();
      if (instructorSnap.exists) {
        const instructorData = instructorSnap.data();
        booking.instructorName = instructorData.displayName || instructorData.name || instructorData.email?.split('@')[0] || 'Unknown Instructor';
      }
    }
    
    // Get student name if not already in booking
    if (!booking.studentName && booking.studentId) {
      const studentSnap = await db.collection('users').doc(booking.studentId).get();
      if (studentSnap.exists) {
        const studentData = studentSnap.data();
        booking.studentName = studentData.displayName || studentData.name || studentData.email?.split('@')[0] || 'Unknown Student';
      }
    }
    
    generateAgreementImage(booking);
  } catch (error) {
    console.error('Error downloading agreement:', error);
    showNotification('Error downloading agreement', 'error');
  }
}

// Generate tamper-proof agreement image with watermarks
// Enable instructor features after payment
function enableInstructorFeatures() {
    if (currentUserData.role !== 'instructor') return;
    
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    // Check if instructor dashboard already exists
    if (document.querySelector('.instructor-dashboard-message')) return;
    
    const dashboardMessage = document.createElement('div');
    dashboardMessage.className = 'message system-message instructor-dashboard-message';
    dashboardMessage.innerHTML = `
        <div class="message-content">
            <div class="instructor-dashboard">
                <div class="dashboard-header">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h4>Instructor Dashboard</h4>
                    <p>Payment confirmed! You now have access to exclusive teaching tools.</p>
                </div>
                <div class="feature-grid">
                    <div class="feature-card" onclick="createExclusiveCourse()">
                        <i class="fas fa-graduation-cap"></i>
                        <h5>Create Course</h5>
                        <p>Build exclusive course for this student</p>
                    </div>
                    <div class="feature-card" onclick="createLivestream()">
                        <i class="fas fa-video"></i>
                        <h5>Start Livestream</h5>
                        <p>Begin live session at scheduled time</p>
                    </div>
                    <div class="feature-card" onclick="createQuiz()">
                        <i class="fas fa-clipboard-question"></i>
                        <h5>Create Quiz</h5>
                        <p>Build assessment for student</p>
                    </div>
                    <div class="feature-card" onclick="uploadResources()">
                        <i class="fas fa-upload"></i>
                        <h5>Upload Resources</h5>
                        <p>Share materials and documents</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(dashboardMessage);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show instructor dashboard after payment
function showInstructorDashboard(booking) {
    enableInstructorFeatures();
}

// Check if session is complete for student review
function checkSessionCompletion(booking) {
    if (currentUserData.role !== 'member') return;
    
    const sessionDate = booking.sessionDate?.toDate();
    const sessionDuration = booking.hours || 1;
    
    if (!sessionDate) return;
    
    const sessionEndTime = new Date(sessionDate.getTime() + (sessionDuration * 60 * 60 * 1000));
    const now = new Date();
    
    // If session has ended and no review submitted yet
    if (now > sessionEndTime && !booking.reviewSubmitted) {
        setTimeout(() => {
            showStudentReviewModal();
        }, 5000); // Show review modal 5 seconds after session ends
    }
}

// Create exclusive course for student
function createExclusiveCourse() {
    if (!window.currentChatSession) return;
    
    // Open new all-in-one instructor dashboard
    const dashboardUrl = `mentorship-instructor.html?sessionId=${window.currentChatSession}`;
    window.open(dashboardUrl, '_blank');
    
    showNotification('Opening instructor dashboard...', 'info');
}

// Create livestream for session
function createLivestream() {
    if (!window.currentChatSession) return;
    
    // Open instructor dashboard on livestream tab
    const dashboardUrl = `mentorship-instructor.html?sessionId=${window.currentChatSession}#livestream`;
    window.open(dashboardUrl, '_blank');
    
    showNotification('Opening livestream dashboard...', 'info');
}

// Create quiz for student
function createQuiz() {
    if (!window.currentChatSession) return;
    
    // Open instructor dashboard on quiz tab
    const dashboardUrl = `mentorship-instructor.html?sessionId=${window.currentChatSession}#quiz`;
    window.open(dashboardUrl, '_blank');
    
    showNotification('Opening quiz creator...', 'info');
}

// Upload resources for student
function uploadResources() {
    if (!window.currentChatSession) return;
    
    // Open instructor dashboard on resources tab
    const dashboardUrl = `mentorship-instructor.html?sessionId=${window.currentChatSession}#resources`;
    window.open(dashboardUrl, '_blank');
    
    showNotification('Opening resource manager...', 'info');
}

// Show student review modal after session
function showStudentReviewModal() {
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.id = 'studentReviewModal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Session Complete - Share Your Experience</h3>
                <button class="modal-close" onclick="closeReviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <div class="form-group">
                        <label>Rate your instructor (1-5 stars)</label>
                        <div class="star-rating">
                            <span class="star" data-rating="1">☆</span>
                            <span class="star" data-rating="2">☆</span>
                            <span class="star" data-rating="3">☆</span>
                            <span class="star" data-rating="4">☆</span>
                            <span class="star" data-rating="5">☆</span>
                        </div>
                        <input type="hidden" id="rating" name="rating" required>
                    </div>
                    <div class="form-group">
                        <label for="testimonial">Write a testimonial</label>
                        <textarea id="testimonial" name="testimonial" rows="4" 
                                placeholder="Share your experience with this instructor..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="publicTestimonial" name="public"> 
                            Make this testimonial public on instructor's profile
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeReviewModal()" class="btn btn-secondary">Skip</button>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add star rating functionality
    const stars = modal.querySelectorAll('.star');
    const ratingInput = modal.querySelector('#rating');
    
    stars.forEach(star => {
        star.addEventListener('click', () => {
            const rating = star.dataset.rating;
            ratingInput.value = rating;
            
            stars.forEach((s, index) => {
                s.textContent = index < rating ? '★' : '☆';
                s.style.color = index < rating ? '#ffd700' : '#ccc';
            });
        });
    });
    
    // Handle form submission
    modal.querySelector('#reviewForm').addEventListener('submit', submitReview);
}

// Submit student review
async function submitReview(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const rating = parseInt(formData.get('rating'));
    const testimonial = formData.get('testimonial');
    const isPublic = formData.get('public') === 'on';
    
    if (!rating || !testimonial) {
        showNotification('Please provide both rating and testimonial', 'error');
        return;
    }
    
    try {
        const booking = await db.collection('bookings').doc(window.currentChatSession).get();
        const bookingData = booking.data();
        
        // Submit testimonial to admin for review
        await db.collection('testimonials').add({
            sessionId: window.currentChatSession,
            instructorId: bookingData.instructorId,
            instructorName: bookingData.instructorName,
            studentId: currentUserData.uid,
            studentName: currentUserData.displayName || currentUserData.email,
            rating: rating,
            content: testimonial,
            isPublic: isPublic,
            status: 'pending', // Admin will review
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Mark review as submitted in booking
        await db.collection('bookings').doc(window.currentChatSession).update({
            reviewSubmitted: true,
            reviewSubmittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Thank you! Your review has been submitted for approval.', 'success');
        closeReviewModal();
        
    } catch (error) {
        console.error('Error submitting review:', error);
        showNotification('Error submitting review. Please try again.', 'error');
    }
}

// Show instructor dashboard buttons in chat
function showInstructorButtons() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    // Check if buttons already exist
    if (document.querySelector('.instructor-buttons-message')) return;
    
    const buttonsMessage = document.createElement('div');
    buttonsMessage.className = 'message system-message instructor-buttons-message';
    buttonsMessage.innerHTML = `
        <div class="message-content">
            <div style="text-align: center; padding: 1rem;">
                <h4 style="margin-bottom: 1rem; color: var(--color-primary);">
                    <i class="fas fa-chalkboard-teacher"></i> Instructor Tools
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    <button onclick="createExclusiveCourse()" class="btn" style="background: var(--color-primary); color: white; padding: 0.5rem; font-size: 0.9rem;">
                        <i class="fas fa-graduation-cap"></i><br>Course
                    </button>
                    <button onclick="createLivestream()" class="btn" style="background: var(--success-color); color: white; padding: 0.5rem; font-size: 0.9rem;">
                        <i class="fas fa-video"></i><br>Live
                    </button>
                    <button onclick="createQuiz()" class="btn" style="background: var(--info-color); color: white; padding: 0.5rem; font-size: 0.9rem;">
                        <i class="fas fa-clipboard-question"></i><br>Quiz
                    </button>
                    <button onclick="uploadResources()" class="btn" style="background: var(--warning-color); color: white; padding: 0.5rem; font-size: 0.9rem;">
                        <i class="fas fa-upload"></i><br>Files
                    </button>
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(buttonsMessage);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Close review modal
function closeReviewModal() {
    const modal = document.getElementById('studentReviewModal');
    if (modal) {
        modal.remove();
    }
}

function generateAgreementImage(booking) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // Set canvas size for A4-like proportions
  canvas.width = 800;
  canvas.height = 1200;
  
  // Background with subtle pattern
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Add watermark background pattern
  ctx.save();
  ctx.globalAlpha = 0.05;
  ctx.fillStyle = '#d97706';
  ctx.font = 'bold 60px Arial';
  ctx.textAlign = 'center';
  
  // Diagonal watermarks across the document
  for (let i = 0; i < 8; i++) {
    for (let j = 0; j < 6; j++) {
      ctx.save();
      ctx.translate(i * 150, j * 200);
      ctx.rotate(-Math.PI / 6);
      ctx.fillText('ANDREW CARES', 0, 0);
      ctx.fillText('VILLAGE HUB', 0, 70);
      ctx.restore();
    }
  }
  ctx.restore();
  
  // Header with logo area
  ctx.fillStyle = 'linear-gradient(135deg, #b45309 0%, #d97706 100%)';
  const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
  gradient.addColorStop(0, '#b45309');
  gradient.addColorStop(1, '#d97706');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, canvas.width, 120);
  
  // Header text
  ctx.fillStyle = '#ffffff';
  ctx.font = 'bold 36px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('MENTORSHIP AGREEMENT', canvas.width / 2, 50);
  ctx.font = '18px Arial';
  ctx.fillText('Andrew Cares Village Hub - Official Document', canvas.width / 2, 85);
  
  // Document content
  let y = 170;
  const leftMargin = 60;
  const rightMargin = canvas.width - 60;
  
  // Helper function to add text
  function addText(text, fontSize = 16, color = '#333333', bold = false, center = false) {
    ctx.fillStyle = color;
    ctx.font = `${bold ? 'bold ' : ''}${fontSize}px Arial`;
    ctx.textAlign = center ? 'center' : 'left';
    
    if (center) {
      ctx.fillText(text, canvas.width / 2, y);
    } else {
      // Handle text wrapping
      const words = text.split(' ');
      let line = '';
      const maxWidth = rightMargin - leftMargin - 20;
      
      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, leftMargin, y);
          line = words[n] + ' ';
          y += fontSize + 8;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, leftMargin, y);
    }
    y += fontSize + 12;
  }
  
  // Document ID and timestamp
  addText(`Document ID: ${window.currentChatSession}`, 12, '#666666');
  addText(`Generated: ${new Date().toLocaleString()}`, 12, '#666666');
  y += 20;
  
  // Agreement details
  addText('PARTIES TO THE AGREEMENT', 20, '#b45309', true);
  y += 10;
  addText(`Student: ${booking.studentName}`, 16, '#333333', true);
  addText(`Student ID: ${booking.studentId}`, 14, '#666666');
  y += 10;
  addText(`Instructor: ${booking.instructorName}`, 16, '#333333', true);
  addText(`Instructor ID: ${booking.instructorId}`, 14, '#666666');
  y += 30;
  
  addText('SESSION DETAILS', 20, '#b45309', true);
  y += 10;
  addText(`Session Date: ${booking.sessionDate?.toDate?.().toDateString() || 'To be determined'}`, 16);
  addText(`Duration: ${booking.hours} hour(s)`, 16);
  addText(`Hourly Rate: ₦${booking.rate?.toLocaleString()}`, 16);
  addText(`Total Amount: ₦${booking.total?.toLocaleString()}`, 18, '#059669', true);
  addText(`Subject: ${booking.subject || 'As discussed'}`, 16);
  y += 20;
  
  addText('SESSION OBJECTIVES', 20, '#b45309', true);
  y += 10;
  addText(booking.objectives || 'As discussed in chat', 16);
  y += 30;
  
  addText('DIGITAL SIGNATURES', 20, '#b45309', true);
  y += 10;
  addText(`Instructor Signed: ${booking.instructorSignedAt?.toDate?.().toLocaleString() || 'Not signed'}`, 16, '#059669', true);
  addText(`Student Signed: ${booking.studentSignedAt?.toDate?.().toLocaleString() || 'Not signed'}`, 16, '#059669', true);
  y += 30;
  
  addText('TERMS AND CONDITIONS', 20, '#b45309', true);
  y += 10;
  addText('1. Both parties agree to the terms specified above', 14);
  addText('2. Payment must be made before the start of the mentorship session', 14);
  addText('3. Either party may reschedule with 24 hours notice', 14);
  addText('4. This agreement is legally binding upon digital signature by both parties', 14);
  y += 30;
  
  // Security features
  addText('DOCUMENT SECURITY FEATURES', 16, '#b45309', true);
  y += 10;
  addText('• This document contains embedded watermarks for authenticity verification', 12, '#666666');
  addText('• Any modification to this document will be detectable', 12, '#666666');
  addText('• Original document hash: ' + generateDocumentHash(booking), 12, '#666666');
  y += 20;
  
  // Footer with timestamp and verification
  ctx.fillStyle = '#f8f9fa';
  ctx.fillRect(0, canvas.height - 80, canvas.width, 80);
  
  ctx.fillStyle = '#666666';
  ctx.font = '12px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('This is an official document from Andrew Cares Village Hub', canvas.width / 2, canvas.height - 50);
  ctx.fillText('Verify authenticity at: andrewcaresvillage.com/verify', canvas.width / 2, canvas.height - 30);
  ctx.fillText(`Document generated on ${new Date().toLocaleString()}`, canvas.width / 2, canvas.height - 10);
  
  // Convert to image and download
  canvas.toBlob(function(blob) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Mentorship_Agreement_${window.currentChatSession}_${new Date().getTime()}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Secure agreement image downloaded successfully', 'success');
  }, 'image/png', 0.95);
}

// Generate a simple hash for document verification
function generateDocumentHash(booking) {
  const dataString = `${booking.studentId}${booking.instructorId}${booking.hours}${booking.rate}${booking.total}${booking.instructorSignedAt}${booking.studentSignedAt}`;
  let hash = 0;
  for (let i = 0; i < dataString.length; i++) {
    const char = dataString.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return Math.abs(hash).toString(16).toUpperCase().substring(0, 8);
}

function hideAgreementStrips(){
  document.querySelectorAll('.agreement-strip, .download-strip, .payment-strip').forEach(el=>el.remove());
}

// Create agreement strip helper function
function createAgreementStrip(additionalClass = '') {
  const chatInputBar = document.querySelector('.chat-input-bar');
  if (!chatInputBar) return null;

  const strip = document.createElement('div');
  strip.className = `agreement-strip ${additionalClass}`.trim();
  strip.id = 'agreementStrip';
  
  chatInputBar.parentNode.insertBefore(strip, chatInputBar);
  return strip;
}
    </script>
          <!-- AI Chat Widget Integration -->
    <script src="js/chat-integration.js"></script>
        <!-- Hybrid AI Chat Widget -->
        <script src="js/advanced-hybrid-chat.js"></script>
    </body>
</html>
