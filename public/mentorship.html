<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-on-1 Mentorship - Andrew Cares Village</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    
    <style>
        :root {
            --background-color: #F4F2ED;
            --text-primary: #333333;
            --text-secondary: #555555;
            --color-primary: #B38B00;
            --color-secondary: #001F3F;
            --card-bg: #FFFFFF;
            --border-color: #EAEAEA;
            --hover-bg: #F9F9F9;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --chat-bg: #f8f9fa;
            --message-sent: #007bff;
            --message-received: #e9ecef;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .hidden { display: none !important; }

        /* Header */
        .main-header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        /* Main Layout - CORRECTED: Main content left, sidebar right */
        .mentorship-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 8rem);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-sidebar {
            width: 280px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        /* Dashboard Headers */
        .dashboard-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .dashboard-header h1 {
            font-family: 'Cinzel', serif;
            margin: 0;
            font-size: 2.5rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background-color: var(--color-primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards and Grids */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--color-secondary);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: #9c7a00; }
        .btn-secondary { background-color: var(--text-secondary); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(179, 139, 0, 0.2);
        }

        /* Chat Sidebar */
        .sidebar-chat-header {
            background-color: var(--color-primary);
            color: white;
            padding: 1rem;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }

        .active-conversations {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .conversation-item:hover {
            background-color: var(--hover-bg);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .mentorship-container {
                flex-direction: column;
                height: auto;
            }
            
            .main-content {
                width: 100%;
                height: auto;
                min-height: 70vh;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 30vh;
                min-height: 250px;
                order: 2;
            }
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .tab-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Header -->
    <header class="main-header">
        <a href="home.html" style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--color-secondary); text-decoration: none;">
            Andrew Cares Village
        </a>
    </header>

    <!-- Main Container -->
    <div class="mentorship-container">
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Member View -->
            <div id="memberView" class="hidden">
                <div class="dashboard-header">
                    <h1><i class="fas fa-graduation-cap"></i> Mentorship Portal</h1>
                    <p>Connect with expert mentors for personalized guidance</p>
                </div>
                
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('browse')">
                        <i class="fas fa-search"></i> Browse Mentors
                    </button>
                    <button class="tab-btn" onclick="switchTab('my-sessions')">
                        <i class="fas fa-calendar-alt"></i> My Sessions
                    </button>
                </div>

                <div id="browse-tab" class="tab-content active">
                    <div class="grid-2">
                        <div class="card">
                            <h2 class="section-title">Available Mentors</h2>
                            <div id="memberInstructorList">
                                <p>Loading mentors...</p>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="section-title" id="memberBookingTitle">Select a Mentor to Begin</h2>
                            <div id="memberCalendar"></div>
                        </div>
                    </div>
                </div>

                <div id="my-sessions-tab" class="tab-content">
                    <div class="card">
                        <h2 class="section-title">My Mentorship Sessions</h2>
                        <div id="memberSessionsList">
                            <p>You have no sessions yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructor View -->
            <div id="instructorView" class="hidden">
                <div class="dashboard-header">
                    <h1><i class="fas fa-chalkboard-teacher"></i> Mentor Dashboard</h1>
                    <p>Manage your mentorship sessions and availability</p>
                </div>
                
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('availability')">
                        <i class="fas fa-clock"></i> Set Availability
                    </button>
                    <button class="tab-btn" onclick="switchTab('bookings')">
                        <i class="fas fa-calendar-check"></i> Bookings
                    </button>
                    <button class="tab-btn" onclick="switchTab('completed')">
                        <i class="fas fa-trophy"></i> Completed
                    </button>
                </div>

                <div id="availability-tab" class="tab-content active">
                    <div class="card">
                        <h2 class="section-title">Set Your Availability</h2>
                        <div class="form-group">
                            <label for="availabilityDate">Select Date:</label>
                            <input type="date" id="availabilityDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="hourlyRate">Hourly Rate (‚Ç¶):</label>
                            <input type="number" id="hourlyRate" class="form-control" placeholder="e.g., 5000" min="1000">
                            <small>Minimum rate: ‚Ç¶1,000 per hour</small>
                        </div>
                        <button class="btn btn-primary" onclick="saveAvailability()">
                            <i class="fas fa-save"></i> Save Availability
                        </button>
                    </div>
                </div>

                <div id="bookings-tab" class="tab-content">
                    <div class="card">
                        <h2 class="section-title">Pending & Confirmed Bookings</h2>
                        <div id="instructorBookingsList">
                            <p>No bookings yet.</p>
                        </div>
                    </div>
                </div>

                <div id="completed-tab" class="tab-content">
                    <div class="card">
                        <h2 class="section-title">Completed Sessions</h2>
                        <div id="completedSessionsList">
                            <p>No completed sessions yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="hidden">
                <div class="dashboard-header">
                    <h1><i class="fas fa-chart-line"></i> Admin Dashboard</h1>
                    <p>Monitor platform performance and commission earnings</p>
                </div>
                
                <div class="card">
                    <h2 class="section-title">Platform Statistics</h2>
                    <div id="adminStats">
                        <p>Loading statistics...</p>
                    </div>
                </div>
            </div>

            <!-- Access Denied View -->
            <div id="accessDeniedView" class="hidden">
                <div class="card" style="text-align: center; padding: 4rem 2rem;">
                    <i class="fas fa-lock" style="font-size: 4rem; color: var(--warning-color); margin-bottom: 1rem;"></i>
                    <h2>Access Restricted</h2>
                    <p>This mentorship platform is available to registered members, instructors, and admins only.</p>
                    <a href="contact.html" class="btn btn-primary">
                        <i class="fas fa-envelope"></i> Contact Support
                    </a>
                </div>
            </div>
        </div>

        <!-- Chat Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-chat-header">
                <h3><i class="fas fa-comments"></i> Active Chats</h3>
            </div>
            <div class="active-conversations" id="sidebarConversations">
                <div class="conversation-item">
                    <img src="https://ui-avatars.com/api/?name=No+Chat&background=ddd&color=999&size=40" alt="Avatar" class="conversation-avatar">
                    <div>
                        <p style="margin: 0; font-weight: 600;">No active chats</p>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary);">Start a session to begin chatting</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
            authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
            projectId: "andrew-cares-village-f4cb6",
            storageBucket: "andrew-cares-village-f4cb6.firebasestorage.app",
            messagingSenderId: "255087116955",
            appId: "1:255087116955:web:84360ee1f13888f9b83c3e"
        };

        // Initialize Firebase with comprehensive error handling
        let auth, db;
        let firebaseInitialized = false;
        
        try {
            // Check if Firebase is available
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            // Initialize Firebase app
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            auth = firebase.auth();
            db = firebase.firestore();
            
            // Configure Firestore settings BEFORE any other operations
            try {
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                    ignoreUndefinedProperties: true
                });
            } catch (settingsError) {
                console.warn('‚ö†Ô∏è Firestore settings already configured:', settingsError.message);
            }
            
            // Test Firebase connection immediately
            db.collection('users').limit(1).get().then(() => {
                console.log('‚úÖ Firebase connected successfully');
                firebaseInitialized = true;
            }).catch(error => {
                console.warn('‚ö†Ô∏è Firebase connection test failed:', error);
                firebaseInitialized = false;
            });
            
            // Enable offline persistence with error handling (optional)
            db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                console.log('‚ÑπÔ∏è Persistence not enabled:', err.code);
            });

            
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
            
            // Create mock Firebase objects for offline development
            auth = {
                onAuthStateChanged: (callback) => {
                    console.log('üîß Using mock auth - redirecting to login');
                    setTimeout(() => callback(null), 1000);
                },
                signOut: () => Promise.resolve()
            };
            
            // Create proper mock snapshot objects
            const createMockSnapshot = (docs = []) => ({
                empty: docs.length === 0,
                docs: docs,
                forEach: (callback) => docs.forEach(callback),
                size: docs.length
            });

            db = {
                collection: () => ({
                    where: (field, operator, value) => ({
                        get: () => Promise.resolve(createMockSnapshot([])),
                        onSnapshot: (callback) => callback(createMockSnapshot([])),
                        where: (field2, operator2, value2) => ({
                            get: () => Promise.resolve(createMockSnapshot([])),
                            onSnapshot: (callback) => callback(createMockSnapshot([])),
                            orderBy: () => ({
                                get: () => Promise.resolve(createMockSnapshot([])),
                                onSnapshot: (callback) => callback(createMockSnapshot([]))
                            })
                        }),
                        orderBy: () => ({
                            get: () => Promise.resolve(createMockSnapshot([])),
                            onSnapshot: (callback) => callback(createMockSnapshot([]))
                        })
                    }),
                    get: () => Promise.resolve(createMockSnapshot([])),
                    onSnapshot: (callback) => callback(createMockSnapshot([])),
                    add: () => Promise.resolve({ id: 'mock-id' }),
                    doc: () => ({
                        get: () => Promise.resolve({ exists: false, data: () => null }),
                        set: () => Promise.resolve(),
                        update: () => Promise.resolve(),
                        delete: () => Promise.resolve()
                    }),
                    orderBy: () => ({
                        get: () => Promise.resolve(createMockSnapshot([])),
                        onSnapshot: (callback) => callback(createMockSnapshot([]))
                    })
                })
            };
            
            firebaseInitialized = false;
        }

        // Global State
        let currentUser = null;
        let currentUserData = null;
        let calendar = null;
        let selectedInstructorId = null;
        let currentChatSession = null;
        const PAYSTACK_PUBLIC_KEY = 'pk_test_4f982216f23d912048d00f1a9c9f77a7b54647bc';

        // Add sample data to Firestore for testing
        async function addSampleData() {
            if (!firebaseInitialized) {
                console.log('‚ö†Ô∏è Firebase not initialized, skipping sample data');
                return;
            }

            try {
                // Add sample mentors
                const sampleMentors = [
                    {
                        name: 'Dr. Sarah Johnson',
                        email: 'sarah.johnson@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Career Development & Leadership',
                        bio: 'Former tech executive with 15+ years experience helping professionals advance their careers. Specializes in leadership development, career transitions, and executive coaching.',
                        hourlyRate: 75,
                        rating: 4.9,
                        totalSessions: 127,
                        profileImage: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face',
                        availability: ['Monday', 'Tuesday', 'Wednesday', 'Thursday'],
                        timeSlots: ['09:00', '10:00', '11:00', '14:00', '15:00'],
                        createdAt: new Date()
                    },
                    {
                        name: 'Prof. Michael Chen',
                        email: 'michael.chen@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Academic Research & PhD Guidance',
                        bio: 'University professor and research supervisor with expertise in data science, machine learning, and academic writing. Published 50+ peer-reviewed papers.',
                        hourlyRate: 60,
                        rating: 4.8,
                        totalSessions: 89,
                        profileImage: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face',
                        availability: ['Tuesday', 'Wednesday', 'Thursday', 'Friday'],
                        timeSlots: ['10:00', '11:00', '13:00', '14:00', '16:00'],
                        createdAt: new Date()
                    },
                    {
                        name: 'Emily Rodriguez',
                        email: 'emily.rodriguez@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Entrepreneurship & Startup Strategy',
                        bio: 'Serial entrepreneur who founded 3 successful startups. Now mentoring the next generation of founders in business strategy, fundraising, and scaling operations.',
                        hourlyRate: 85,
                        rating: 4.7,
                        totalSessions: 156,
                        profileImage: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face',
                        availability: ['Monday', 'Wednesday', 'Friday', 'Saturday'],
                        timeSlots: ['09:00', '10:00', '15:00', '16:00', '17:00'],
                        createdAt: new Date()
                    }
                ];

                // Check if mentors already exist
                const existingMentors = await db.collection('users').where('role', '==', 'instructor').get();
                
                if (existingMentors.empty) {
                    console.log('üìù Adding sample mentors to Firestore...');
                    
                    for (const mentor of sampleMentors) {
                        await db.collection('users').add(mentor);
                    }
                    
                    console.log('‚úÖ Sample mentors added successfully!');
                } else {
                    console.log('‚ÑπÔ∏è Mentors already exist in database');
                }

            } catch (error) {
                console.error('‚ùå Error adding sample data:', error);
            }
        }

        // Authentication State Management - prioritize Firestore connection
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Real authenticated user - prioritize this
                console.log('üë§ Real user authenticated:', user.email);
                currentUser = user;
                
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                        console.log('üìã User data loaded from Firestore');
                    } else {
                        // Create new user document
                        currentUserData = {
                            name: user.displayName || 'New User',
                            email: user.email,
                            role: 'member',
                            createdAt: new Date()
                        };
                        await db.collection('users').doc(user.uid).set(currentUserData);
                        console.log('üìù New user document created');
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    currentUserData = {
                        name: user.displayName || 'User',
                        email: user.email,
                        role: 'member'
                    };
                }
            } else {
                // No authenticated user - create test user for development
                console.log('üîß Development mode - creating test user');
                currentUser = { uid: 'test-user-123', email: 'test@example.com' };
                currentUserData = { 
                    name: 'Test User', 
                    email: 'test@example.com', 
                    role: 'member' // Change to 'instructor' or 'admin' to test different views
                };
            }
            
            // Try to add sample data if Firebase is working
            try {
                if (firebaseInitialized) {
                    await addSampleData();
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è Could not add sample data, continuing with demo data');
            }
            
            initializeView();
        });

        function initializeView() {
            const userRole = currentUserData.role;

            // Hide all views first
            document.getElementById('memberView').classList.add('hidden');
            document.getElementById('instructorView').classList.add('hidden');
            document.getElementById('adminView').classList.add('hidden');
            document.getElementById('accessDeniedView').classList.add('hidden');

            // Show appropriate view
            if (userRole === 'member') {
                document.getElementById('memberView').classList.remove('hidden');
                updateSidebarConversations();
                loadMemberSessions();
                loadAvailableMentors(); // Load mentors when member view is shown
                initializeMemberCalendar(); // Initialize calendar when member view is shown
            } else if (userRole === 'instructor') {
                document.getElementById('instructorView').classList.remove('hidden');
                initializeInstructor();
            } else if (userRole === 'admin') {
                document.getElementById('adminView').classList.remove('hidden');
                initializeAdmin();
            } else {
                document.getElementById('accessDeniedView').classList.remove('hidden');
            }

            updateSidebarConversations();
        }

        // Tab Management
        window.switchTab = function(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
        };

        // Member Functions
        function initializeMember() {
            initializeMemberCalendar();
            loadMentorsForMember();
            loadMemberSessions();
        }

        function initializeMemberCalendar() {
            if (calendar) {
                calendar.destroy();
            }
            
            try {
                const calendarEl = document.getElementById('memberCalendar');
                if (!calendarEl) {
                    console.error('‚ùå Calendar element not found');
                    return;
                }
                
                console.log('üìÖ Initializing member calendar...');
                
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    slotMinTime: '08:00:00',
                    slotMaxTime: '20:00:00',
                    height: 'auto',
                    events: [],
                    eventClick: function(info) {
                        if (info.event.extendedProps.available) {
                            bookSession(info.event.extendedProps.timeSlot, info.event.start);
                        }
                    }
                });
                
                calendar.render();
                console.log('‚úÖ Calendar initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing calendar:', error);
                document.getElementById('memberCalendar').innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Calendar unavailable. Please refresh the page.</p>';
            }
        }

        async function loadMentorsForMember() {
            const instructorList = document.getElementById('memberInstructorList');
            instructorList.innerHTML = '<p>Loading mentors...</p>';
            
            try {
                const snapshot = await db.collection("users").where("role", "==", "instructor").get();
                instructorList.innerHTML = '';
                
                for (const docSnap of snapshot.docs) {
                    const instructor = { id: docSnap.id, ...docSnap.data() };
                    
                    const card = document.createElement('div');
                    card.className = 'instructor-card';
                    card.dataset.instructorId = instructor.id;
                    card.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        padding: 1rem;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 1px solid transparent;
                        margin-bottom: 1rem;
                    `;
                    
                    const avatarUrl = instructor.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(instructor.name)}`;
                    
                    card.innerHTML = `
                        <img src="${avatarUrl}" 
                             alt="${instructor.name}" 
                             style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;"
                             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(instructor.name)}'">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-weight: 600;">${instructor.name}</h4>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
                                ${instructor.expertise?.join(', ') || 'General Mentorship'}
                            </p>
                            <small>From ‚Ç¶${instructor.hourlyRate || 5000}/hour</small>
                        </div>
                    `;
                    
                    card.onclick = () => selectMentorForMember(instructor.id, instructor.name, card);
                    card.onmouseover = () => {
                        card.style.backgroundColor = 'var(--hover-bg)';
                        card.style.transform = 'translateX(5px)';
                    };
                    card.onmouseout = () => {
                        if (!card.classList.contains('active')) {
                            card.style.backgroundColor = '';
                            card.style.transform = '';
                        }
                    };
                    
                    instructorList.appendChild(card);
                }
            } catch (error) {
                console.error('Error loading mentors:', error);
                instructorList.innerHTML = '<p>Error loading mentors. Please refresh the page.</p>';
            }
        }

        async function selectMentorForMember(instructorId, instructorName, cardElement) {
            selectedInstructorId = instructorId;
            
            // Update UI
            document.querySelectorAll('.instructor-card').forEach(c => {
                c.classList.remove('active');
                c.style.backgroundColor = '';
                c.style.borderColor = 'transparent';
                c.style.transform = '';
            });
            cardElement.classList.add('active');
            cardElement.style.backgroundColor = 'var(--hover-bg)';
            cardElement.style.borderColor = 'var(--color-primary)';
            cardElement.style.boxShadow = '0 2px 10px rgba(179, 139, 0, 0.2)';
            
            document.getElementById('memberBookingTitle').textContent = `Booking with ${instructorName}`;

            // Load instructor's available slots
            try {
                console.log('üîç Loading slots for instructor:', instructorId);
                
                // For testing, create mock availability data if Firebase fails
                if (!firebaseInitialized) {
                    console.log('üìÖ Using mock availability data');
                    const mockEvents = [
                        {
                            id: 'mock-1',
                            title: 'Available',
                            start: new Date().toISOString().split('T')[0] + 'T09:00:00',
                            backgroundColor: '#28a745',
                            borderColor: '#28a745',
                            extendedProps: { available: true, timeSlot: '09:00' }
                        },
                        {
                            id: 'mock-2', 
                            title: 'Available',
                            start: new Date().toISOString().split('T')[0] + 'T14:00:00',
                            backgroundColor: '#28a745',
                            borderColor: '#28a745',
                            extendedProps: { available: true, timeSlot: '14:00' }
                        }
                    ];
                    
                    if (calendar) {
                        calendar.removeAllEvents();
                        calendar.addEventSource(mockEvents);
                    }
                    return;
                }
                
                const snapshot = await db.collection("mentorshipSlots")
                    .where("instructorId", "==", instructorId)
                    .get();
                
                let events = [];
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.timeSlots && Array.isArray(data.timeSlots)) {
                        data.timeSlots.forEach(timeSlot => {
                            events.push({
                                id: `${docSnap.id}_${timeSlot.time}`,
                                title: `Available - ‚Ç¶${timeSlot.rate}/hr`,
                                start: `${data.date}T${timeSlot.time}`,
                                end: new Date(new Date(`${data.date}T${timeSlot.time}`).getTime() + 45 * 60000).toISOString(),
                                extendedProps: { 
                                    slotDocId: docSnap.id, 
                                    timeSlot: timeSlot.time, 
                                    instructorName,
                                    hourlyRate: timeSlot.rate
                                }
                            });
                        });
                    }
                });

                // Filter out already booked sessions
                const bookingsSnapshot = await db.collection("bookings")
                    .where("instructorId", "==", instructorId)
                    .get();
                const bookedSlots = new Set(
                    bookingsSnapshot.docs.map(d => `${d.data().slotDocId}_${d.data().timeSlot}`)
                );
                
                const availableEvents = events.filter(event => !bookedSlots.has(event.id));

                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(availableEvents);
                }
            } catch (error) {
                console.error('Error loading mentor availability:', error);
            }
        }

        async function handleMemberEventClick(info) {
            const { slotDocId, timeSlot, instructorName, hourlyRate } = info.event.extendedProps;
            const startTime = info.event.start;

            // Simple booking for now - will add agreement modal later
            if (confirm(`Book session with ${instructorName} at ${startTime.toLocaleString()} for ‚Ç¶${hourlyRate}/hour?`)) {
                try {
                    await db.collection("bookings").add({
                        studentId: currentUser.uid,
                        studentName: currentUserData.name,
                        instructorId: selectedInstructorId,
                        instructorName: instructorName,
                        slotDocId: slotDocId,
                        timeSlot: timeSlot,
                        startTime: firebase.firestore.Timestamp.fromDate(startTime),
                        hourlyRate: hourlyRate,
                        status: 'negotiating',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Booking request sent! The instructor will review and confirm.');
                    
                    // Refresh calendar
                    selectMentorForMember(selectedInstructorId, instructorName, 
                        document.querySelector(`[data-instructor-id="${selectedInstructorId}"]`));
                } catch (error) {
                    console.error('Error creating booking:', error);
                    alert('Failed to create booking. Please try again.');
                }
            }
        }

        function loadMemberSessions() {
            const sessionsList = document.getElementById('memberSessionsList');
            
            if (!currentUser) return;
            
            try {
                let q = db.collection("bookings").where("studentId", "==", currentUser.uid);
                
                // Try to add orderBy if available (real Firebase)
                if (firebaseInitialized && typeof q.orderBy === 'function') {
                    q = q.orderBy("createdAt", "desc");
                }
                
                q.onSnapshot((snapshot) => {
                    sessionsList.innerHTML = snapshot.empty ? '<p>You have no sessions yet.</p>' : '';
                    
                    snapshot.forEach(docSnap => {
                        const session = { id: docSnap.id, ...docSnap.data() };
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'session-card';
                        sessionEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        // Handle mock data vs real Firebase data
                        const sessionDate = session.startTime?.toDate ? session.startTime.toDate() : new Date();
                        const statusClass = `status-${session.status || 'pending'}`;
                        
                        sessionEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${session.instructorName || 'Instructor'}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Rate: ‚Ç¶${session.hourlyRate || 5000}/hour</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="session-status ${statusClass}" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    ${session.status || 'pending'}
                                </span>
                                <button class="btn btn-info btn-sm" onclick="openChat('${session.id}', '${session.instructorId}', '${session.instructorName}')">
                                    <i class="fas fa-comments"></i> Chat
                                </button>
                            </div>
                        `;
                        sessionsList.appendChild(sessionEl);
                    });
                });
            } catch (error) {
                console.error('Error loading member sessions:', error);
                sessionsList.innerHTML = '<p>Error loading sessions. Please refresh the page.</p>';
            }
        }

        // Instructor Functions
        function initializeInstructor() {
            generateTimeSlots();
            loadInstructorBookings();
            loadCompletedSessions();
        }

        function generateTimeSlots() {
            const grid = document.getElementById('timeSlotGrid');
            if (!grid) {
                // Create time slot grid if it doesn't exist
                const availabilityTab = document.getElementById('availability-tab');
                const saveButton = availabilityTab.querySelector('.btn-primary');
                const timeSlotContainer = document.createElement('div');
                timeSlotContainer.innerHTML = `
                    <div class="form-group">
                        <label>Available Time Slots:</label>
                        <div class="availability-grid" id="timeSlotGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <!-- Time slots will be generated here -->
                        </div>
                    </div>
                `;
                saveButton.parentNode.insertBefore(timeSlotContainer, saveButton);
            }
            
            const timeSlotGrid = document.getElementById('timeSlotGrid');
            const timeSlots = [
                '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', 
                '15:00', '16:00', '17:00', '18:00', '19:00'
            ];
            
            timeSlotGrid.innerHTML = '';
            timeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                slot.dataset.time = time;
                slot.style.cssText = `
                    padding: 0.8rem;
                    border: 2px dashed var(--border-color);
                    border-radius: 8px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                `;
                slot.onclick = () => toggleTimeSlot(slot);
                slot.onmouseover = () => {
                    if (!slot.classList.contains('selected')) {
                        slot.style.borderColor = 'var(--color-primary)';
                        slot.style.backgroundColor = 'var(--hover-bg)';
                    }
                };
                slot.onmouseout = () => {
                    if (!slot.classList.contains('selected')) {
                        slot.style.borderColor = 'var(--border-color)';
                        slot.style.backgroundColor = '';
                    }
                };
                timeSlotGrid.appendChild(slot);
            });
        }

        function toggleTimeSlot(slot) {
            slot.classList.toggle('selected');
            if (slot.classList.contains('selected')) {
                slot.style.borderColor = 'var(--color-primary)';
                slot.style.backgroundColor = 'rgba(179, 139, 0, 0.1)';
            } else {
                slot.style.borderColor = 'var(--border-color)';
                slot.style.backgroundColor = '';
            }
        }

        function loadInstructorBookings() {
            const bookingsList = document.getElementById('instructorBookingsList');
            
            if (!currentUser) return;
            
            try {
                let q = db.collection("bookings").where("instructorId", "==", currentUser.uid);
                
                // Add additional filters if available
                if (firebaseInitialized) {
                    q = q.where("status", "in", ["negotiating", "confirmed"]);
                    if (typeof q.orderBy === 'function') {
                        q = q.orderBy("createdAt", "desc");
                    }
                }
                
                q.onSnapshot((snapshot) => {
                    bookingsList.innerHTML = snapshot.empty ? '<p>No bookings yet.</p>' : '';
                    
                    snapshot.forEach(docSnap => {
                        const booking = { id: docSnap.id, ...docSnap.data() };
                        const bookingEl = document.createElement('div');
                        bookingEl.className = 'session-card';
                        bookingEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        const sessionDate = booking.startTime?.toDate ? booking.startTime.toDate() : new Date();
                        const statusClass = `status-${booking.status || 'pending'}`;
                        
                        bookingEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${booking.studentName || 'Student'}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Rate: ‚Ç¶${booking.hourlyRate || 5000}/hour</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <span class="session-status ${statusClass}" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    ${booking.status || 'pending'}
                                </span>
                                <button class="btn btn-info btn-sm" onclick="openChat('${booking.id}', '${booking.studentId}', '${booking.studentName}')">
                                    <i class="fas fa-comments"></i> Chat
                                </button>
                                ${(booking.status === 'negotiating' || !booking.status) ? `
                                    <button class="btn btn-success btn-sm" onclick="confirmBooking('${booking.id}')">
                                        <i class="fas fa-check"></i> Confirm
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectBooking('${booking.id}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                ` : ''}
                                ${booking.status === 'confirmed' ? `
                                    <button class="btn btn-success btn-sm" onclick="markSessionComplete('${booking.id}')">
                                        <i class="fas fa-check-circle"></i> Complete
                                    </button>
                                ` : ''}
                            </div>
                        `;
                        bookingsList.appendChild(bookingEl);
                    });
                });
            } catch (error) {
                console.error('Error loading instructor bookings:', error);
                bookingsList.innerHTML = '<p>Error loading bookings. Please refresh the page.</p>';
            }
        }

        function loadCompletedSessions() {
            const completedList = document.getElementById('completedSessionsList');
            
            if (!currentUser) return;
            
            try {
                let q = db.collection("bookings").where("instructorId", "==", currentUser.uid);
                
                if (firebaseInitialized) {
                    q = q.where("status", "==", "completed");
                    if (typeof q.orderBy === 'function') {
                        q = q.orderBy("completedAt", "desc");
                    }
                }
                
                q.onSnapshot((snapshot) => {
                    completedList.innerHTML = snapshot.empty ? '<p>No completed sessions yet.</p>' : '';
                    
                    snapshot.forEach(docSnap => {
                        const session = { id: docSnap.id, ...docSnap.data() };
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'session-card';
                        sessionEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        const sessionDate = session.startTime?.toDate ? session.startTime.toDate() : new Date();
                        const finalAmount = session.finalAmount || session.hourlyRate || 5000;
                        const earnings = Math.round(finalAmount * 0.9); // 90% after platform fee
                        
                        sessionEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${session.studentName || 'Student'}</p>
                                <p style="margin: 0; color: var(--success-color); font-size: 0.9rem; font-weight: 600;">Earned: ‚Ç¶${earnings.toLocaleString()}</p>
                                <div style="color: var(--warning-color); font-size: 0.8rem;">
                                    Rating: ${'‚òÖ'.repeat(session.rating || 5)} ${session.rating || 5}/5
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="session-status status-completed" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    Completed
                                </span>
                            </div>
                        `;
                        completedList.appendChild(sessionEl);
                    });
                });
            } catch (error) {
                console.error('Error loading completed sessions:', error);
                completedList.innerHTML = '<p>Error loading completed sessions. Please refresh the page.</p>';
            }
        }

        function initializeAdmin() {
            loadAdminStatistics();
            loadAllTransactions();
            loadAllMentors();
        }

        async function loadAdminStatistics() {
            try {
                // Get all completed bookings
                const completedSnapshot = await db.collection("bookings")
                    .where("status", "==", "completed")
                    .get();
                
                let totalCommission = 0;
                completedSnapshot.forEach(doc => {
                    const booking = doc.data();
                    totalCommission += Math.round((booking.finalAmount || booking.hourlyRate) * 0.1); // 10% commission
                });
                
                // Get pending sessions
                const pendingSnapshot = await db.collection("bookings")
                    .where("status", "in", ["negotiating", "confirmed"])
                    .get();
                
                // Update admin stats display
                const statsContainer = document.getElementById('adminStats');
                statsContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--color-primary), #d4af37); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">‚Ç¶${totalCommission.toLocaleString()}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Commission Earned</p>
                        </div>
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--info-color), #20c997); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">${completedSnapshot.size}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Sessions Completed</p>
                        </div>
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--warning-color), #f39c12); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">${pendingSnapshot.size}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Pending Sessions</p>
                        </div>
                    </div>
                    
                    <div class="tab-nav" style="margin-bottom: 2rem;">
                        <button class="tab-btn active" onclick="switchAdminTab('transactions')">
                            <i class="fas fa-money-bill-wave"></i> Transactions
                        </button>
                        <button class="tab-btn" onclick="switchAdminTab('mentors')">
                            <i class="fas fa-users"></i> Mentors
                        </button>
                    </div>
                    
                    <div id="admin-transactions-tab" class="admin-tab-content active">
                        <h3 style="color: var(--color-secondary); margin-bottom: 1rem;">All Transactions</h3>
                        <div id="adminTransactionsList">
                            <p>Loading transactions...</p>
                        </div>
                    </div>
                    
                    <div id="admin-mentors-tab" class="admin-tab-content" style="display: none;">
                        <h3 style="color: var(--color-secondary); margin-bottom: 1rem;">Mentor Management</h3>
                        <div id="adminMentorsList">
                            <p>Loading mentors...</p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading admin statistics:', error);
                document.getElementById('adminStats').innerHTML = '<p>Error loading statistics. Please refresh the page.</p>';
            }
        }

        function loadAvailableMentors() {
            const mentorsGrid = document.getElementById('memberInstructorList');
            if (!mentorsGrid) {
                console.error('‚ùå Mentors container not found');
                return;
            }

            console.log('üîç Loading mentors, Firebase initialized:', firebaseInitialized);

            // Demo data as fallback
            const demoMentors = [
                {
                    id: 'mentor-1',
                    name: 'Dr. Sarah Johnson',
                    expertise: 'Career Development & Leadership',
                    rating: 4.9,
                    hourlyRate: 75,
                    profileImage: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face',
                    bio: 'Former tech executive with 15+ years experience helping professionals advance their careers.',
                    totalSessions: 127
                },
                {
                    id: 'mentor-2',
                    name: 'Prof. Michael Chen',
                    expertise: 'Academic Research & PhD Guidance',
                    rating: 4.8,
                    hourlyRate: 60,
                    profileImage: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face',
                    bio: 'University professor and research supervisor with expertise in data science and machine learning.',
                    totalSessions: 89
                },
                {
                    id: 'mentor-3',
                    name: 'Emily Rodriguez',
                    expertise: 'Entrepreneurship & Startup Strategy',
                    rating: 4.7,
                    hourlyRate: 85,
                    profileImage: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face',
                    bio: 'Serial entrepreneur who founded 3 successful startups. Expert in business strategy and fundraising.',
                    totalSessions: 156
                }
            ];

            function displayMentors(mentors, source = 'demo') {
                mentorsGrid.innerHTML = mentors.map(mentor => `
                    <div class="instructor-card" onclick="selectMentorForMember('${mentor.id}', '${mentor.name}', this)" style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <img src="${mentor.profileImage}" alt="${mentor.name}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjZGRkIi8+CjxjaXJjbGUgY3g9IjMwIiBjeT0iMjUiIHI9IjEwIiBmaWxsPSIjOTk5Ii8+CjxwYXRoIGQ9Ik0xNSA0NWMwLTggNi43LTE1IDE1LTE1czE1IDcgMTUgMTV2NUgxNXYtNXoiIGZpbGw9IiM5OTkiLz4KPC9zdmc+Cg=='"
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 5px 0; color: var(--color-primary);">${mentor.name}</h3>
                                <p style="margin: 0 0 5px 0; color: #666; font-size: 14px;">${mentor.expertise}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #f39c12;">‚≠ê ${mentor.rating} (${mentor.totalSessions} sessions)</span>
                                    <span style="font-weight: bold; color: var(--color-primary);">$${mentor.hourlyRate}/hour</span>
                                </div>
                            </div>
                        </div>
                        <p style="margin: 10px 0 0 0; font-size: 13px; color: #777;">${mentor.bio}</p>
                    </div>
                `).join('');
                console.log(`üìã Displaying ${mentors.length} mentors from ${source}`);
            }

            // Try to load from Firestore first
            if (firebaseInitialized && db) {
                console.log('üî• Attempting to load mentors from Firestore...');
                
                db.collection("users")
                    .where("role", "==", "instructor")
                    .where("isActive", "==", true)
                    .get()
                    .then((snapshot) => {
                        console.log('üìä Firestore query result:', snapshot.size, 'mentors found');
                        
                        if (!snapshot.empty) {
                            const mentors = [];
                            snapshot.forEach((doc) => {
                                const data = doc.data();
                                mentors.push({
                                    id: doc.id,
                                    name: data.name || 'Anonymous Mentor',
                                    expertise: data.expertise || 'General Mentoring',
                                    rating: data.rating || 4.5,
                                    hourlyRate: data.hourlyRate || 40,
                                    profileImage: data.profileImage || 'https://via.placeholder.com/150',
                                    bio: data.bio || 'Experienced mentor ready to help you grow.',
                                    totalSessions: data.totalSessions || 0
                                });
                            });
                            displayMentors(mentors, 'Firestore');
                        } else {
                            console.log('üìù No mentors in Firestore, using demo data');
                            displayMentors(demoMentors, 'demo (no Firestore data)');
                        }
                    })
                    .catch((error) => {
                        console.error('‚ùå Firestore error, falling back to demo data:', error);
                        displayMentors(demoMentors, 'demo (Firestore error)');
                    });
            } else {
                console.log('üìù Firebase not initialized, using demo data');
                displayMentors(demoMentors, 'demo (no Firebase)');
            }
        }

        function loadAllTransactions() {
            const transactionsList = document.getElementById('adminTransactionsList');
            
            try {
                let q = db.collection("bookings");
                
                if (firebaseInitialized) {
                    q = q.where("status", "==", "completed");
                    if (typeof q.orderBy === 'function') {
                        q = q.orderBy("completedAt", "desc");
                    }
                }
                
                q.onSnapshot((snapshot) => {
                    transactionsList.innerHTML = snapshot.empty ? '<p>No transactions yet.</p>' : '';
                    
                    snapshot.forEach(docSnap => {
                        const transaction = { id: docSnap.id, ...docSnap.data() };
                        const transactionEl = document.createElement('div');
                        transactionEl.className = 'session-card';
                        transactionEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        const completedDate = transaction.completedAt?.toDate ? transaction.completedAt.toDate() : new Date();
                        const finalAmount = transaction.finalAmount || transaction.hourlyRate || 5000;
                        const commission = Math.round(finalAmount * 0.1);
                        const instructorEarning = Math.round(finalAmount * 0.9);
                        
                        transactionEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">Transaction #${transaction.id.substr(-6).toUpperCase()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${transaction.studentName || 'Student'} ‚Üí ${transaction.instructorName || 'Instructor'}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Completed: ${completedDate.toLocaleString()}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">Total: ‚Ç¶${finalAmount.toLocaleString()}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="margin: 0; color: var(--success-color); font-size: 0.9rem; font-weight: 600;">Commission (10%): ‚Ç¶${commission.toLocaleString()}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Instructor (90%): ‚Ç¶${instructorEarning.toLocaleString()}</p>
                                <span class="session-status status-completed" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    Completed
                                </span>
                            </div>
                        `;
                        transactionsList.appendChild(transactionEl);
                    });
                });
            } catch (error) {
                console.error('Error loading transactions:', error);
                transactionsList.innerHTML = '<p>Error loading transactions. Please refresh the page.</p>';
            }
        }

        async function loadAllMentors() {
            const mentorsList = document.getElementById('adminMentorsList');
            
            try {
                const snapshot = await db.collection("users").where("role", "==", "instructor").get();
                mentorsList.innerHTML = '';
                
                for (const docSnap of snapshot.docs) {
                    const mentor = { id: docSnap.id, ...docSnap.data() };
                    
                    // Get mentor statistics
                    const sessionsSnap = await db.collection("bookings")
                        .where("instructorId", "==", mentor.id)
                        .where("status", "==", "completed")
                        .get();
                    
                    let totalEarnings = 0;
                    sessionsSnap.forEach(doc => {
                        const finalAmount = doc.data().finalAmount || doc.data().hourlyRate;
                        totalEarnings += Math.round(finalAmount * 0.9);
                    });
                    
                    const mentorEl = document.createElement('div');
                    mentorEl.className = 'session-card';
                    mentorEl.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.5rem;
                        border: 1px solid var(--border-color);
                        border-radius: 12px;
                        margin-bottom: 1rem;
                        transition: all 0.3s;
                    `;
                    
                    mentorEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <img src="${mentor.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(mentor.name)}`}" 
                                 alt="${mentor.name}" 
                                 style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${mentor.name}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${mentor.email}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Expertise: ${mentor.expertise?.join(', ') || 'Not specified'}</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Completed Sessions: ${sessionsSnap.size}</p>
                            <p style="margin: 0; color: var(--success-color); font-size: 0.9rem; font-weight: 600;">Total Earnings: ‚Ç¶${totalEarnings.toLocaleString()}</p>
                            <button class="btn btn-info btn-sm" onclick="viewMentorDetails('${mentor.id}')" style="margin-top: 0.5rem;">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    `;
                    mentorsList.appendChild(mentorEl);
                }
            } catch (error) {
                console.error('Error loading mentors:', error);
                mentorsList.innerHTML = '<p>Error loading mentors. Please refresh the page.</p>';
            }
        }

        window.switchAdminTab = function(tabName) {
            // Update active tab button
            document.querySelectorAll('#adminStats .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all admin tab contents
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(`admin-${tabName}-tab`);
            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
            }
        };

        window.viewMentorDetails = function(mentorId) {
            console.log('Viewing mentor details for:', mentorId);
            // Could open a detailed modal or navigate to mentor profile
        };

        function updateSidebarConversations() {
            const sidebarConversations = document.getElementById('sidebarConversations');
            
            if (!currentUser || !currentUserData) return;
            
            // Query for active sessions/conversations
            const q = db.collection("bookings")
                .where(currentUserData.role === 'instructor' ? "instructorId" : "studentId", "==", currentUser.uid)
                .where("status", "in", ["confirmed", "negotiating", "completed"]);
            
            q.onSnapshot((snapshot) => {
                sidebarConversations.innerHTML = '';
                
                if (snapshot.empty) {
                    sidebarConversations.innerHTML = `
                        <div class="conversation-item">
                            <img src="https://ui-avatars.com/api/?name=No+Chat&background=ddd&color=999&size=40" alt="Avatar" class="conversation-avatar">
                            <div>
                                <p style="margin: 0; font-weight: 600;">No active chats</p>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary);">Start a session to begin chatting</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const session = { id: docSnap.id, ...docSnap.data() };
                    const isInstructor = currentUserData.role === 'instructor';
                    const partnerName = isInstructor ? session.studentName : session.instructorName;
                    
                    const conversationEl = document.createElement('div');
                    conversationEl.className = 'conversation-item';
                    conversationEl.onclick = () => openChat(session.id, isInstructor ? session.studentId : session.instructorId, partnerName);
                    
                    conversationEl.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(partnerName)}&size=40" alt="${partnerName}" class="conversation-avatar">
                        <div>
                            <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">${partnerName}</p>
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary);">Mentorship Session</p>
                        </div>
                    `;
                    
                    sidebarConversations.appendChild(conversationEl);
                });
            });
        }

        window.saveAvailability = async function() {
            const date = document.getElementById('availabilityDate').value;
            const hourlyRate = parseInt(document.getElementById('hourlyRate').value);
            const selectedSlots = document.querySelectorAll('.time-slot.selected');
            
            if (!date || !hourlyRate || selectedSlots.length === 0) {
                alert('Please fill all fields and select at least one time slot.');
                return;
            }

            if (hourlyRate < 1000) {
                alert('Minimum hourly rate is ‚Ç¶1,000.');
                return;
            }

            const timeSlots = Array.from(selectedSlots).map(slot => ({
                time: slot.dataset.time,
                rate: hourlyRate
            }));

            try {
                await db.collection("mentorshipSlots").doc(`${currentUser.uid}_${date}`).set({
                    instructorId: currentUser.uid,
                    date: date,
                    timeSlots: timeSlots,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Availability saved successfully!');
                
                // Reset form
                document.getElementById('availabilityDate').value = '';
                document.getElementById('hourlyRate').value = '';
                selectedSlots.forEach(slot => {
                    slot.classList.remove('selected');
                    slot.style.borderColor = 'var(--border-color)';
                    slot.style.backgroundColor = '';
                });
                
            } catch (error) {
                console.error('Error saving availability:', error);
                alert('Failed to save availability. Please try again.');
            }
        };

        window.confirmBooking = async function(bookingId) {
            if (confirm('Confirm this booking?')) {
                try {
                    await db.collection("bookings").doc(bookingId).update({
                        status: 'confirmed',
                        confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Booking confirmed!');
                } catch (error) {
                    console.error('Error confirming booking:', error);
                    alert('Failed to confirm booking.');
                }
            }
        };

        window.rejectBooking = async function(bookingId) {
            if (confirm('Reject this booking? This action cannot be undone.')) {
                try {
                    await db.collection("bookings").doc(bookingId).delete();
                    alert('Booking rejected and removed.');
                } catch (error) {
                    console.error('Error rejecting booking:', error);
                    alert('Failed to reject booking.');
                }
            }
        };

        window.markSessionComplete = async function(bookingId) {
            if (confirm('Mark this session as completed?')) {
                try {
                    const bookingDoc = await db.collection("bookings").doc(bookingId).get();
                    const bookingData = bookingDoc.data();
                    
                    await db.collection("bookings").doc(bookingId).update({
                        status: 'completed',
                        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        finalAmount: bookingData.hourlyRate, // 1 hour session
                        rating: 5 // Default rating, can be updated by student later
                    });
                    alert('Session marked as completed!');
                } catch (error) {
                    console.error('Error completing session:', error);
                    alert('Failed to complete session.');
                }
            }
        };

        function openChat(sessionId, partnerId, partnerName) {
            console.log('Opening chat:', sessionId, partnerId, partnerName);
            // Will implement chat functionality in next step
        }

        // Add status styles
        const statusStyles = document.createElement('style');
        statusStyles.textContent = `
            .status-pending { background-color: var(--warning-color); color: white; }
            .status-confirmed { background-color: var(--success-color); color: white; }
            .status-completed { background-color: var(--info-color); color: white; }
            .status-negotiating { background-color: var(--color-primary); color: white; }
        `;
        document.head.appendChild(statusStyles);
    </script>
</body>
</html>
