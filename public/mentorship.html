<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-on-1 Mentorship - Andrew Cares Village</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    
    <style>
        :root {
            --background-color: #F4F2ED;
            --text-primary: #333333;
            --text-secondary: #555555;
            --color-primary: #B38B00;
            --color-secondary: #001F3F;
            --card-bg: #FFFFFF;
            --border-color: #EAEAEA;
            --hover-bg: #F9F9F9;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --chat-bg: #f8f9fa;
            --message-sent: #007bff;
            --message-received: #e9ecef;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .hidden { display: none !important; }

        /* Header */
        .main-header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        /* Main Layout - CORRECTED: Main content left, sidebar right */
        .mentorship-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 8rem);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-sidebar {
            width: 450px;
            background: linear-gradient(145deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            border-left: 1px solid rgba(255,255,255,0.1);
            box-shadow: -8px 0 32px rgba(0,0,0,0.25);
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(15px);
            z-index: 1000;
            border-radius: 20px 0 0 20px;
        }

        /* Dashboard Headers */
        .dashboard-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .dashboard-header h1 {
            font-family: 'Cinzel', serif;
            margin: 0;
            font-size: 2.5rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background-color: var(--color-primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards and Grids */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--color-secondary);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover { background-color: #9c7a00; }
        .btn-secondary { background-color: var(--text-secondary); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(179, 139, 0, 0.2);
        }

        /* Chat Sidebar */
        .sidebar-chat-header {
            background-color: var(--color-primary);
            color: white;
            padding: 1rem;
            text-align: center;
            border-radius: 12px 12px 0 0;
        }

        .active-conversations {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .conversation-item:hover {
            background-color: var(--hover-bg);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .mentorship-container {
                flex-direction: column;
                height: auto;
            }
            
            .main-content {
                width: 100%;
                height: auto;
                min-height: 70vh;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 40vh;
                min-height: 350px;
                position: relative;
                right: auto;
                top: auto;
                border-radius: 15px 15px 0 0;
            }
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .tab-btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <!-- Header -->
    <header class="main-header">
        <a href="home.html" style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--color-secondary); text-decoration: none;">
            Andrew Cares Village
        </a>
    </header>

    <!-- Main Container -->
    <div class="mentorship-container">
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Member View -->
            <div id="memberView" class="hidden">
                <div class="dashboard-header">
                    <h1><i class="fas fa-graduation-cap"></i> Mentorship Portal</h1>
                    <p>Connect with expert mentors for personalized guidance</p>
                </div>
                
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('browse')">
                        <i class="fas fa-search"></i> Browse Mentors
                    </button>
                    <button class="tab-btn" onclick="switchTab('my-sessions')">
                        <i class="fas fa-calendar-alt"></i> My Sessions
                    </button>
                </div>

                <div id="browse-tab" class="tab-content active">
                    <div class="grid-2">
                        <div class="card">
                            <h2 class="section-title">Available Mentors</h2>
                            <div id="memberInstructorList">
                                <p>Loading mentors...</p>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="section-title" id="memberBookingTitle">Select a Mentor to Begin</h2>
                            <div id="memberCalendar"></div>
                        </div>
                    </div>
                </div>

                <div id="my-sessions-tab" class="tab-content">
                    <div class="card">
                        <h2 class="section-title">My Mentorship Sessions</h2>
                        <div id="memberSessionsList">
                            <p>You have no sessions yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructor View -->
            <div id="instructorView" class="hidden">
                <div class="dashboard-header">
                    <h1><i class="fas fa-chalkboard-teacher"></i> Mentor Dashboard</h1>
                    <p>Manage your mentorship sessions and availability</p>
                </div>
                
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab('availability')">
                        <i class="fas fa-clock"></i> Set Availability
                    </button>
                    <button class="tab-btn" onclick="switchTab('bookings')">
                        <i class="fas fa-calendar-check"></i> Bookings
                    </button>
                    <button class="tab-btn" onclick="switchTab('completed')">
                        <i class="fas fa-trophy"></i> Completed
                    </button>
                </div>

                <div id="availability-tab" class="tab-content active">
                    <div class="card">
                        <h2 class="section-title">Set Your Availability</h2>
                        <div class="form-group">
                            <label for="availabilityDate">Select Date:</label>
                            <input type="date" id="availabilityDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="hourlyRate">Hourly Rate (‚Ç¶):</label>
                            <input type="number" id="hourlyRate" class="form-control" placeholder="e.g., 5000" min="1000">
                            <small>Minimum rate: ‚Ç¶1,000 per hour</small>
                        </div>
                        <button class="btn btn-primary" onclick="saveAvailability()">
                            <i class="fas fa-save"></i> Save Availability
                        </button>
                    </div>
                </div>

                <div id="bookings-tab" class="tab-content">
                    <div class="card">
                        <h2 class="section-title">Pending & Confirmed Bookings</h2>
                        <div id="instructorBookingsList">
                            <p>No bookings yet.</p>
                        </div>
                    </div>
                </div>

                <div id="completed-tab" class="tab-content">
                    <div class="card">
                        <h2 class="section-title">Completed Sessions</h2>
                        <div id="completedSessionsList">
                            <p>No completed sessions yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="hidden">
                <div class="dashboard-header">
                    <h1><i class="fas fa-chart-line"></i> Admin Dashboard</h1>
                    <p>Monitor platform performance and commission earnings</p>
                </div>
                
                <div class="card">
                    <h2 class="section-title">Platform Statistics</h2>
                    <div id="adminStats">
                        <p>Loading statistics...</p>
                    </div>
                </div>
            </div>

            <!-- Goal-Based Mentor Matching Section -->
            <div class="section" id="memberSection" style="display: none;">
                <div class="container">
                    <h2 style="text-align: center; margin-bottom: 1rem; color: var(--color-secondary);">
                        <i class="fas fa-users"></i> Find Your Perfect Mentor
                    </h2>
                    
                    <!-- Goal Selection Interface -->
                    <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05)); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 1px solid rgba(102, 126, 234, 0.2);">
                        <h3 style="text-align: center; margin-bottom: 1.5rem; color: #334155; font-weight: 600;">What are your mentorship goals?</h3>
                        <div id="goalSelection" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="goal-card" data-goal="career" onclick="selectGoal('career')" style="padding: 1.5rem; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
                                <div style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-chart-line" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <h4 style="margin: 0 0 0.5rem 0; color: #334155;">Career Growth</h4>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Advance your career and leadership skills</p>
                            </div>
                            
                            <div class="goal-card" data-goal="tech" onclick="selectGoal('tech')" style="padding: 1.5rem; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
                                <div style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-code" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <h4 style="margin: 0 0 0.5rem 0; color: #334155;">Tech & Engineering</h4>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Master technical skills and system design</p>
                            </div>
                            
                            <div class="goal-card" data-goal="business" onclick="selectGoal('business')" style="padding: 1.5rem; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
                                <div style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-rocket" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <h4 style="margin: 0 0 0.5rem 0; color: #334155;">Entrepreneurship</h4>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Build and scale successful businesses</p>
                            </div>
                            
                            <div class="goal-card" data-goal="academic" onclick="selectGoal('academic')" style="padding: 1.5rem; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s;">
                                <div style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-graduation-cap" style="color: white; font-size: 1.5rem;"></i>
                                </div>
                                <h4 style="margin: 0 0 0.5rem 0; color: #334155;">Academic Research</h4>
                                <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Excel in research and publications</p>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button id="clearGoalsBtn" onclick="clearGoalSelection()" style="padding: 0.75rem 1.5rem; background: rgba(100, 116, 139, 0.1); color: #64748b; border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 8px; cursor: pointer; font-weight: 500; display: none;">
                                <i class="fas fa-times" style="margin-right: 0.5rem;"></i>
                                Clear Selection
                            </button>
                        </div>
                    </div>

                <div id="memberInstructorList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
                    <!-- Mentors will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Access Denied View -->
        <div id="accessDeniedView" class="hidden">
            <div class="dashboard-header">
                <h1><i class="fas fa-lock"></i> Access Restricted</h1>
                <p>This mentorship platform is available to registered members, instructors, and admins only.</p>
            </div>
            <div class="container">
                <div class="card" style="text-align: center; padding: 3rem;">
                    <i class="fas fa-lock" style="font-size: 4rem; color: var(--warning-color); margin-bottom: 1rem;"></i>
                    <h2>Access Restricted</h2>
                    <p>This mentorship platform is available to registered members, instructors, and admins only.</p>
                    <a href="contact.html" class="btn btn-primary">
                        <i class="fas fa-envelope"></i> Contact Support
                    </a>
                </div>
            </div>
        </div>

        <!-- Professional Chat Sidebar -->
        <div class="chat-sidebar" id="chatSidebar" style="display: none;">
            <!-- Chat List Header -->
            <div class="sidebar-chat-header" style="padding: 1.5rem; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.15);">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.8rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-comments" style="color: white; font-size: 1.2rem;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; color: white; font-size: 1.1rem; font-weight: 700;">Messages</h3>
                            <p style="margin: 0; color: rgba(255,255,255,0.7); font-size: 0.8rem;">Professional Support</p>
                        </div>
                    </div>
                    <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);"></div>
                </div>
            </div>
            
            <!-- Active Conversations List -->
            <div class="active-conversations" id="sidebarConversations" style="flex: 1; overflow-y: auto; padding: 0.5rem;">
                <div class="conversation-item" style="padding: 1rem; margin: 0.5rem; background: rgba(255,255,255,0.08); border-radius: 12px; cursor: pointer; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.1);" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="position: relative;">
                            <img src="https://ui-avatars.com/api/?name=Support&background=667eea&color=fff&size=45&rounded=true" alt="Avatar" style="width: 45px; height: 45px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2);">
                            <div style="position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; background: #10b981; border: 2px solid #1e3c72; border-radius: 50%;"></div>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem;">
                                <h4 style="margin: 0; color: white; font-size: 0.95rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Professional Support</h4>
                                <span style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">Online</span>
                            </div>
                            <p style="margin: 0; color: rgba(255,255,255,0.7); font-size: 0.85rem; line-height: 1.3;">Ready to assist with your mentorship session</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Professional Chat Header -->
            <div class="chat-header" style="padding: 2rem 1.5rem; background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.15); position: relative;">
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);"></div>
                <div style="display: flex; align-items: center; gap: 1.2rem;">
                    <div class="user-avatar" style="width: 52px; height: 52px; border-radius: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.3rem; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3); border: 2px solid rgba(255,255,255,0.2);">U</div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1.2rem; color: white; font-weight: 700; letter-spacing: -0.02em;">Professional Chat</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.3rem;">
                            <div style="width: 8px; height: 8px; border-radius: 50%; background: #4ade80; box-shadow: 0 0 8px rgba(74, 222, 128, 0.6);"></div>
                            <p style="margin: 0; font-size: 0.85rem; color: rgba(255,255,255,0.9); font-weight: 500;">Active Session</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="minimizeChat()" style="background: rgba(255,255,255,0.15); border: none; color: white; padding: 0.7rem; border-radius: 12px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button onclick="closeChatSidebar()" style="background: rgba(239, 68, 68, 0.2); border: none; color: #fca5a5; padding: 0.7rem; border-radius: 12px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="chatMessages" style="flex: 1; padding: 2rem 1.5rem; overflow-y: auto; background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(248,250,252,0.95) 100%); margin: 1rem; border-radius: 20px; box-shadow: inset 0 4px 20px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.1); position: relative;">
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1), transparent);"></div>
                <div style="text-align: center; padding: 3rem 2rem; color: #64748b;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                        <i class="fas fa-comments" style="font-size: 2.5rem; color: #94a3b8;"></i>
                    </div>
                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1.3rem; font-weight: 700; color: #334155; letter-spacing: -0.02em;">Professional Messaging</h4>
                    <p style="margin: 0; font-size: 1rem; color: #64748b; font-weight: 500;">Secure, encrypted communication</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #94a3b8;">Start your mentorship conversation</p>
                </div>
            </div>
            
            <!-- Payment & Agreement Section -->
            <div id="paymentSection" style="padding: 1.5rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border-top: 1px solid rgba(34, 197, 94, 0.2); display: none;">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="width: 60px; height: 60px; margin: 0 auto 1rem; background: linear-gradient(135deg, #10b981, #059669); border-radius: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);">
                        <i class="fas fa-handshake" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <h4 style="margin: 0 0 0.5rem 0; color: white; font-weight: 700;">Agreement Reached</h4>
                    <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 0.9rem;">Rate: <span id="agreedRate">‚Ç¶5000/hour</span></p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="initiatePayment()" style="flex: 1; padding: 1rem 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(16, 185, 129, 0.4)'">
                        <i class="fas fa-credit-card" style="margin-right: 0.5rem;"></i>
                        Pay Now
                    </button>
                    <button onclick="openAgreementForm()" style="flex: 1; padding: 1rem 1.5rem; background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px);" onmouseover="this.style.background='linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.2))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1))'">
                        <i class="fas fa-file-contract" style="margin-right: 0.5rem;"></i>
                        View Agreement
                    </button>
                </div>
            </div>
            
            <!-- Professional Input Area -->
            <div class="chat-input" style="padding: 1.5rem; background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.08) 100%); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.15); position: relative;">
                <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);"></div>
                <div style="display: flex; gap: 1rem; align-items: flex-end;">
                    <div style="flex: 1; position: relative;">
                        <div style="position: relative; background: rgba(255,255,255,0.95); border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1), inset 0 1px 3px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.8);">
                            <input type="text" id="chatInput" placeholder="Type your professional message..." style="width: 100%; padding: 1.2rem 1.8rem 1.2rem 1.5rem; border: none; border-radius: 20px; background: transparent; font-size: 0.95rem; outline: none; color: #334155; font-weight: 500; letter-spacing: -0.01em;" onkeypress="if(event.key==='Enter') sendChatMessage()">
                            <div style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8;">
                                <i class="fas fa-keyboard" style="font-size: 0.9rem;"></i>
                            </div>
                        </div>
                        <div class="typing-indicator" style="position: absolute; bottom: -30px; left: 20px; font-size: 0.8rem; color: rgba(255,255,255,0.9); display: none; background: rgba(0,0,0,0.1); padding: 0.3rem 0.8rem; border-radius: 12px; backdrop-filter: blur(10px);">
                            <i class="fas fa-circle" style="animation: pulse 1.5s infinite; font-size: 0.5rem;"></i>
                            <i class="fas fa-circle" style="animation: pulse 1.5s infinite 0.3s; font-size: 0.5rem;"></i>
                            <i class="fas fa-circle" style="animation: pulse 1.5s infinite 0.6s; font-size: 0.5rem;"></i>
                            <span style="margin-left: 0.5rem;">Typing...</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.8rem;">
                        <button onclick="attachFile()" style="padding: 1.2rem; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%); color: white; border: none; border-radius: 16px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                            <i class="fas fa-paperclip" style="font-size: 1.1rem;"></i>
                        </button>
                        <button onclick="sendChatMessage()" style="padding: 1.2rem 1.8rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4); font-weight: 600;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 24px rgba(102, 126, 234, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(102, 126, 234, 0.4)'">
                            <i class="fas fa-paper-plane" style="margin-right: 0.5rem;"></i>
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
            authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
            projectId: "andrew-cares-village-f4cb6",
            storageBucket: "andrew-cares-village-f4cb6.firebasestorage.app",
            messagingSenderId: "255087116955",
            appId: "1:255087116955:web:84360ee1f13888f9b83c3e"
        };

        // Initialize Firebase with comprehensive error handling
        let auth, db;
        let firebaseInitialized = false;
        
        try {
            // Check if Firebase is available
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            // Initialize Firebase app
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            auth = firebase.auth();
            db = firebase.firestore();
            
            // Enable offline persistence FIRST before any other operations
            db.enablePersistence({ synchronizeTabs: true }).then(() => {
                console.log('‚úÖ Firebase persistence enabled');
                
                // Configure Firestore settings after persistence
                try {
                    db.settings({
                        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                        ignoreUndefinedProperties: true
                    });
                } catch (settingsError) {
                    console.warn('‚ö†Ô∏è Firestore settings already configured:', settingsError.message);
                }
                
                // Test Firebase connection
                return db.collection('users').limit(1).get();
            }).then(() => {
                console.log('‚úÖ Firebase connected successfully');
                firebaseInitialized = true;
                // Reload mentors now that Firebase is ready
                if (currentUserData && currentUserData.role === 'member') {
                    loadAvailableMentors();
                }
            }).catch(error => {
                console.warn('‚ö†Ô∏è Firebase initialization warning:', error.message);
                
                // Still try to configure settings and test connection
                try {
                    db.settings({
                        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
                        ignoreUndefinedProperties: true
                    });
                } catch (settingsError) {
                    // Ignore settings error
                }
                
                // Test connection without persistence
                db.collection('users').limit(1).get().then(() => {
                    console.log('‚úÖ Firebase connected (without persistence)');
                    firebaseInitialized = true;
                    // Reload mentors now that Firebase is ready
                    if (currentUserData && currentUserData.role === 'member') {
                        loadAvailableMentors();
                    }
                }).catch(connError => {
                    console.warn('‚ö†Ô∏è Firebase connection failed:', connError);
                    firebaseInitialized = false;
                });
            });

            
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
            
            // Create mock Firebase objects for offline development
            auth = {
                onAuthStateChanged: (callback) => {
                    console.log('üîß Using mock auth - redirecting to login');
                    setTimeout(() => callback(null), 1000);
                },
                signOut: () => Promise.resolve()
            };
            
            // Create proper mock snapshot objects
            const createMockSnapshot = (docs = []) => ({
                empty: docs.length === 0,
                docs: docs,
                forEach: (callback) => docs.forEach(callback),
                size: docs.length
            });

            db = {
                collection: () => ({
                    where: (field, operator, value) => ({
                        get: () => Promise.resolve(createMockSnapshot([])),
                        onSnapshot: (callback) => callback(createMockSnapshot([])),
                        where: (field2, operator2, value2) => ({
                            get: () => Promise.resolve(createMockSnapshot([])),
                            onSnapshot: (callback) => callback(createMockSnapshot([])),
                            orderBy: () => ({
                                get: () => Promise.resolve(createMockSnapshot([])),
                                onSnapshot: (callback) => callback(createMockSnapshot([]))
                            })
                        }),
                        orderBy: () => ({
                            get: () => Promise.resolve(createMockSnapshot([])),
                            onSnapshot: (callback) => callback(createMockSnapshot([]))
                        })
                    }),
                    get: () => Promise.resolve(createMockSnapshot([])),
                    onSnapshot: (callback) => callback(createMockSnapshot([])),
                    add: () => Promise.resolve({ id: 'mock-id' }),
                    doc: () => ({
                        get: () => Promise.resolve({ exists: false, data: () => null }),
                        set: () => Promise.resolve(),
                        update: () => Promise.resolve(),
                        delete: () => Promise.resolve()
                    }),
                    orderBy: () => ({
                        get: () => Promise.resolve(createMockSnapshot([])),
                        onSnapshot: (callback) => callback(createMockSnapshot([]))
                    })
                })
            };
            
            firebaseInitialized = false;
        }

        // Global State
        let currentUser = null;
        let currentUserData = null;
        let calendar = null;
        let selectedInstructorId = null;
        let currentChatSession = null;
        const PAYSTACK_PUBLIC_KEY = 'pk_test_4f982216f23d912048d00f1a9c9f77a7b54647bc';

        // Add sample data to Firestore for testing
        async function addSampleData() {
            if (!firebaseInitialized) {
                console.log('‚ö†Ô∏è Firebase not initialized, skipping sample data');
                return;
            }

            try {
                // Add sample mentors
                const sampleMentors = [
                    {
                        name: 'Dr. Sarah Johnson',
                        email: 'sarah.johnson@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Career Development & Leadership',
                        bio: 'Former tech executive with 15+ years experience helping professionals advance their careers. Specializes in leadership development, career transitions, and executive coaching.',
                        hourlyRate: 75,
                        rating: 4.9,
                        totalSessions: 127,
                        profileImage: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face',
                        availability: ['Monday', 'Tuesday', 'Wednesday', 'Thursday'],
                        timeSlots: ['09:00', '10:00', '11:00', '14:00', '15:00'],
                        createdAt: new Date()
                    },
                    {
                        name: 'Prof. Michael Chen',
                        email: 'michael.chen@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Academic Research & PhD Guidance',
                        bio: 'University professor and research supervisor with expertise in data science, machine learning, and academic writing. Published 50+ peer-reviewed papers.',
                        hourlyRate: 60,
                        rating: 4.8,
                        totalSessions: 89,
                        profileImage: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face',
                        availability: ['Tuesday', 'Wednesday', 'Thursday', 'Friday'],
                        timeSlots: ['10:00', '11:00', '13:00', '14:00', '16:00'],
                        createdAt: new Date()
                    },
                    {
                        name: 'Emily Rodriguez',
                        email: 'emily.rodriguez@example.com',
                        role: 'instructor',
                        isActive: true,
                        expertise: 'Entrepreneurship & Startup Strategy',
                        bio: 'Serial entrepreneur who founded 3 successful startups. Now mentoring the next generation of founders in business strategy, fundraising, and scaling operations.',
                        hourlyRate: 85,
                        rating: 4.7,
                        totalSessions: 156,
                        profileImage: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face',
                        availability: ['Monday', 'Wednesday', 'Friday', 'Saturday'],
                        timeSlots: ['09:00', '10:00', '15:00', '16:00', '17:00'],
                        createdAt: new Date()
                    }
                ];

                // Check if mentors already exist
                const existingMentors = await db.collection('users').where('role', '==', 'instructor').get();
                
                if (existingMentors.empty) {
                    console.log('üìù Adding sample mentors to Firestore...');
                    
                    for (const mentor of sampleMentors) {
                        await db.collection('users').add(mentor);
                    }
                    
                    console.log('‚úÖ Sample mentors added successfully!');
                } else {
                    console.log('‚ÑπÔ∏è Mentors already exist in database');
                }

            } catch (error) {
                console.error('‚ùå Error adding sample data:', error);
            }
        }

        // Authentication State Management - prioritize Firestore connection
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Real authenticated user - prioritize this
                console.log('üë§ Real user authenticated:', user.email);
                currentUser = user;
                
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUserData = userDoc.data();
                        console.log('üìã User data loaded from Firestore');
                    } else {
                        // Create new user document
                        currentUserData = {
                            name: user.displayName || 'New User',
                            email: user.email,
                            role: 'member',
                            createdAt: new Date()
                        };
                        await db.collection('users').doc(user.uid).set(currentUserData);
                        console.log('üìù New user document created');
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    currentUserData = {
                        name: user.displayName || 'User',
                        email: user.email,
                        role: 'member'
                    };
                }
            } else {
                // No authenticated user - create test user for development
                console.log('üîß Development mode - creating test user');
                currentUser = { uid: 'test-user-123', email: 'test@example.com' };
                currentUserData = { 
                    name: 'Test User', 
                    email: 'test@example.com', 
                    role: 'member' // Change to 'instructor' or 'admin' to test different views
                };
            }
            
            // Try to add sample data if Firebase is working
            try {
                if (firebaseInitialized) {
                    await addSampleData();
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è Could not add sample data, continuing with demo data');
            }
            
            initializeView();
        });

        function initializeView() {
            const userRole = currentUserData?.role;

            // Helper function to safely hide/show elements
            function safeToggleElement(elementId, show = false) {
                const element = document.getElementById(elementId);
                if (element) {
                    if (show) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                } else {
                    console.warn(`Element with ID '${elementId}' not found`);
                }
            }

            // Hide all views first
            safeToggleElement('memberView', false);
            safeToggleElement('instructorView', false);
            safeToggleElement('adminView', false);
            safeToggleElement('accessDeniedView', false);

            // Show appropriate view
            if (userRole === 'member') {
                safeToggleElement('memberView', true);
                updateSidebarConversations();
                loadMemberSessions();
                loadAvailableMentors(); // Load mentors when member view is shown
                initializeMemberCalendar(); // Initialize calendar when member view is shown
            } else if (userRole === 'instructor') {
                safeToggleElement('instructorView', true);
                initializeInstructor();
            } else if (userRole === 'admin') {
                safeToggleElement('adminView', true);
                initializeAdmin();
            } else {
                safeToggleElement('accessDeniedView', true);
            }

            updateSidebarConversations();
        }

        // Tab Management
        window.switchTab = function(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
        };

        // Member Functions
        function initializeMember() {
            initializeMemberCalendar();
            loadMentorsForMember();
            loadMemberSessions();
        }

        function initializeMemberCalendar() {
            if (calendar) {
                calendar.destroy();
            }
            
            try {
                const calendarEl = document.getElementById('memberCalendar');
                if (!calendarEl) {
                    console.error('‚ùå Calendar element not found');
                    return;
                }
                
                console.log('üìÖ Initializing member calendar...');
                
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    slotMinTime: '08:00:00',
                    slotMaxTime: '20:00:00',
                    height: 'auto',
                    events: [],
                    eventClick: function(info) {
                        if (info.event.extendedProps.available) {
                            bookSession(info.event.extendedProps.timeSlot, info.event.start);
                        }
                    }
                });
                
                calendar.render();
                console.log('‚úÖ Calendar initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing calendar:', error);
                document.getElementById('memberCalendar').innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">Calendar unavailable. Please refresh the page.</p>';
            }
        }

        async function loadMentorsForMember() {
            const instructorList = document.getElementById('memberInstructorList');
            instructorList.innerHTML = '<p>Loading mentors...</p>';
            
            try {
                const snapshot = await db.collection("users").where("role", "==", "instructor").get();
                instructorList.innerHTML = '';
                
                for (const docSnap of snapshot.docs) {
                    const instructor = { id: docSnap.id, ...docSnap.data() };
                    
                    const card = document.createElement('div');
                    card.className = 'instructor-card';
                    card.dataset.instructorId = instructor.id;
                    card.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        padding: 1rem;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 1px solid transparent;
                        margin-bottom: 1rem;
                    `;
                    
                    const avatarUrl = instructor.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(instructor.name)}`;
                    
                    card.innerHTML = `
                        <img src="${avatarUrl}" 
                             alt="${instructor.name}" 
                             style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;"
                             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(instructor.name)}'">
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-weight: 600;">${instructor.name}</h4>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">
                                ${instructor.expertise?.join(', ') || 'General Mentorship'}
                            </p>
                            <small>From ‚Ç¶${instructor.hourlyRate || 5000}/hour</small>
                        </div>
                    `;
                    
                    card.onclick = () => selectMentorForMember(instructor.id, instructor.name, card);
                    card.onmouseover = () => {
                        card.style.backgroundColor = 'var(--hover-bg)';
                        card.style.transform = 'translateX(5px)';
                    };
                    card.onmouseout = () => {
                        if (!card.classList.contains('active')) {
                            card.style.backgroundColor = '';
                            card.style.transform = '';
                        }
                    };
                    
                    instructorList.appendChild(card);
                }
            } catch (error) {
                console.error('Error loading mentors:', error);
                instructorList.innerHTML = '<p>Error loading mentors. Please refresh the page.</p>';
            }
        }

        async function selectMentorForMember(instructorId, instructorName, cardElement) {
            selectedInstructorId = instructorId;
            
            // Update UI
            document.querySelectorAll('.instructor-card').forEach(c => {
                c.classList.remove('active');
                c.style.backgroundColor = '';
                c.style.borderColor = 'transparent';
                c.style.transform = '';
            });
            cardElement.classList.add('active');
            cardElement.style.backgroundColor = 'var(--hover-bg)';
            cardElement.style.borderColor = 'var(--color-primary)';
            cardElement.style.boxShadow = '0 2px 10px rgba(179, 139, 0, 0.2)';
            
            document.getElementById('memberBookingTitle').textContent = `Booking with ${instructorName}`;

            // Load instructor's available slots
            try {
                console.log('üîç Loading slots for instructor:', instructorId);
                
                // For testing, create mock availability data if Firebase fails
                if (!firebaseInitialized) {
                    console.log('üìÖ Using mock availability data');
                    const mockEvents = [
                        {
                            id: 'mock-1',
                            title: 'Available',
                            start: new Date().toISOString().split('T')[0] + 'T09:00:00',
                            backgroundColor: '#28a745',
                            borderColor: '#28a745',
                            extendedProps: { available: true, timeSlot: '09:00' }
                        },
                        {
                            id: 'mock-2', 
                            title: 'Available',
                            start: new Date().toISOString().split('T')[0] + 'T14:00:00',
                            backgroundColor: '#28a745',
                            borderColor: '#28a745',
                            extendedProps: { available: true, timeSlot: '14:00' }
                        }
                    ];
                    
                    if (calendar) {
                        calendar.removeAllEvents();
                        calendar.addEventSource(mockEvents);
                    }
                    return;
                }
                
                const snapshot = await db.collection("mentorshipSlots")
                    .where("instructorId", "==", instructorId)
                    .get();
                
                let events = [];
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.timeSlots && Array.isArray(data.timeSlots)) {
                        data.timeSlots.forEach(timeSlot => {
                            events.push({
                                id: `${docSnap.id}_${timeSlot.time}`,
                                title: `Available - ‚Ç¶${timeSlot.rate}/hr`,
                                start: `${data.date}T${timeSlot.time}`,
                                end: new Date(new Date(`${data.date}T${timeSlot.time}`).getTime() + 45 * 60000).toISOString(),
                                extendedProps: { 
                                    slotDocId: docSnap.id, 
                                    timeSlot: timeSlot.time, 
                                    instructorName,
                                    hourlyRate: timeSlot.rate
                                }
                            });
                        });
                    }
                });

                // Filter out already booked sessions
                const bookingsSnapshot = await db.collection("bookings")
                    .where("instructorId", "==", instructorId)
                    .get();
                const bookedSlots = new Set(
                    bookingsSnapshot.docs.map(d => `${d.data().slotDocId}_${d.data().timeSlot}`)
                );
                
                const availableEvents = events.filter(event => !bookedSlots.has(event.id));

                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(availableEvents);
                }
            } catch (error) {
                console.error('Error loading mentor availability:', error);
            }
        }

        async function handleMemberEventClick(info) {
            const { slotDocId, timeSlot, instructorName, hourlyRate } = info.event.extendedProps;
            const startTime = info.event.start;

            // Simple booking for now - will add agreement modal later
            if (confirm(`Book session with ${instructorName} at ${startTime.toLocaleString()} for ‚Ç¶${hourlyRate}/hour?`)) {
                try {
                    await db.collection("bookings").add({
                        studentId: currentUser.uid,
                        studentName: currentUserData.name,
                        instructorId: selectedInstructorId,
                        instructorName: instructorName,
                        slotDocId: slotDocId,
                        timeSlot: timeSlot,
                        startTime: firebase.firestore.Timestamp.fromDate(startTime),
                        hourlyRate: hourlyRate,
                        status: 'negotiating',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    alert('Booking request sent! The instructor will review and confirm.');
                    
                    // Refresh calendar
                    selectMentorForMember(selectedInstructorId, instructorName, 
                        document.querySelector(`[data-instructor-id="${selectedInstructorId}"]`));
                } catch (error) {
                    console.error('Error creating booking:', error);
                    alert('Failed to create booking. Please try again.');
                }
            }
        }

        function loadMemberSessions() {
            const sessionsList = document.getElementById('memberSessionsList');
            
            if (!currentUser) return;
            
            try {
                let q = db.collection("bookings").where("studentId", "==", currentUser.uid);
                
                // Try to add orderBy if available (real Firebase)
                if (firebaseInitialized && typeof q.orderBy === 'function') {
                    q = q.orderBy("createdAt", "desc");
                }
                
                q.onSnapshot((snapshot) => {
                    sessionsList.innerHTML = snapshot.empty ? '<p>You have no sessions yet.</p>' : '';
                    
                    snapshot.forEach(docSnap => {
                        const session = { id: docSnap.id, ...docSnap.data() };
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'session-card';
                        sessionEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        // Handle mock data vs real Firebase data
                        const sessionDate = session.startTime?.toDate ? session.startTime.toDate() : new Date();
                        const statusClass = `status-${session.status || 'pending'}`;
                        
                        sessionEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${session.instructorName || 'Instructor'}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Rate: ‚Ç¶${session.hourlyRate || 5000}/hour</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="session-status ${statusClass}" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    ${session.status || 'pending'}
                                </span>
                                <button class="btn btn-info btn-sm" onclick="openChat('${session.id}', '${session.instructorId}', '${session.instructorName}')">
                                    <i class="fas fa-comments"></i> Chat
                                </button>
                            </div>
                        `;
                        sessionsList.appendChild(sessionEl);
                    });
                });
            } catch (error) {
                console.error('Error loading member sessions:', error);
                sessionsList.innerHTML = '<p>Error loading sessions. Please refresh the page.</p>';
            }
        }

        // Instructor Functions
        function initializeInstructor() {
            generateTimeSlots();
            loadInstructorBookings();
            loadCompletedSessions();
        }

        function generateTimeSlots() {
            const grid = document.getElementById('timeSlotGrid');
            if (!grid) {
                // Create time slot grid if it doesn't exist
                const availabilityTab = document.getElementById('availability-tab');
                const saveButton = availabilityTab.querySelector('.btn-primary');
                const timeSlotContainer = document.createElement('div');
                timeSlotContainer.innerHTML = `
                    <div class="form-group">
                        <label>Available Time Slots:</label>
                        <div class="availability-grid" id="timeSlotGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <!-- Time slots will be generated here -->
                        </div>
                    </div>
                `;
                saveButton.parentNode.insertBefore(timeSlotContainer, saveButton);
            }
            
            const timeSlotGrid = document.getElementById('timeSlotGrid');
            const timeSlots = [
                '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', 
                '15:00', '16:00', '17:00', '18:00', '19:00'
            ];
            
            timeSlotGrid.innerHTML = '';
            timeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                slot.dataset.time = time;
                slot.style.cssText = `
                    padding: 0.8rem;
                    border: 2px dashed var(--border-color);
                    border-radius: 8px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                `;
                slot.onclick = () => toggleTimeSlot(slot);
                slot.onmouseover = () => {
                    if (!slot.classList.contains('selected')) {
                        slot.style.borderColor = 'var(--color-primary)';
                        slot.style.backgroundColor = 'var(--hover-bg)';
                    }
                };
                slot.onmouseout = () => {
                    if (!slot.classList.contains('selected')) {
                        slot.style.borderColor = 'var(--border-color)';
                        slot.style.backgroundColor = '';
                    }
                };
                timeSlotGrid.appendChild(slot);
            });
        }

        function toggleTimeSlot(slot) {
            slot.classList.toggle('selected');
            if (slot.classList.contains('selected')) {
                slot.style.borderColor = 'var(--color-primary)';
                slot.style.backgroundColor = 'rgba(179, 139, 0, 0.1)';
            } else {
                slot.style.borderColor = 'var(--border-color)';
                slot.style.backgroundColor = '';
            }
        }

        function loadInstructorBookings() {
            console.log('üîç Loading instructor bookings for:', currentUser?.uid);
            const bookingsList = document.getElementById('instructorBookingsList');
            
            if (!currentUser) {
                console.log('‚ùå No current user for instructor bookings');
                return;
            }
            
            if (!bookingsList) {
                console.log('‚ùå instructorBookingsList element not found');
                return;
            }
            
            try {
                // Query directly for this instructor's bookings (no need to get all first)
                let q = db.collection("bookings").where("instructorId", "==", currentUser.uid);
                
                console.log('üéØ Querying bookings for instructor:', currentUser.uid);
                
                q.onSnapshot((snapshot) => {
                    console.log(`üìã Found ${snapshot.size} bookings for instructor`);
                    
                    if (snapshot.empty) {
                        bookingsList.innerHTML = '<p>No bookings yet.</p>';
                        console.log('üìù No bookings found for this instructor');
                        return;
                    }
                    
                    bookingsList.innerHTML = '';
                    
                    snapshot.forEach(docSnap => {
                        const booking = { id: docSnap.id, ...docSnap.data() };
                        console.log('‚úÖ Processing booking:', booking);
                        
                        const bookingEl = document.createElement('div');
                        bookingEl.className = 'session-card';
                        bookingEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        const sessionDate = booking.sessionDate?.toDate ? booking.sessionDate.toDate() : 
                                          booking.startTime?.toDate ? booking.startTime.toDate() : 
                                          booking.createdAt?.toDate ? booking.createdAt.toDate() : new Date();
                        const statusClass = `status-${booking.status || 'negotiating'}`;
                        
                        bookingEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${booking.studentName || 'Student'}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Rate: ‚Ç¶${booking.hourlyRate || 5000}/hour</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">Time: ${booking.timeSlot || 'TBD'}</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <span class="session-status ${statusClass}" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    ${booking.status || 'negotiating'}
                                </span>
                                <button class="btn btn-info btn-sm" onclick="openChat('${booking.id}', '${booking.studentId}', '${booking.studentName || 'Student'}')" style="background: linear-gradient(45deg, #667eea, #764ba2); border: none; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                                    <i class="fas fa-comments"></i> Chat
                                </button>
                                ${(booking.status === 'negotiating' || !booking.status) ? `
                                    <button class="btn btn-success btn-sm" onclick="confirmBooking('${booking.id}')">
                                        <i class="fas fa-check"></i> Confirm
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectBooking('${booking.id}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                ` : ''}
                                ${booking.status === 'confirmed' ? `
                                    <button class="btn btn-success btn-sm" onclick="markSessionComplete('${booking.id}')">
                                        <i class="fas fa-check-circle"></i> Complete
                                    </button>
                                ` : ''}
                            </div>
                        `;
                        bookingsList.appendChild(bookingEl);
                    });
                });
            } catch (error) {
                console.error('Error loading instructor bookings:', error);
                bookingsList.innerHTML = '<p>Error loading bookings. Please refresh the page.</p>';
            }
        }

        // Booking management functions for instructors
        window.confirmBooking = async function(bookingId) {
            try {
                await db.collection("bookings").doc(bookingId).update({
                    status: 'confirmed',
                    confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Booking confirmed successfully!', 'success');
                
                // Send system message to chat
                const booking = await db.collection("bookings").doc(bookingId).get();
                if (booking.exists) {
                    const bookingData = booking.data();
                    await db.collection("chats").add({
                        sessionId: bookingId,
                        senderId: 'system',
                        senderName: 'System',
                        text: `‚úÖ Session confirmed by instructor. Looking forward to our mentorship session!`,
                        messageType: 'system',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Error confirming booking:', error);
                showNotification('Failed to confirm booking. Please try again.', 'error');
            }
        };

        window.rejectBooking = async function(bookingId) {
            try {
                console.log('üö´ Rejecting booking:', bookingId);
                console.log('üë§ Current user:', currentUser?.uid);
                console.log('üìã Current user data:', currentUserData);
                console.log('üé≠ User role:', currentUserData?.role);
                
                // Get the booking first to check permissions
                const bookingDoc = await db.collection("bookings").doc(bookingId).get();
                if (!bookingDoc.exists) {
                    throw new Error('Booking not found');
                }
                
                const bookingData = bookingDoc.data();
                console.log('üìÑ Booking data:', bookingData);
                console.log('üéØ Instructor ID:', bookingData.instructorId);
                console.log('üîç Is current user the instructor?', bookingData.instructorId === currentUser?.uid);
                
                await db.collection("bookings").doc(bookingId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Booking rejected.', 'info');
                
                // Send system message to chat
                await db.collection("chats").add({
                    sessionId: bookingId,
                    senderId: 'system',
                    senderName: 'System',
                    text: `‚ùå Session request declined. Please feel free to book another available slot.`,
                    messageType: 'system',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('Error rejecting booking:', error);
                console.error('Error details:', error.message);
                showNotification('Failed to reject booking. Please try again.', 'error');
            }
        };

        window.markSessionComplete = async function(bookingId) {
            try {
                await db.collection("bookings").doc(bookingId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Session marked as completed!', 'success');
                
                // Send system message to chat
                await db.collection("chats").add({
                    sessionId: bookingId,
                    senderId: 'system',
                    senderName: 'System',
                    text: `üéâ Session completed successfully! Thank you for the mentorship.`,
                    messageType: 'system',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error completing session:', error);
                showNotification('Failed to mark session as complete. Please try again.', 'error');
            }
        };

        function loadCompletedSessions() {
            const completedList = document.getElementById('completedSessionsList');
            
            if (!currentUser) return;
            
            try {
                let q = db.collection("bookings").where("instructorId", "==", currentUser.uid);
                
                if (firebaseInitialized) {
                    q = q.where("status", "==", "completed");
                    if (typeof q.orderBy === 'function') {
                        q = q.orderBy("completedAt", "desc");
                    }
                }
                
                q.onSnapshot((snapshot) => {
                    completedList.innerHTML = snapshot.empty ? '<p>No completed sessions yet.</p>' : '';
                    
                    snapshot.forEach(docSnap => {
                        const session = { id: docSnap.id, ...docSnap.data() };
                        const sessionEl = document.createElement('div');
                        sessionEl.className = 'session-card';
                        sessionEl.style.cssText = `
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1.5rem;
                            border: 1px solid var(--border-color);
                            border-radius: 12px;
                            margin-bottom: 1rem;
                            transition: all 0.3s;
                        `;
                        
                        const sessionDate = session.startTime?.toDate ? session.startTime.toDate() : new Date();
                        const finalAmount = session.finalAmount || session.hourlyRate || 5000;
                        const earnings = Math.round(finalAmount * 0.9); // 90% after platform fee
                        
                        sessionEl.innerHTML = `
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${sessionDate.toLocaleString()}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">with ${session.studentName || 'Student'}</p>
                                <p style="margin: 0; color: var(--success-color); font-size: 0.9rem; font-weight: 600;">Earned: ‚Ç¶${earnings.toLocaleString()}</p>
                                <div style="color: var(--warning-color); font-size: 0.8rem;">
                                    Rating: ${'‚òÖ'.repeat(session.rating || 5)} ${session.rating || 5}/5
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="session-status status-completed" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                    Completed
                                </span>
                            </div>
                        `;
                        completedList.appendChild(sessionEl);
                    });
                });
            } catch (error) {
                console.error('Error loading completed sessions:', error);
                completedList.innerHTML = '<p>Error loading completed sessions. Please refresh the page.</p>';
            }
        }

        function initializeAdmin() {
            loadAdminStatistics();
            loadAllTransactions();
            loadAllMentors();
        }

        async function loadAdminStatistics() {
            try {
                // Get all completed bookings
                const completedSnapshot = await db.collection("bookings")
                    .where("status", "==", "completed")
                    .get();
                
                let totalCommission = 0;
                completedSnapshot.forEach(doc => {
                    const booking = doc.data();
                    totalCommission += Math.round((booking.finalAmount || booking.hourlyRate) * 0.1); // 10% commission
                });
                
                // Get pending sessions
                const pendingSnapshot = await db.collection("bookings")
                    .where("status", "in", ["negotiating", "confirmed"])
                    .get();
                
                // Update admin stats display
                const statsContainer = document.getElementById('adminStats');
                statsContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--color-primary), #d4af37); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">‚Ç¶${totalCommission.toLocaleString()}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Commission Earned</p>
                        </div>
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--info-color), #20c997); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">${completedSnapshot.size}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Total Sessions Completed</p>
                        </div>
                        <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, var(--warning-color), #f39c12); color: white; border-radius: 12px;">
                            <h3 style="font-size: 2.5rem; margin: 0;">${pendingSnapshot.size}</h3>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Pending Sessions</p>
                        </div>
                    </div>
                    
                    <div class="tab-nav" style="margin-bottom: 2rem;">
                        <button class="tab-btn active" onclick="switchAdminTab('transactions')">
                            <i class="fas fa-money-bill-wave"></i> Transactions
                        </button>
                        <button class="tab-btn" onclick="switchAdminTab('mentors')">
                            <i class="fas fa-users"></i> Mentors
                        </button>
                    </div>
                    
                    <div id="admin-transactions-tab" class="admin-tab-content active">
                        <h3 style="color: var(--color-secondary); margin-bottom: 1rem;">All Transactions</h3>
                        <div id="adminTransactionsList">
                            <p>Loading transactions...</p>
                        </div>
                    </div>
                    
                    <div id="admin-mentors-tab" class="admin-tab-content" style="display: none;">
                        <h3 style="color: var(--color-secondary); margin-bottom: 1rem;">Mentor Management</h3>
                        <div id="adminMentorsList">
                            <p>Loading mentors...</p>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading admin statistics:', error);
            }
        }

        function loadAvailableMentors() {
            console.log('üîç Loading mentors, Firebase initialized:', firebaseInitialized);
            const mentorsGrid = document.getElementById('memberInstructorList');
            if (!mentorsGrid) {
                console.error('‚ùå memberInstructorList element not found');
                return;
            }

            // Enhanced demo data with professional mentors and expertise tags
            const demoMentors = [
                {
                    id: 'demo1',
                    name: 'Dr. Sarah Johnson',
                    expertise: 'Career Development & Leadership',
                    bio: 'Former Fortune 500 executive with 15+ years experience in leadership development and C-suite transitions.',
                    rating: 4.9,
                    sessions: 127,
                    hourlyRate: 75,
                    avatar: 'https://ui-avatars.com/api/?name=Sarah+Johnson&background=667eea&color=fff&size=150',
                    expertiseTags: ['Leadership', 'Career Growth', 'Executive Coaching', 'Team Management', 'Performance Review'],
                    languages: ['English', 'Spanish'],
                    availability: 'Mon-Fri 9AM-5PM EST',
                    responseTime: '< 2 hours',
                    totalReviews: 142,
                    achievements: ['Top 1% Mentor', 'Leadership Expert', 'Career Catalyst'],
                    publications: ['The Executive Mindset', 'Career Acceleration Strategies']
                },
                {
                    id: 'demo2',
                    name: 'Michael Chen',
                    expertise: 'Tech & Software Engineering',
                    bio: 'Senior Software Architect at Google, specializing in system design and career growth in tech.',
                    rating: 4.8,
                    sessions: 89,
                    hourlyRate: 85,
                    avatar: 'https://ui-avatars.com/api/?name=Michael+Chen&background=10b981&color=fff&size=150',
                    expertiseTags: ['System Design', 'Software Architecture', 'Tech Career', 'Code Review', 'Team Leadership'],
                    languages: ['English', 'Mandarin'],
                    availability: 'Tue-Thu 2PM-8PM EST',
                    responseTime: '< 4 hours',
                    totalReviews: 76,
                    achievements: ['Tech Excellence', 'System Design Expert', 'Code Mentor'],
                    publications: ['Scalable System Design', 'The Tech Career Guide']
                },
                {
                    id: 'demo3',
                    name: 'Emily Rodriguez',
                    expertise: 'Business Strategy & Entrepreneurship',
                    bio: 'Serial entrepreneur and business consultant, helped launch 20+ successful startups with $50M+ exits.',
                    rating: 4.9,
                    sessions: 156,
                    hourlyRate: 95,
                    avatar: 'https://ui-avatars.com/api/?name=Emily+Rodriguez&background=f59e0b&color=fff&size=150',
                    expertiseTags: ['Startup Strategy', 'Fundraising', 'Product-Market Fit', 'Scaling', 'Exit Strategy'],
                    languages: ['English', 'Portuguese'],
                    availability: 'Mon-Wed 10AM-6PM EST',
                    responseTime: '< 1 hour',
                    totalReviews: 187,
                    achievements: ['Startup Unicorn', 'Funding Expert', 'Exit Specialist'],
                    publications: ['Zero to Unicorn Playbook', 'Fundraising Secrets']
                }
            ];

            function displayMentors(mentors, source = 'demo') {
                mentorsGrid.innerHTML = mentors.map(mentor => `
                    <div class="mentor-card" onclick="selectMentor('${mentor.id}')" style="
                        background: white;
                        border: 1px solid #e0e0e0;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 16px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <img src="${mentor.avatar}" alt="${mentor.name}" style="
                                width: 50px;
                                height: 50px;
                                border-radius: 50%;
                                margin-right: 15px;
                                object-fit: cover;
                            ">
                            <div>
                                <h3 style="margin: 0; color: #1a1a1a; font-size: 18px; font-weight: 600;">${mentor.name}</h3>
                                <p style="margin: 4px 0 0 0; color: #6366f1; font-size: 14px; font-weight: 500;">${mentor.expertise}</p>
                            </div>
                        </div>
                        <p style="margin: 0 0 12px 0; color: #666; font-size: 14px; line-height: 1.4;">${mentor.bio}</p>
                        
                        ${mentor.expertiseTags ? `
                        <div style="margin-bottom: 12px;">
                            ${mentor.expertiseTags.slice(0, 3).map(tag => `
                                <span style="
                                    display: inline-block;
                                    background: linear-gradient(135deg, #667eea, #764ba2);
                                    color: white;
                                    padding: 4px 8px;
                                    border-radius: 12px;
                                    font-size: 11px;
                                    font-weight: 500;
                                    margin-right: 6px;
                                    margin-bottom: 4px;
                                ">${tag}</span>
                            `).join('')}
                            ${mentor.expertiseTags.length > 3 ? `<span style="color: #888; font-size: 11px;">+${mentor.expertiseTags.length - 3} more</span>` : ''}
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px; font-size: 12px;">
                                <span style="color: #f59e0b;">‚≠ê ${mentor.rating}</span>
                                <span style="color: #888;">${mentor.totalReviews || mentor.sessions} reviews</span>
                                ${mentor.responseTime ? `<span style="color: #10b981;">üïí ${mentor.responseTime}</span>` : ''}
                            </div>
                            <span style="color: #10b981; font-weight: 600; font-size: 14px;">‚Ç¶${mentor.hourlyRate * 100}/hr</span>
                        </div>
                        
                        ${mentor.achievements ? `
                        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                            ${mentor.achievements.slice(0, 2).map(achievement => `
                                <span style="
                                    background: rgba(16, 185, 129, 0.1);
                                    color: #059669;
                                    padding: 2px 6px;
                                    border-radius: 8px;
                                    font-size: 10px;
                                    font-weight: 600;
                                ">üèÜ ${achievement}</span>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        ${mentor.languages ? `
                        <div style="font-size: 11px; color: #666; margin-top: 8px;">
                            <span>üåê ${mentor.languages.join(', ')}</span>
                            ${mentor.availability ? `<span style="margin-left: 12px;">üìÖ ${mentor.availability}</span>` : ''}
                        </div>
                        ` : ''}
                    </div>
                `).join('');
                console.log(`üìã Displaying ${mentors.length} mentors from ${source}`);
            }

            // Always show demo data first for immediate UI feedback
            displayMentors(demoMentors, 'demo (loading...)');

            // Then try to load real data if Firebase is available
            if (firebaseInitialized && db) {
                console.log('üî• Loading mentors from Firestore...');
                
                // First try to get all users and filter for instructors
                db.collection("users").get()
                    .then(snapshot => {
                        console.log(`üìä Found ${snapshot.size} total users in database`);
                        
                        if (!snapshot.empty) {
                            const mentors = [];
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                console.log(`üë§ User ${doc.id}:`, data);
                                
                                // Check if user is an instructor (flexible field checking)
                                const isInstructor = data.role === 'instructor' || 
                                                   data.userType === 'instructor' || 
                                                   data.type === 'instructor' ||
                                                   data.accountType === 'instructor';
                                
                                if (isInstructor) {
                                    console.log(`‚úÖ Found instructor: ${data.name || data.displayName || doc.id}`);
                                    mentors.push({
                                        id: doc.id,
                                        name: data.name || data.displayName || data.firstName || 'Unknown Mentor',
                                        expertise: data.expertise || data.specialization || data.skills || 'General Mentoring',
                                        bio: data.bio || data.description || data.about || 'Experienced mentor ready to help you grow.',
                                        rating: data.rating || 4.5,
                                        sessions: data.completedSessions || data.totalSessions || 0,
                                        hourlyRate: data.hourlyRate || data.rate || 50,
                                        avatar: data.avatar || data.photoURL || data.profileImage || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2MzY2RjEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K'
                                    });
                                }
                            });
                            
                            if (mentors.length > 0) {
                                console.log(`üéØ Found ${mentors.length} instructors to display`);
                                displayMentors(mentors, 'Firestore');
                            } else {
                                console.log('üìù No instructors found in users collection, keeping demo data');
                                displayMentors(demoMentors, 'demo (no instructors found)');
                            }
                        } else {
                            console.log('üìù No users found in Firestore, keeping demo data');
                            displayMentors(demoMentors, 'demo (no users data)');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error loading users from Firestore:', error);
                        displayMentors(demoMentors, 'demo (Firestore error)');
                    });
            } else {
                console.log('üìù Firebase not initialized, keeping demo data');
            }
        }

        // Add selectMentor function
        window.selectMentor = async function(mentorId) {
            console.log('üéØ Selected mentor:', mentorId);
            
            // Store selected mentor ID globally for booking
            window.selectedMentorId = mentorId;
            
            try {
                // Check if instructor has available mentorship slots
                const slotsQuery = await db.collection("mentorshipSlots")
                    .where("instructorId", "==", mentorId)
                    .get();
                
                if (slotsQuery.empty) {
                    showNotification('Instructor is not available for now. Try again later.', 'warning');
                    return;
                }
                
                // Load mentor's available time slots into calendar
                const events = [];
                slotsQuery.forEach(doc => {
                    const slotData = doc.data();
                    if (slotData.timeSlots && Array.isArray(slotData.timeSlots)) {
                        slotData.timeSlots.forEach(slot => {
                            const eventDate = new Date(slotData.date + 'T' + slot.time);
                            events.push({
                                title: `Available - $${slot.rate}/hr`,
                                start: eventDate,
                                end: new Date(eventDate.getTime() + 60 * 60 * 1000), // 1 hour
                                backgroundColor: '#10b981',
                                borderColor: '#059669',
                                extendedProps: {
                                    available: true,
                                    mentorId: mentorId,
                                    timeSlot: slot,
                                    rate: slot.rate
                                }
                            });
                        });
                    }
                });
                
                if (events.length === 0) {
                    showNotification('Instructor has no available time slots. Try again later.', 'warning');
                    return;
                }
                
                // Update calendar with mentor's availability
                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                    showNotification(`Showing ${events.length} available slots for this instructor`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading mentor availability:', error);
                showNotification('Error loading instructor availability. Try again later.', 'error');
            }
        };

        // Add notification system
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.slide-notification');
            if (existing) existing.remove();
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'slide-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: -400px;
                width: 350px;
                background: ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#6366f1'};
                color: white;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                transition: right 0.3s ease;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            notification.querySelector('.notification-content').style.cssText = `
                display: flex;
                align-items: center;
                padding: 16px;
                gap: 12px;
            `;
            
            notification.querySelector('.notification-message').style.cssText = `
                flex: 1;
                font-size: 14px;
                font-weight: 500;
            `;
            
            notification.querySelector('.notification-close').style.cssText = `
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background-color 0.2s;
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Slide in
            setTimeout(() => {
                notification.style.right = '20px';
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.right = '-400px';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Enhanced booking system that allows multiple concurrent bookings
        window.bookSession = async function(timeSlot, eventStart) {
            console.log('üìÖ Booking session:', timeSlot, eventStart);
            
            try {
                // Get proper student name from user data
                const studentName = currentUserData?.displayName || 
                                  currentUserData?.name || 
                                  currentUserData?.email?.split('@')[0] || 
                                  'Student';
                
                // Generate unique booking ID for this specific request
                const bookingId = `${timeSlot.mentorId || window.selectedMentorId}_${eventStart.getTime()}_${currentUser.uid}_${Date.now()}`;
                
                // Create booking request with unique identifier
                const bookingData = {
                    bookingId: bookingId,
                    studentId: currentUser.uid,
                    studentName: studentName,
                    instructorId: timeSlot.mentorId || window.selectedMentorId || 'unknown',
                    sessionDate: eventStart,
                    timeSlot: timeSlot.time,
                    hourlyRate: timeSlot.rate || 50,
                    status: 'negotiating',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    message: 'I would like to book this mentorship session.',
                    slotId: `${timeSlot.mentorId || window.selectedMentorId}_${eventStart.getTime()}` // For tracking multiple bookings on same slot
                };
                
                // Add booking to Firestore (allows multiple bookings for same time slot)
                const bookingRef = await db.collection("bookings").add(bookingData);
                console.log('üìã Booking created with ID:', bookingRef.id, 'Data:', bookingData);
                
                showNotification('Session booking request sent! The instructor can accept multiple students for this time slot.', 'success');
                
                // Update calendar to show booking status without querying (to avoid permissions issues)
                if (calendar) {
                    const events = calendar.getEvents();
                    events.forEach(event => {
                        if (event.start.getTime() === eventStart.getTime()) {
                            // Get current pending count from event properties
                            const currentPending = event.extendedProps.pendingBookings || 0;
                            const newPendingCount = currentPending + 1;
                            
                            // Update title to show booking count
                            const baseTitle = event.title.replace(/ \(\d+ pending\)| \(\d+ booked\)/g, '');
                            event.setProp('title', `${baseTitle} (${newPendingCount} pending)`);
                            
                            // Color coding based on booking count
                            if (newPendingCount === 1) {
                                event.setProp('backgroundColor', '#f59e0b'); // Orange for 1 booking
                                event.setProp('borderColor', '#d97706');
                            } else if (newPendingCount >= 2) {
                                event.setProp('backgroundColor', '#ef4444'); // Red for multiple bookings
                                event.setProp('borderColor', '#dc2626');
                            }
                            
                            // Keep slot available for more bookings
                            event.setExtendedProp('pendingBookings', newPendingCount);
                            event.setExtendedProp('available', true); // Always keep available
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error booking session:', error);
                showNotification('Failed to book session. Please try again.', 'error');
            }
        };

function loadCompletedSessions() {
    const completedList = document.getElementById('completedSessionsList');

    if (!currentUser) return;

    try {
        let q = db.collection("bookings").where("instructorId", "==", currentUser.uid);

        if (firebaseInitialized) {
            q = q.where("status", "==", "completed");
            if (typeof q.orderBy === 'function') {
                q = q.orderBy("completedAt", "desc");
            }
        }
        
        q.onSnapshot((snapshot) => {
            completedList.innerHTML = snapshot.empty ? '<p>No completed sessions yet.</p>' : '';
            
            snapshot.forEach(docSnap => {
                const session = { id: docSnap.id, ...docSnap.data() };
                const sessionEl = document.createElement('div');
                sessionEl.className = 'session-card';
                sessionEl.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 1.5rem;
                    border: 1px solid var(--border-color);
                    border-radius: 12px;
                    margin-bottom: 1rem;
                    transition: all 0.3s;
                `;
                
                const completedDate = session.completedAt?.toDate ? session.completedAt.toDate() : new Date();
                const finalAmount = session.finalAmount || session.hourlyRate || 5000;
                
                sessionEl.innerHTML = `
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">Session with ${session.studentName || 'Student'}</h4>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Completed: ${completedDate.toLocaleString()}</p>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; font-weight: 600;">Earned: ‚Ç¶${Math.round(finalAmount * 0.9).toLocaleString()}</p>
                    </div>
                    <div style="text-align: right;">
                        <span class="session-status status-completed" style="padding: 0.25rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                            Completed
                        </span>
                    </div>
                `;
                completedList.appendChild(sessionEl);
            });
        });
    } catch (error) {
        console.error('Error loading completed sessions:', error);
        completedList.innerHTML = '<p>Error loading sessions. Please refresh the page.</p>';
    }
}

        async function loadAllMentors() {
            const mentorsList = document.getElementById('adminMentorsList');
            
            try {
                const snapshot = await db.collection("users").where("role", "==", "instructor").get();
                mentorsList.innerHTML = '';
                
                for (const docSnap of snapshot.docs) {
                    const mentor = { id: docSnap.id, ...docSnap.data() };
                    
                    // Get mentor statistics
                    const sessionsSnap = await db.collection("bookings")
                        .where("instructorId", "==", mentor.id)
                        .where("status", "==", "completed")
                        .get();
                    
                    let totalEarnings = 0;
                    sessionsSnap.forEach(doc => {
                        const finalAmount = doc.data().finalAmount || doc.data().hourlyRate;
                        totalEarnings += Math.round(finalAmount * 0.9);
                    });
                    
                    const mentorEl = document.createElement('div');
                    mentorEl.className = 'session-card';
                    mentorEl.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.5rem;
                        border: 1px solid var(--border-color);
                        border-radius: 12px;
                        margin-bottom: 1rem;
                        transition: all 0.3s;
                    `;
                    
                    mentorEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <img src="${mentor.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(mentor.name)}`}" 
                                 alt="${mentor.name}" 
                                 style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--color-secondary);">${mentor.name}</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${mentor.email}</p>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Expertise: ${mentor.expertise?.join(', ') || 'Not specified'}</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Completed Sessions: ${sessionsSnap.size}</p>
                            <p style="margin: 0; color: var(--success-color); font-size: 0.9rem; font-weight: 600;">Total Earnings: ‚Ç¶${totalEarnings.toLocaleString()}</p>
                            <button class="btn btn-info btn-sm" onclick="viewMentorDetails('${mentor.id}')" style="margin-top: 0.5rem;">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    `;
                    mentorsList.appendChild(mentorEl);
                }
            } catch (error) {
                console.error('Error loading mentors:', error);
                mentorsList.innerHTML = '<p>Error loading mentors. Please refresh the page.</p>';
            }
        }

        window.switchAdminTab = function(tabName) {
            // Update active tab button
            document.querySelectorAll('#adminStats .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all admin tab contents
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(`admin-${tabName}-tab`);
            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
            }
        };

        window.viewMentorDetails = function(mentorId) {
            console.log('Viewing mentor details for:', mentorId);
            // Could open a detailed modal or navigate to mentor profile
        };

        function updateSidebarConversations() {
            const sidebarConversations = document.getElementById('sidebarConversations');
            
            if (!currentUser || !currentUserData) return;
            
            // Query for active sessions/conversations
            const q = db.collection("bookings")
                .where(currentUserData.role === 'instructor' ? "instructorId" : "studentId", "==", currentUser.uid)
                .where("status", "in", ["confirmed", "negotiating", "completed"]);
            
            q.onSnapshot((snapshot) => {
                sidebarConversations.innerHTML = '';
                
                if (snapshot.empty) {
                    sidebarConversations.innerHTML = `
                        <div class="conversation-item">
                            <img src="https://ui-avatars.com/api/?name=No+Chat&background=ddd&color=999&size=40" alt="Avatar" class="conversation-avatar">
                            <div>
                                <p style="margin: 0; font-weight: 600;">No active chats</p>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary);">Start a session to begin chatting</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const session = { id: docSnap.id, ...docSnap.data() };
                    const isInstructor = currentUserData.role === 'instructor';
                    const partnerName = isInstructor ? session.studentName : session.instructorName;
                    
                    const conversationEl = document.createElement('div');
                    conversationEl.className = 'conversation-item';
                    conversationEl.onclick = () => openChat(session.id, isInstructor ? session.studentId : session.instructorId, partnerName);
                    
                    conversationEl.innerHTML = `
                        <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(partnerName)}&size=40" alt="${partnerName}" class="conversation-avatar">
                        <div>
                            <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">${partnerName}</p>
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary);">Mentorship Session</p>
                        </div>
                    `;
                    
                    sidebarConversations.appendChild(conversationEl);
                });
            });
        }

        window.saveAvailability = async function() {
            const date = document.getElementById('availabilityDate').value;
            const hourlyRate = parseInt(document.getElementById('hourlyRate').value);
            const selectedSlots = document.querySelectorAll('.time-slot.selected');
            
            if (!date || !hourlyRate || selectedSlots.length === 0) {
                alert('Please fill all fields and select at least one time slot.');
                return;
            }

            if (hourlyRate < 1000) {
                alert('Minimum hourly rate is ‚Ç¶1,000.');
                return;
            }

            const timeSlots = Array.from(selectedSlots).map(slot => ({
                time: slot.dataset.time,
                rate: hourlyRate
            }));

            try {
                await db.collection("mentorshipSlots").doc(`${currentUser.uid}_${date}`).set({
                    instructorId: currentUser.uid,
                    date: date,
                    timeSlots: timeSlots,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Availability saved successfully!');
                
                // Reset form
                document.getElementById('availabilityDate').value = '';
                document.getElementById('hourlyRate').value = '';
                selectedSlots.forEach(slot => {
                    slot.classList.remove('selected');
                    slot.style.borderColor = 'var(--border-color)';
                    slot.style.backgroundColor = '';
                });
                
            } catch (error) {
                console.error('Error saving availability:', error);
                alert('Failed to save availability. Please try again.');
            }
        };

        window.confirmBooking = async function(bookingId) {
            if (confirm('Confirm this booking?')) {
                try {
                    await db.collection("bookings").doc(bookingId).update({
                        status: 'confirmed',
                        confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Booking confirmed!');
                } catch (error) {
                    console.error('Error confirming booking:', error);
                    alert('Failed to confirm booking.');
                }
            }
        };

        window.rejectBooking = async function(bookingId) {
            if (confirm('Reject this booking? This action cannot be undone.')) {
                try {
                    await db.collection("bookings").doc(bookingId).delete();
                    alert('Booking rejected and removed.');
                } catch (error) {
                    console.error('Error rejecting booking:', error);
                    alert('Failed to reject booking.');
                }
            }
        };

        window.markSessionComplete = async function(bookingId) {
            if (confirm('Mark this session as completed?')) {
                try {
                    const bookingDoc = await db.collection("bookings").doc(bookingId).get();
                    const bookingData = bookingDoc.data();
                    
                    await db.collection("bookings").doc(bookingId).update({
                        status: 'completed',
                        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        finalAmount: bookingData.hourlyRate, // 1 hour session
                        rating: 5 // Default rating, can be updated by student later
                    });
                    alert('Session marked as completed!');
                } catch (error) {
                    console.error('Error completing session:', error);
                    alert('Failed to complete session.');
                }
            }
        };

        function openChat(sessionId, partnerId, partnerName) {
            console.log('Opening chat:', sessionId, partnerId, partnerName);
            
            // Show chat sidebar
            const chatSidebar = document.getElementById('chatSidebar');
            const chatMessages = document.getElementById('chatMessages');
            
            if (!chatSidebar) {
                console.error('‚ùå Chat sidebar not found');
                return;
            }
            
            if (!chatMessages) {
                console.error('‚ùå Chat messages container not found');
                return;
            }
            
            // Animate chat sidebar opening
            chatSidebar.style.display = 'flex';
            chatSidebar.style.animation = 'slideInRight 0.3s ease';
            
            // Update active conversation in sidebar
            updateActiveConversation(partnerName);
            
            // Update chat header with user info
            const chatHeader = document.querySelector('.chat-header h3');
            const userAvatar = document.querySelector('.user-avatar');
            const userStatus = document.querySelector('.chat-header p');
            
            if (chatHeader) {
                chatHeader.textContent = `${partnerName || 'User'}`;
            }
            
            if (userAvatar) {
                const initials = (partnerName || 'U').split(' ').map(n => n[0]).join('').toUpperCase();
                userAvatar.textContent = initials;
                userAvatar.style.background = `linear-gradient(45deg, ${getRandomColor()}, ${getRandomColor()})`;
            }
            
            if (userStatus) {
                userStatus.textContent = 'Active Session';
                userStatus.style.color = 'rgba(255,255,255,0.9)';
            }
            
            // Load chat messages
            loadChatMessages(sessionId);
            
            // Set current chat session
            window.currentChatSession = sessionId;
            window.currentChatPartner = { id: partnerId, name: partnerName || 'User' };
            
            // Check for agreement button
            checkForAgreementButton(sessionId);
            
            // Focus on input
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if (chatInput) chatInput.focus();
            }, 300);
        }
        
        // Update active conversation in sidebar
        function updateActiveConversation(partnerName) {
            const conversationItem = document.querySelector('.conversation-item');
            if (conversationItem) {
                const nameElement = conversationItem.querySelector('h4');
                const messageElement = conversationItem.querySelector('p');
                const avatar = conversationItem.querySelector('img');
                
                if (nameElement) nameElement.textContent = partnerName || 'Professional Support';
                if (messageElement) messageElement.textContent = 'Active mentorship session';
                if (avatar) {
                    const initials = (partnerName || 'Support').split(' ').map(n => n[0]).join('');
                    avatar.src = `https://ui-avatars.com/api/?name=${initials}&background=667eea&color=fff&size=45&rounded=true`;
                }
            }
        }
        
        // Helper function for random colors
        function getRandomColor() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function loadChatMessages(sessionId) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            // Listen for real-time chat messages
            db.collection("chats")
                .where("sessionId", "==", sessionId)
                .orderBy("timestamp", "asc")
                .onSnapshot((snapshot) => {
                    chatMessages.innerHTML = '';
                    
                    if (snapshot.empty) {
                        chatMessages.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #666;">
                                <i class="fas fa-comments" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                                <p style="margin: 0; font-size: 1.1rem; font-weight: 500;">No messages yet</p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #999;">Start the conversation!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let lastDate = null;
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        const isCurrentUser = message.senderId === currentUser.uid;
                        const timestamp = message.timestamp?.toDate ? message.timestamp.toDate() : new Date();
                        const messageDate = timestamp.toDateString();
                        
                        // Add date separator if needed
                        if (lastDate !== messageDate) {
                            const dateSeparator = document.createElement('div');
                            dateSeparator.style.cssText = `
                                text-align: center;
                                margin: 1.5rem 0;
                                position: relative;
                            `;
                            dateSeparator.innerHTML = `
                                <span style="
                                    background: rgba(255,255,255,0.9);
                                    padding: 0.3rem 1rem;
                                    border-radius: 15px;
                                    font-size: 0.8rem;
                                    color: #666;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                ">${messageDate === new Date().toDateString() ? 'Today' : messageDate}</span>
                            `;
                            chatMessages.appendChild(dateSeparator);
                            lastDate = messageDate;
                        }
                        
                        const messageEl = document.createElement('div');
                        messageEl.className = `message-bubble ${isCurrentUser ? 'message-sent' : 'message-received'}`;
                        
                        const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const senderName = isCurrentUser ? 'You' : (message.senderName || 'User');
                        
                        messageEl.innerHTML = `
                            <div style="font-size: 0.9rem; line-height: 1.4;">${message.text}</div>
                            <div class="message-time" style="${isCurrentUser ? 'text-align: right;' : 'text-align: left;'}">
                                ${senderName} ‚Ä¢ ${timeString}
                            </div>
                            ${isCurrentUser ? '<div class="message-status"><i class="fas fa-check" style="color: rgba(255,255,255,0.7);"></i></div>' : ''}
                        `;
                        
                        chatMessages.appendChild(messageEl);
                    });
                    
                    // Smooth scroll to bottom
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                });
        }

        function checkForAgreementButton(sessionId) {
            // Get booking details to check status
            db.collection("bookings").doc(sessionId).get().then(doc => {
                if (doc.exists) {
                    const booking = doc.data();
                    const chatInput = document.querySelector('.chat-input');
                    
                    // Remove existing agreement button
                    const existingBtn = document.querySelector('.agreement-button');
                    if (existingBtn) existingBtn.remove();
                    
                    // Show agreement button if booking is confirmed and no agreement exists
                    if (booking.status === 'confirmed' && !booking.agreementSigned) {
                        const agreementBtn = document.createElement('div');
                        agreementBtn.className = 'agreement-button';
                        agreementBtn.innerHTML = `
                            <button onclick="openAgreementForm('${sessionId}')" style="
                                background: linear-gradient(135deg, #10b981, #059669);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                font-weight: 600;
                                cursor: pointer;
                                width: 100%;
                                margin-bottom: 10px;
                                box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
                                transition: all 0.2s ease;
                            " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.3)'">
                                üìù Finalize Agreement & Sign Contract
                            </button>
                        `;
                        
                        chatInput.parentNode.insertBefore(agreementBtn, chatInput);
                    }
                }
            });
        }

        window.openAgreementForm = function(sessionId) {
            // Create agreement modal
            const modal = document.createElement('div');
            modal.className = 'agreement-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeAgreementModal()"></div>
                <div class="modal-content" style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 16px;
                    padding: 2rem;
                    width: 90%;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
                    z-index: 10001;
                ">
                    <h2 style="margin: 0 0 1.5rem 0; color: #1a1a1a;">Mentorship Agreement</h2>
                    
                    <form id="agreementForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Session Duration (hours):</label>
                            <input type="number" id="sessionDuration" min="1" max="8" value="1" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 1rem;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Total Amount (‚Ç¶):</label>
                            <input type="number" id="totalAmount" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 1rem;
                            ">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Session Objectives:</label>
                            <textarea id="sessionObjectives" rows="3" required style="
                                width: 100%;
                                padding: 0.75rem;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                font-size: 1rem;
                                resize: vertical;
                            " placeholder="What do you hope to achieve in this session?"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="agreeTerms" required>
                                <span>I agree to the terms and conditions of this mentorship session</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button type="button" onclick="closeAgreementModal()" style="
                                flex: 1;
                                padding: 0.75rem;
                                border: 1px solid #e0e0e0;
                                background: white;
                                border-radius: 8px;
                                cursor: pointer;
                            ">Cancel</button>
                            <button type="submit" style="
                                flex: 1;
                                padding: 0.75rem;
                                background: #10b981;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">Sign Agreement</button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10000;
            `;
            
            modal.querySelector('.modal-overlay').style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('agreementForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await signAgreement(sessionId);
            });
        };

        window.closeAgreementModal = function() {
            const modal = document.querySelector('.agreement-modal');
            if (modal) modal.remove();
        };

        async function signAgreement(sessionId) {
            try {
                const duration = document.getElementById('sessionDuration').value;
                const amount = document.getElementById('totalAmount').value;
                const objectives = document.getElementById('sessionObjectives').value;
                
                // Update booking with agreement details
                await db.collection("bookings").doc(sessionId).update({
                    agreementSigned: true,
                    sessionDuration: parseInt(duration),
                    finalAmount: parseInt(amount),
                    sessionObjectives: objectives,
                    agreementDate: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'agreed'
                });
                
                // Add system message to chat
                await db.collection("chats").add({
                    sessionId: sessionId,
                    senderId: 'system',
                    senderName: 'System',
                    text: `üìã Agreement signed! Session duration: ${duration}h, Amount: ‚Ç¶${parseInt(amount).toLocaleString()}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: 'system'
                });
                
                closeAgreementModal();
                showNotification('Agreement signed successfully! Session is now finalized.', 'success');
                
            } catch (error) {
                console.error('Error signing agreement:', error);
                showNotification('Failed to sign agreement. Please try again.', 'error');
            }
        }

        // Send chat message function with price detection
        window.sendChatMessage = function() {
            const messageInput = document.getElementById('chatInput');
            const message = messageInput.value.trim();
            
            if (!message || !window.currentChatSession) return;
            
            // Add visual feedback
            const sendButton = document.querySelector('[onclick="sendChatMessage()"]');
            const originalContent = sendButton.innerHTML;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            sendButton.disabled = true;
            
            // Clear input immediately for better UX
            messageInput.value = '';
            
            // Check for price agreement in message
            const priceMatch = message.match(/(?:‚Ç¶|\$|USD|NGN)\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/i) || 
                             message.match(/(\d+(?:,\d{3})*(?:\.\d{2})?)\s*(?:‚Ç¶|naira|dollars?|USD|NGN)/i);
            
            let messageType = 'text';
            let agreedPrice = null;
            
            if (priceMatch && (message.toLowerCase().includes('agree') || message.toLowerCase().includes('accept') || message.toLowerCase().includes('deal'))) {
                messageType = 'price_agreement';
                agreedPrice = priceMatch[1].replace(/,/g, '');
            }
            
            db.collection("chats").add({
                sessionId: window.currentChatSession,
                senderId: currentUser.uid,
                senderName: currentUserData?.displayName || currentUserData?.name || currentUserData?.email?.split('@')[0] || 'User',
                text: message,
                messageType: messageType,
                agreedPrice: agreedPrice,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'sent'
            }).then(() => {
                // Reset button
                sendButton.innerHTML = originalContent;
                sendButton.disabled = false;
                
                // Show payment section if price agreed
                if (messageType === 'price_agreement') {
                    showPaymentSection(agreedPrice);
                    showNotification('Price agreement detected! Payment option available.', 'success');
                } else {
                    showNotification('Message sent!', 'success');
                }
            }).catch(error => {
                console.error('Error sending message:', error);
                // Restore message if failed
                messageInput.value = message;
                sendButton.innerHTML = originalContent;
                sendButton.disabled = false;
                showNotification('Failed to send message. Please try again.', 'error');
            });
        };
        
        // Show payment section when price is agreed
        function showPaymentSection(agreedPrice) {
            const paymentSection = document.getElementById('paymentSection');
            const agreedRateElement = document.getElementById('agreedRate');
            
            if (paymentSection && agreedRateElement) {
                agreedRateElement.textContent = `‚Ç¶${agreedPrice}/hour`;
                paymentSection.style.display = 'block';
                
                // Store agreed price globally
                window.agreedPrice = agreedPrice;
            }
        }
        
        // Initiate payment process
        window.initiatePayment = function() {
            if (!window.agreedPrice) {
                showNotification('No agreed price found', 'error');
                return;
            }
            
            // Here you would integrate with Paystack or your payment provider
            showNotification('Redirecting to payment gateway...', 'info');
            
            // Placeholder for Paystack integration
            setTimeout(() => {
                showNotification('Payment feature will be integrated with Paystack', 'info');
            }, 1000);
        };

        // Goal-based mentor matching functionality
        let selectedGoals = [];

        window.selectGoal = function(goalType) {
            const goalCard = document.querySelector(`[data-goal="${goalType}"]`);
            const clearBtn = document.getElementById('clearGoalsBtn');
            
            if (selectedGoals.includes(goalType)) {
                // Deselect goal
                selectedGoals = selectedGoals.filter(g => g !== goalType);
                goalCard.style.border = '2px solid #e2e8f0';
                goalCard.style.background = 'white';
                goalCard.style.transform = 'scale(1)';
            } else {
                // Select goal
                selectedGoals.push(goalType);
                goalCard.style.border = '2px solid #667eea';
                goalCard.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05))';
                goalCard.style.transform = 'scale(1.02)';
            }
            
            // Show/hide clear button
            clearBtn.style.display = selectedGoals.length > 0 ? 'inline-flex' : 'none';
            
            // Filter mentors based on selected goals
            filterMentorsByGoals();
        };

        window.clearGoalSelection = function() {
            selectedGoals = [];
            document.querySelectorAll('.goal-card').forEach(card => {
                card.style.border = '2px solid #e2e8f0';
                card.style.background = 'white';
                card.style.transform = 'scale(1)';
            });
            document.getElementById('clearGoalsBtn').style.display = 'none';
            
            // Show all mentors
            filterMentorsByGoals();
        };

        function filterMentorsByGoals() {
            const mentorsGrid = document.getElementById('memberInstructorList');
            if (!mentorsGrid) return;
            
            // Get current mentors data
            const demoMentors = [
                {
                    id: 'demo1',
                    name: 'Dr. Sarah Johnson',
                    expertise: 'Career Development & Leadership',
                    bio: 'Former Fortune 500 executive with 15+ years experience in leadership development and C-suite transitions.',
                    rating: 4.9,
                    sessions: 127,
                    hourlyRate: 75,
                    avatar: 'https://ui-avatars.com/api/?name=Sarah+Johnson&background=667eea&color=fff&size=150',
                    expertiseTags: ['Leadership', 'Career Growth', 'Executive Coaching', 'Team Management', 'Performance Review'],
                    languages: ['English', 'Spanish'],
                    availability: 'Mon-Fri 9AM-5PM EST',
                    responseTime: '< 2 hours',
                    totalReviews: 142,
                    achievements: ['Top 1% Mentor', 'Leadership Expert', 'Career Catalyst'],
                    publications: ['The Executive Mindset', 'Career Acceleration Strategies'],
                    goalCategories: ['career']
                },
                {
                    id: 'demo2',
                    name: 'Michael Chen',
                    expertise: 'Tech & Software Engineering',
                    bio: 'Senior Software Architect at Google, specializing in system design and career growth in tech.',
                    rating: 4.8,
                    sessions: 89,
                    hourlyRate: 85,
                    avatar: 'https://ui-avatars.com/api/?name=Michael+Chen&background=10b981&color=fff&size=150',
                    expertiseTags: ['System Design', 'Software Architecture', 'Tech Career', 'Code Review', 'Team Leadership'],
                    languages: ['English', 'Mandarin'],
                    availability: 'Tue-Thu 2PM-8PM EST',
                    responseTime: '< 4 hours',
                    totalReviews: 76,
                    achievements: ['Tech Excellence', 'System Design Expert', 'Code Mentor'],
                    publications: ['Scalable System Design', 'The Tech Career Guide'],
                    goalCategories: ['tech', 'career']
                },
                {
                    id: 'demo3',
                    name: 'Emily Rodriguez',
                    expertise: 'Business Strategy & Entrepreneurship',
                    bio: 'Serial entrepreneur and business consultant, helped launch 20+ successful startups with $50M+ exits.',
                    rating: 4.9,
                    sessions: 156,
                    hourlyRate: 95,
                    avatar: 'https://ui-avatars.com/api/?name=Emily+Rodriguez&background=f59e0b&color=fff&size=150',
                    expertiseTags: ['Startup Strategy', 'Fundraising', 'Product-Market Fit', 'Scaling', 'Exit Strategy'],
                    languages: ['English', 'Portuguese'],
                    availability: 'Mon-Wed 10AM-6PM EST',
                    responseTime: '< 1 hour',
                    totalReviews: 187,
                    achievements: ['Startup Unicorn', 'Funding Expert', 'Exit Specialist'],
                    publications: ['Zero to Unicorn Playbook', 'Fundraising Secrets'],
                    goalCategories: ['business', 'career']
                }
            ];
            
            // Filter mentors based on selected goals
            let filteredMentors = demoMentors;
            if (selectedGoals.length > 0) {
                filteredMentors = demoMentors.filter(mentor => 
                    mentor.goalCategories && mentor.goalCategories.some(cat => selectedGoals.includes(cat))
                );
            }
            
            // Display filtered mentors
            displayFilteredMentors(filteredMentors);
            
            // Show notification
            if (selectedGoals.length > 0) {
                const goalNames = selectedGoals.map(g => {
                    const goalMap = {
                        'career': 'Career Growth',
                        'tech': 'Tech & Engineering', 
                        'business': 'Entrepreneurship',
                        'academic': 'Academic Research'
                    };
                    return goalMap[g];
                }).join(', ');
                showNotification(`Showing ${filteredMentors.length} mentors for: ${goalNames}`, 'info');
            }
        }

        function displayFilteredMentors(mentors) {
            const mentorsGrid = document.getElementById('memberInstructorList');
            if (!mentorsGrid) return;
            
            mentorsGrid.innerHTML = mentors.map(mentor => `
                <div class="mentor-card" onclick="selectMentor('${mentor.id}')" style="
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 12px;
                    padding: 20px;
                    margin-bottom: 16px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <img src="${mentor.avatar}" alt="${mentor.name}" style="
                            width: 50px;
                            height: 50px;
                            border-radius: 50%;
                            margin-right: 15px;
                            object-fit: cover;
                        ">
                        <div>
                            <h3 style="margin: 0; color: #1a1a1a; font-size: 18px; font-weight: 600;">${mentor.name}</h3>
                            <p style="margin: 4px 0 0 0; color: #6366f1; font-size: 14px; font-weight: 500;">${mentor.expertise}</p>
                        </div>
                    </div>
                    <p style="margin: 0 0 12px 0; color: #666; font-size: 14px; line-height: 1.4;">${mentor.bio}</p>
                    
                    ${mentor.expertiseTags ? `
                    <div style="margin-bottom: 12px;">
                        ${mentor.expertiseTags.slice(0, 3).map(tag => `
                            <span style="
                                display: inline-block;
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                padding: 4px 8px;
                                border-radius: 12px;
                                font-size: 11px;
                                font-weight: 500;
                                margin-right: 6px;
                                margin-bottom: 4px;
                            ">${tag}</span>
                        `).join('')}
                        ${mentor.expertiseTags.length > 3 ? `<span style="color: #888; font-size: 11px;">+${mentor.expertiseTags.length - 3} more</span>` : ''}
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px; font-size: 12px;">
                            <span style="color: #f59e0b;">‚≠ê ${mentor.rating}</span>
                            <span style="color: #888;">${mentor.totalReviews || mentor.sessions} reviews</span>
                            ${mentor.responseTime ? `<span style="color: #10b981;">üïí ${mentor.responseTime}</span>` : ''}
                        </div>
                        <span style="color: #10b981; font-weight: 600; font-size: 14px;">‚Ç¶${mentor.hourlyRate * 100}/hr</span>
                    </div>
                    
                    ${mentor.achievements ? `
                    <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                        ${mentor.achievements.slice(0, 2).map(achievement => `
                            <span style="
                                background: rgba(16, 185, 129, 0.1);
                                color: #059669;
                                padding: 2px 6px;
                                border-radius: 8px;
                                font-size: 10px;
                                font-weight: 600;
                            ">üèÜ ${achievement}</span>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${mentor.languages ? `
                    <div style="font-size: 11px; color: #666; margin-top: 8px;">
                        <span>üåê ${mentor.languages.join(', ')}</span>
                        ${mentor.availability ? `<span style="margin-left: 12px;">üìÖ ${mentor.availability}</span>` : ''}
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Close chat sidebar function
        window.closeChatSidebar = function() {
            const chatSidebar = document.getElementById('chatSidebar');
            if (chatSidebar) {
                chatSidebar.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    chatSidebar.style.display = 'none';
                    chatSidebar.style.transform = 'translateX(0)';
                }, 300);
            }
        };

        // Minimize chat function
        window.minimizeChat = function() {
            const chatSidebar = document.getElementById('chatSidebar');
            if (chatSidebar) {
                chatSidebar.style.height = '60px';
                chatSidebar.style.overflow = 'hidden';
                setTimeout(() => {
                    chatSidebar.style.height = '100vh';
                    chatSidebar.style.overflow = 'hidden';
                }, 2000);
            }
        };
        
        // Cloudinary configuration
        const CLOUDINARY_CONFIG = {
            cloudName: 'dkd6x857p',
            uploadPreset: 'Andrew Cares Village Hub'
        };

        // Attach file function with Cloudinary upload
        window.attachFile = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            input.multiple = false;
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification('File size must be less than 10MB', 'error');
                    return;
                }
                
                // Show upload progress
                const uploadNotification = showUploadProgress('Uploading file...');
                
                try {
                    const uploadResult = await uploadToCloudinary(file, (progress) => {
                        updateUploadProgress(uploadNotification, progress);
                    });
                    
                    // Remove upload notification
                    uploadNotification.remove();
                    
                    // Send file message
                    await sendFileMessage(uploadResult);
                    
                    showNotification('File uploaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    uploadNotification.remove();
                    showNotification('Failed to upload file. Please try again.', 'error');
                }
            };
            
            input.click();
        };

        // Upload to Cloudinary
        async function uploadToCloudinary(file, onProgress) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
                
                const fileExtension = file.name.split('.').pop().toLowerCase();
                let resourceType = 'auto';
                
                // Determine resource type
                if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExtension)) {
                    resourceType = 'image';
                } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(fileExtension)) {
                    resourceType = 'video';
                } else if (['mp3', 'wav', 'ogg', 'aac'].includes(fileExtension)) {
                    resourceType = 'video'; // Cloudinary uses 'video' for audio
                }
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable && onProgress) {
                        const progress = Math.round((e.loaded / e.total) * 100);
                        onProgress(progress);
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        resolve({
                            url: response.secure_url,
                            publicId: response.public_id,
                            resourceType: response.resource_type,
                            format: response.format,
                            originalFilename: file.name,
                            fileSize: file.size
                        });
                    } else {
                        reject(new Error('Upload failed'));
                    }
                });
                
                xhr.addEventListener('error', () => reject(new Error('Upload failed')));
                
                xhr.open('POST', `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/${resourceType}/upload`);
                xhr.send(formData);
            });
        }

        // Send file message
        async function sendFileMessage(uploadResult) {
            const fileType = uploadResult.resourceType;
            let messageContent = '';
            
            if (fileType === 'image') {
                messageContent = `<div class="file-message image-message">
                    <img src="${uploadResult.url}" alt="${uploadResult.originalFilename}" style="max-width: 250px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="window.open('${uploadResult.url}', '_blank')">
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; opacity: 0.8;">${uploadResult.originalFilename}</p>
                </div>`;
            } else if (fileType === 'video') {
                messageContent = `<div class="file-message video-message">
                    <video controls style="max-width: 250px; max-height: 200px; border-radius: 8px;">
                        <source src="${uploadResult.url}" type="video/${uploadResult.format}">
                        Your browser does not support the video tag.
                    </video>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; opacity: 0.8;">${uploadResult.originalFilename}</p>
                </div>`;
            } else {
                messageContent = `<div class="file-message document-message" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer;" onclick="window.open('${uploadResult.url}', '_blank')">
                    <i class="fas fa-file-alt" style="font-size: 2rem; color: #667eea;"></i>
                    <div>
                        <p style="margin: 0; font-weight: 500;">${uploadResult.originalFilename}</p>
                        <p style="margin: 0; font-size: 0.8rem; opacity: 0.8;">${(uploadResult.fileSize / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                    <i class="fas fa-download" style="margin-left: auto; opacity: 0.6;"></i>
                </div>`;
            }
            
            return db.collection("chats").add({
                sessionId: window.currentChatSession,
                senderId: currentUser.uid,
                senderName: currentUserData?.displayName || currentUserData?.name || currentUserData?.email?.split('@')[0] || 'User',
                text: messageContent,
                fileUrl: uploadResult.url,
                fileName: uploadResult.originalFilename,
                fileType: fileType,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'sent',
                isFile: true
            });
        }

        // Show upload progress notification
        function showUploadProgress(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                z-index: 1001;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                backdrop-filter: blur(10px);
                min-width: 250px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: 500;">${message}</p>
                        <div style="background: rgba(255,255,255,0.3); height: 4px; border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
                            <div class="upload-progress-bar" style="background: white; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            return notification;
        }

        // Update upload progress
        function updateUploadProgress(notification, progress) {
            const progressBar = notification.querySelector('.upload-progress-bar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }

        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });

        // Add status styles
        const statusStyles = document.createElement('style');
        statusStyles.textContent = `
            .status-pending { background-color: var(--warning-color); color: white; }
            .status-confirmed { background-color: var(--success-color); color: white; }
            .status-completed { background-color: var(--info-color); color: white; }
            .status-negotiating { background-color: var(--color-primary); color: white; }
        `;
        document.head.appendChild(statusStyles);
    </script>
</body>
</html>
