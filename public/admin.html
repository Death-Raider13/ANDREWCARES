<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Citadel - Andrew Cares Village</title>

        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@400;500;700&display=swap"
            rel="stylesheet">

        <!-- Font Awesome for Icons -->
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
            crossorigin="anonymous" referrerpolicy="no-referrer" />

        <!-- Firebase SDK -->
        <script
            src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
        <script
            src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
        <script
            src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
        <script
            src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

        <!-- Cloudinary SDK -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/cloudinary-core/2.13.0/cloudinary-core-shrinkwrap.min.js"></script>

        <!-- Notification Service -->
        <script src="/js/notification-service.js"></script>

        <!-- Custom CSS -->
        <style>
        /* --- Global Styles & Variables --- */
        :root {
            --background-color: #F4F2ED;
            --text-primary: #333333;
            --text-secondary: #555555;
            --color-primary: #B38B00;
            --color-secondary: #001F3F;
            --card-bg: #FFFFFF;
            --border-color: #EAEAEA;
            --hover-bg: #F9F9F9;
            --danger-color: #D32F2F;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --info-color: #2196F3;
            --live-color: #E53E3E;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* --- Admin Layout --- */
        .admin-layout {
            display: flex;
            height: 100vh;
        }

        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 280px;
            background-color: var(--color-secondary);
            color: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header .logo {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        /* Andrew Cares Logo Styles */
        .andrew-cares-logo {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            color: inherit;
            transition: transform 0.3s ease;
            margin-bottom: 1rem;
        }

        .andrew-cares-logo:hover {
            transform: scale(1.05);
        }

        .andrew-cares-logo img {
            height: 60px;
            width: auto;
            max-width: 200px;
            filter: brightness(0) invert(1);
        }

        @media (max-width: 768px) {
            .andrew-cares-logo img {
                height: 50px;
            }
        }

        @media (max-width: 480px) {
            .andrew-cares-logo img {
                height: 40px;
            }
        }

        .sidebar-nav {
            flex-grow: 1;
            padding: 1rem 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active {
            background-color: var(--color-primary);
            color: #fff;
            font-weight: 700;
        }

        .nav-link i {
            width: 30px;
            font-size: 1.1rem;
            margin-right: 0.5rem;
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-button {
            background: none;
            border: none;
            color: #fff;
            display: flex;
            align-items: center;
            width: 100%;
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--color-secondary);
        }

        /* --- Widget & Table Styles --- */
        .widget {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .widget-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--color-secondary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--color-primary), #9c7a00);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
            transition: all 0.3s;
        }

        .stat-card:hover::before {
            transform: rotate(45deg) translate(50%, 50%);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            font-weight: 700;
            color: var(--text-secondary);
            background-color: var(--hover-bg);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .table-actions button {
            background: none;
            border: 1px solid;
            border-radius: 5px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        /* --- Button Styles --- */
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            border: 1px solid var(--color-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background-color: #9c7a00;
        }

        .btn-success {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .btn-success:hover {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-danger {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-info {
            border-color: var(--info-color);
            color: var(--info-color);
        }

        .btn-info:hover {
            background-color: var(--info-color);
            color: white;
        }

        /* --- Status Badges --- */
        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background-color: var(--success-color);
            color: white;
        }

        .status-blocked {
            background-color: var(--danger-color);
            color: white;
        }

        .status-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .status-new {
            background-color: var(--info-color);
            color: white;
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* --- Upload Area --- */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--color-primary);
            background-color: var(--hover-bg);
        }

        .upload-area.dragover {
            border-color: var(--color-primary);
            background-color: var(--hover-bg);
        }

        .upload-area.uploading {
            pointer-events: none;
            opacity: 0.7;
        }

        /* --- Live Streaming Styles --- */
        .stream-container {
            position: relative;
            background: linear-gradient(135deg, var(--color-secondary), var(--color-primary));
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .stream-placeholder {
            padding: 2rem;
        }

        .stream-placeholder h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-family: 'Cinzel', serif;
        }

        .stream-placeholder p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .stream-link-display {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .stream-link-display input {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.8rem;
            width: 100%;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .stream-link-display input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .stream-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 8px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .stream-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stream-status.offline {
            background-color: var(--danger-color);
        }

        .stream-status.live {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }

        .stream-status.ready {
            background-color: var(--info-color);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .stream-info {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-left: auto;
        }

        .stream-info div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stream-url-display {
            background: var(--hover-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
        }

        .stream-url-display label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .stream-url-display input {
            width: 100%;
            background: transparent;
            border: none;
            font-family: inherit;
            font-size: inherit;
            color: var(--text-secondary);
        }

        .copy-button {
            background: var(--info-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            transition: background-color 0.3s;
        }

        .copy-button:hover {
            background: #1976D2;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        /* --- Alert styles --- */
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            position: relative;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* --- Loading spinner --- */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- Progress bar --- */
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 10px;
            background: linear-gradient(90deg, var(--color-primary), #9c7a00);
            width: 0%;
            transition: width 0.3s;
        }

        /* --- Real-time indicator --- */
        .realtime-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--success-color);
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            background-color: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* --- Connection Status --- */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s;
        }

        .connection-status.connected {
            background-color: var(--success-color);
            color: white;
        }

        .connection-status.disconnected {
            background-color: var(--danger-color);
            color: white;
        }

        .connection-status.connecting {
            background-color: var(--warning-color);
            color: white;
        }

        /* --- Empty state --- */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* --- Fade out animation for alerts --- */
        .fade-out {
            animation: fadeOut 0.5s ease-in-out forwards;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* --- Alternative Streaming Options --- */
        .streaming-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .streaming-option {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .streaming-option:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .streaming-option.selected {
            border-color: var(--color-primary);
            background: var(--hover-bg);
        }

        .streaming-option h3 {
            color: var(--color-secondary);
            margin-bottom: 1rem;
            font-family: 'Cinzel', serif;
        }

        .streaming-option .features {
            list-style: none;
            margin-bottom: 1rem;
        }

        .streaming-option .features li {
            padding: 0.3rem 0;
            color: var(--text-secondary);
        }

        .streaming-option .features li i {
            color: var(--success-color);
            margin-right: 0.5rem;
        }

        /* --- Responsive design --- */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .admin-layout {
                flex-direction: column;
                height: auto;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .table-actions {
                flex-direction: column;
            }

            .stream-controls {
                flex-wrap: wrap;
            }

            .stream-info {
                margin-left: 0;
                margin-top: 1rem;
                flex-wrap: wrap;
            }

            .streaming-options {
                grid-template-columns: 1fr;
            }
        }
        .hidden {
    display: none !important;
}
/* Question Form Styles */
.answer-option {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background: var(--hover-bg);
}

.answer-option input[type="text"] {
    flex: 1;
    margin: 0;
}

.answer-option label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    white-space: nowrap;
    margin: 0;
}

.answer-option input[type="radio"] {
    width: auto;
    margin: 0;
}

.answer-option .remove-option {
    background: var(--danger-color);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

#multipleChoiceSection {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    background: var(--hover-bg);
}

#addOptionBtn {
    margin-top: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

/* Question Dashboard Styles */
.question-status-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-active {
    background-color: var(--success-color);
    color: white;
}

.status-scheduled {
    background-color: var(--info-color);
    color: white;
}

.status-completed {
    background-color: var(--warning-color);
    color: white;
}

.status-archived {
    background-color: var(--text-secondary);
    color: white;
}

/* Active Question Display */
.active-question-card {
    background: linear-gradient(135deg, var(--color-primary), #9c7a00);
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.active-question-card h3 {
    margin-bottom: 1rem;
    color: white;
}

.active-question-card p {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.question-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    font-size: 0.9rem;
    opacity: 0.9;
}

.question-actions {
    text-align: center;
    margin-top: 1rem;
}

.question-actions button {
    margin: 0 0.5rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .answer-option {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
    }
    
    .answer-option label {
        justify-content: center;
    }
    
    .question-stats {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
    }
}
    </style>
    </head>

    <body>
        <!-- Connection Status Indicator -->
        <div id="connectionStatus" class="connection-status connecting">
            <div class="loading"></div> Connecting...
        </div>

        <div class="admin-layout">
            <!-- Sidebar Navigation -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <a href="index.html" class="andrew-cares-logo">
                        <img src="images/andrew_cares_logo.png" alt="Andrew Cares Village Logo">
                    </a>
                    <h2 class="logo">Admin Citadel</h2>
                    <div class="realtime-indicator">
                        <div class="realtime-dot"></div>
                        Real-time Connected
                    </div>
                </div>
                <nav class="sidebar-nav">
                    <button class="nav-link active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button class="nav-link" data-page="users">
                        <i class="fas fa-users"></i> User Management
                    </button>
                    <button class="nav-link" data-page="courses">
                        <i class="fas fa-book-open"></i> Course Approvals
                    </button>
                    <!-- ADD THIS NEW BUTTON -->
                    <button class="nav-link" data-page="applications">
                        <i class="fas fa-user-check"></i> Applications
                    </button>
                    <button class="nav-link" data-page="content">
                        <i class="fas fa-pen"></i> Content
                    </button>
                    <button class="nav-link" data-page="moderation">
                        <i class="fas fa-gavel"></i> Moderation Center
                    </button>
                    <button class="nav-link" data-page="live-events">
                        <i class="fas fa-video"></i> Live Events
                    </button>
                    <button class="nav-link" data-page="content">
                        <i class="fas fa-question-circle"></i> Content
                        Management
                    </button>
                    <button class="nav-link" data-page="resources">
                        <i class="fas fa-archive"></i> Resource Management
                    </button>
                    <button class="nav-link" data-page="announcements">
                        <i class="fas fa-bullhorn"></i> Announcements
                    </button>
                    <button class="nav-link" data-page="testimonials">
                        <i class="fas fa-star"></i> Testimonial Review
                    </button>

                </nav>
                <div class="sidebar-footer">
                    <button id="logoutButton" class="logout-button">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <a href="home.html">home</a>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content active">
                    <div class="page-header">
                        <h1>Dashboard Overview</h1>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number"
                                id="pendingModerations">0</div>
                            <div class="stat-label">Pending Moderations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalResources">0</div>
                            <div class="stat-label">Total Resources</div>
                        </div>
                    </div>

                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-chart-line"></i> Recent Activity
                        </h2>
                        <div id="recentActivity">
                            <div class="empty-state">
                                <i class="fas fa-clock"></i>
                                <p>Loading recent activities...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Page -->
                <div id="page-users" class="page-content">
                    <div class="page-header">
                        <h1>User Management</h1>
                    </div>
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-users"></i> All Users
                            <div class="realtime-indicator"
                                style="margin-left: auto;">
                                <div class="realtime-dot"></div>
                                Live Data
                            </div>
                        </h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>

                                        <th>Role</th>
                                        <th>Warnings</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="7"
                                            style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Loading
                                            users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Course Approvals Page -->
                <div id="page-courses" class="page-content">
                    <div class="page-header">
                        <h1>Course Approvals</h1>
                    </div>
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-clock"></i> Pending Review
                        </h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Course Title</th>
                                        <th>Instructor</th>
                                        <th>Discipline</th>
                                        <th>Level</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="coursesTableBody">
                                    <tr>
                                        <td colspan="6"
                                            style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Loading
                                            courses...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Applications Page -->
                <div id="page-applications" class="page-content">
                    <div class="page-header">
                        <h1>Instructor Applications</h1>
                        <p>Review and approve pending instructor
                            applications.</p>
                    </div>
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-user-clock"></i> Pending
                            Applications
                        </h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Applicant Name</th>
                                        <th>Email</th>
                                        <th>Expertise</th>
                                        <th>Submitted On</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="applicationsTableBody">
                                    <!-- Applications will be loaded here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Moderation Center Page -->
                <div id="page-moderation" class="page-content">
                    <div class="page-header">
                        <h1>Moderation Center</h1>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Privacy First:</strong> This tool is for
                        moderation purposes only. Direct access to private
                        user messages is disabled. All actions are logged and
                        reviewed for transparency.
                    </div>

                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Moderation Alerts
                        </h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Reported User</th>
                                        <th>Reporter</th>
                                        <th>Reason</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="moderationTableBody">
                                    <tr>
                                        <td colspan="6"
                                            style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Loading
                                            moderation reports...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Live Events Page -->
                <div id="page-live-events" class="page-content">
                    <div class="page-header">
                        <h1>Live Events Management</h1>
                    </div>

                    <!-- Production-Ready Live Stream Section -->
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-broadcast-tower"></i> Production
                            Live Streaming Control
                        </h2>

                        <!-- Streaming Platform Selection -->
                        <div class="streaming-options">
                            <div class="streaming-option selected"
                                data-platform="jitsi">
                                <i class="fas fa-video"
                                    style="font-size: 2rem; color: var(--info-color); margin-bottom: 1rem;"></i>
                                <h3>Jitsi Meet (Recommended)</h3>
                                <ul class="features">
                                    <li><i class="fas fa-check"></i> Up to 500+
                                        participants</li>
                                    <li><i class="fas fa-check"></i> Free & Open
                                        Source</li>
                                    <li><i class="fas fa-check"></i> No time
                                        limits</li>
                                    <li><i class="fas fa-check"></i> HD video
                                        quality</li>
                                    <li><i class="fas fa-check"></i> Screen
                                        sharing</li>
                                    <li><i class="fas fa-check"></i> Recording
                                        available</li>
                                </ul>
                                <button class="btn-primary"
                                    onclick="selectPlatform('jitsi')">Select
                                    Jitsi</button>
                            </div>

                            <div class="streaming-option"
                                data-platform="youtube">
                                <i class="fab fa-youtube"
                                    style="font-size: 2rem; color: #FF0000; margin-bottom: 1rem;"></i>
                                <h3>YouTube Live</h3>
                                <ul class="features">
                                    <li><i class="fas fa-check"></i> Unlimited
                                        viewers</li>
                                    <li><i class="fas fa-check"></i> Auto
                                        recording</li>
                                    <li><i class="fas fa-check"></i> Chat
                                        moderation</li>
                                    <li><i
                                            class="fas fa-exclamation-triangle"></i>
                                        Requires 50+ subscribers</li>
                                    <li><i
                                            class="fas fa-exclamation-triangle"></i>
                                        24hr verification needed</li>
                                </ul>
                                <button class="btn-primary"
                                    onclick="selectPlatform('youtube')">Select
                                    YouTube</button>
                            </div>

                            <div class="streaming-option"
                                data-platform="custom">
                                <i class="fas fa-cog"
                                    style="font-size: 2rem; color: var(--color-primary); margin-bottom: 1rem;"></i>
                                <h3>Custom RTMP Stream</h3>
                                <ul class="features">
                                    <li><i class="fas fa-check"></i> Any
                                        streaming platform</li>
                                    <li><i class="fas fa-check"></i>
                                        Professional setup</li>
                                    <li><i class="fas fa-check"></i> Custom
                                        branding</li>
                                    <li><i
                                            class="fas fa-exclamation-triangle"></i>
                                        Requires streaming software</li>
                                    <li><i
                                            class="fas fa-exclamation-triangle"></i>
                                        Technical setup needed</li>
                                </ul>
                                <button class="btn-primary"
                                    onclick="selectPlatform('custom')">Select
                                    Custom</button>
                            </div>
                        </div>

                        <!-- Stream Container -->
                        <div class="stream-container" id="streamContainer">
                            <div class="stream-placeholder"
                                id="streamPlaceholder">
                                <i class="fas fa-video"
                                    style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.7;"></i>
                                <h3>Ready to Go Live</h3>
                                <p>Create a professional live stream for your
                                    community</p>

                                <div class="stream-link-display"
                                    id="streamLinkDisplay"
                                    style="display: none;">
                                    <label>Join Link (Share with
                                        participants):</label>
                                    <input type="text" id="joinLink" readonly
                                        placeholder="Stream link will appear here">
                                    <button class="copy-button"
                                        onclick="copyJoinLink()">
                                        <i class="fas fa-copy"></i> Copy Join
                                        Link
                                    </button>
                                </div>

                                <div class="quick-actions">
                                    <button id="createStreamBtn"
                                        class="btn-primary"
                                        style="font-size: 1.1rem; padding: 1rem 2rem;">
                                        <i class="fas fa-play-circle"></i>
                                        Create Live Stream
                                    </button>
                                    <button id="endStreamBtn" class="btn-danger"
                                        style="display: none; font-size: 1.1rem; padding: 1rem 2rem;">
                                        <i class="fas fa-stop-circle"></i> End
                                        Stream
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Stream Controls -->
                        <div class="stream-controls">
                            <div class="stream-status offline"
                                id="streamStatus">
                                <i class="fas fa-circle"></i>
                                <span>Offline</span>
                            </div>
                            <button id="openStreamBtn" class="btn-info"
                                style="display: none;">
                                <i class="fas fa-external-link-alt"></i> Open
                                Stream Room
                            </button>
                            <button id="shareStreamBtn" class="btn-warning"
                                style="display: none;">
                                <i class="fas fa-share"></i> Share Stream
                            </button>

                            <div class="stream-info">
                                <div>
                                    <i class="fas fa-users"></i>
                                    <span>Max Participants: <strong
                                            id="maxParticipants">500+</strong></span>
                                </div>
                                <div>
                                    <i class="fas fa-clock"></i>
                                    <span>Duration: <strong
                                            id="streamDuration">Unlimited</strong></span>
                                </div>
                            </div>
                        </div>

                        <!-- Stream URL Display -->
                        <div id="streamUrlDisplay" class="stream-url-display"
                            style="display: none;">
                            <label>Moderator/Host Link (Admin access):</label>
                            <input type="text" id="streamUrl" readonly>
                            <button class="copy-button"
                                onclick="copyStreamUrl()">
                                <i class="fas fa-copy"></i> Copy Admin Link
                            </button>

                            <label style="margin-top: 1rem;">Participant Join
                                Link:</label>
                            <input type="text" id="participantUrl" readonly>
                            <button class="copy-button"
                                onclick="copyParticipantUrl()">
                                <i class="fas fa-copy"></i> Copy Join Link
                            </button>
                        </div>
                    </div>

                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-plus"></i> Schedule New Event
                        </h2>
                        <form id="newEventForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="eventTitle">Event Title
                                        *</label>
                                    <input type="text" id="eventTitle" required>
                                </div>
                                <div class="form-group">
                                    <label for="eventDateTime">Date & Time
                                        *</label>
                                    <input type="datetime-local"
                                        id="eventDateTime" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="eventDescription">Description
                                    *</label>
                                <textarea id="eventDescription"
                                    required></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="eventAudience">Target Audience
                                        *</label>
                                    <select id="eventAudience" required>
                                        <option value>Select Audience</option>
                                        <option value="All Members">All
                                            Members</option>
                                        <option value="Male Members Only">Male
                                            Members Only</option>
                                        <option
                                            value="Female Members Only">Female
                                            Members Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="eventDuration">Duration
                                        (minutes)</label>
                                    <input type="number" id="eventDuration"
                                        placeholder="60" min="15" max="480">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="isLiveStream">Live Stream
                                        Event</label>
                                    <select id="isLiveStream">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="streamPlatform">Streaming
                                        Platform</label>
                                    <select id="streamPlatform">
                                        <option value="jitsi">Jitsi
                                            Meet</option>
                                        <option value="youtube">YouTube
                                            Live</option>
                                        <option value="custom">Custom
                                            RTMP</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-calendar-plus"></i> Schedule
                                Event
                            </button>
                        </form>
                    </div>

                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-list"></i> Event Dashboard
                        </h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Event Title</th>
                                        <th>Date & Time</th>
                                        <th>Audience</th>
                                        <th>Platform</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="eventsTableBody">
                                    <tr>
                                        <td colspan="6"
                                            style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Loading
                                            events...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="page-content" class="page-content">
                    <div class="page-header">
                        <h1>Content Management</h1>
                    </div>
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-plus"></i> Create Question of the
                            Day
                        </h2>
                        <form id="questionForm">
                            <div class="form-group">
                                <label for="questionTitle">Question Title
                                    *</label>
                                <input type="text" id="questionTitle" required
                                    placeholder="Today's Challenge">
                            </div>
                            <div class="form-group">
                                <label for="questionText">Question *</label>
                                <textarea id="questionText" required
                                    placeholder="What's your question for the community?"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="questionType">Question Type
                                        *</label>
                                    <select id="questionType" required>
                                        <option value>Select Type</option>
                                        <option value="open">Open Text
                                            Response</option>
                                        <option value="multiple-choice">Multiple
                                            Choice</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label
                                        for="questionCategory">Category</label>
                                    <select id="questionCategory">
                                        <option value="general">General</option>
                                        <option value="trading">Trading</option>
                                        <option value="fitness">Fitness</option>
                                        <option
                                            value="personal-development">Personal
                                            Development</option>
                                        <option value="mindset">Mindset</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Multiple Choice Options (hidden by default) -->
                            <div id="multipleChoiceSection"
                                style="display: none;">
                                <div class="form-group">
                                    <label>Answer Options</label>
                                    <div id="answerOptions">
                                        <div class="answer-option">
                                            <input type="text"
                                                placeholder="Option 1"
                                                class="answer-input">
                                            <label><input type="radio"
                                                    name="correctAnswer"
                                                    value="0"> Correct
                                                Answer</label>
                                        </div>
                                        <div class="answer-option">
                                            <input type="text"
                                                placeholder="Option 2"
                                                class="answer-input">
                                            <label><input type="radio"
                                                    name="correctAnswer"
                                                    value="1"> Correct
                                                Answer</label>
                                        </div>
                                    </div>
                                    <button type="button" id="addOptionBtn"
                                        class="btn-info">Add Option</button>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="scheduledDate">Schedule Date
                                        *</label>
                                    <input type="date" id="scheduledDate"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label for="revealTime">Reveal Answers
                                        At</label>
                                    <input type="time" id="revealTime"
                                        value="20:00">
                                </div>
                            </div>

                            <button type="submit" class="btn-primary">
                                <i class="fas fa-paper-plane"></i> Publish
                                Question
                            </button>
                        </form>
                    </div>

                    <!-- Active Question -->
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-bullseye"></i> Today's Active
                            Question
                        </h2>
                        <div id="activeQuestionDisplay">
                            <div class="empty-state">
                                <i class="fas fa-question-circle"></i>
                                <p>No active question for today</p>
                            </div>
                        </div>
                    </div>

                    <!-- Questions Dashboard -->
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-chart-bar"></i> Questions Dashboard
                        </h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Question</th>
                                        <th>Type</th>
                                        <th>Responses</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="questionsTableBody">
                                    <tr>
                                        <td colspan="6"
                                            style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Loading
                                            questions...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Resource Management Page -->
                <div id="page-resources" class="page-content">
                    <div class="page-header">
                        <h1>Resource Management</h1>
                    </div>
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-upload"></i> Upload New Resource
                        </h2>
                        <form id="resourceUploadForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="resourceTitle">Resource Title
                                        *</label>
                                    <input type="text" id="resourceTitle"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label for="resourceCategory">Category
                                        *</label>
                                    <select id="resourceCategory" required>
                                        <option value>Select Category</option>
                                        <option value="forex">Forex
                                            Trading</option>
                                        <option value="fitness">Fitness &
                                            Health</option>
                                        <option value="karate">Martial
                                            Arts</option>
                                        <option
                                            value="business">Business</option>
                                        <option value="personal">Personal
                                            Development</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="resourceDescription">Description
                                    *</label>
                                <textarea id="resourceDescription" required
                                    placeholder="Provide a detailed description of the resource..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="resourceFeatured">Featured
                                        Resource</label>
                                    <select id="resourceFeatured">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>File Upload *</label>
                                <div class="upload-area" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt"
                                        style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                    <p>Click to upload or drag and drop</p>
                                    <p
                                        style="font-size: 0.9rem; opacity: 0.7;">PDF,
                                        DOC, MP4, MP3, ZIP files supported
                                        (Max: 50MB)</p>
                                </div>
                                <input type="file" id="resourceFile"
                                    style="display: none;"
                                    accept=".pdf,.doc,.docx,.mp4,.mp3,.zip">
                                <div id="fileInfo" class="file-info"
                                    style="display: none;">
                                    <strong>Selected File:</strong>
                                    <p id="fileName"></p>
                                    <p id="fileSize"
                                        style="font-size: 0.9rem; opacity: 0.7;"></p>
                                </div>
                                <div id="uploadProgress"
                                    class="progress-container"
                                    style="display: none;">
                                    <div id="uploadProgressBar"
                                        class="progress-bar"></div>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary"
                                id="uploadResourceBtn">
                                <i class="fas fa-upload"></i> Upload Resource
                            </button>
                        </form>
                    </div>

                    <!-- Resource Library -->
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-archive"></i> Resource Library
                        </h2>
                        <div id="alertContainer"></div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Category</th>
                                        <th>Type</th>
                                        <th>Size</th>

                                        <th>Downloads</th>
                                        <th>Featured</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resourcesTableBody">
                                    <tr>
                                        <td colspan="8"
                                            style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Loading
                                            resources...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Announcements Page -->
                <div id="page-announcements" class="page-content">
                    <div class="page-header">
                        <h1>Announcements</h1>
                    </div>
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-bullhorn"></i> Create New
                            Announcement
                        </h2>
                        <form id="announcementForm">
                            <div class="form-group">
                                <label for="announcementTitle">Title *</label>
                                <input type="text" id="announcementTitle"
                                    required>
                            </div>
                            <div class="form-group">
                                <label for="announcementContent">Content
                                    *</label>
                                <textarea id="announcementContent"
                                    required></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="announcementAudience">Target
                                        Audience *</label>
                                    <select id="announcementAudience" required>
                                        <option value>Select Audience</option>
                                        <option value="all">All Members</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="announcementPriority">Priority
                                        *</label>
                                    <select id="announcementPriority" required>
                                        <option value>Select Priority</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-paper-plane"></i> Send
                                Announcement
                            </button>
                        </form>
                    </div>

                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-list"></i> Recent Announcements
                        </h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Audience</th>
                                        <th>Priority</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="announcementsTableBody">
                                    <tr>
                                        <td colspan="6"
                                            style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Loading
                                            announcements...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Testimonials Page -->
                <div id="page-testimonials" class="page-content">
                    <div class="page-header">
                        <h1>Testimonial Review</h1>
                    </div>
                    <div class="widget">
                        <h2 class="widget-title">
                            <i class="fas fa-star"></i> Pending Testimonials
                        </h2>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Content</th>
                                        <th>Rating</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="testimonialsTableBody">
                                    <tr>
                                        <td colspan="5"
                                            style="text-align: center; padding: 2rem;">
                                            <div class="loading"></div> Loading
                                            testimonials...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
    // --- Firebase v9 SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, updateDoc, addDoc, deleteDoc, serverTimestamp, increment, Timestamp, orderBy, limit, getDocs, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Global Configuration
    const CONFIG = {
        firebase: {
            apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
            authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
               projectId: "andrew-cares-village-f4cb6", 
            storageBucket: "andrew-cares-village-f4cb6.firebasestorage.app",
            messagingSenderId: "255087116955",
            appId: "1:255087116955:web:84360ee1f13888f9b83c3e"
        },
        cloudinary: {
            cloudName: 'dkd6x857p',
            uploadPreset: 'Andrew Cares Village Hub'
        },
        streaming: {
            jitsi: {
                domain: 'meet.jit.si',
                roomPrefix: 'AndrewCaresVillage_'
            },
            youtube: {
                apiKey: 'YOUR_YOUTUBE_API_KEY'
            }
        }
    };

    // Global Variables
    let db, auth, storage;
    let isConnected = false;
    let currentStreamPlatform = 'jitsi';
    let currentRoomName = '';
    let streamStartTime = null;
    let currentStreamEventId = null;

    // Enhanced connection error handling
    let connectionRetries = 0;
    const maxRetries = 3;

    function handleFirebaseError(error) {
        console.error('Firebase Error:', error);
        
        if (error.code === 'unavailable' || error.code === 'deadline-exceeded') {
            if (connectionRetries < maxRetries) {
                connectionRetries++;
                showNotification(`Connection issue. Retrying... (${connectionRetries}/${maxRetries})`, 'warning');
                return true;
            } else {
                showNotification('Unable to connect to server. Please check your internet connection and try again.', 'error');
            }
        } else if (error.code === 'permission-denied') {
            showNotification('Access denied. Please contact support if this persists.', 'error');
        } else {
            showNotification('An unexpected error occurred. Please try again.', 'error');
        }
        return false;
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 300px;
            word-wrap: break-word;
        `;
        
        switch(type) {
            case 'error':
                notification.style.backgroundColor = '#f44336';
                break;
            case 'warning':
                notification.style.backgroundColor = '#ff9800';
                break;
            case 'success':
                notification.style.backgroundColor = '#4caf50';
                break;
            default:
                notification.style.backgroundColor = '#2196f3';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // Initialize Firebase v9
    async function initializeFirebase() {
        try {
            console.log('Initializing Firebase v9...');
            const app = initializeApp(CONFIG.firebase);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            console.log('Firebase v9 initialized successfully');
            
            // Initialize notification service for admin
            await initializeAdminNotificationService();
            
            return true;
        } catch (error) {
            console.error('Firebase initialization error:', error);
            updateConnectionStatus('disconnected');
            return false;
        }
    }

    // Initialize Admin Notification Service
    let notificationService;
    async function initializeAdminNotificationService() {
        try {
            if (typeof NotificationService !== 'undefined') {
                notificationService = new NotificationService();
                await notificationService.initialize(auth, db);
                console.log('Admin notification service initialized');
            }
        } catch (error) {
            console.error('Error initializing admin notification service:', error);
        }
    }

    function loadAllData() {
    listenForUsers();
    listenForCourses();
    loadDashboardStats();
    loadModeration();
     listenForApplications(); 
}
function setupRealtimeListeners() {
    if (!isConnected || !db) return;

    try {
        // Listen for resources
        const resourcesRef = collection(db, 'resources');
        onSnapshot(resourcesRef, (snapshot) => {
            updateResourcesTable(snapshot.docs);
            // Update resources stat
            document.getElementById('totalResources').textContent = snapshot.size;
        }, (error) => {
            console.error('Error listening for resources:', error);
        });

        // Listen for announcements
        const announcementsRef = collection(db, 'announcements');
        onSnapshot(announcementsRef, (snapshot) => {
            updateAnnouncementsTable(snapshot.docs);
        }, (error) => {
            console.error('Error listening for announcements:', error);
        });

        // Listen for testimonials
        const testimonialsRef = collection(db, 'testimonials');
        const pendingTestimonials = query(testimonialsRef, where('status', '==', 'pending'));
        onSnapshot(pendingTestimonials, (snapshot) => {
            updateTestimonialsTable(snapshot.docs);
        }, (error) => {
            console.error('Error listening for testimonials:', error);
        });

        // Listen for events
        const eventsRef = collection(db, 'liveEvents');
        onSnapshot(eventsRef, (snapshot) => {
            updateEventsTable(snapshot.docs);
        }, (error) => {
            console.error('Error listening for events:', error);
        });

        // Setup dashboard activity listener
        setupDashboardActivityListener();

    } catch (error) {
        console.error('Error setting up real-time listeners:', error);
    }
}


    // Setup Dashboard Activity Listener
    function setupDashboardActivityListener() {
        try {
            // Listen for recent user registrations
            const recentUsersRef = query(
                collection(db, 'users'),
                orderBy('createdAt', 'desc'),
                limit(5)
            );

            // Listen for recent course submissions
            const recentCoursesRef = query(
                collection(db, 'courses'),
                orderBy('createdAt', 'desc'),
                limit(5)
            );

            // Listen for recent testimonials
            const recentTestimonialsRef = query(
                collection(db, 'testimonials'),
                orderBy('createdAt', 'desc'),
                limit(5)
            );

            // Listen for recent events
            const recentEventsRef = query(
                collection(db, 'liveEvents'),
                orderBy('createdAt', 'desc'),
                limit(5)
            );

            // Combine all activity streams
            const activityPromises = [
                onSnapshot(recentUsersRef, (snapshot) => {
                    const activities = snapshot.docs.map(doc => ({
                        type: 'user_joined',
                        data: doc.data(),
                        id: doc.id,
                        timestamp: doc.data().createdAt
                    }));
                    updateRecentActivity(activities, 'users');
                }),

                onSnapshot(recentCoursesRef, (snapshot) => {
                    const activities = snapshot.docs.map(doc => ({
                        type: 'course_submitted',
                        data: doc.data(),
                        id: doc.id,
                        timestamp: doc.data().createdAt
                    }));
                    updateRecentActivity(activities, 'courses');
                }),

                onSnapshot(recentTestimonialsRef, (snapshot) => {
                    const activities = snapshot.docs.map(doc => ({
                        type: 'testimonial_submitted',
                        data: doc.data(),
                        id: doc.id,
                        timestamp: doc.data().createdAt
                    }));
                    updateRecentActivity(activities, 'testimonials');
                }),

                onSnapshot(recentEventsRef, (snapshot) => {
                    const activities = snapshot.docs.map(doc => ({
                        type: 'event_created',
                        data: doc.data(),
                        id: doc.id,
                        timestamp: doc.data().createdAt
                    }));
                    updateRecentActivity(activities, 'events');
                })
            ];

        } catch (error) {
            console.error('Error setting up dashboard activity listener:', error);
        }
    }
   // Update the loadDashboardStats function to be more robust
async function loadDashboardStats() {
    try {
        // These will be updated by the real-time listeners, but we can set initial values
        const [usersSnapshot, moderationsSnapshot, resourcesSnapshot, pendingCoursesSnapshot, pendingApplicationsSnapshot] = await Promise.all([
            getDocs(collection(db, 'users')),
            getDocs(collection(db, 'moderation_alerts')),
            getDocs(collection(db, 'resources')),
            getDocs(query(collection(db, 'courses'), where('status', '==', 'pending'))),
            getDocs(query(collection(db, 'instructor_applications'), where('status', '==', 'pending')))
        ]);

        // Safely update elements only if they exist
        const totalUsersEl = document.getElementById('totalUsers');
        if (totalUsersEl) totalUsersEl.textContent = usersSnapshot.size;
        
        const pendingModerationsEl = document.getElementById('pendingModerations');
        if (pendingModerationsEl) pendingModerationsEl.textContent = moderationsSnapshot.size;
        
        const totalResourcesEl = document.getElementById('totalResources');
        if (totalResourcesEl) totalResourcesEl.textContent = resourcesSnapshot.size;
        
        const pendingCoursesEl = document.getElementById('pendingCourses');
        if (pendingCoursesEl) pendingCoursesEl.textContent = pendingCoursesSnapshot.size;
        
        const pendingApplicationsEl = document.getElementById('pendingApplications');
        if (pendingApplicationsEl) pendingApplicationsEl.textContent = pendingApplicationsSnapshot.size;

        console.log(`Dashboard stats loaded - Users: ${usersSnapshot.size}, Pending Courses: ${pendingCoursesSnapshot.size}, Pending Applications: ${pendingApplicationsSnapshot.size}`);
        
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
        // Set default values if there's an error and elements exist
        const totalUsersEl = document.getElementById('totalUsers');
        if (totalUsersEl) totalUsersEl.textContent = '0';
        
        const pendingModerationsEl = document.getElementById('pendingModerations');
        if (pendingModerationsEl) pendingModerationsEl.textContent = '0';
        
        const totalResourcesEl = document.getElementById('totalResources');
        if (totalResourcesEl) totalResourcesEl.textContent = '0';
    }
}

// Add missing moderation action functions
async function reviewReport(reportId) {
    try {
        const reportRef = doc(db, 'moderation_alerts', reportId);
        const reportDoc = await getDoc(reportRef);
        const reportData = reportDoc.data();
        
        showAlert('Report Details', `
            <div style="text-align: left;">
                <p><strong>Reported User:</strong> ${reportData.reportedUser}</p>
                <p><strong>Reporter:</strong> ${reportData.reporterUser}</p>
                <p><strong>Reason:</strong> ${reportData.reason}</p>
                <p><strong>Details:</strong> ${reportData.details || 'No additional details'}</p>
                <p><strong>Date:</strong> ${reportData.createdAt ? new Date(reportData.createdAt.seconds * 1000).toLocaleString() : 'Unknown'}</p>
            </div>
        `, 'info');
    } catch (error) {
        console.error('Error reviewing report:', error);
        showAlert('Error', 'Failed to load report details', 'error');
    }
}

async function resolveReport(reportId) {
    if (!confirm('Mark this report as resolved?')) return;
    
    try {
        const reportRef = doc(db, 'moderation_alerts', reportId);
        await updateDoc(reportRef, {
            status: 'resolved',
            resolvedAt: serverTimestamp(),
            resolvedBy: 'admin'
        });
        showAlert('Success', 'Report marked as resolved', 'success');
    } catch (error) {
        console.error('Error resolving report:', error);
        showAlert('Error', 'Failed to resolve report', 'error');
    }
}

async function dismissReport(reportId) {
    if (!confirm('Dismiss this report?')) return;
    
    try {
        const reportRef = doc(db, 'moderation_alerts', reportId);
        await updateDoc(reportRef, {
            status: 'dismissed',
            dismissedAt: serverTimestamp(),
            dismissedBy: 'admin'
        });
        showAlert('Success', 'Report dismissed', 'success');
    } catch (error) {
        console.error('Error dismissing report:', error);
        showAlert('Error', 'Failed to dismiss report', 'error');
    }
}

// Make these functions globally accessible
window.reviewReport = reviewReport;
window.resolveReport = resolveReport;
window.dismissReport = dismissReport;

    // Recent Activity Storage
    let recentActivities = {
        users: [],
        courses: [],
        testimonials: [],
        events: []
    };

    // Update Recent Activity
    function updateRecentActivity(activities, type) {
        recentActivities[type] = activities;
        renderRecentActivity();
    }

    // Render Recent Activity
    function renderRecentActivity() {
        const container = document.getElementById('recentActivity');
        if (!container) return;

        // Combine all activities and sort by timestamp
        const allActivities = [
            ...recentActivities.users,
            ...recentActivities.courses,
            ...recentActivities.testimonials,
            ...recentActivities.events
        ].filter(activity => activity.timestamp)
         .sort((a, b) => {
             const timeA = a.timestamp?.seconds || 0;
             const timeB = b.timestamp?.seconds || 0;
             return timeB - timeA;
         })
         .slice(0, 10); // Show only latest 10 activities

        if (allActivities.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clock"></i>
                    <p>No recent activities yet</p>
                </div>
            `;
            return;
        }

        const activitiesHTML = allActivities.map(activity => {
            const timestamp = activity.timestamp ? 
                new Date(activity.timestamp.seconds * 1000).toLocaleString() : 
                'Just now';

            let icon, title, description;

            switch (activity.type) {
                case 'user_joined':
                    icon = 'fas fa-user-plus';
                    title = 'New User Registered';
                    description = `${activity.data.displayName || activity.data.email} joined as ${activity.data.membershipTier || 'Free'} member`;
                    break;
                case 'course_submitted':
                    icon = 'fas fa-book';
                    title = 'Course Submitted for Review';
                    description = `"${activity.data.title}" by ${activity.data.instructorName}`;
                    break;
                case 'testimonial_submitted':
                    icon = 'fas fa-star';
                    title = 'New Testimonial';
                    description = `${activity.data.rating}-star review from ${activity.data.userName}`;
                    break;
                case 'event_created':
                    icon = 'fas fa-calendar';
                    title = 'Event Scheduled';
                    description = `"${activity.data.title}" for ${activity.data.targetAudience}`;
                    break;
                default:
                    icon = 'fas fa-bell';
                    title = 'Activity';
                    description = 'System activity detected';
            }

            return `
                <div class="activity-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color);">
                    <div style="background: var(--color-primary); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; flex-shrink: 0;">
                        <i class="${icon}"></i>
                    </div>
                    <div style="flex-grow: 1; min-width: 0;">
                        <h4 style="margin: 0 0 0.25rem 0; font-size: 0.95rem; font-weight: 600;">${title}</h4>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.4;">${description}</p>
                        <small style="color: var(--text-secondary); opacity: 0.8; font-size: 0.75rem;">${timestamp}</small>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = `
            <div style="max-height: 400px; overflow-y: auto;">
                ${activitiesHTML}
            </div>
        `;
    }

// Update connection status
function updateConnectionStatus(status) {
    const statusElement = document.getElementById('connectionStatus');
    const statusText = {
            connecting: '<div class="loading"></div> Connecting...',
            connected: '<i class="fas fa-check"></i> Connected',
            disconnected: '<i class="fas fa-times"></i> Disconnected'
        };

        statusElement.className = `connection-status ${status}`;
        statusElement.innerHTML = statusText[status];
        isConnected = status === 'connected';
    }

    // Update testimonials table
    function updateTestimonialsTable(docs) {
        const tbody = document.getElementById('testimonialsTableBody');
        if (docs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No pending testimonials</td></tr>';
            return;
        }

        tbody.innerHTML = docs.map(doc => {
            const testimonial = doc.data();
            const createdAt = testimonial.createdAt ? new Date(testimonial.createdAt.seconds * 1000) : new Date();
            
            // Create star rating display
            const stars = '★'.repeat(testimonial.rating || 0) + '☆'.repeat(5 - (testimonial.rating || 0));
            
            // Truncate content for table display
            const truncatedContent = testimonial.content && testimonial.content.length > 100 
                ? testimonial.content.substring(0, 100) + '...' 
                : testimonial.content || 'No content';

            return `
                <tr>
                    <td>
                        <strong>${testimonial.userName || 'Anonymous'}</strong><br>
                        <small style="color: var(--text-secondary);">${testimonial.userEmail || 'No email'}</small>
                    </td>
                    <td>
                        <div style="max-width: 300px; overflow: hidden;">
                            ${truncatedContent}
                        </div>
                    </td>
                    <td>
                        <div style="color: #ffa500; font-size: 1.1rem;" title="${testimonial.rating}/5 stars">
                            ${stars}
                        </div>
                        <small>${testimonial.rating || 0}/5</small>
                    </td>
                    <td>
                        <div>${createdAt.toLocaleDateString()}</div>
                        <small style="color: var(--text-secondary);">${createdAt.toLocaleTimeString()}</small>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-success" onclick="approveTestimonial('${doc.id}')" title="Approve">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-info" onclick="viewTestimonial('${doc.id}')" title="View Full">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-danger" onclick="rejectTestimonial('${doc.id}')" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Testimonial Actions
    async function approveTestimonial(testimonialId) {
        try {
            const testimonialRef = doc(db, 'testimonials', testimonialId);
            const testimonialDoc = await getDoc(testimonialRef);
            const testimonialData = testimonialDoc.data();
            
            await updateDoc(testimonialRef, {
                status: 'approved',
                approvedAt: serverTimestamp(),
                approvedBy: 'admin',
                isPublic: true
            });

            // Send notification to testimonial author
            if (notificationService && testimonialData.userId) {
                await notificationService.createAdminNotification(
                    testimonialData.userId,
                    'testimonial_approved',
                    `Your testimonial has been approved and is now live on our website!`,
                    testimonialId
                );
            }

            showAlert('Success', 'Testimonial approved and published!', 'success');
        } catch (error) {
            console.error('Error approving testimonial:', error);
            showAlert('Error', 'Failed to approve testimonial', 'error');
        }
    }

    async function rejectTestimonial(testimonialId) {
        if (!confirm('Are you sure you want to reject this testimonial?')) return;

        try {
            const testimonialRef = doc(db, 'testimonials', testimonialId);
            await updateDoc(testimonialRef, {
                status: 'rejected',
                rejectedAt: serverTimestamp(),
                rejectedBy: 'admin',
                isPublic: false
            });
            showAlert('Info', 'Testimonial rejected', 'info');
        } catch (error) {
            console.error('Error rejecting testimonial:', error);
            showAlert('Error', 'Failed to reject testimonial', 'error');
        }
    }

    async function viewTestimonial(testimonialId) {
        try {
            const testimonialRef = doc(db, 'testimonials', testimonialId);
            const testimonialDoc = await getDoc(testimonialRef);
            const testimonialData = testimonialDoc.data();

            const createdAt = testimonialData.createdAt ? 
                new Date(testimonialData.createdAt.seconds * 1000).toLocaleString() : 
                'Unknown date';

            const stars = '★'.repeat(testimonialData.rating || 0) + '☆'.repeat(5 - (testimonialData.rating || 0));

            showAlert('Testimonial Details', `
                <div style="text-align: left;">
                    <h3 style="margin-bottom: 1rem;">${testimonialData.userName || 'Anonymous User'}</h3>
                    <div style="margin-bottom: 1rem;">
                        <strong>Rating:</strong> 
                        <span style="color: #ffa500; font-size: 1.2rem;">${stars}</span> 
                        (${testimonialData.rating || 0}/5)
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Email:</strong> ${testimonialData.userEmail || 'Not provided'}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Membership:</strong> ${testimonialData.userTier || 'Unknown'}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Submitted:</strong> ${createdAt}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Content:</strong><br>
                        <div style="background: var(--hover-bg); padding: 1rem; border-radius: 5px; margin-top: 0.5rem; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
                            ${testimonialData.content || 'No content provided'}
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button onclick="approveTestimonial('${testimonialId}')" style="background: var(--success-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-right: 0.5rem; cursor: pointer;">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button onclick="rejectTestimonial('${testimonialId}')" style="background: var(--danger-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
            `, 'info');
        } catch (error) {
            console.error('Error loading testimonial details:', error);
            showAlert('Error', 'Failed to load testimonial details', 'error');
        }
    }

    // Platform selection
    function selectPlatform(platform) {
        currentStreamPlatform = platform;

        document.querySelectorAll('.streaming-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.querySelector(`[data-platform="${platform}"]`).classList.add('selected');

        const maxParticipants = document.getElementById('maxParticipants');
        switch (platform) {
            case 'jitsi':
                maxParticipants.textContent = '500+';
                break;
            case 'youtube':
                maxParticipants.textContent = 'Unlimited';
                break;
            case 'custom':
                maxParticipants.textContent = 'Depends on service';
                break;
        }

        showAlert('Platform Selected', `${platform.charAt(0).toUpperCase() + platform.slice(1)} streaming platform selected`, 'info');
    }

    // Generate unique room name
    function generateRoomName() {
        const timestamp = Date.now();
        const randomString = Math.random().toString(36).substring(2, 8);
        return `${CONFIG.streaming.jitsi.roomPrefix}${timestamp}_${randomString}`;
    }

    // Create live stream
    async function createLiveStream() {
        try {
            const createBtn = document.getElementById('createStreamBtn');
            const endBtn = document.getElementById('endStreamBtn');
            const streamStatus = document.getElementById('streamStatus');

            createBtn.disabled = true;
            createBtn.innerHTML = '<div class="loading"></div> Creating Stream...';

            let streamUrl, joinUrl;

            switch (currentStreamPlatform) {
                case 'jitsi':
                    currentRoomName = generateRoomName();
                    streamUrl = `https://${CONFIG.streaming.jitsi.domain}/${currentRoomName}`;
                    joinUrl = streamUrl;
                    break;

                case 'youtube':
                    showAlert('Info', 'YouTube Live integration requires additional setup. Please contact support.', 'info');
                    return;

                case 'custom':
                    showAlert('Info', 'Custom RTMP streaming requires additional configuration. Please contact support.', 'info');
                    return;
            }

            // Update UI
            document.getElementById('streamUrl').value = streamUrl;
            document.getElementById('participantUrl').value = joinUrl;
            document.getElementById('joinLink').value = joinUrl;

            document.getElementById('streamUrlDisplay').style.display = 'block';
            document.getElementById('streamLinkDisplay').style.display = 'block';
            document.getElementById('openStreamBtn').style.display = 'inline-block';
            document.getElementById('shareStreamBtn').style.display = 'inline-block';

            createBtn.style.display = 'none';
            endBtn.style.display = 'inline-block';

            streamStatus.className = 'stream-status ready';
            streamStatus.innerHTML = '<i class="fas fa-circle"></i> <span>Ready</span>';

            streamStartTime = Date.now();

            // Save to database using v9 syntax
            if (isConnected && db) {
                try {
                    const liveEventData = {
                        title: "Live Admin Stream",
                        description: "Live streaming session from admin panel",
                        instructorName: "Admin",
                        platform: currentStreamPlatform,
                        roomName: currentRoomName,
                        streamUrl: streamUrl,
                        joinUrl: joinUrl,
                        streamRoomName: currentRoomName,
                        status: 'live',
                        targetAudience: 'All Members',
                        scheduledAt: serverTimestamp(),
                        duration: 3600,
                        createdAt: serverTimestamp(),
                        createdBy: 'admin',
                        isAdminStream: true,
                        participantCount: 0,
                        streamStartedAt: serverTimestamp()
                    };

                    const eventsRef = collection(db, 'liveEvents');
                    const docRef = await addDoc(eventsRef, liveEventData);
                    currentStreamEventId = docRef.id;

                    const activeStreamRef = doc(db, 'activeStreams', 'current');
                    await updateDoc(activeStreamRef, {
                        ...liveEventData,
                        eventId: docRef.id
                    }).catch(async () => {
                        // If document doesn't exist, create it
                        await addDoc(collection(db, 'activeStreams'), {
                            ...liveEventData,
                            eventId: docRef.id
                        });
                    });

                    console.log('Live event created with ID:', docRef.id);

                    // Notify all users about the new livestream
                    if (notificationService) {
                        await notificationService.createLivestreamNotification(
                            docRef.id,
                            "Live Admin Stream",
                            "Live streaming session from admin panel",
                            joinUrl
                        );
                    }

                } catch (error) {
                    console.warn('Could not save to database:', error);
                }
            }

            showAlert('Success', `Live stream created successfully! Share the join link with participants.`, 'success');

        } catch (error) {
            console.error('Error creating live stream:', error);
            showAlert('Error', 'Failed to create live stream: ' + error.message, 'error');
        } finally {
            const createBtn = document.getElementById('createStreamBtn');
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="fas fa-play-circle"></i> Create Live Stream';
        }
    }

    // End live stream
    async function endLiveStream() {
        try {
            const createBtn = document.getElementById('createStreamBtn');
            const endBtn = document.getElementById('endStreamBtn');
            const streamStatus = document.getElementById('streamStatus');

            // Clear URLs
            document.getElementById('streamUrl').value = '';
            document.getElementById('participantUrl').value = '';
            document.getElementById('joinLink').value = '';

            // Hide elements
            document.getElementById('streamUrlDisplay').style.display = 'none';
            document.getElementById('streamLinkDisplay').style.display = 'none';
            document.getElementById('openStreamBtn').style.display = 'none';
            document.getElementById('shareStreamBtn').style.display = 'none';

            createBtn.style.display = 'inline-block';
            endBtn.style.display = 'none';

            streamStatus.className = 'stream-status offline';
            streamStatus.innerHTML = '<i class="fas fa-circle"></i> <span>Offline</span>';

            // Update database using v9 syntax
            if (isConnected && db) {
                try {
                    if (currentStreamEventId) {
                        const eventRef = doc(db, 'liveEvents', currentStreamEventId);
                        await updateDoc(eventRef, {
                            status: 'archived',
                            endedAt: serverTimestamp(),
                            streamEndedAt: serverTimestamp()
                        });
                    }

                    const activeStreamRef = doc(db, 'activeStreams', 'current');
                    await deleteDoc(activeStreamRef);

                } catch (error) {
                    console.warn('Could not update database:', error);
                }
            }

            currentRoomName = '';
            streamStartTime = null;
            currentStreamEventId = null;

            showAlert('Info', 'Live stream ended successfully.', 'info');

        } catch (error) {
            console.error('Error ending live stream:', error);
            showAlert('Error', 'Failed to end live stream properly', 'error');
        }
    }

    // Open stream room
    function openStreamRoom() {
        const streamUrl = document.getElementById('streamUrl').value;
        if (streamUrl) {
            window.open(streamUrl, '_blank', 'width=1200,height=800');

            const streamStatus = document.getElementById('streamStatus');
            streamStatus.className = 'stream-status live';
            streamStatus.innerHTML = '<i class="fas fa-circle"></i> <span>Live</span>';

            if (isConnected && db && currentStreamEventId) {
                const eventRef = doc(db, 'liveEvents', currentStreamEventId);
                updateDoc(eventRef, {
                    status: 'live',
                    liveStartedAt: serverTimestamp(),
                    adminJoinedAt: serverTimestamp()
                }).catch(console.warn);
            }
        }
    }

    // Share stream
    function shareStream() {
        const joinUrl = document.getElementById('participantUrl').value;
        if (joinUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Join Live Stream - Andrew Cares Village',
                    text: 'Join our live stream session',
                    url: joinUrl
                }).catch(console.log);
            } else {
                copyParticipantUrl();
            }
        }
    }

    // Copy functions
    function copyStreamUrl() {
        copyToClipboard('streamUrl', 'Admin stream link copied!');
    }

    function copyParticipantUrl() {
        copyToClipboard('participantUrl', 'Participant join link copied!');
    }

    function copyJoinLink() {
        copyToClipboard('joinLink', 'Join link copied to clipboard!');
    }

    function copyToClipboard(elementId, successMessage) {
        const input = document.getElementById(elementId);
        if (input && input.value) {
            input.select();
            input.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                showAlert('Success', successMessage, 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                showAlert('Info', 'Please manually copy the link', 'info');
            }
        }
    }

   function listenForCourses() {
    const tbody = document.getElementById('coursesTableBody');
    if (!db) return;

    const coursesRef = collection(db, "courses");
    const q = query(coursesRef, where("status", "==", "pending"));

    onSnapshot(q, (querySnapshot) => {
        if (querySnapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No courses are pending approval.</td></tr>';
            return;
        }

        tbody.innerHTML = querySnapshot.docs.map(doc => {
            const course = doc.data();
            const submittedDate = course.createdAt ? new Date(course.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
            const lessonCount = course.totalModules || 0;
            
            return `
                <tr>
                    <td>
                        <div style="max-width: 200px;">
                            <strong>${course.title || 'N/A'}</strong>
                            ${course.description ? `<br><small style="color: var(--text-secondary); font-size: 0.8rem;">${course.description.substring(0, 50)}...</small>` : ''}
                        </div>
                    </td>
                    <td>${course.instructorName || 'Unknown'}</td>
                    <td>
                        <span class="status-badge status-info">${course.discipline || 'General'}</span>
                        <br><small>${course.level || 'Beginner'}</small>
                    </td>
                    <td>
                        <div>${lessonCount} modules</div>
                        <small style="color: var(--text-secondary);">${course.duration || 'N/A'} duration</small>
                    </td>
                    <td>
                        <div>${submittedDate}</div>
                        <small style="color: var(--text-secondary);">by ${course.instructorName}</small>
                    </td>
                    <td>
                        <div class="table-actions" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn-info" onclick="previewCourse('${doc.id}')" title="Preview course content">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button class="btn-primary" onclick="viewCourseDetails('${doc.id}')" title="View detailed information">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn-success" onclick="approveCourse('${doc.id}', '${course.title}')" title="Approve and publish">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn-danger" onclick="rejectCourse('${doc.id}', '${course.title}')" title="Reject and request revision">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }, (error) => {
        console.error("Error listening for courses:", error);
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: red;">Error loading courses. Check console.</td></tr>';
    });
}

// Preview course function - opens course management page in admin mode
async function previewCourse(courseId) {
    try {
        // Verify course exists and get basic info
        const courseRef = doc(db, 'courses', courseId);
        const courseDoc = await getDoc(courseRef);
        
        if (!courseDoc.exists()) {
            showAlert('Error', 'Course not found', 'error');
            return;
        }
        
        const courseData = courseDoc.data();
        
        // Open course management page in new tab with admin preview mode
        const previewUrl = `course-management.html?id=${courseId}&mode=admin_preview&return=admin`;
        window.open(previewUrl, '_blank', 'width=1200,height=800');
        
        // Log the preview action
        console.log(`Admin previewing course: ${courseData.title} (${courseId})`);
        
        // Optional: Track admin preview in database
        try {
            await addDoc(collection(db, 'admin_actions'), {
                action: 'course_preview',
                courseId: courseId,
                courseTitle: courseData.title,
                adminId: 'admin', // You might want to get actual admin ID
                timestamp: serverTimestamp()
            });
        } catch (logError) {
            console.warn('Could not log admin action:', logError);
        }
        
    } catch (error) {
        console.error('Error previewing course:', error);
        showAlert('Error', 'Failed to preview course', 'error');
    }
}

// View course details in a modal
async function viewCourseDetails(courseId) {
    try {
        const courseRef = doc(db, 'courses', courseId);
        const courseDoc = await getDoc(courseRef);
        
        if (!courseDoc.exists()) {
            showAlert('Error', 'Course not found', 'error');
            return;
        }
        
        const course = courseDoc.data();
        const createdDate = course.createdAt ? new Date(course.createdAt.seconds * 1000).toLocaleString() : 'Unknown';
        const submittedDate = course.submittedAt ? new Date(course.submittedAt.seconds * 1000).toLocaleString() : 'Not submitted';
        
        // Get lesson count
        let lessonCount = 0;
        try {
            const lessonsQuery = query(collection(db, "courses", courseId, "lessons"));
            const lessonsSnapshot = await getDocs(lessonsQuery);
            lessonCount = lessonsSnapshot.size;
        } catch (lessonError) {
            console.warn('Could not get lesson count:', lessonError);
        }
        
        const detailsHTML = `
            <div style="text-align: left; max-height: 600px; overflow-y: auto;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <div>
                        <h3 style="color: var(--color-primary); margin-bottom: 1rem;">${course.title}</h3>
                        <p><strong>Instructor:</strong> ${course.instructorName}</p>
                        <p><strong>Discipline:</strong> ${course.discipline || 'General'}</p>
                        <p><strong>Level:</strong> ${course.level || 'Beginner'}</p>
                        <p><strong>Duration:</strong> ${course.duration || 'Not specified'}</p>
                    </div>
                    <div>
                        <p><strong>Total Modules:</strong> ${course.totalModules || 0}</p>
                        <p><strong>Actual Lessons:</strong> ${lessonCount}</p>
                        <p><strong>Language:</strong> ${course.language || 'English'}</p>
                        <p><strong>Created:</strong> ${createdDate}</p>
                        <p><strong>Submitted:</strong> ${submittedDate}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <strong>Description:</strong>
                    <div style="background: var(--hover-bg); padding: 1rem; border-radius: 8px; margin-top: 0.5rem; line-height: 1.5;">
                        ${course.description || 'No description provided'}
                    </div>
                </div>
                
                ${course.prerequisites ? `
                <div style="margin-bottom: 1.5rem;">
                    <strong>Prerequisites:</strong>
                    <div style="background: var(--hover-bg); padding: 1rem; border-radius: 8px; margin-top: 0.5rem; line-height: 1.5;">
                        ${course.prerequisites}
                    </div>
                </div>
                ` : ''}
                
                ${course.skills && course.skills.length > 0 ? `
                <div style="margin-bottom: 1.5rem;">
                    <strong>Skills Covered:</strong>
                    <div style="margin-top: 0.5rem;">
                        ${course.skills.map(skill => `<span class="skill-tag" style="display: inline-block; background: var(--color-primary); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; margin: 0.2rem; font-size: 0.8rem;">${skill}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button class="btn btn-info" onclick="previewCourse('${courseId}')" style="margin-right: 1rem;">
                        <i class="fas fa-eye"></i> Preview Full Course
                    </button>
                    <button class="btn btn-success" onclick="approveCourse('${courseId}', '${course.title}'); closeModal();" style="margin-right: 0.5rem;">
                        <i class="fas fa-check"></i> Approve Course
                    </button>
                    <button class="btn btn-danger" onclick="rejectCourse('${courseId}', '${course.title}'); closeModal();">
                        <i class="fas fa-times"></i> Reject Course
                    </button>
                </div>
            </div>
        `;
        
        showAlert(`Course Details: ${course.title}`, detailsHTML, 'info');
        
    } catch (error) {
        console.error('Error loading course details:', error);
        showAlert('Error', 'Failed to load course details', 'error');
    }
}

    // Update dashboard stats using v9 syntax
       async function updateStats() {
        const [usersSnapshot, moderationsSnapshot, resourcesSnapshot] = await Promise.all([
            getDocs(collection(db, 'users')),
            getDocs(collection(db, 'moderation_alerts')),
            getDocs(collection(db, 'resources'))
        ]);

        document.getElementById('totalUsers').textContent = usersSnapshot.size;
        // The 'activeSubscriptions' element is removed, so we don't need to update it.
        document.getElementById('pendingModerations').textContent = moderationsSnapshot.size;
        document.getElementById('totalResources').textContent = resourcesSnapshot.size;
    }

    // Update users table
    function updateUsersTable(docs) {
        const tbody = document.getElementById('usersTableBody');
        if (docs.length === 0) {
            tbody.innerHTML = '<tr> <td colspan="6" style="text-align: center; padding: 2rem;">No users found</td></tr>';
            return;
        }

        tbody.innerHTML = docs.map(doc => {
            const user = doc.data();
            return `
                <tr>
                    <td>${user.displayName || 'Unknown'}</td>
                    <td>${user.email}</td>
                     
                    <td>${user.role || 'Member'}</td>
                    <td>${user.warnings || 0}</td>
                    <td><span class="status-badge ${getStatusClass(user.status)}">${user.status || 'Active'}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-primary" onclick="viewUser('${doc.id}')">View</button>
                            <button class="btn-warning" onclick="editUser('${doc.id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteUser('${doc.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Update events table
    function updateEventsTable(docs) {
        const tbody = document.getElementById('eventsTableBody');
        if (docs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No events scheduled</td></tr>';
            return;
        }

        tbody.innerHTML = docs.map(doc => {
            const event = doc.data();
            const eventDate = event.scheduledAt ? new Date(event.scheduledAt.seconds * 1000) : new Date();

            return `
                <tr>
                    <td>${event.title}</td>
                    <td>${eventDate.toLocaleString()}</td>
                    <td>${event.targetAudience || event.audience}</td>
                    <td>${event.platform || event.streamPlatform || 'Jitsi Meet'}</td>
                    <td><span class="status-badge ${getStatusClass(event.status)}">${event.status || 'Scheduled'}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-primary" onclick="editEvent('${doc.id}')">Edit</button>
                            <button class="btn-danger" onclick="cancelEvent('${doc.id}')">Cancel</button>
                            ${event.isLiveStream ? `<button class="btn-info" onclick="startEventStream('${doc.id}')">Go Live</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Update resources table
    function updateResourcesTable(docs) {
        const tbody = document.getElementById('resourcesTableBody');
        if (docs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No resources found</td></tr>';
            return;
        }

        tbody.innerHTML = docs.map(doc => {
            const resource = doc.data();
            return `
                <tr>
                    <td>${resource.title}</td>
                    <td>${capitalizeFirst(resource.category)}</td>
                    <td>${resource.fileType || 'Unknown'}</td>
                    <td>${formatFileSize(resource.fileSize || 0)}</td>
                     
                    <td>${resource.downloads || 0}</td>
                    <td>${resource.featured ? 'Yes' : 'No'}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-info" onclick="downloadResource('${doc.id}')">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn-warning" onclick="editResource('${doc.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-danger" onclick="deleteResourceEnhanced('${doc.id}', '${resource.filePath || ''}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Update announcements table
    function updateAnnouncementsTable(docs) {
        const tbody = document.getElementById('announcementsTableBody');
        if (docs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No announcements found</td></tr>';
            return;
        }

        tbody.innerHTML = docs.map(doc => {
            const announcement = doc.data();
            const createdAt = announcement.createdAt ? new Date(announcement.createdAt.seconds * 1000) : new Date();

            return `
                <tr>
                    <td>${announcement.title}</td>
                    <td>${announcement.audience}</td>
                    <td><span class="status-badge ${getPriorityClass(announcement.priority)}">${announcement.priority}</span></td>
                    <td>${createdAt.toLocaleString()}</td>
                    <td><span class="status-badge ${getStatusClass(announcement.status)}">${announcement.status || 'Sent'}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-primary" onclick="viewAnnouncement('${doc.id}')">View</button>
                            <button class="btn-danger" onclick="deleteAnnouncement('${doc.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Cloudinary upload function
    async function uploadToCloudinary(file, onProgress) {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CONFIG.cloudinary.uploadPreset);

            const fileExtension = file.name.split('.').pop().toLowerCase();
            let resourceType = 'auto';

            if (fileExtension === 'pdf') {
                resourceType = 'raw';
            }

            formData.append('resource_type', resourceType);

            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable && onProgress) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    onProgress(percentComplete);
                }
            });

            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    resolve(response);
                } else {
                    reject(new Error('Upload failed'));
                }
            });

            xhr.addEventListener('error', () => reject(new Error('Upload failed')));

            xhr.open('POST', `https://api.cloudinary.com/v1_1/${CONFIG.cloudinary.cloudName}/${resourceType}/upload`);
            xhr.send(formData);
        });
    }

    // Utility functions
    function getStatusClass(status) {
        switch (status?.toLowerCase()) {
            case 'active': return 'status-active';
            case 'blocked': return 'status-blocked';
            case 'warning': return 'status-warning';
            case 'new': return 'status-new';
            case 'live': return 'status-active';
            case 'scheduled': return 'status-new';
            case 'cancelled': return 'status-blocked';
            case 'ready': return 'status-warning';
            default: return 'status-active';
        }
    }

    function getPriorityClass(priority) {
        switch (priority?.toLowerCase()) {
            case 'low': return 'status-new';
            case 'medium': return 'status-warning';
            case 'high': return 'status-blocked';
            case 'urgent': return 'status-blocked';
            default: return 'status-new';
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function getFileType(fileName) {
        const extension = fileName.split('.').pop().toUpperCase();
        return extension;
    }

    function capitalizeFirst(str) {
        if (!str) return 'Unknown';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Navigation System
    function initializeNavigation() {
        const navButtons = document.querySelectorAll('.nav-link');
        const pageContents = document.querySelectorAll('.page-content');

        navButtons.forEach((button) => {
            button.addEventListener('click', function (e) {
                e.preventDefault();

                navButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                const pageId = this.dataset.page;
                pageContents.forEach(page => page.classList.remove('active'));

                const selectedPage = document.getElementById(`page-${pageId}`);
                if (selectedPage) {
                    selectedPage.classList.add('active');
                }
            });
        });
    }

    // Alert System
    function showAlert(title, message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `
            <h4>${title}</h4>
            <p>${message}</p>
        `;
        document.querySelector('.main-content').prepend(alert);

        setTimeout(() => {
            alert.classList.add('fade-out');
            setTimeout(() => alert.remove(), 500);
        }, 4000);
    }

    // File Upload Handler
    function initializeFileUpload() {
        const uploadArea = document.getElementById('uploadArea');
        const resourceFile = document.getElementById('resourceFile');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        if (uploadArea && resourceFile) {
            uploadArea.addEventListener('click', () => resourceFile.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleFileSelect(file);
            });

            resourceFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFileSelect(file);
            });
        }

        function handleFileSelect(file) {
            if (file.size > 50 * 1024 * 1024) {
                showAlert('Error', 'File too large. Maximum size is 50MB.', 'error');
                return;
            }

            const allowedTypes = ['pdf', 'doc', 'docx', 'mp4', 'mp3', 'zip'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExtension)) {
                showAlert('Error', 'File type not allowed. Please upload PDF, DOC, MP4, MP3, or ZIP files.', 'error');
                return;
            }

            if (fileName && fileSize && fileInfo) {
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                fileInfo.style.display = 'block';
            }
        }
    }

    // Form Handlers
    function initializeForms() {
        // Resource Upload Form
        const resourceForm = document.getElementById('resourceUploadForm');
        if (resourceForm) {
            resourceForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const file = document.getElementById('resourceFile').files[0];
                if (!file) {
                    showAlert('Error', 'Please select a file to upload', 'error');
                    return;
                }

                const uploadBtn = document.getElementById('uploadResourceBtn');
                const uploadProgress = document.getElementById('uploadProgress');
                const uploadProgressBar = document.getElementById('uploadProgressBar');
                const uploadArea = document.getElementById('uploadArea');

                try {
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<div class="loading"></div> Uploading...';
                    uploadArea.classList.add('uploading');
                    uploadProgress.style.display = 'block';

                    const uploadResult = await uploadToCloudinary(file, (progress) => {
                        uploadProgressBar.style.width = progress + '%';
                    });

                    const resourceData = {
                        title: document.getElementById('resourceTitle').value,
                        category: document.getElementById('resourceCategory').value,
                        description: document.getElementById('resourceDescription').value,
                        requiredTier: document.getElementById('resourceTier').value,
                        featured: document.getElementById('resourceFeatured').value === 'true',
                        downloadUrl: uploadResult.secure_url,
                        fileName: file.name,
                        fileType: getFileType(file.name),
                        fileSize: file.size,
                        filePath: uploadResult.public_id,
                        downloads: 0,
                        createdAt: serverTimestamp(),
                        uploadedBy: 'admin'
                    };

                    const resourcesRef = collection(db, 'resources');
                    await addDoc(resourcesRef, resourceData);
                    showAlert('Success', 'Resource uploaded successfully!', 'success');
                    resourceForm.reset();
                    document.getElementById('fileInfo').style.display = 'none';

                } catch (error) {
                    console.error('Upload error:', error);
                    showAlert('Error', 'Failed to upload resource: ' + error.message, 'error');
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Resource';
                    uploadArea.classList.remove('uploading');
                    uploadProgress.style.display = 'none';
                    uploadProgressBar.style.width = '0%';
                }
            });
        }

        // Event Form
        const eventForm = document.getElementById('newEventForm');
        if (eventForm) {
            eventForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                try {
                    const eventData = {
                        title: document.getElementById('eventTitle').value,
                        scheduledAt: Timestamp.fromDate(new Date(document.getElementById('eventDateTime').value)),
                        description: document.getElementById('eventDescription').value,
                        targetAudience: document.getElementById('eventAudience').value,
                        duration: parseInt(document.getElementById('eventDuration').value) || 60,
                        isLiveStream: document.getElementById('isLiveStream').value === 'true',
                        streamPlatform: document.getElementById('streamPlatform').value,
                        status: 'scheduled',
                        createdAt: serverTimestamp(),
                        createdBy: 'admin'
                    };

                    if (eventData.isLiveStream) {
                        eventData.streamDomain = CONFIG.streaming[eventData.streamPlatform]?.domain || 'meet.jit.si';
                    }

                    const eventsRef = collection(db, 'liveEvents');
                    await addDoc(eventsRef, eventData);
                    showAlert('Success', 'Event scheduled successfully!', 'success');
                    eventForm.reset();
                } catch (error) {
                    console.error('Event creation error:', error);
                    showAlert('Error', 'Failed to schedule event: ' + error.message, 'error');
                }
            });
        }

        // Announcement Form
        const announcementForm = document.getElementById('announcementForm');
        if (announcementForm) {
            announcementForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                try {
                    const announcementData = {
                        title: document.getElementById('announcementTitle').value,
                        content: document.getElementById('announcementContent').value,
                        audience: document.getElementById('announcementAudience').value,
                        priority: document.getElementById('announcementPriority').value,
                        status: 'sent',
                        createdAt: serverTimestamp(),
                        createdBy: 'admin'
                    };

                    const announcementsRef = collection(db, 'announcements');
                    await addDoc(announcementsRef, announcementData);
                    showAlert('Success', 'Announcement sent successfully!', 'success');
                    announcementForm.reset();
                } catch (error) {
                    console.error('Announcement creation error:', error);
                    showAlert('Error', 'Failed to send announcement: ' + error.message, 'error');
                }
            });
        }
    }

    // Live Stream Controls
    function initializeLiveStreamControls() {
        const createStreamBtn = document.getElementById('createStreamBtn');
        const endStreamBtn = document.getElementById('endStreamBtn');
        const openStreamBtn = document.getElementById('openStreamBtn');
        const shareStreamBtn = document.getElementById('shareStreamBtn');

        if (createStreamBtn) {
            createStreamBtn.addEventListener('click', createLiveStream);
        }

        if (endStreamBtn) {
            endStreamBtn.addEventListener('click', endLiveStream);
        }

        if (openStreamBtn) {
            openStreamBtn.addEventListener('click', openStreamRoom);
        }

        if (shareStreamBtn) {
            shareStreamBtn.addEventListener('click', shareStream);
        }
    }

    // Action functions - Fixed to use v9 syntax
    async function viewUser(userId) {
        try {
            const userRef = doc(db, 'users', userId);
            const userDoc = await getDoc(userRef);
            const userData = userDoc.data();
            showAlert('User Details', `
                Name: ${userData.displayName}<br>
                Email: ${userData.email}<br>
                Tier: ${userData.membershipTier}<br>
                Status: ${userData.status}
            `, 'info');
        } catch (error) {
            showAlert('Error', 'Failed to load user details', 'error');
        }
    }

    async function editUser(userId) {
        showAlert('Info', 'Edit user functionality would open a modal here', 'info');
    }

    async function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            try {
                const userRef = doc(db, 'users', userId);
                await deleteDoc(userRef);
                showAlert('Success', 'User deleted successfully', 'success');
            } catch (error) {
                showAlert('Error', 'Failed to delete user', 'error');
            }
        }
    }


// Updated approval function with better feedback
async function approveCourse(courseId, courseTitle) {
    const confirmMessage = `Approve and publish "${courseTitle}"?\n\nThis will make the course available to students immediately.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        const courseRef = doc(db, 'courses', courseId);
        await updateDoc(courseRef, {
            status: 'published',
            approvedAt: serverTimestamp(),
            approvedBy: 'admin',
            publishedAt: serverTimestamp()
        });
        
        // Log admin action
        await addDoc(collection(db, 'admin_actions'), {
            action: 'course_approved',
            courseId: courseId,
            courseTitle: courseTitle,
            adminId: 'admin',
            timestamp: serverTimestamp()
        });
        
        showAlert('Success', `Course "${courseTitle}" approved and published successfully!`, 'success');
    } catch (error) {
        console.error('Error approving course:', error);
        showAlert('Error', 'Failed to approve course', 'error');
    }
}

// Updated rejection function with feedback system
async function rejectCourse(courseId, courseTitle) {
    const feedback = prompt(`Reject "${courseTitle}"?\n\nPlease provide feedback for the instructor (required):`);
    
    if (feedback === null) {
        return; // User cancelled
    }
    
    if (!feedback.trim()) {
        alert('Feedback is required when rejecting a course.');
        return;
    }

    try {
        const courseRef = doc(db, 'courses', courseId);
        await updateDoc(courseRef, {
            status: 'needs_revision',
            rejectedAt: serverTimestamp(),
            rejectedBy: 'admin',
            adminFeedback: feedback,
            needsRevision: true
        });
        
        // Log admin action
        await addDoc(collection(db, 'admin_actions'), {
            action: 'course_rejected',
            courseId: courseId,
            courseTitle: courseTitle,
            feedback: feedback,
            adminId: 'admin',
            timestamp: serverTimestamp()
        });
        
        showAlert('Info', `Course "${courseTitle}" rejected and sent back for revision with feedback.`, 'info');
    } catch (error) {
        console.error('Error rejecting course:', error);
        showAlert('Error', 'Failed to reject course', 'error');
    }
}

// Make functions globally accessible
window.previewCourse = previewCourse;
window.viewCourseDetails = viewCourseDetails;
window.approveCourse = approveCourse;
window.rejectCourse = rejectCourse;

// Add this to your admin panel JavaScript

// Helper function to update course with admin feedback from preview window
async function updateCourseWithFeedback(courseId, feedback, checklistData) {
    try {
        const courseRef = doc(db, 'courses', courseId);
        await updateDoc(courseRef, {
            adminFeedback: feedback,
            adminChecklist: checklistData,
            reviewedAt: serverTimestamp(),
            reviewedBy: 'admin'
        });
        
        console.log('Course updated with admin feedback');
    } catch (error) {
        console.error('Error updating course with feedback:', error);
        throw error;
    }
}

// Enhanced rejection function that accepts feedback parameter
async function rejectCourseWithFeedback(courseId, courseTitle, feedback = null) {
    const finalFeedback = feedback || prompt(`Reject "${courseTitle}"?\n\nPlease provide feedback for the instructor (required):`);
    
    if (finalFeedback === null) {
        return; // User cancelled
    }
    
    if (!finalFeedback.trim()) {
        alert('Feedback is required when rejecting a course.');
        return;
    }

    try {
        const courseRef = doc(db, 'courses', courseId);
        await updateDoc(courseRef, {
            status: 'needs_revision',
            rejectedAt: serverTimestamp(),
            rejectedBy: 'admin',
            adminFeedback: finalFeedback,
            needsRevision: true
        });
        
        // Log admin action
        await addDoc(collection(db, 'admin_actions'), {
            action: 'course_rejected',
            courseId: courseId,
            courseTitle: courseTitle,
            feedback: finalFeedback,
            adminId: 'admin',
            timestamp: serverTimestamp()
        });
        
        showAlert('Info', `Course "${courseTitle}" rejected and sent back for revision with feedback.`, 'info');
    } catch (error) {
        console.error('Error rejecting course:', error);
        showAlert('Error', 'Failed to reject course', 'error');
    }
}

// Enhanced approval function that accepts feedback parameter
async function approveCourseWithFeedback(courseId, courseTitle, feedback = null, checklistData = null) {
    try {
        const updateData = {
            status: 'published',
            approvedAt: serverTimestamp(),
            approvedBy: 'admin',
            publishedAt: serverTimestamp()
        };
        
        if (feedback) {
            updateData.adminFeedback = feedback;
        }
        
        if (checklistData) {
            updateData.adminChecklist = checklistData;
        }
        
        const courseRef = doc(db, 'courses', courseId);
        await updateDoc(courseRef, updateData);
        
        // Log admin action
        await addDoc(collection(db, 'admin_actions'), {
            action: 'course_approved',
            courseId: courseId,
            courseTitle: courseTitle,
            feedback: feedback,
            checklistData: checklistData,
            adminId: 'admin',
            timestamp: serverTimestamp()
        });
        
        showAlert('Success', `Course "${courseTitle}" approved and published successfully!`, 'success');
    } catch (error) {
        console.error('Error approving course:', error);
        showAlert('Error', 'Failed to approve course', 'error');
    }
}

// Make these functions globally accessible for preview window
window.updateCourseWithFeedback = updateCourseWithFeedback;
window.rejectCourseWithFeedback = rejectCourseWithFeedback;
window.approveCourseWithFeedback = approveCourseWithFeedback;

// Update the original functions to use the new enhanced versions
window.rejectCourse = function(courseId, courseTitle) {
    return rejectCourseWithFeedback(courseId, courseTitle);
};

window.approveCourse = function(courseId, courseTitle) {
    const confirmMessage = `Approve and publish "${courseTitle}"?\n\nThis will make the course available to students immediately.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    return approveCourseWithFeedback(courseId, courseTitle);
};
    async function editEvent(eventId) {
        showAlert('Info', 'Edit event modal would open here', 'info');
    }

    async function cancelEvent(eventId) {
        if (confirm('Are you sure you want to cancel this event?')) {
            try {
                const eventRef = doc(db, 'liveEvents', eventId);
                await updateDoc(eventRef, {
                    status: 'cancelled',
                    cancelledAt: serverTimestamp()
                });
                showAlert('Info', 'Event cancelled', 'info');
            } catch (error) {
                showAlert('Error', 'Failed to cancel event', 'error');
            }
        }
    }

    async function startEventStream(eventId) {
        try {
            const eventRef = doc(db, 'liveEvents', eventId);
            const eventDoc = await getDoc(eventRef);
            const eventData = eventDoc.data();

            if (eventData.isLiveStream) {
                const eventRoomName = `${CONFIG.streaming.jitsi.roomPrefix}Event_${eventId}`;
                const streamUrl = `https://${CONFIG.streaming.jitsi.domain}/${eventRoomName}`;

                await updateDoc(eventRef, {
                    status: 'live',
                    streamRoomName: eventRoomName,
                    streamUrl: streamUrl,
                    liveStartedAt: serverTimestamp()
                });

                window.open(streamUrl, '_blank', 'width=1200,height=800');
                showAlert('Success', `Event "${eventData.title}" is now live! Room: ${eventRoomName}`, 'success');
            } else {
                showAlert('Error', 'This event is not configured as a live stream event', 'error');
            }
        } catch (error) {
            console.error('Error starting event stream:', error);
            showAlert('Error', 'Failed to start event stream', 'error');
        }
    }

    async function downloadResource(resourceId) {
        try {
            const resourceRef = doc(db, 'resources', resourceId);
            const resourceDoc = await getDoc(resourceRef);
            const resourceData = resourceDoc.data();

            window.open(resourceData.downloadUrl || resourceData.fileUrl, '_blank');

            await updateDoc(resourceRef, {
                downloads: increment(1)
            });

            showAlert('Success', 'Download started!', 'success');
        } catch (error) {
            console.error('Download error:', error);
            showAlert('Error', 'Download failed: ' + error.message, 'error');
        }
    }

    async function editResource(resourceId) {
        showAlert('Info', 'Edit resource modal would open here', 'info');
    }

    async function deleteResourceEnhanced(resourceId, filePath) {
        if (!confirm('Are you sure you want to delete this resource? This action cannot be undone.')) {
            return;
        }

        try {
            if (filePath && storage) {
                try {
                    const fileRef = ref(storage, filePath);
                    await deleteObject(fileRef);
                } catch (storageError) {
                    console.warn('Could not delete from storage:', storageError);
                }
            }

            const resourceRef = doc(db, 'resources', resourceId);
            await deleteDoc(resourceRef);
            showAlert('Success', 'Resource deleted successfully!', 'success');
        } catch (error) {
            console.error('Delete error:', error);
            showAlert('Error', 'Delete failed: ' + error.message, 'error');
        }
    }

    async function viewAnnouncement(announcementId) {
        try {
            const announcementRef = doc(db, 'announcements', announcementId);
            const announcementDoc = await getDoc(announcementRef);
            const announcementData = announcementDoc.data();

            showAlert('Announcement Details', `
                <strong>${announcementData.title}</strong><br><br>
                ${announcementData.content}<br><br>
                <small>Audience: ${announcementData.audience} | Priority: ${announcementData.priority}</small>
            `, 'info');
        } catch (error) {
            showAlert('Error', 'Failed to load announcement details', 'error');
        }
    }

    async function deleteAnnouncement(announcementId) {
        if (confirm('Are you sure you want to delete this announcement?')) {
            try {
                const announcementRef = doc(db, 'announcements', announcementId);
                await deleteDoc(announcementRef);
                showAlert('Success', 'Announcement deleted successfully', 'success');
            } catch (error) {
                showAlert('Error', 'Failed to delete announcement', 'error');
            }
        }
    }

    // Logout Handler
    function initializeLogout() {
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        if (currentRoomName) {
                            await endLiveStream();
                        }

                        if (auth) {
                            await signOut(auth);
                        }

                        showAlert('Info', 'Logged out successfully', 'info');
                        setTimeout(() => {
                            window.location.href = '/login.html';
                        }, 1000);
                    } catch (error) {
                        showAlert('Error', 'Logout failed', 'error');
                    }
                }
            });
        }
    }

    // Add demo data - Fixed to use v9 syntax
    async function addDemoData() {
        if (!isConnected) return;

        try {
            const usersRef = collection(db, 'users');
            const usersSnapshot = await getDocs(usersRef);
            if (usersSnapshot.size > 0) return;

            const demoUsers = [
                {
                    displayName: 'John Doe',
                    email: 'john@example.com',
                    membershipTier: 'Patron',
                    role: 'Member',
                    status: 'active',
                    warnings: 0,
                    createdAt: serverTimestamp()
                },
                {
                    displayName: 'Jane Smith',
                    email: 'jane@example.com',
                    membershipTier: 'Elder',
                    role: 'Instructor',
                    status: 'active',
                    warnings: 1,
                    createdAt: serverTimestamp()
                }
            ];

            for (const user of demoUsers) {
                await addDoc(usersRef, user);
            }

            const demoEvents = [
                {
                    title: 'Weekly Trading Masterclass',
                    description: 'Advanced forex trading strategies and market analysis',
                    scheduledAt: Timestamp.fromDate(new Date(Date.now() + 24 * 60 * 60 * 1000)),
                    targetAudience: 'Patrons & Up',
                    isLiveStream: true,
                    streamPlatform: 'jitsi',
                    status: 'scheduled',
                    duration: 90,
                    createdAt: serverTimestamp()
                }
            ];

            const eventsRef = collection(db, 'liveEvents');
            for (const event of demoEvents) {
                await addDoc(eventsRef, event);
            }

            // Add demo testimonials
            const demoTestimonials = [
                {
                    userName: 'Michael Johnson',
                    userEmail: 'michael@example.com',
                    userTier: 'Elder',
                    rating: 5,
                    content: 'This community has completely transformed my trading approach. The live sessions are incredibly valuable and Andrew\'s teaching style makes complex concepts easy to understand.',
                    status: 'pending',
                    createdAt: serverTimestamp()
                },
                {
                    userName: 'Sarah Williams',
                    userEmail: 'sarah@example.com',
                    userTier: 'Patron',
                    rating: 4,
                    content: 'Great resources and supportive community. The fitness programs have helped me stay disciplined not just in trading but in life. Highly recommend to anyone serious about personal development.',
                    status: 'pending',
                    createdAt: serverTimestamp()
                }
            ];

            const testimonialsRef = collection(db, 'testimonials');
            for (const testimonial of demoTestimonials) {
                await addDoc(testimonialsRef, testimonial);
            }

            console.log('Demo data added successfully');
        } catch (error) {
            console.error('Error adding demo data:', error);
        }
    }

    // Make functions globally available
    window.selectPlatform = selectPlatform;
    window.copyStreamUrl = copyStreamUrl;
    window.copyParticipantUrl = copyParticipantUrl;
    window.copyJoinLink = copyJoinLink;
    window.viewUser = viewUser;
    window.editUser = editUser;
    window.deleteUser = deleteUser;
    window.approveCourse = approveCourse;
    window.rejectCourse = rejectCourse;
    window.reviewCourse = (courseId) => {
        console.log(`Admin is reviewing course with ID: ${courseId}`);
        window.open(`course-management.html?id=${courseId}&view=admin`, '_blank');
    };
    window.editEvent = editEvent;
    window.cancelEvent = cancelEvent;
    window.startEventStream = startEventStream;
    window.downloadResource = downloadResource;
    window.editResource = editResource;
    window.deleteResourceEnhanced = deleteResourceEnhanced;
    window.viewAnnouncement = viewAnnouncement;
    window.deleteAnnouncement = deleteAnnouncement;
    window.approveTestimonial = approveTestimonial;
    window.rejectTestimonial = rejectTestimonial;
    window.viewTestimonial = viewTestimonial;
    window.activateQuestion = activateQuestion;
window.deactivateQuestion = deactivateQuestion;
window.deleteQuestion = deleteQuestion;
window.viewQuestion = viewQuestion;
window.editQuestion = editQuestion;
window.viewQuestionResponses = viewQuestionResponses;
window.viewApplicationDetails = viewApplicationDetails;
window.approveApplication = approveApplication;
window.rejectApplication = rejectApplication;

// Approve application
async function approveApplication(applicationId, applicantName, applicantEmail) {
    const confirmMessage = `Approve ${applicantName}'s instructor application?\n\nThis will:\n- Create an instructor account\n- Send welcome email\n- Grant instructor permissions`;
    
    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        // Update application status
        const appRef = doc(db, 'instructor_applications', applicationId);
        await updateDoc(appRef, {
            status: 'approved',
            approvedAt: serverTimestamp(),
            approvedBy: 'admin',
            processedAt: serverTimestamp()
        });

        // Create instructor account in users collection
        const instructorData = {
            email: applicantEmail,
            displayName: applicantName,
            role: 'instructor',
            membershipTier: 'Instructor',
            status: 'active',
            isInstructor: true,
            instructorStatus: 'approved',
            approvedAt: serverTimestamp(),
            createdAt: serverTimestamp(),
            applicationId: applicationId
        };

        // Check if user already exists
        const usersRef = collection(db, 'users');
        const existingUserQuery = query(usersRef, where('email', '==', applicantEmail));
        const existingUserSnapshot = await getDocs(existingUserQuery);

        if (!existingUserSnapshot.empty) {
            // Update existing user
            const existingUserDoc = existingUserSnapshot.docs[0];
            await updateDoc(existingUserDoc.ref, {
                role: 'instructor',
                membershipTier: 'Instructor',
                isInstructor: true,
                instructorStatus: 'approved',
                instructorApprovedAt: serverTimestamp(),
                applicationId: applicationId
            });
        } else {
            // Create new user with email-based document ID to avoid conflicts
            const userDocId = applicantEmail.replace(/[@.]/g, '_');
            await setDoc(doc(db, 'users', userDocId), instructorData);
        }

        // Log admin action
        try {
            await addDoc(collection(db, 'admin_actions'), {
                action: 'instructor_approved',
                applicantName: applicantName,
                applicantEmail: applicantEmail,
                applicationId: applicationId,
                adminId: 'admin',
                timestamp: serverTimestamp()
            });
        } catch (actionError) {
            console.warn('Failed to log admin action:', actionError);
        }

        // Create notification for the new instructor
        try {
            await addDoc(collection(db, 'notifications'), {
                userId: applicantEmail,
                type: 'instructor_approval',
                title: 'Welcome to Andrew Cares Village!',
                message: 'Congratulations! Your instructor application has been approved. You can now start creating courses and hosting sessions.',
                read: false,
                createdAt: serverTimestamp()
            });
        } catch (notificationError) {
            console.warn('Failed to create notification:', notificationError);
        }

        showAlert('Success', `${applicantName} approved as instructor! Approval email will be sent shortly.`, 'success');

        // Call Google Apps Script to send approval email
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbyCsr7VugKOEA3tRCpwfpDFAfjIkpK-Ih7DyE1mTGVUP5J8YhYyHAppNr7PjQt1uKcHRA/exec', {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'sendApprovalEmail',
                    applicantName: applicantName,
                    applicantEmail: applicantEmail
                })
            });
            console.log('Approval email triggered');
        } catch (emailError) {
            console.warn('Failed to trigger approval email:', emailError);
        }

    } catch (error) {
        console.error('Error approving application:', error);
        showAlert('Error', 'Failed to approve application: ' + error.message, 'error');
    }
}


   // FIXED: Main initialization for admin panel
document.addEventListener('DOMContentLoaded', async function () {
    console.log('DOM Content Loaded - Initializing admin panel...');

    try {
        updateConnectionStatus('connecting');
        const firebaseInit = await initializeFirebase();

        if (!firebaseInit) {
            throw new Error('Firebase initialization failed');
        }

        // Initialize UI components
        initializeNavigation();
        initializeFileUpload();
        initializeForms();
        initializeLiveStreamControls();
        initializeLogout();

        // FIXED: Load data after Firebase is ready
        console.log('Setting up real-time listeners...');
        
        // Set up individual listeners (this replaces the problematic loadAllData call)
        listenForUsers();        // Now defined
        listenForCourses();      // This is the important one for course approvals
        loadModeration();        // Now defined
        listenForApplications(); // Already working
        
        // Set up other real-time listeners
        setupRealtimeListeners();
        
        // Load initial dashboard stats
        await loadDashboardStats();

        console.log('Admin panel initialized successfully');
        showAlert('Success', 'Admin panel loaded successfully! All systems operational.', 'success');

        setTimeout(() => {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.style.display = 'none';
            }
        }, 3000);

        // Add demo data if needed (after everything is set up)
        setTimeout(addDemoData, 2000);

    } catch (error) {
        console.error('Error initializing admin panel:', error);
        showAlert('Error', 'Failed to initialize admin panel: ' + error.message, 'error');
        updateConnectionStatus('disconnected');
    }
});

    // Cleanup on page unload
    window.addEventListener('beforeunload', function (e) {
        if (currentRoomName) {
            endLiveStream();
        }
    });

    // Network status monitoring
    window.addEventListener('online', () => {
        showAlert('Success', 'Connection restored', 'success');
        updateConnectionStatus('connected');
    });

    window.addEventListener('offline', () => {
        showAlert('Error', 'Connection lost. Some features may be unavailable.', 'error');
        updateConnectionStatus('disconnected');
    });
    // Question form handling
function initializeQuestionForm() {
    const questionForm = document.getElementById('questionForm');
    const questionType = document.getElementById('questionType');
    const multipleChoiceSection = document.getElementById('multipleChoiceSection');
    const addOptionBtn = document.getElementById('addOptionBtn');
    
    // Show/hide multiple choice section
    questionType.addEventListener('change', function() {
        multipleChoiceSection.style.display = this.value === 'multiple-choice' ? 'block' : 'none';
    });
    
    // Add new answer option
    addOptionBtn.addEventListener('click', function() {
        const answerOptions = document.getElementById('answerOptions');
        const optionCount = answerOptions.children.length;
        const newOption = document.createElement('div');
        newOption.className = 'answer-option';
        newOption.innerHTML = `
            <input type="text" placeholder="Option ${optionCount + 1}" class="answer-input">
            <label><input type="radio" name="correctAnswer" value="${optionCount}"> Correct Answer</label>
            <button type="button" class="btn-danger remove-option" onclick="this.parentElement.remove()">Remove</button>
        `;
        answerOptions.appendChild(newOption);
    });
    
    // Form submission
    questionForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const questionData = {
            title: document.getElementById('questionTitle').value,
            question: document.getElementById('questionText').value,
            type: document.getElementById('questionType').value,
            category: document.getElementById('questionCategory').value,
            scheduledDate: document.getElementById('scheduledDate').value,
            revealTime: document.getElementById('revealTime').value,
            createdAt: serverTimestamp(),
            createdBy: 'admin',
            status: 'scheduled',
            responses: [],
            responseCount: 0
        };
        
        if (questionData.type === 'multiple-choice') {
            const answerInputs = document.querySelectorAll('.answer-input');
            const correctAnswerRadio = document.querySelector('input[name="correctAnswer"]:checked');
            
            questionData.options = Array.from(answerInputs).map(input => input.value).filter(val => val.trim());
            questionData.correctAnswer = correctAnswerRadio ? parseInt(correctAnswerRadio.value) : null;
            
            if (questionData.options.length < 2) {
                showAlert('Error', 'Multiple choice questions need at least 2 options', 'error');
                return;
            }
            if (questionData.correctAnswer === null) {
                showAlert('Error', 'Please select the correct answer', 'error');
                return;
            }
        }
        
        try {
            // Create the question
            const questionsRef = collection(db, 'questions');
            const docRef = await addDoc(questionsRef, questionData);
            
            // Check if this is for today and set as active
            const today = new Date().toISOString().split('T')[0];
            if (questionData.scheduledDate === today) {
                await setActiveQuestion(docRef.id, questionData);
            }
            
            showAlert('Success', 'Question created successfully!', 'success');
            questionForm.reset();
            multipleChoiceSection.style.display = 'none';
            
        } catch (error) {
            console.error('Error creating question:', error);
            showAlert('Error', 'Failed to create question', 'error');
        }
    });
}

// Set active question
// Set active question
async function setActiveQuestion(questionId, questionData) {
    try {
        const activeQuestionRef = doc(db, 'active_question', 'current');
        await setDoc(activeQuestionRef, {
            questionId: questionId,
            ...questionData,
            isActive: true,
            activatedAt: serverTimestamp()
        });
    } catch (error) {
        console.error('Error setting active question:', error);
        throw error; // Re-throw so the calling function can handle it
    }
}

// Load questions for dashboard
function loadQuestionsDashboard() {
    const tbody = document.getElementById('questionsTableBody');
    if (!db) return;
    
    const questionsRef = collection(db, 'questions');
    const q = query(questionsRef, orderBy('createdAt', 'desc'));
    
    onSnapshot(q, (querySnapshot) => {
        if (querySnapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No questions created yet.</td></tr>';
            return;
        }
        
        tbody.innerHTML = querySnapshot.docs.map(doc => {
            const question = doc.data();
            const scheduledDate = new Date(question.scheduledDate).toLocaleDateString();
            return `
                <tr>
                    <td>${scheduledDate}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${question.question}">${question.question}</td>
                    <td><span class="status-badge ${question.type === 'multiple-choice' ? 'status-info' : 'status-new'}">${question.type}</span></td>
                    <td>${question.responseCount || 0}</td>
                    <td><span class="status-badge ${getQuestionStatusClass(question.status)}">${question.status}</span></td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-info" onclick="viewQuestion('${doc.id}')">View</button>
                            <button class="btn-primary" onclick="editQuestion('${doc.id}')">Edit</button>
                            <button class="btn-success" onclick="activateQuestion('${doc.id}')" ${question.status === 'active' ? 'disabled' : ''}>Activate</button>
                            <button class="btn-danger" onclick="deleteQuestion('${doc.id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    });
}
// Listen for users - this was missing
function listenForUsers() {
    const usersRef = collection(db, 'users');
    onSnapshot(usersRef, (snapshot) => {
        updateUsersTable(snapshot.docs);
        // Update the total users stat
        document.getElementById('totalUsers').textContent = snapshot.size;
    }, (error) => {
        console.error('Error listening for users:', error);
    });
}

// Load moderation data - also seems to be missing
function loadModeration() {
    const moderationRef = collection(db, 'moderation_alerts');
    onSnapshot(moderationRef, (snapshot) => {
        // Update pending moderations stat
        document.getElementById('pendingModerations').textContent = snapshot.size;
        
        // Update moderation table if it exists
        const tbody = document.getElementById('moderationTableBody');
        if (tbody) {
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No moderation reports found.</td></tr>';
                return;
            }

            tbody.innerHTML = snapshot.docs.map(doc => {
                const report = doc.data();
                const createdAt = report.createdAt ? new Date(report.createdAt.seconds * 1000) : new Date();
                
                return `
                    <tr>
                        <td>${report.reportedUser || 'Unknown'}</td>
                        <td>${report.reporterUser || 'Anonymous'}</td>
                        <td>${report.reason || 'No reason provided'}</td>
                        <td>${createdAt.toLocaleString()}</td>
                        <td><span class="status-badge ${getStatusClass(report.status)}">${report.status || 'Pending'}</span></td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-primary" onclick="reviewReport('${doc.id}')">Review</button>
                                <button class="btn-success" onclick="resolveReport('${doc.id}')">Resolve</button>
                                <button class="btn-danger" onclick="dismissReport('${doc.id}')">Dismiss</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }, (error) => {
        console.error('Error loading moderation data:', error);
    });
}

// Load active question display
function loadActiveQuestionDisplay() {
    const activeQuestionRef = doc(db, 'active_question', 'current');
    onSnapshot(activeQuestionRef, (doc) => {
        const container = document.getElementById('activeQuestionDisplay');
        
        if (!doc.exists()) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-question-circle"></i>
                    <p>No active question for today</p>
                </div>
            `;
            return;
        }
        
        const question = doc.data();
        container.innerHTML = `
            <div style="background: var(--hover-bg); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                <h3 style="color: var(--color-primary); margin-bottom: 1rem;">${question.title}</h3>
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">${question.question}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: var(--text-secondary);">
                    <span>Type: ${question.type}</span>
                    <span>Responses: ${question.responseCount || 0}</span>
                    <span>Category: ${question.category}</span>
                </div>
                ${question.type === 'multiple-choice' ? `
                    <div style="margin-top: 1rem;">
                        <strong>Options:</strong>
                        <ul style="margin: 0.5rem 0;">
                            ${question.options.map((option, index) => 
                                `<li${index === question.correctAnswer ? ' style="color: var(--success-color); font-weight: bold;"' : ''}>${option}${index === question.correctAnswer ? ' ✓' : ''}</li>`
                            ).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
            <div style="text-align: center;">
                <button class="btn-danger" onclick="deactivateQuestion()">Deactivate Question</button>
                <button class="btn-info" onclick="viewQuestionResponses('${question.questionId}')">View All Responses</button>
            </div>
        `;
    });
}

// Question action functions
function getQuestionStatusClass(status) {
    switch(status) {
        case 'active': return 'status-active';
        case 'scheduled': return 'status-new';
        case 'completed': return 'status-warning';
        case 'archived': return 'status-blocked';
        default: return 'status-new';
    }
}

async function activateQuestion(questionId) {
    try {
        const questionRef = doc(db, 'questions', questionId);
        const questionDoc = await getDoc(questionRef);
        
        if (questionDoc.exists()) {
            const questionData = questionDoc.data();
            await setActiveQuestion(questionId, questionData);
            await updateDoc(questionRef, {
                status: 'active',
                activatedAt: serverTimestamp()
            });
            showAlert('Success', 'Question activated successfully!', 'success');
        }
    } catch (error) {
        console.error('Error activating question:', error);
        showAlert('Error', 'Failed to activate question', 'error');
    }
}

async function deactivateQuestion() {
    if (!confirm('Are you sure you want to deactivate the current question?')) return;
    
    try {
        const activeQuestionRef = doc(db, 'active_question', 'current');
        await deleteDoc(activeQuestionRef);
        showAlert('Info', 'Question deactivated', 'info');
    } catch (error) {
        console.error('Error deactivating question:', error);
        showAlert('Error', 'Failed to deactivate question', 'error');
    }
}

async function deleteQuestion(questionId) {
    if (!confirm('Are you sure you want to delete this question?')) return;
    
    try {
        await deleteDoc(doc(db, 'questions', questionId));
        showAlert('Success', 'Question deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting question:', error);
        showAlert('Error', 'Failed to delete question', 'error');
    }
}

function viewQuestion(questionId) {
    // Implementation for viewing question details
    showAlert('Info', 'View question details modal would open here', 'info');
}

function editQuestion(questionId) {
    // Implementation for editing question
    showAlert('Info', 'Edit question modal would open here', 'info');
}

function viewQuestionResponses(questionId) {
    // Implementation for viewing all responses
    showAlert('Info', 'Question responses modal would open here', 'info');
}

// Update the main initialization to include question form
document.addEventListener('DOMContentLoaded', function() {
    // ... existing initialization code ...
    
    
    // Add question form initialization
    setTimeout(() => {
        initializeQuestionForm();
        loadQuestionsDashboard();
        loadActiveQuestionDisplay();
    }, 1000);
});

    // =======================================================
    // === APPLICATION REVIEW FUNCTIONS ===
    // =======================================================

function listenForApplications() {
    const tbody = document.getElementById('applicationsTableBody');
    if (!db) return;

    const applicationsRef = collection(db, "instructor_applications");
    const q = query(applicationsRef, where("status", "==", "pending"), orderBy("submittedAt", "desc"));

    onSnapshot(q, (querySnapshot) => {
        if (querySnapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No pending applications found.</td></tr>';
            return;
        }

        tbody.innerHTML = querySnapshot.docs.map(doc => {
            const app = doc.data();
            const submittedDate = app.submittedAt ? 
                (app.submittedAt.seconds ? 
                    new Date(app.submittedAt.seconds * 1000).toLocaleDateString() : 
                    new Date(app.submittedAt).toLocaleDateString()) : 
                'Unknown';
            
            return `
                <tr>
                    <td>
                        <div>
                            <strong>${app.fullName || 'Unknown'}</strong>
                            ${app.phone ? `<br><small style="color: var(--text-secondary);">${app.phone}</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div>${app.email || 'No email provided'}</div>
                        ${app.linkedin ? `<br><small><a href="${app.linkedin}" target="_blank" rel="noopener noreferrer">LinkedIn Profile</a></small>` : ''}
                    </td>
                    <td>
                        <div>
                            <span class="status-badge status-info">${app.expertise || 'General'}</span>
                            ${app.experience ? `<br><small>${app.experience} experience</small>` : ''}
                        </div>
                    </td>
                    <td>
                        <div>${submittedDate}</div>
                        <small style="color: var(--text-secondary);">
                            ${app.source === 'google_forms' ? 'Google Forms' : 'Direct'}
                        </small>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="btn-info" onclick="viewApplicationDetails('${doc.id}')" title="View full application">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn-success" onclick="approveApplication('${doc.id}', '${app.fullName}', '${app.email}')" title="Approve application">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn-danger" onclick="rejectApplication('${doc.id}', '${app.fullName}', '${app.email}')" title="Reject application">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }, (error) => {
        console.error("Error listening for applications:", error);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: red;">Error loading applications. Check console.</td></tr>';
    });
}


    window.viewApplication = async (appId) => {
        const appDoc = await getDoc(doc(db, "instructor_applications", appId));
        if (!appDoc.exists()) return alert("Application not found.");
        
        const app = appDoc.data();
        const modalContent = `
            <div style="text-align:left;">
                <p><strong>Applicant:</strong> ${app.fullName} (${app.email})</p>
                <p><strong>Expertise:</strong> ${app.expertise}</p>
                <p><strong>Credentials:</strong> <a href="${app.credentialsLink}" target="_blank" rel="noopener noreferrer">View Credentials</a></p>
                <div style="margin-top:1rem; padding:1rem; background-color:var(--hover-bg); border-radius:8px;">
                    <strong>Bio:</strong>
                    <p>${app.bio}</p>
                </div>
                <div style="margin-top:2rem; text-align:center;">
                    <button class="btn-success" onclick="window.processApplication('${appId}', true)">Approve</button>
                    <button class="btn-danger" onclick="window.processApplication('${appId}', false)">Reject</button>
                </div>
            </div>
        `;
        showModal("Review Application", modalContent);
    };

    // Add these functions to your existing admin.js file

async function approveInstructor(userId, userEmail, userName) {
    if (!confirm(`Approve ${userName || userEmail} as instructor?`)) return;
    
    try {
        const response = await fetch('/.netlify/functions/approve-instructor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                userId: userId,
                userEmail: userEmail,
                userName: userName
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✅ Instructor approved! Email notification sent.');
            // Update your admin UI to show approved status
            updateInstructorStatus(userId, 'approved');
        } else {
            alert('❌ Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error approving instructor:', error);
        alert('❌ Approval failed. Please try again.');
    }
}

function updateInstructorStatus(userId, status) {
    // Update your admin table/list to show the new status
    const statusElement = document.querySelector(`[data-user-id="${userId}"] .status`);
    if (statusElement) {
        statusElement.textContent = status;
        statusElement.className = `status ${status}`;
    }
}

// Example usage in your admin HTML
// <button onclick="approveInstructor('user123', 'john@example.com', 'John Doe')">Approve</button>

    window.processApplication = async (appId, isApproved) => {
        if (!confirm(`Are you sure you want to ${isApproved ? 'APPROVE' : 'REJECT'} this application?`)) return;

        const appRef = doc(db, "instructor_applications", appId);
        const appDoc = await getDoc(appRef);
        const appData = appDoc.data();
        const userRef = doc(db, "users", appData.userId);

        try {
            if (isApproved) {
                // Use a transaction to ensure both writes succeed or fail together
                await runTransaction(db, async (transaction) => {
                    transaction.update(userRef, { role: "instructor" });
                    transaction.update(appRef, { status: "approved" });
                });

                // Send approval notification to the applicant
                if (notificationService && appData.userId) {
                    await notificationService.createAdminNotification(
                        appData.userId,
                        'instructor_approved',
                        `Congratulations! Your instructor application has been approved. You now have instructor privileges and can create courses.`,
                        appId
                    );
                }

                alert("Application Approved! The user has been promoted to an instructor.");
            } else {
                await updateDoc(appRef, { status: "rejected" });

                // Send rejection notification to the applicant
                if (notificationService && appData.userId) {
                    await notificationService.createAdminNotification(
                        appData.userId,
                        'instructor_rejected',
                        `Your instructor application has been reviewed. Please check your email for more details about next steps.`,
                        appId
                    );
                }

                alert("Application Rejected.");
            }
            closeModal();
        } catch (error) {
            console.error("Error processing application:", error);
            alert("An error occurred. Please check the console.");
        }
    };

async function rejectApplication(applicationId, applicantName, applicantEmail) {
    const reason = prompt(`Rejection reason for ${applicantName} (optional):`);
    if (!confirm(`Are you sure you want to reject ${applicantName}'s application?`)) return;
    
    try {
        // Update application status in Firestore
        const applicationRef = doc(db, 'instructor_applications', applicationId);
        await updateDoc(applicationRef, {
            status: 'rejected',
            rejectedAt: serverTimestamp(),
            rejectedBy: 'admin',
            rejectionReason: reason || ''
        });

        // Log admin action
        await addDoc(collection(db, 'admin_actions'), {
            action: 'instructor_rejected',
            applicantName: applicantName,
            applicantEmail: applicantEmail,
            applicationId: applicationId,
            adminId: 'admin',
            rejectionReason: reason || '',
            timestamp: serverTimestamp()
        });

        // Call Google Apps Script to send rejection email
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbyCsr7VugKOEA3tRCpwfpDFAfjIkpK-Ih7DyE1mTGVUP5J8YhYyHAppNr7PjQt1uKcHRA/exec', {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'sendRejectionEmail',
                    applicantName: applicantName,
                    applicantEmail: applicantEmail,
                    reason: reason || ''
                })
            });
            console.log('Rejection email triggered');
        } catch (emailError) {
            console.warn('Failed to trigger rejection email:', emailError);
        }

        showAlert('Success', `${applicantName}'s application has been rejected. Notification email will be sent.`, 'success');

    } catch (error) {
        console.error('Error rejecting application:', error);
        showAlert('Error', 'Failed to reject application: ' + error.message, 'error');
    }
}

async function viewApplicationDetails(applicationId) {
    try {
        const appRef = doc(db, 'instructor_applications', applicationId);
        const appDoc = await getDoc(appRef);
        
        if (!appDoc.exists()) {
            showAlert('Error', 'Application not found', 'error');
            return;
        }
        
        const app = appDoc.data();
        const submittedDate = app.submittedAt ? 
            (app.submittedAt.seconds ? 
                new Date(app.submittedAt.seconds * 1000).toLocaleString() : 
                new Date(app.submittedAt).toLocaleString()) : 
            'Unknown';
        
        showAlert('Application Details', `
            <div style="text-align: left; max-width: 600px;">
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--hover-bg); border-radius: 8px;">
                    <h3 style="margin: 0 0 1rem 0; color: var(--color-secondary);">${app.fullName || 'Unknown Applicant'}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div><strong>Email:</strong><br>${app.email || 'Not provided'}</div>
                        <div><strong>Phone:</strong><br>${app.phone || 'Not provided'}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div><strong>Expertise:</strong><br>${app.expertise || 'Not specified'}</div>
                        <div><strong>Experience:</strong><br>${app.experience || 'Not specified'}</div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Qualifications:</strong><br>
                        <div style="background: white; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                            ${app.qualifications || 'Not provided'}
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--hover-bg); border-radius: 8px;">
                    <strong>Professional Bio:</strong><br>
                    <div style="background: white; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; max-height: 150px; overflow-y: auto;">
                        ${app.bio || 'No bio provided'}
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--hover-bg); border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <strong>Portfolio:</strong><br>
                            ${app.portfolio ? `<a href="${app.portfolio}" target="_blank" rel="noopener noreferrer">View Portfolio</a>` : 'Not provided'}
                        </div>
                        <div>
                            <strong>LinkedIn:</strong><br>
                            ${app.linkedin ? `<a href="${app.linkedin}" target="_blank" rel="noopener noreferrer">View Profile</a>` : 'Not provided'}
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Teaching Availability:</strong><br>
                        ${app.availability || 'Not specified'}
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Preferred Format:</strong><br>
                        ${app.preferredFormat || 'Not specified'}
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--info-color); color: white; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><strong>Submitted:</strong><br>${submittedDate}</div>
                        <div><strong>Source:</strong><br>${app.source === 'google_forms' ? 'Google Forms' : 'Direct Application'}</div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>Application ID:</strong><br>
                        <code style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 3px;">${app.applicationId || applicationId}</code>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button onclick="approveApplication('${applicationId}', '${app.fullName}', '${app.email}')" 
                            style="background: var(--success-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 5px; margin-right: 1rem; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-check"></i> Approve Application
                    </button>
                    <button onclick="rejectApplication('${applicationId}', '${app.fullName}', '${app.email}')" 
                            style="background: var(--danger-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 5px; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-times"></i> Reject Application
                    </button>
                </div>
            </div>
        `, 'info');
        
    } catch (error) {
        console.error('Error loading application details:', error);
        showAlert('Error', 'Failed to load application details', 'error');
    }
}

// Helper function to send rejection email
async function sendRejectionEmail(email, name, reason) {
    // This would integrate with your email service
    console.log(`Would send rejection email to ${email} for ${name} with reason: ${reason}`);
    // Implementation depends on your email service (EmailJS, SendGrid, etc.)
}

// Make functions globally accessible
window.approveApplication = approveApplication;
window.rejectApplication = rejectApplication;
window.viewApplicationDetails = viewApplicationDetails;

</script>
