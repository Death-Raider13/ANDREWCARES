<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Andrew Cares Village</title>

    <!-- Enhanced Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Animate.css for smooth animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- PDF.js for document preview -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        /* Enhanced Professional Variables */
        :root {
            --primary-color: #6366f1;
            --primary-hover: #5b21b6;
            --secondary-color: #0f172a;
            --background-color: #f8fafc;
            --background-secondary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --hover-bg: #f8fafc;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            
            /* Enhanced Shadows */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            
            /* Professional Gradients */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-message-sent: linear-gradient(135deg, #dcf8c6 0%, #c8e6c9 100%);
            --gradient-message-received: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);

            /* WhatsApp-style colors */
            --whatsapp-green: #25d366;
            --whatsapp-green-dark: #128c7e;
            --whatsapp-blue: #34b7f1;
            --whatsapp-gray: #f0f2f5;
            --whatsapp-dark: #111b21;
            --message-sent-bg: #dcf8c6;
            --message-received-bg: #ffffff;
            
            /* Chat wallpaper variables */
            --chat-wallpaper: none;
            --wallpaper-opacity: 0.1;
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* Enhanced Header with Glass Effect */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.875rem 1.5rem;
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            position: relative;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }

        .logo {
            font-family: 'Inter', serif;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--secondary-color);
            flex-shrink: 0;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Mobile Navigation */
        .main-nav {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-light);
            flex-direction: column;
            padding: 1.5rem;
            gap: 1rem;
            box-shadow: var(--shadow-md);
            z-index: 1000;
        }

        .main-nav.mobile-open {
            display: flex;
        }

        .main-nav a {
            font-weight: 500;
            color: var(--text-secondary);
            padding: 0.875rem 0;
            border-bottom: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            border-radius: 8px;
        }

        .main-nav a:hover {
            color: var(--primary-color);
            background: var(--hover-bg);
        }

        .mobile-menu-toggle {
            display: block;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.5rem;
            min-height: 44px;
            min-width: 44px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            background: var(--hover-bg);
            transform: scale(1.05);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }

        .user-profile-nav {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .user-profile-nav:hover {
            background: var(--hover-bg);
        }

        .user-avatar-nav {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .user-avatar-nav:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .user-name-nav {
            font-weight: 600;
            font-size: 0.875rem;
            display: none;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 120%;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 220px;
            overflow: hidden;
            z-index: 1001;
            border: 1px solid var(--border-light);
        }

        .user-profile-nav:hover .profile-dropdown {
            display: block;
        }

        .profile-dropdown a,
        .profile-dropdown button {
            display: block;
            width: 100%;
            padding: 1rem 1.25rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .profile-dropdown a:hover,
        .profile-dropdown button:hover {
            background: var(--hover-bg);
        }

        .profile-dropdown .logout-button {
            color: var(--danger-color);
        }

        /* Enhanced Messaging Layout */
        .messaging-container {
            display: block;
            position: relative;
            height: calc(100vh - 77px);
            overflow: hidden;
            background: var(--card-bg);
        }

        /* Enhanced Conversation List */
        .conversation-list {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--card-bg);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        .conversation-list-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--card-bg), var(--background-secondary));
        }

        .conversation-list-header h2 {
            font-family: 'Inter', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .conversation-search {
            position: relative;
            margin-top: 1rem;
        }

        .conversation-search input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.875rem;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--background-secondary);
        }

        .conversation-search input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }

        .conversation-search i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .conversation-list-body {
            overflow-y: auto;
            flex-grow: 1;
            background: var(--card-bg);
            position: relative;
        }

        /* Pull to refresh indicator */
        .pull-refresh-indicator {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            opacity: 0;
        }

        .pull-refresh-indicator.show {
            opacity: 1;
            top: 10px;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 85px;
            position: relative;
        }

        .conversation-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .conversation-item:hover {
            background: var(--hover-bg);
            transform: translateX(4px);
        }

        .conversation-item:hover::before {
            opacity: 1;
        }

        .conversation-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            border-left: 4px solid var(--primary-color);
            transform: translateX(0);
        }

        .conversation-item.active::before {
            opacity: 1;
        }

        .conversation-item.active .convo-name {
            color: var(--primary-color);
            font-weight: 600;
        }

        .convo-avatar-wrapper {
            position: relative;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .convo-avatar {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            object-fit: cover;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .conversation-item:hover .convo-avatar {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 3px solid var(--card-bg);
            background: var(--success-color);
            box-shadow: var(--shadow-sm);
        }

        .online-indicator.offline {
            background: var(--text-muted);
        }

        .online-indicator.typing {
            background: var(--whatsapp-blue);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .convo-details {
            flex-grow: 1;
            overflow: hidden;
            min-width: 0;
        }

        .convo-name {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
            transition: all 0.3s ease;
        }

        .last-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .unread-count {
            background: var(--whatsapp-green);
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 20px;
            height: 20px;
            text-align: center;
            margin-left: auto;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto;
            flex-shrink: 0;
        }

        /* Enhanced Chat Window */
        .chat-window {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--card-bg);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
        }

        .messaging-container.show-chat .conversation-list {
            transform: translateX(-100%);
        }

        .messaging-container.show-chat .chat-window {
            transform: translateX(0);
        }

        .chat-window-placeholder {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--text-secondary);
            padding: 3rem 2rem;
            background: linear-gradient(135deg, var(--background-color), var(--background-secondary));
        }

        .chat-window-placeholder i {
            font-size: 5rem;
            margin-bottom: 2rem;
            color: var(--text-muted);
            opacity: 0.5;
        }

        .chat-window-placeholder h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .chat-window-placeholder p {
            font-size: 1rem;
            line-height: 1.6;
            max-width: 400px;
        }

        /* Enhanced Chat Header */
        .chat-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--card-bg), var(--background-secondary));
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .mobile-back-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.75rem;
            margin-right: 0.5rem;
            min-height: 44px;
            min-width: 44px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .mobile-back-btn:hover {
            background: var(--hover-bg);
            color: var(--primary-color);
            transform: translateX(-2px);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-grow: 1;
            cursor: pointer;
        }

        .chat-header-avatar {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            object-fit: cover;
            box-shadow: var(--shadow-sm);
        }

        .chat-header-details h3 {
            font-family: 'Inter', serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.125rem;
        }

        .chat-header-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .typing-indicator {
            color: var(--success-color);
            font-style: italic;
        }

        .last-seen {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-action-btn {
            background: none;
            border: none;
            font-size: 1.125rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            min-height: 44px;
            min-width: 44px;
            position: relative;
        }

        .chat-action-btn:hover {
            background: var(--hover-bg);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* Enhanced Message Area */
        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0;
            min-height: 0;
            background: var(--whatsapp-gray);
            position: relative;
            background-image: var(--chat-wallpaper);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .message-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, var(--wallpaper-opacity));
            pointer-events: none;
            z-index: 1;
        }

        .message-list {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 100%;
            position: relative;
            z-index: 2;
        }

        /* Enhanced Message Bubbles with WhatsApp styling */
        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem 0.5rem;
            border-radius: 8px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            box-shadow: var(--shadow-xs);
            transition: all 0.3s ease;
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* WhatsApp-style message tails */
        .message-bubble::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .message-bubble.sent {
            background: var(--message-sent-bg);
            color: var(--text-primary);
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 3px;
        }

        .message-bubble.sent::before {
            right: -8px;
            bottom: 0;
            border-width: 0 0 8px 8px;
            border-color: transparent transparent var(--message-sent-bg) transparent;
        }

        .message-bubble.received {
            background: var(--message-received-bg);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 3px;
            box-shadow: var(--shadow-sm);
        }

        .message-bubble.received::before {
            left: -8px;
            bottom: 0;
            border-width: 0 8px 8px 0;
            border-color: transparent var(--message-received-bg) transparent transparent;
        }

        .message-bubble:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .message-content {
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        /* Message reactions */
        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .reaction {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reaction:hover {
            background: rgba(0, 0, 0, 0.15);
            transform: scale(1.05);
        }

        .reaction.my-reaction {
            background: var(--primary-color);
            color: white;
        }

        /* Reply preview */
        .reply-preview {
            background: rgba(0, 0, 0, 0.1);
            border-left: 3px solid var(--primary-color);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .reply-preview .reply-author {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .reply-preview .reply-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Link preview */
        .link-preview {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .link-preview:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .link-preview-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .link-preview-content {
            padding: 0.75rem;
        }

        .link-preview-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            line-height: 1.3;

.link-preview-domain {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
}

.message-timestamp {
    font-size: 0.7rem;
    color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    gap: 0.25rem;
    justify-content: flex-end;
    margin-top: 0.25rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .message-timestamp {
            font-size: 0.7rem;
            color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            justify-content: flex-end;
            margin-top: 0.25rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message-bubble:hover .message-timestamp,
        .message-bubble.show-timestamp .message-timestamp {
            opacity: 1;
        }

        .message-status-icon {
            font-size: 0.65rem;
        }

        .message-status-icon.delivered {
            color: var(--text-muted);
        }

        .message-status-icon.read {
            color: var(--whatsapp-blue);
        }

        /* Scheduled message indicator */
        .scheduled-indicator {
            background: var(--warning-color);
            color: white;
            font-size: 0.7rem;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
        }

        /* Media Message Styles */
        .message-image {
            border-radius: 8px;
            max-width: 100%;
            height: auto;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-image:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .image-thumbnail {
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }

        .image-thumbnail::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .image-thumbnail:hover::after {
            background: rgba(0, 0, 0, 0.1);
        }

        .message-file {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-light);
        }

        .message-file:hover {
            background: rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .file-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .file-info {
            flex-grow: 1;
            min-width: 0;
        }

        .file-info h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .file-download-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .file-download-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
        }

        /* PDF Preview */
        .pdf-preview {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            max-width: 250px;
        }

        .pdf-preview-header {
            background: var(--background-secondary);
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: between;
            gap: 0.5rem;
        }

        .pdf-preview-title {
            font-size: 0.8rem;
            font-weight: 600;
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pdf-preview-pages {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .pdf-preview-canvas {
            width: 100%;
            height: 150px;
            background: var(--background-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Location Message */
        .location-message {
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            max-width: 250px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-message:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .location-map {
            width: 100%;
            height: 150px;
            background: var(--background-secondary);
        }

        .location-info {
            padding: 0.75rem;
            background: var(--card-bg);
            border-top: 1px solid var(--border-light);
        }

        .location-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .location-address {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        /* Contact Card */
        .contact-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            max-width: 250px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .contact-card:hover {
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .contact-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .contact-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .contact-phone {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .contact-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .contact-action-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .contact-action-btn:hover {
            background: var(--hover-bg);
            border-color: var(--primary-color);
        }

        /* Enhanced Voice Message */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            min-width: 200px;
        }

        .voice-play-btn {
            background: var(--primary-color);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 0.9rem;
        }

        .voice-play-btn:hover {
            transform: scale(1.1);
            background: var(--primary-hover);
        }

        .voice-play-btn.playing {
            background: var(--danger-color);
        }

        .voice-waveform {
            flex-grow: 1;
            height: 32px;
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
        }

        .voice-bar {
            width: 3px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .voice-bar:hover {
            background: var(--primary-color);
        }

        .voice-bar.active {
            background: var(--primary-color);
        }

        .voice-progress {
            width: 100%;
            height: 4px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }

        .voice-progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        .voice-duration {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 35px;
            text-align: center;
        }

        /* Typing Indicator */
        .typing-indicator-bubble {
            max-width: 75%;
            padding: 1rem 1.25rem;
            border-radius: 8px;
            border-bottom-left-radius: 3px;
            align-self: flex-start;
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: typingFadeIn 0.4s ease;
            position: relative;
        }

        .typing-indicator-bubble::before {
            content: '';
            position: absolute;
            left: -8px;
            bottom: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 8px 8px 0;
            border-color: transparent var(--card-bg) transparent transparent;
        }

        @keyframes typingFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0ms; }
        .typing-dot:nth-child(2) { animation-delay: 200ms; }
        .typing-dot:nth-child(3) { animation-delay: 400ms; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* Message date separator */
        .date-separator {
            text-align: center;
            margin: 1.5rem 0;
            position: relative;
        }

        .date-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
        }

        .date-separator span {
            background: var(--background-color);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-radius: 12px;
            position: relative;
            z-index: 1;
        }

        /* Enhanced Message Input */
        .message-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            flex-shrink: 0;
            background: var(--card-bg);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .input-wrapper {
            flex-grow: 1;
            position: relative;
            background: var(--background-secondary);
            border-radius: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .message-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 0.875rem 4rem 0.875rem 1.25rem;
            border-radius: 24px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            min-height: 48px;
            max-height: 120px;
            resize: none;
            transition: all 0.3s ease;
            overflow-y: auto;
            line-height: 1.4;
        }

        .message-input:focus {
            outline: none;
        }

        .message-input::placeholder {
            color: var(--text-muted);
        }

        .input-actions {
            position: absolute;
            right: 0.5rem;
            bottom: 50%;
            transform: translateY(50%);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .input-action-btn {
            background: none;
            border: none;
            font-size: 1.125rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-height: 36px;
            min-width: 36px;
        }

        .input-action-btn:hover {
            background: var(--hover-bg);
            color: var(--primary-color);
            transform: scale(1.05);
        }

        .input-action-btn.recording {
            color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        .send-btn {
            background: var(--whatsapp-green);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .send-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-md);
            background: var(--whatsapp-green-dark);
        }

        .send-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        /* Reply input bar */
        .reply-input-bar {
            padding: 0.75rem 1.5rem;
            background: var(--background-secondary);
            border-bottom: 1px solid var(--border-light);
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .reply-input-bar.show {
            display: flex;
        }

        .reply-input-preview {
            flex-grow: 1;
            font-size: 0.85rem;
        }

        .reply-input-author {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .reply-input-text {
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-cancel-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .reply-cancel-btn:hover {
            background: var(--hover-bg);
            color: var(--danger-color);
        }

        /* Message context menu */
        .message-context-menu {
            position: absolute;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            padding: 0.5rem 0;
            min-width: 150px;
            z-index: 1000;
            display: none;
        }

        .message-context-menu.show {
            display: block;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .context-menu-item:hover {
            background: var(--hover-bg);
        }

        .context-menu-item.danger {
            color: var(--danger-color);
        }

        /* Emoji picker */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            width: 300px;
            max-height: 300px;
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        .emoji-picker.show {
            display: flex;
        }

        .emoji-picker-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .emoji-picker-body {
            padding: 0.75rem;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
        }

        .emoji-item {
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .emoji-item:hover {
            background: var(--hover-bg);
            transform: scale(1.1);
        }

        /* Chat wallpaper selector */
        .wallpaper-selector {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .wallpaper-selector.show {
            display: flex;
        }

        .wallpaper-modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .wallpaper-modal h3 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .wallpaper-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .wallpaper-option {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .wallpaper-option:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .wallpaper-option.selected {
            border-color: var(--primary-color);
        }

        .wallpaper-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .wallpaper-option.none {
            background: var(--whatsapp-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* File Upload Modal */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .upload-modal.show {
            display: flex;
        }

        .upload-modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
        }

        .upload-modal h3 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .upload-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .upload-option {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-option:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-option i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .upload-option span {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Camera capture modal */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
        }

        .camera-modal.show {
            display: flex;
        }

        .camera-container {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }

        .camera-video {
            width: 100%;
            height: auto;
            border-radius: 12px;
        }

        .camera-controls {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .camera-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .camera-btn:hover {
            transform: scale(1.1);
        }

        .camera-btn.capture {
            background: var(--whatsapp-green);
            color: white;
        }

        .camera-btn.close {
            background: var(--danger-color);
            color: white;
        }

        /* Enhanced Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: var(--text-secondary);
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message search */
        .message-search {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .message-search.show {
            transform: translateY(0);
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-close-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
        }

        .search-results-info {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Tablet Styles */
        @media (min-width: 768px) {
            .main-header {
                padding: 1rem 1.5rem;
            }

            .logo {
                font-size: 1.4rem;
            }

            .mobile-menu-toggle {
                display: none;
            }

            .main-nav {
                display: flex !important;
                position: static;
                background: transparent;
                -webkit-backdrop-filter: none;
                backdrop-filter: none;
                border-top: none;
                flex-direction: row;
                padding: 0;
                gap: 2rem;
                box-shadow: none;
            }

            .main-nav a {
                padding: 0.5rem 0;
                text-align: left;
            }

            .user-name-nav {
                display: inline;
                font-size: 0.875rem;
            }

            .user-avatar-nav {
                width: 40px;
                height: 40px;
            }

            .header-actions {
                gap: 1.5rem;
            }

            .messaging-container {
                display: grid;
                grid-template-columns: 350px 1fr;
                height: calc(100vh - 77px);
            }

            .conversation-list {
                position: static;
                width: auto;
                height: auto;
                transform: none;
                transition: none;
                z-index: auto;
                border-right: 1px solid var(--border-light);
            }

            .chat-window {
                position: static;
                width: auto;
                height: auto;
                transform: none;
                transition: none;
                z-index: auto;
            }

            .mobile-back-btn {
                display: none;
            }

            .conversation-list-header {
                padding: 2rem;
            }

            .conversation-list-header h2 {
                font-size: 1.75rem;
            }

            .conversation-item {
                padding: 1.5rem 2rem;
            }

            .chat-header {
                padding: 1.5rem 2rem;
            }

            .message-list {
                padding: 2rem;
                gap: 1rem;
            }

            .message-bubble {
                max-width: 65%;
                padding: 0.875rem 1.25rem 0.75rem;
            }

            .message-input-area {
                padding: 1.5rem 2rem;
                gap: 1rem;
            }

            .message-input {
                padding: 1rem 4rem 1rem 1.5rem;
                font-size: 1rem;
            }

            .send-btn {
                width: 52px;
                height: 52px;
                font-size: 1.5rem;
            }
        }

        /* Desktop/Laptop Styles */
        @media (min-width: 1024px) {
            .messaging-container {
                grid-template-columns: 380px 1fr;
            }

            .conversation-list-header h2 {
                font-size: 1.875rem;
            }
        }

        /* Large Desktop */
        @media (min-width: 1440px) {
            .messaging-container {
                grid-template-columns: 420px 1fr;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #0f172a;
                --background-secondary: #1e293b;
                --text-primary: #f8fafc;
                --text-secondary: #cbd5e1;
                --text-muted: #64748b;
                --card-bg: #1e293b;
                --border-color: #334155;
                --border-light: #475569;
                --hover-bg: #334155;
                --whatsapp-gray: #2a3942;
                --message-sent-bg: #005c4b;
                --message-received-bg: #262d31;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            .conversation-list,
            .chat-window,
            .main-nav,
            .message-bubble,
            .typing-indicator-bubble,
            .message-search {
                transition: none;
                animation: none;
            }
            
            .typing-dot,
            .spinner {
                animation: none;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --border-light: #000000;
                --text-secondary: #000000;
                --text-muted: #333333;
            }
        }

        /* Print styles */
        @media print {
            .main-header,
            .conversation-list,
            .message-input-area,
            .chat-header-actions,
            .upload-modal,
            .camera-modal,
            .wallpaper-selector,
            .emoji-picker,
            .message-context-menu {
                display: none !important;
            }
            
            .messaging-container {
                height: auto !important;
                display: block !important;
            }
            
            .chat-window {
                position: static !important;
                transform: none !important;
            }
            
            .message-area {
                background: white !important;
                overflow: visible !important;
            }
            
            .message-bubble {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }
        }

        /* Focus visible for keyboard navigation */
        .conversation-item:focus,
        .chat-action-btn:focus,
        .input-action-btn:focus,
        .send-btn:focus,
        .message-input:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        .message-area,
        .conversation-list-body {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar styles */
        .message-area::-webkit-scrollbar,
        .conversation-list-body::-webkit-scrollbar,
        .emoji-picker-body::-webkit-scrollbar {
            width: 6px;
        }

        .message-area::-webkit-scrollbar-track,
        .conversation-list-body::-webkit-scrollbar-track,
        .emoji-picker-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .message-area::-webkit-scrollbar-thumb,
        .conversation-list-body::-webkit-scrollbar-thumb,
        .emoji-picker-body::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .message-area::-webkit-scrollbar-thumb:hover,
        .conversation-list-body::-webkit-scrollbar-thumb:hover,
        .emoji-picker-body::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 5000;
            opacity: 0;
            transform: translateX(100%) scale(0.95);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            font-size: 0.9rem;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0) scale(1);
        }

        .notification.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
        }

        .notification.info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
        }

        .notification.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95));
        }

        /* Message scheduling modal */
        .schedule-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .schedule-modal.show {
            display: flex;
        }

        .schedule-modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-xl);
        }

        .schedule-modal h3 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .schedule-input-group {
            margin-bottom: 1rem;
        }

        .schedule-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .schedule-input-group input,
        .schedule-input-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .schedule-input-group input:focus,
        .schedule-input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .schedule-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--background-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        /* Voice recording modal */
        .voice-recording-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-light);
            padding: 2rem;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: var(--shadow-xl);
        }

        .voice-recording-modal.show {
            transform: translateY(0);
        }

        .voice-recording-content {
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .voice-recording-visualizer {
            width: 200px;
            height: 100px;
            margin: 1.5rem auto;
            background: var(--background-secondary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 1rem;
        }

        .voice-recording-bar {
            width: 4px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: voiceBarPulse 0.8s ease-in-out infinite alternate;
        }

        .voice-recording-bar:nth-child(2n) {
            animation-delay: 0.1s;
        }

        .voice-recording-bar:nth-child(3n) {
            animation-delay: 0.2s;
        }

        @keyframes voiceBarPulse {
            from { height: 10px; }
            to { height: 40px; }
        }

        .voice-recording-time {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .voice-recording-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .voice-recording-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .voice-recording-btn.stop {
            background: var(--danger-color);
            color: white;
        }

        .voice-recording-btn.send {
            background: var(--whatsapp-green);
            color: white;
        }

        .voice-recording-btn.cancel {
            background: var(--text-muted);
            color: white;
        }

        .voice-recording-btn:hover {
            transform: scale(1.1);
        }

        /* Image viewer modal */
        .image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .image-viewer-modal.show {
            display: flex;
        }

        .image-viewer-content {
            position: relative;
            max-width: 95vw;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-viewer-img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: var(--shadow-xl);
        }

        .image-viewer-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .image-viewer-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .image-viewer-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .image-viewer-info {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        /* Contact search modal */
        .contact-search-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .contact-search-modal.show {
            display: flex;
        }

        .contact-search-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }

        .contact-search-header {
            margin-bottom: 1.5rem;
        }

        .contact-search-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .contact-search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
        }

        .contact-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .contact-search-results {
            flex-grow: 1;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .contact-search-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .contact-search-item:hover {
            background: var(--hover-bg);
        }

        .contact-search-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .contact-search-details {
            flex-grow: 1;
        }

        .contact-search-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .contact-search-phone {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Location sharing modal */
        .location-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .location-modal.show {
            display: flex;
        }

        .location-modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-xl);
        }

        .location-modal h3 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .location-preview {
            width: 100%;
            height: 200px;
            border-radius: 8px;
            background: var(--background-secondary);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .location-details {
            margin-bottom: 1.5rem;
        }

        .location-details h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .location-details p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .location-actions {
            display: flex;
            gap: 1rem;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 480px) {
            .message-bubble {
                max-width: 85%;
                padding: 0.75rem 1rem 0.5rem;
                font-size: 0.9rem;
            }
            
            .upload-modal-content,
            .schedule-modal-content,
            .contact-search-content,
            .location-modal-content {
                width: 95%;
                padding: 1.5rem;
            }
            
            .voice-recording-modal {
                padding: 1.5rem;
            }
            
            .camera-controls {
                bottom: 2rem;
                gap: 1.5rem;
            }
            
            .camera-btn {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }
            
            .wallpaper-options {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 0.75rem;
            }
            
            .upload-options {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
                gap: 0.75rem;
            }
        }

        /* Performance optimizations */
        .message-bubble,
        .conversation-item {
            will-change: transform;
        }

        .message-area {
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* Lazy loading placeholder */
        .lazy-image {
            background: var(--background-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .lazy-image.loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Message status indicators */
        .message-status-indicators {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .status-icon {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .status-icon.sent {
            color: var(--text-muted);
        }

        .status-icon.delivered {
            color: var(--text-secondary);
        }

        .status-icon.read {
            color: var(--whatsapp-blue);
        }

        /* Message forwarded indicator */
        .forwarded-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Selection styles */
        .message-bubble.selected {
            background: rgba(99, 102, 241, 0.1) !important;
            border: 2px solid var(--primary-color);
        }

        .message-selection-counter {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 24px;
            font-weight: 600;
            z-index: 1500;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .message-selection-counter.show {
            display: block;
        }

        /* Message editing indicator */
        .editing-indicator {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.25rem;
        }
        .close-emoji-picker-btn {
    float: right;
    background: none;
    border: none;
    cursor: pointer;
}
    </style>
</head>

<body>
    <!-- Enhanced Header -->
    <header class="main-header">
        <a href="home.html" class="logo">Andrew Cares Village</a>
        
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
        </button>
        
        <nav class="main-nav" id="mainNav">
            <a href="home.html">Home</a>
            <a href="dojo.html?discipline=Forex">Forex Training</a>
            <a href="dojo.html?discipline=Fitness">Fitness Training</a>
            <a href="dojo.html?discipline=Karate">Karate Training</a>
        </nav>
        
        <div class="header-actions">
            <div id="userProfileNav" class="user-profile-nav">
                <img id="userAvatarNav" src="" alt="User Avatar" class="user-avatar-nav">
                <span id="userNameNav" class="user-name-nav">Loading...</span>
                <div class="profile-dropdown">
                    <a href="profile.html">My Profile</a>
                    <a href="friends.html">Friends</a>
                    <button id="logoutButton" class="logout-button">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Enhanced Main Content -->
    <main class="messaging-container" id="messagingContainer">
        <!-- Left Pane: Conversation List -->
        <aside class="conversation-list">
            
            <div class="conversation-list-header">
                <h2>Messages</h2>
                <div class="conversation-search">
                    <input type="text" placeholder="Search conversations..." id="conversationSearch">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="conversation-list-body" id="conversationListBody">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading conversations...
                </div>
            </div>
        </aside>

        <!-- Right Pane: Chat Window -->
        <section class="chat-window" id="chatWindow">
            <div class="chat-window-placeholder" id="chatWindowPlaceholder">
                <i class="fas fa-comments"></i>
                <h2>Select a conversation</h2>
                <p>Choose from your friends list to start chatting, or send voice messages, images, files, and locations.</p>
            </div>
        </section>
    </main>

    <!-- Enhanced Modals -->
    
    <!-- File Upload Modal -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-modal-content">
            <h3>Share Media & Files</h3>
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag and drop files here or click to browse</p>
                <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip">
            </div>
            <div class="upload-options">
                <div class="upload-option" onclick="openCamera()">
                    <i class="fas fa-camera"></i>
                    <span>Camera</span>
                </div>
                <div class="upload-option" onclick="shareLocation()">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Location</span>
                </div>
                <div class="upload-option" onclick="shareContact()">
                    <i class="fas fa-address-book"></i>
                    <span>Contact</span>
                </div>
                <div class="upload-option" onclick="selectFile('image/*')">
                    <i class="fas fa-image"></i>
                    <span>Photos</span>
                </div>
                <div class="upload-option" onclick="selectFile('.pdf,.doc,.docx')">
                    <i class="fas fa-file-alt"></i>
                    <span>Document</span>
                </div>
            </div>
            <div style="margin-top: 1.5rem; text-align: right;">
                <button onclick="closeUploadModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-container">
            <video class="camera-video" id="cameraVideo" autoplay></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div class="camera-controls">
                <button class="camera-btn close" title="Close Camera" onclick="closeCamera()">
                    <i class="fas fa-times"></i>
                </button>
                <button class="camera-btn capture" title="Capture Photo" onclick="capturePhoto()">
                    <i class="fas fa-camera"></i>
                </button>
                <button class="camera-btn" title="Switch Camera" onclick="switchCamera()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Voice Recording Modal -->
    <div class="voice-recording-modal" id="voiceRecordingModal">
        <div class="voice-recording-content">
            <h3>Recording Voice Message</h3>
            <div class="voice-recording-visualizer" id="voiceVisualizer">
                <div class="voice-recording-bar"></div>
                <div class="voice-recording-bar"></div>
                <div class="voice-recording-bar"></div>
                <div class="voice-recording-bar"></div>
                <div class="voice-recording-bar"></div>
                <div class="voice-recording-bar"></div>
                <div class="voice-recording-bar"></div>
                <div class="voice-recording-bar"></div>
            </div>
            <div class="voice-recording-time" id="voiceRecordingTime">00:00</div>
            <p>Speak into your microphone</p>
            <div class="voice-recording-controls">
                <button type="button" class="voice-recording-btn cancel" title="Cancel Voice Recording" onclick="cancelVoiceRecording()">
                    <i class="fas fa-times"></i>
                </button>
                <button type="button" class="voice-recording-btn stop" title="Stop Voice Recording" onclick="stopVoiceRecording()">
                    <i class="fas fa-stop"></i>
                </button>
                <button class="voice-recording-btn send" title="Send Voice Recording" onclick="sendVoiceRecording()" style="display: none;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div class="image-viewer-modal" id="imageViewerModal">
        <div class="image-viewer-content">
            <div class="image-viewer-controls">
                <button class="image-viewer-btn" onclick="downloadImage()" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="image-viewer-btn" onclick="closeImageViewer()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <img class="image-viewer-img" id="imageViewerImg" src="" alt="Full size image">
            <div class="image-viewer-info" id="imageViewerInfo">
                Image details
            </div>
        </div>
    </div>

    <!-- Schedule Message Modal -->
    <div class="schedule-modal" id="scheduleModal">
        <div class="schedule-modal-content">
            <h3>Schedule Message</h3>
            <div class="schedule-input-group">
                <label for="scheduleDate">Date</label>
                <input type="date" id="scheduleDate" name="scheduleDate">
            </div>
            <div class="schedule-input-group">
                <label for="scheduleTime">Time</label>
                <input type="time" id="scheduleTime" name="scheduleTime">
            </div>
            <div class="schedule-input-group">
                <label for="scheduleMessage">Message</label>
                <textarea id="scheduleMessage" name="scheduleMessage" rows="3" placeholder="Type your message here..."></textarea>
            </div>
            <div class="schedule-actions">
                <button onclick="closeScheduleModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="scheduleMessage()" class="btn btn-primary">Schedule</button>
            </div>
        </div>
    </div>

    <!-- Contact Search Modal -->
    <div class="contact-search-modal" id="contactSearchModal">
        <div class="contact-search-content">
            <div class="contact-search-header">
                <h3>Share Contact</h3>
                <input type="text" class="contact-search-input" id="contactSearchInput" placeholder="Search contacts...">
            </div>
            <div class="contact-search-results" id="contactSearchResults">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading contacts...
                </div>
            </div>
            <div class="schedule-actions">
                <button onclick="closeContactSearchModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Location Sharing Modal -->
    <div class="location-modal" id="locationModal">
        <div class="location-modal-content">
            <h3>Share Location</h3>
            <div class="location-preview" id="locationPreview">
                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                    <i class="fas fa-map-marker-alt" style="font-size: 2rem;"></i>
                </div>
            </div>
            <div class="location-details" id="locationDetails">
                <h4>Getting your location...</h4>
                <p>Please allow location access to share your current position.</p>
            </div>
            <div class="location-actions">
                <button onclick="closeLocationModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="sendCurrentLocation()" class="btn btn-primary" id="sendLocationBtn" disabled>Send Location</button>
            </div>
        </div>
    </div>

    <!-- Wallpaper Selector Modal -->
    <div class="wallpaper-selector" id="wallpaperSelector">
        <div class="wallpaper-modal">
            <h3>Choose Chat Wallpaper</h3>
            <div class="wallpaper-options">
                <div class="wallpaper-option none selected" data-wallpaper="none" onclick="selectWallpaper('none')">
                    <span>None</span>
                </div>
                <div class="wallpaper-option" data-wallpaper="bubbles" onclick="selectWallpaper('bubbles')">
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); width: 100%; height: 100%;"></div>
                </div>
                <div class="wallpaper-option" data-wallpaper="geometric" onclick="selectWallpaper('geometric')">
                    <div style="background: linear-gradient(45deg, #f093fb, #f5576c); width: 100%; height: 100%;"></div>
                </div>
                <div class="wallpaper-option" data-wallpaper="nature" onclick="selectWallpaper('nature')">
                    <div style="background: linear-gradient(45deg, #4facfe, #00f2fe); width: 100%; height: 100%;"></div>
                </div>
                <div class="wallpaper-option" data-wallpaper="dark" onclick="selectWallpaper('dark')">
                    <div style="background: linear-gradient(45deg, #2c3e50, #34495e); width: 100%; height: 100%;"></div>
                </div>
                <div class="wallpaper-option" data-wallpaper="sunset" onclick="selectWallpaper('sunset')">
                    <div style="background: linear-gradient(45deg, #ff9a9e, #fecfef); width: 100%; height: 100%;"></div>
                </div>
            </div>
            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button onclick="closeWallpaperSelector()" class="btn btn-secondary">Cancel</button>
                <button onclick="applyWallpaper()" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>

    <!-- Message Context Menu -->
    <div class="message-context-menu" id="messageContextMenu">
        <div class="context-menu-item" onclick="replyToMessage()">
            <i class="fas fa-reply"></i>
            Reply
        </div>
        <div class="context-menu-item" onclick="forwardMessage()">
            <i class="fas fa-share"></i>
            Forward
        </div>
        <div class="context-menu-item" onclick="addReaction()">
            <i class="fas fa-smile"></i>
            React
        </div>
        <div class="context-menu-item" onclick="copyMessage()">
            <i class="fas fa-copy"></i>
            Copy
        </div>
        <div class="context-menu-item" onclick="selectMessage()">
            <i class="fas fa-check-square"></i>
            Select
        </div>
        <div class="context-menu-item danger" onclick="deleteMessage()">
            <i class="fas fa-trash"></i>
            Delete
        </div>
    </div>

    <!-- Emoji Picker -->
    <div class="emoji-picker" id="emojiPicker">
        <div class="emoji-picker-header">
            <span>Choose Emoji</span>
            <button type="button" onclick="closeEmojiPicker()" class="close-emoji-picker-btn" title="Close Emoji Picker">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="emoji-picker-body" id="emojiPickerBody">
            <!-- Emojis will be populated by JavaScript -->
        </div>
    </div>

    <!-- Reply Input Bar -->
    <div class="reply-input-bar" id="replyInputBar">
        <div class="reply-input-preview">
            <div class="reply-input-author" id="replyAuthor">John Doe</div>
            <div class="reply-input-text" id="replyText">Original message text...</div>
        </div>
      <button type="button" class="reply-cancel-btn" title="Cancel reply" onclick="cancelReply()">
    <i class="fas fa-times"></i>
</button>
    </div>

    <!-- Message Selection Counter -->
    <div class="message-selection-counter" id="messageSelectionCounter">
        <span id="selectionCount">0</span> messages selected
    </div>

    <!-- Forward Modal -->
    <div class="contact-search-modal" id="forwardModal">
        <div class="contact-search-content">
            <div class="contact-search-header">
                <h3>Forward Message</h3>
                <input type="text" class="contact-search-input" id="forwardSearchInput" placeholder="Search contacts...">
            </div>
            <div class="contact-search-results" id="forwardSearchResults">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading contacts...
                </div>
            </div>
            <div class="schedule-actions">
                <button onclick="closeForwardModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="schedule-modal" id="deleteModal">
        <div class="schedule-modal-content">
            <h3>Delete Message</h3>
            <p style="margin-bottom: 2rem; color: var(--text-secondary);">Choose delete option:</p>
            <div class="schedule-actions" style="flex-direction: column; gap: 1rem;">
                <button onclick="deleteMessageForMe()" class="btn btn-secondary">Delete for me</button>
                <button onclick="deleteMessageForEveryone()" class="btn" style="background: var(--danger-color); color: white;">Delete for everyone</button>
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Enhanced JavaScript with All Features -->
    <script type="module">
        // Firebase SDK Imports (keeping the same as your original)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, onSnapshot, orderBy, limit, updateDoc, deleteDoc, startAfter, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Your existing Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
            authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
            projectId: "andrew-cares-village-f4cb6",
            storageBucket: "andrew-cares-village-f4cb6.firebasestorage.app",
            messagingSenderId: "255087116955",
            appId: "1:255087116955:web:84360ee1f13888f9b83c3e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enhanced Global State
        let currentAuthUser = null;
        let currentAuthUserData = null;
        let activeChatUnsubscribe = null;
        let friendsUnsubscribe = null;
        let friends = new Map();
        let currentChatFriend = null;
        let isTyping = false;
        let typingTimeout = null;
        let messageCache = new Map();
        let lastVisibleMessage = null;
        let isLoadingMessages = false;
        let currentWallpaper = 'none';
        let selectedMessages = new Set();
        let replyToMessage = null;
        let currentLocation = null;
        let voiceRecorder = null;
        let voiceChunks = [];
        let displayedMessageIds = new Set(); // Track displayed messages to prevent duplicates

        // IndexedDB for local caching
        let dbCache;
        const DB_NAME = 'MessagingCache';
        const DB_VERSION = 1;

        // Initialize IndexedDB
        function initializeCache() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => console.error('Error opening IndexedDB');
            
            request.onsuccess = (event) => {
                dbCache = event.target.result;
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains('messages')) {
                    const messagesStore = db.createObjectStore('messages', { keyPath: 'id' });
                    messagesStore.createIndex('chatId', 'chatId', { unique: false });
                    messagesStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('contacts')) {
                    db.createObjectStore('contacts', { keyPath: 'id' });
                }
            };
        }

        initializeCache();

        // Enhanced Emoji System
        const emojiCategories = {
            'smileys': ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎'],
            'hearts': ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟'],
            'reactions': ['👍', '👎', '👌', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '👇', '☝️', '✋', '🤚', '🖐️', '🖖', '👋', '🤝', '👏', '🙌']
        };

        // DOM Elements
        const userNameNavEl = document.getElementById('userNameNav');
        const userAvatarNavEl = document.getElementById('userAvatarNav');
        const logoutButton = document.getElementById('logoutButton');
        const conversationListBody = document.getElementById('conversationListBody');
        const chatWindow = document.getElementById('chatWindow');
        const messagingContainer = document.getElementById('messagingContainer');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const mainNav = document.getElementById('mainNav');
        const conversationSearch = document.getElementById('conversationSearch');

        // Enhanced Mobile Menu Setup (from previous code)
        function setupMobileMenu() {
            mobileMenuToggle.addEventListener('click', () => {
                mainNav.classList.toggle('mobile-open');
                const icon = mobileMenuToggle.querySelector('i');
                icon.className = mainNav.classList.contains('mobile-open') 
                    ? 'fas fa-times' 
                    : 'fas fa-bars';
            });

            document.addEventListener('click', (e) => {
                if (!mobileMenuToggle.contains(e.target) && !mainNav.contains(e.target)) {
                    mainNav.classList.remove('mobile-open');
                    const icon = mobileMenuToggle.querySelector('i');
                    icon.className = 'fas fa-bars';
                }
            });
        }
        setupMobileMenu();

        // Enhanced Authentication Observer with Demo Mode Fallback
        let authTimeout = setTimeout(() => {
            // Fallback to demo mode if Firebase auth takes too long
            console.log('Firebase auth timeout, switching to demo mode');
            initializeDemoMode();
        }, 3000);

        onAuthStateChanged(auth, async (user) => {
                clearTimeout(authTimeout);
                
                if (user) {
                    currentAuthUser = user;
                    try {
                        const authUserDocRef = doc(db, "users", currentAuthUser.uid);
                        const authUserSnap = await getDoc(authUserDocRef);

                        if (authUserSnap.exists()) {
                            currentAuthUserData = authUserSnap.data();
                            updateHeaderUI();
                            await loadFriends();

                            const urlParams = new URLSearchParams(window.location.search);
                            const friendId = urlParams.get('friendId');

                            if (friendId && friends.has(friendId)) {
                                const friendData = friends.get(friendId);
                                loadChatWindow(friendData);
                                highlightConversation(friendId);
                                showChatWindow();
                            }
                        } else {
                            initializeDemoMode();
                        }
                    } catch (error) {
                        console.error('Firebase error, switching to demo mode:', error);
                        // Only switch to demo mode if it's actually a Firebase error, not a missing function
                        if (error.name === 'ReferenceError' && error.message.includes('updateHeaderUI')) {
                            console.error('updateHeaderUI function missing - this should be fixed now');
                        }
                        initializeDemoMode();
                    }
                } else {
                    initializeDemoMode();
                }
            });

        function initializeDemoMode() {
            console.log('Initializing demo mode');
            
            // Create demo user
            currentAuthUser = {
                uid: 'demo-user-123',
                email: 'demo@andrewcaresvillage.com',
                displayName: 'Demo User'
            };
            
            currentAuthUserData = {
                name: 'Demo User',
                email: 'demo@andrewcaresvillage.com',
                avatar: generateAvatar('Demo User'),
                status: 'online'
            };
            
            updateHeaderUI();
            loadDemoFriends();
        }

        function loadDemoFriends() {
            // Create demo friends
            const demoFriends = [
                {
                    id: 'friend-1',
                    name: 'John Doe',
                    email: 'john@example.com',
                    avatar: generateAvatar('John Doe'),
                    status: 'online',
                    lastMessage: 'Hey, how are you doing?',
                    lastMessageTime: new Date(Date.now() - 300000), // 5 minutes ago
                    unreadCount: 2
                },
                {
                    id: 'friend-2', 
                    name: 'Jane Smith',
                    email: 'jane@example.com',
                    avatar: generateAvatar('Jane Smith'),
                    status: 'away',
                    lastMessage: 'Thanks for the help!',
                    lastMessageTime: new Date(Date.now() - 3600000), // 1 hour ago
                    unreadCount: 0
                },
                {
                    id: 'friend-3',
                    name: 'Mike Johnson',
                    email: 'mike@example.com', 
                    avatar: generateAvatar('Mike Johnson'),
                    status: 'offline',
                    lastMessage: 'See you tomorrow',
                    lastMessageTime: new Date(Date.now() - 86400000), // 1 day ago
                    unreadCount: 1
                }
            ];
            
            // Add to friends map
            friends.clear();
            demoFriends.forEach(friend => {
                friends.set(friend.id, friend);
            });
            
            displayFriends(demoFriends);
            hideLoadingState();
        }

        function displayFriends(friendsList) {
            updateConversationsList();
        }

        function hideLoadingState() {
            const loadingEl = document.querySelector('.loading-conversations');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        }

        function generateAvatar(name) {
            const colors = [
                '#6366f1', '#8b5cf6', '#ec4899', '#ef4444', 
                '#f59e0b', '#10b981', '#06b6d4', '#3b82f6'
            ];
            const color = colors[Math.abs(name.split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % colors.length];
            const initials = name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2);

            return `data:image/svg+xml;base64,${btoa(`
                <svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${color}dd;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect width="52" height="52" fill="url(#grad)" rx="14"/>
                    <text x="50%" y="50%" font-family="Inter, sans-serif" font-size="20" font-weight="600" 
                          text-anchor="middle" dy="0.35em" fill="white">${initials}</text>
                </svg>
            `)}`;
        }

        // Enhanced Friends Loading with caching
        async function loadFriends() {
            if (!currentAuthUser) return;

            if (friendsUnsubscribe) {
                friendsUnsubscribe();
            }

            try {
                const friendsRef = collection(db, "users", currentAuthUser.uid, "friends");
                const friendsQuery = query(friendsRef, where("status", "==", "accepted"));

                friendsUnsubscribe = onSnapshot(friendsQuery, async (snapshot) => {
                    friends.clear();

                    const friendPromises = snapshot.docs.map(async (friendDoc) => {
                        try {
                            const friendId = friendDoc.id;
                            const userDocRef = doc(db, "users", friendId);
                            const userSnap = await getDoc(userDocRef);

                            if (userSnap.exists()) {
                                const userData = userSnap.data();
                                friends.set(friendId, {
                                    id: friendId,
                                    ...userData,
                                    ...friendDoc.data()
                                });
                            }
                        } catch (error) {
                            console.error(`Error loading friend ${friendDoc.id}:`, error);
                        }
                    });

                    await Promise.allSettled(friendPromises);
                    updateConversationsList();
                });

            } catch (error) {
                console.error("Error loading friends:", error);
                conversationListBody.innerHTML = '<p style="padding: 2rem; color: var(--text-secondary);">Error loading conversations.</p>';
            }
        }

        // Enhanced Conversations List with real-time updates
        function updateConversationsList() {
            if (friends.size === 0) {
                conversationListBody.innerHTML = `
                    <div style="padding: 3rem 2rem; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.3; color: var(--text-muted);"></i>
                        <h3 style="font-size: 1.25rem; margin-bottom: 0.75rem; color: var(--text-primary);">No Conversations Yet</h3>
                        <p style="margin-bottom: 1.5rem; line-height: 1.6;">Connect with friends to start chatting</p>
                        <a href="friends.html" style="color: var(--primary-color); text-decoration: none; font-weight: 500; padding: 0.75rem 1.5rem; border: 2px solid var(--primary-color); border-radius: 12px; transition: all 0.3s ease;">Find Friends</a>
                    </div>
                `;
                return;
            }

            const friendsArray = Array.from(friends.values()).sort((a, b) => a.name.localeCompare(b.name));

            conversationListBody.innerHTML = friendsArray.map(friend => {
                const avatarUrl = friend.avatarUrl || generateAvatar(friend.name);
                const isOnline = Math.random() > 0.3; // Simulate online status
                const hasUnreadMessages = Math.random() > 0.7; // Simulate unread messages
                const unreadCount = hasUnreadMessages ? Math.floor(Math.random() * 5) + 1 : 0;
                const isTyping = Math.random() > 0.9; // Simulate typing
                
                return `
                    <div class="conversation-item" data-friend-id="${friend.id}" onclick="startConversation('${friend.id}')">
                        <div class="convo-avatar-wrapper">
                            <img src="${avatarUrl}" alt="${escapeHtml(friend.name)}" class="convo-avatar">
                            <div class="online-indicator ${isOnline ? 'online' : 'offline'} ${isTyping ? 'typing' : ''}"></div>
                        </div>
                        <div class="convo-details">
                            <div class="convo-name">${escapeHtml(friend.name)}</div>
                            <div class="last-message">
                                <span class="message-status">${isTyping ? 'typing...' : 'Click to start chatting...'}</span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            <div class="conversation-time">Now</div>
                            ${unreadCount > 0 ? `<div class="unread-count">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }


        // Enhanced Start Conversation
        window.startConversation = function (friendId) {
            const friendData = friends.get(friendId);
            if (!friendData) return;

            currentChatFriend = friendData;
            highlightConversation(friendId);
            loadChatWindow(friendData);
            showChatWindow();
        };

        function highlightConversation(friendId) {
            document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-friend-id="${friendId}"]`)?.classList.add('active');
        }

        function showChatWindow() {
            messagingContainer.classList.add('show-chat');
            // Update browser history for mobile back button
            if (window.innerWidth <= 768) {
                window.history.pushState({showChat: true}, '', window.location.href);
            }
        }

        window.showConversationList = function() {
            messagingContainer.classList.remove('show-chat');
            currentChatFriend = null;
            selectedMessages.clear();
            hideSelectionCounter();
            
            const placeholder = document.getElementById('chatWindowPlaceholder');
            if (placeholder) {
                chatWindow.innerHTML = `
                    <div class="chat-window-placeholder" id="chatWindowPlaceholder">
                        <i class="fas fa-comments"></i>
                        <h2>Select a conversation</h2>
                        <p>Choose from your friends list to start chatting, or send voice messages, images, files, and locations.</p>
                    </div>
                `;
            }
            
            if (activeChatUnsubscribe) {
                activeChatUnsubscribe();
                activeChatUnsubscribe = null;
            }
        };

        // Enhanced Chat Window Loading
        function loadChatWindow(friendData) {
            if (activeChatUnsubscribe) {
                activeChatUnsubscribe();
            }

            const avatarUrl = friendData.avatarUrl || generateAvatar(friendData.name);
            const isOnline = Math.random() > 0.3;
            const isTyping = Math.random() > 0.8;

            chatWindow.innerHTML = `
                <div class="chat-header">
                    <button class="mobile-back-btn" onclick="showConversationList()" aria-label="Back to conversations">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-header-info" onclick="showChatInfo('${friendData.id}')">
                        <img src="${avatarUrl}" alt="${escapeHtml(friendData.name)}" class="chat-header-avatar">
                        <div class="chat-header-details">
                            <h3>${escapeHtml(friendData.name)}</h3>
                            <div class="chat-header-status">
                                ${isTyping ? 
                                    '<span class="typing-indicator">typing...</span>' :
                                    '<span>' + (isOnline ? 'Active now' : 'Last seen recently') + '</span>'
                                }
                            </div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-action-btn" onclick="searchInChat()" data-tooltip="Search messages">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="chat-action-btn" onclick="startVoiceCall('${friendData.id}')" data-tooltip="Voice call">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="chat-action-btn" onclick="startVideoCall('${friendData.id}')" data-tooltip="Video call">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="chat-action-btn" onclick="showChatMenu('${friendData.id}')" data-tooltip="More options">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Message Search Bar -->
                <div class="message-search" id="messageSearch">
                    <div class="search-input-wrapper">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search messages...">
                        <button class="search-close-btn" onclick="closeMessageSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="search-results-info" id="searchResultsInfo"></div>
                </div>

                <div class="message-area" id="messageArea">
                    <div class="message-list" id="messageList">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading messages...
                        </div>
                    </div>
                </div>

                <!-- Reply Input Bar -->
                <div class="reply-input-bar" id="replyInputBar">
                    <div class="reply-input-preview">
                        <div class="reply-input-author" id="replyAuthor"></div>
                        <div class="reply-input-text" id="replyText"></div>
                    </div>
                    <button class="reply-cancel-btn" onclick="cancelReply()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="message-input-area">
                    <div class="input-wrapper">
                        <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                        <div class="input-actions">
                            <button class="input-action-btn" onclick="showEmojiPicker()" data-tooltip="Emoji">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="input-action-btn" onclick="showUploadModal()" data-tooltip="Attach">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="input-action-btn" onclick="startVoiceRecording()" data-tooltip="Voice note" id="voiceBtn">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <!-- Emoji Picker positioned relative to input -->
                        <div class="emoji-picker" id="emojiPicker">
                            <div class="emoji-picker-header">
                                <span>Choose Emoji</span>
                                <button onclick="closeEmojiPicker()" style="float: right; background: none; border: none; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                           <div class="emoji-picker-body" id="emojiPickerBody">
                                <!-- Emoji content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage('${friendData.id}')" aria-label="Send message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>

            `;

            setupMessageInput();
            setupMessageSearch();
            setupMessageInteractions();
            listenForMessages(friendData.id);
            loadStoredWallpaper();
        }

        // Generate Emoji Picker
        function generateEmojiPicker() {
            let html = '';
            for (const [category, emojis] of Object.entries(emojiCategories)) {
                html += `<div class="emoji-category" data-category="${category}">`;
                emojis.forEach(emoji => {
                    html += `<div class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</div>`;
                });
                html += '</div>';
            }
            return html;
        }

        // Enhanced Message Input Setup with all features
        function setupMessageInput() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            if (!messageInput || !sendBtn) return;

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Update send button state
                sendBtn.disabled = !this.value.trim();
                sendBtn.style.opacity = this.value.trim() ? '1' : '0.6';

                // Handle typing indicator
                handleTypingIndicator();
            });

            // Send on Enter (but not Shift+Enter)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (this.value.trim() && currentChatFriend) {
                        sendMessage(currentChatFriend.id);
                    }
                }
            });

            // Initial state
            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.6';
        }

        // Setup Message Search
        function setupMessageSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', debounce((e) => {
                const query = e.target.value.toLowerCase().trim();
                if (query.length > 0) {
                    searchMessages(query);
                } else {
                    clearSearchHighlights();
                }
            }, 300));
        }

        // Setup Message Interactions
        function setupMessageInteractions() {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return;

            // Infinite scroll for loading older messages
            messageArea.addEventListener('scroll', debounce(() => {
                if (messageArea.scrollTop === 0 && !isLoadingMessages && currentChatFriend) {
                    loadOlderMessages();
                }
            }, 200));

            // Long press for message context menu (mobile)
            let longPressTimer;
            let selectedMessageElement;

            messageArea.addEventListener('touchstart', (e) => {
                const messageElement = e.target.closest('.message-bubble');
                if (messageElement) {
                    selectedMessageElement = messageElement;
                    longPressTimer = setTimeout(() => {
                        showMessageContextMenu(e, messageElement);
                        navigator.vibrate && navigator.vibrate(50); // Haptic feedback
                    }, 500);
                }
            });

            messageArea.addEventListener('touchend', () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
            });

            messageArea.addEventListener('touchmove', () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                }
            });

            // Desktop right-click context menu
            messageArea.addEventListener('contextmenu', (e) => {
                const messageElement = e.target.closest('.message-bubble');
                if (messageElement) {
                    e.preventDefault();
                    showMessageContextMenu(e, messageElement);
                }
            });

            // Message selection mode
            messageArea.addEventListener('click', (e) => {
                if (selectedMessages.size > 0) {
                    const messageElement = e.target.closest('.message-bubble');
                    if (messageElement) {
                        e.preventDefault();
                        toggleMessageSelection(messageElement);
                    }
                } else {
                    // Show/hide timestamp on tap
                    const messageElement = e.target.closest('.message-bubble');
                    if (messageElement) {
                        messageElement.classList.toggle('show-timestamp');
                    }
                }
            });

            // Click outside to close context menu
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.message-context-menu')) {
                    closeMessageContextMenu();
                }
            });
        }

        // Enhanced Message Listening with pagination and caching
    function listenForMessages(friendId) {
    const chatId = getChatId(friendId);
    messageCache.clear();
    lastVisibleMessage = null;
    displayedMessageIds.clear(); // Reset displayed messages tracker

    // Try to load from cache first
    loadMessagesFromCache(chatId).then((cachedMessages) => {
        if (cachedMessages.length > 0) {
            displayMessages(cachedMessages);
        }
    });

    const messagesRef = collection(db, "chats", chatId, "messages");
    const q = query(messagesRef, orderBy("timestamp", "desc"));

    activeChatUnsubscribe = onSnapshot(q, (querySnapshot) => {
        const messageList = document.getElementById('messageList');
        const messageArea = document.getElementById('messageArea');
        if (!messageList || !messageArea) return;

        if (querySnapshot.empty) {
            messageList.innerHTML = getEmptyStateHTML();
            return;
        }

        const messages = [];
        querySnapshot.forEach(doc => {
            const messageData = { id: doc.id, ...doc.data() };
            // Prevent duplicate messages
            if (!displayedMessageIds.has(doc.id)) {
                messages.push(messageData);
                messageCache.set(doc.id, messageData);
                displayedMessageIds.add(doc.id);
            }
        });

        if (messages.length === 0) return; // No new messages

        // Cache messages locally
        cacheMessages(chatId, messages);

        messages.reverse(); // Display in chronological order
        displayMessages(messages);
        
        if (!lastVisibleMessage) {
            setTimeout(() => {
                messageArea.scrollTop = messageArea.scrollHeight;
            }, 100);
        }

        // Mark messages as read
        markMessagesAsRead(messages);
    }, (error) => {
        console.error("Error listening to messages:", error);
        // Show error state but don't break the app
        const messageList = document.getElementById('messageList');
        if (messageList && messageList.innerHTML.includes('Loading messages')) {
            messageList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--warning-color);"></i>
                    <p>Unable to load messages. Please check your connection.</p>
                    <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                </div>
            `;
        }
    });
}


        // Display Messages with Enhanced Features
        function displayMessages(messages) {
            const messageList = document.getElementById('messageList');
            if (!messageList) return;

            // Only clear if we're loading initial messages
            if (!lastVisibleMessage) {
                messageList.innerHTML = '';
                displayedMessageIds.clear();
            }

            if (messages.length === 0) {
                messageList.innerHTML = getEmptyStateHTML();
                return;
            }

            messages.forEach((message, index) => {
                // Only add if not already displayed
                if (!displayedMessageIds.has(message.id)) {
                    const messageHTML = createEnhancedMessageBubbleHTML(message, messages, index);
                    messageList.insertAdjacentHTML('beforeend', messageHTML);
                    displayedMessageIds.add(message.id);
                }
            });

            // Setup enhanced features
            setupImageLazyLoading();
            setupVoiceMessagePlayers();
            setupMessageInteractions();
        }

        // Enhanced Message Bubble Creation with All Features
        function createEnhancedMessageBubbleHTML(message, dayMessages, index) {
            const isSent = message.senderId === currentAuthUser.uid;
            const timestamp = formatMessageTimestamp(message.timestamp);
            const safeText = escapeHtml(message.text || '');
            
            // Check if this is a consecutive message from same sender
            const prevMessage = dayMessages[index - 1];
            const isConsecutive = prevMessage && prevMessage.senderId === message.senderId && 
                                 (message.timestamp?.seconds - prevMessage.timestamp?.seconds) < 300; // 5 min

            // Message reactions
            const reactions = message.reactions || {};
            const reactionsHTML = Object.keys(reactions).length > 0 ? 
                createReactionsHTML(reactions, message.id) : '';

            // Reply preview
            const replyHTML = message.replyTo ? createReplyPreviewHTML(message.replyTo) : '';

            // Forwarded indicator
            const forwardedHTML = message.forwarded ? 
                '<div class="forwarded-indicator"><i class="fas fa-share"></i> Forwarded</div>' : '';

            // Edited indicator
            const editedHTML = message.edited ? 
                '<div class="editing-indicator">edited</div>' : '';

            // Message content based on type
            let messageContent = createMessageContentHTML(message, safeText);

            // Message status icons
            let statusIcon = '';
            if (isSent) {
                statusIcon = createStatusIconHTML(message);
            }

            // Scheduled indicator
            const scheduledHTML = message.scheduled ? 
                '<div class="scheduled-indicator">Scheduled</div>' : '';

            // Link preview
            const linkPreviewHTML = message.linkPreview ? 
                createLinkPreviewHTML(message.linkPreview) : '';

            return `
                <div class="message-bubble ${isSent ? 'sent' : 'received'} ${isConsecutive ? 'consecutive' : ''}" 
                     data-message-id="${message.id}" data-sender-id="${message.senderId}">
                    ${forwardedHTML}
                    ${replyHTML}
                    ${messageContent}
                    ${linkPreviewHTML}
                    ${reactionsHTML}
                    <div class="message-timestamp">
                        ${timestamp}
                        ${scheduledHTML}
                        ${editedHTML}
                        ${statusIcon}
                    </div>
                </div>
            `;
        }

        // Create Message Content HTML based on type
        function createMessageContentHTML(message, safeText) {
            switch (message.type) {
                case 'image':
                    return `
                        <div class="image-thumbnail-wrapper">
                            <img src="${message.imageUrl}" alt="Shared image" class="message-image lazy-image" 
                                 onclick="openImageViewer('${message.imageUrl}', '${escapeHtml(message.fileName || 'Image')}')"
                                 loading="lazy">
                        </div>
                        ${safeText ? `<div class="message-content">${safeText}</div>` : ''}
                    `;
                
                case 'file':
                    return `
                        <div class="message-file" onclick="downloadFile('${message.fileUrl}', '${escapeHtml(message.fileName)}')">
                            <i class="fas fa-file file-icon"></i>
                            <div class="file-info">
                                <h4>${escapeHtml(message.fileName)}</h4>
                                <div class="file-size">${formatFileSize(message.fileSize || 0)}</div>
                            </div>
                            <button class="file-download-btn">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        ${safeText ? `<div class="message-content">${safeText}</div>` : ''}
                    `;
                
                case 'voice':
                    return createVoiceMessageHTML(message);
                
                case 'location':
                    return createLocationMessageHTML(message);
                
                case 'contact':
                    return createContactCardHTML(message);
                
                case 'pdf':
                    return createPDFPreviewHTML(message);
                
                default:
                    // Auto-detect and create link previews
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    if (urlRegex.test(safeText) && !message.linkPreview) {
                        // In real app, you'd fetch link preview asynchronously
                        generateLinkPreview(message.id, safeText);
                    }
                    return `<div class="message-content">${safeText}</div>`;
            }
        }

        // Voice Message HTML with Waveform
        function createVoiceMessageHTML(message) {
            const duration = message.duration || '0:00';
            const waveformData = message.waveform || generateWaveformData();
            
            return `
                <div class="voice-message" data-voice-url="${message.voiceUrl}" data-message-id="${message.id}">
                    <button class="voice-play-btn" onclick="toggleVoicePlayback('${message.id}')">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="voice-waveform" onclick="seekVoiceMessage('${message.id}', event)">
                        ${createWaveformBars(waveformData)}
                        <div class="voice-progress-bar" style="width: 0%;"></div>
                    </div>
                    <div class="voice-duration">${duration}</div>
                </div>
            `;
        }

        // Generate Waveform Data
        function generateWaveformData() {
            return Array.from({length: 30}, () => Math.random() * 0.8 + 0.2);
        }

        function createWaveformBars(waveformData) {
            return waveformData.map((height, index) => 
                `<div class="voice-bar" style="height: ${height * 40}px;" data-index="${index}"></div>`
            ).join('');
        }

        // Voice Message Playback System
        const voicePlaybackSystem = {
            currentAudio: null,
            currentMessageId: null,
            
            async play(messageId, voiceUrl) {
                if (this.currentAudio && this.currentMessageId === messageId) {
                    if (this.currentAudio.paused) {
                        this.currentAudio.play();
                        this.updatePlayButton(messageId, 'playing');
                    } else {
                        this.currentAudio.pause();
                        this.updatePlayButton(messageId, 'paused');
                    }
                    return;
                }
                
                // Stop current audio if playing different message
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.updatePlayButton(this.currentMessageId, 'stopped');
                }
                
                // Demo mode simulation
                if (currentAuthUser.uid.startsWith('demo-user') || voiceUrl === '#') {
                    this.simulatePlayback(messageId);
                    return;
                }
                
                try {
                    this.currentAudio = new Audio(voiceUrl);
                    this.currentMessageId = messageId;
                    
                    this.currentAudio.addEventListener('loadedmetadata', () => {
                        this.updatePlayButton(messageId, 'playing');
                    });
                    
                    this.currentAudio.addEventListener('timeupdate', () => {
                        this.updateProgress(messageId);
                    });
                    
                    this.currentAudio.addEventListener('ended', () => {
                        this.updatePlayButton(messageId, 'stopped');
                        this.currentMessageId = null;
                        this.currentAudio = null;
                    });
                    
                    this.currentAudio.currentTime = 0;
                    
                    const playPromise = this.currentAudio.play();
                    if (playPromise !== undefined) {
                        await playPromise;
                    }
                } catch (error) {
                    // Only show error if it's not an AbortError (which happens during normal operation)
                    if (error.name !== 'AbortError') {
                        console.error('Error playing voice message:', error);
                        showNotification('Could not play voice message', 'error');
                    }
                }
            },
            
            simulatePlayback(messageId) {
                this.updatePlayButton(messageId, 'playing');
                
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 2;
                    this.updateProgressBar(messageId, progress);
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        this.updatePlayButton(messageId, 'stopped');
                        this.currentMessageId = null;
                    }
                }, 100);
                
                // Store interval for potential cleanup
                this.currentInterval = interval;
            },
            
            updatePlayButton(messageId, state) {
                const playBtn = document.querySelector(`[data-message-id="${messageId}"] .voice-play-btn i`);
                if (!playBtn) return;
                
                switch (state) {
                    case 'playing':
                        playBtn.className = 'fas fa-pause';
                        break;
                    case 'paused':
                    case 'stopped':
                        playBtn.className = 'fas fa-play';
                        break;
                }
            },
            
            updateProgress(messageId) {
                if (!this.currentAudio) return;
                const progress = (this.currentAudio.currentTime / this.currentAudio.duration) * 100;
                this.updateProgressBar(messageId, progress);
            },
            
            updateProgressBar(messageId, progress) {
                const progressBar = document.querySelector(`[data-message-id="${messageId}"] .voice-progress-bar`);
                if (progressBar) {
                    progressBar.style.width = `${Math.min(progress, 100)}%`;
                }
                
                // Update waveform visualization
                const waveformBars = document.querySelectorAll(`[data-message-id="${messageId}"] .voice-bar`);
                const activeBarIndex = Math.floor((progress / 100) * waveformBars.length);
                
                waveformBars.forEach((bar, index) => {
                    if (index <= activeBarIndex) {
                        bar.classList.add('active');
                    } else {
                        bar.classList.remove('active');
                    }
                });
            }
        };

        // Global Voice Playback Functions
        window.toggleVoicePlayback = function(messageId) {
            const voiceMessage = document.querySelector(`[data-message-id="${messageId}"] .voice-message`);
            const voiceUrl = voiceMessage?.dataset.voiceUrl;
            if (voiceUrl) {
                voicePlaybackSystem.play(messageId, voiceUrl);
            }
        };

        window.seekVoiceMessage = function(messageId, event) {
            const waveform = event.currentTarget;
            const rect = waveform.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = (clickX / rect.width) * 100;
            
            if (voicePlaybackSystem.currentAudio && voicePlaybackSystem.currentMessageId === messageId) {
                const newTime = (percentage / 100) * voicePlaybackSystem.currentAudio.duration;
                voicePlaybackSystem.currentAudio.currentTime = newTime;
            }
        };

        // Message Reactions System
        function createReactionsHTML(reactions, messageId) {
            let html = '<div class="message-reactions">';
            
            for (const [emoji, users] of Object.entries(reactions)) {
                const count = users.length;
                const hasMyReaction = users.includes(currentAuthUser.uid);
                
                html += `
                    <div class="reaction ${hasMyReaction ? 'my-reaction' : ''}" 
                         onclick="toggleReaction('${messageId}', '${emoji}')">
                        ${emoji} ${count}
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        window.toggleReaction = async function(messageId, emoji) {
            if (!currentChatFriend) return;
            
            try {
                if (currentAuthUser.uid.startsWith('demo-user')) {
                    // Demo mode - just update UI
                    const reactionEl = document.querySelector(`[data-message-id="${messageId}"] .reaction`);
                    if (reactionEl) {
                        reactionEl.classList.toggle('my-reaction');
                        const count = parseInt(reactionEl.textContent.match(/\d+/)?.[0] || '0');
                        reactionEl.innerHTML = `${emoji} ${reactionEl.classList.contains('my-reaction') ? count + 1 : Math.max(count - 1, 0)}`;
                    }
                    return;
                }
                
                const chatId = getChatId(currentChatFriend.id);
                const messageRef = doc(db, "chats", chatId, "messages", messageId);
                
                // This would be implemented with Firestore transactions in a real app
                showNotification('Reaction added!', 'success');
                
            } catch (error) {
                console.error('Error toggling reaction:', error);
                showNotification('Could not add reaction', 'error');
            }
        };

        // Enhanced Search System
        window.searchInChat = function() {
            const messageSearch = document.getElementById('messageSearch');
            messageSearch.classList.add('show');
            document.getElementById('searchInput').focus();
        };

        window.closeMessageSearch = function() {
            const messageSearch = document.getElementById('messageSearch');
            messageSearch.classList.remove('show');
            document.getElementById('searchInput').value = '';
            clearSearchHighlights();
        };

        function searchMessages(query) {
            const messageElements = document.querySelectorAll('.message-bubble .message-content');
            let matches = 0;
            
            clearSearchHighlights();
            
            messageElements.forEach(element => {
                const text = element.textContent.toLowerCase();
                if (text.includes(query)) {
                    highlightSearchTerm(element, query);
                    matches++;
                }
            });
            
            document.getElementById('searchResultsInfo').textContent = 
                matches > 0 ? `${matches} message${matches > 1 ? 's' : ''} found` : 'No messages found';
        }

        function highlightSearchTerm(element, term) {
            const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
            element.innerHTML = element.innerHTML.replace(regex, '<mark>$1</mark>');
            element.closest('.message-bubble').classList.add('search-highlight');
        }

        function clearSearchHighlights() {
            document.querySelectorAll('.message-bubble').forEach(el => {
                el.classList.remove('search-highlight');
            });
            document.querySelectorAll('mark').forEach(mark => {
                mark.outerHTML = mark.innerHTML;
            });
        }
function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

        // Message Context Menu System
        function showMessageContextMenu(event, messageElement) {
            const messageId = messageElement.dataset.messageId;
            const senderId = messageElement.dataset.senderId;
            const isSent = senderId === currentAuthUser.uid;
            
            const contextMenu = document.getElementById('messageContextMenu');
            contextMenu.innerHTML = `
                <div class="context-menu-item" onclick="replyToMessage('${messageId}')">
                    <i class="fas fa-reply"></i>
                    Reply
                </div>
                <div class="context-menu-item" onclick="forwardMessage('${messageId}')">
                    <i class="fas fa-share"></i>
                    Forward
                </div>
                <div class="context-menu-item" onclick="showReactionPicker('${messageId}')">
                    <i class="fas fa-smile"></i>
                    React
                </div>
                <div class="context-menu-item" onclick="copyMessageText('${messageId}')">
                    <i class="fas fa-copy"></i>
                    Copy
                </div>
                <div class="context-menu-item" onclick="selectMessage('${messageId}')">
                    <i class="fas fa-check-square"></i>
                    Select
                </div>
                ${isSent ? '<div class="context-menu-item" onclick="editMessage(\'' + messageId + '\')"><i class="fas fa-edit"></i>Edit</div>' : ''}
                <div class="context-menu-item danger" onclick="showDeleteModal('${messageId}')">
                    <i class="fas fa-trash"></i>
                    Delete
                </div>
            `;
            
            // Position context menu
            const rect = messageElement.getBoundingClientRect();
            const menuHeight = 280; // Approximate height
            const menuWidth = 150;
            
            let top = event.clientY || (rect.top + rect.height / 2);
            let left = event.clientX || (rect.right + 10);
            
            // Adjust if menu would go off screen
            if (top + menuHeight > window.innerHeight) {
                top = window.innerHeight - menuHeight - 10;
            }
            if (left + menuWidth > window.innerWidth) {
                left = window.innerWidth - menuWidth - 10;
            }
            
            contextMenu.style.top = `${top}px`;
            contextMenu.style.left = `${left}px`;
            contextMenu.classList.add('show');
        }

        function closeMessageContextMenu() {
            const contextMenu = document.getElementById('messageContextMenu');
            contextMenu.classList.remove('show');
        }

        // Message Reply System
        window.replyToMessage = function(messageId) {
            closeMessageContextMenu();
            
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageElement) return;
            
            const messageContent = messageElement.querySelector('.message-content');
            const senderId = messageElement.dataset.senderId;
            const senderName = senderId === currentAuthUser.uid ? 'You' : currentChatFriend?.name || 'Unknown';
            
            replyToMessage = {
                id: messageId,
                text: messageContent?.textContent || 'Media message',
                senderName: senderName
            };
            
            // Show reply bar
            const replyBar = document.getElementById('replyInputBar');
            const replyAuthor = document.getElementById('replyAuthor');
            const replyText = document.getElementById('replyText');
            
            replyAuthor.textContent = senderName;
            replyText.textContent = replyToMessage.text;
            replyBar.classList.add('show');
            
            // Focus on message input
            document.getElementById('messageInput').focus();
        };

        window.cancelReply = function() {
            replyToMessage = null;
            document.getElementById('replyInputBar').classList.remove('show');
        };

        function createReplyPreviewHTML(replyData) {
            return `
                <div class="reply-preview">
                    <div class="reply-author">${escapeHtml(replyData.senderName)}</div>
                    <div class="reply-text">${escapeHtml(replyData.text)}</div>
                </div>
            `;
        }

        // Message Selection System
        window.selectMessage = function(messageId) {
            closeMessageContextMenu();
            toggleMessageSelection(document.querySelector(`[data-message-id="${messageId}"]`));
        };

        function toggleMessageSelection(messageElement) {
            const messageId = messageElement.dataset.messageId;
            
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
                messageElement.classList.remove('selected');
            } else {
                selectedMessages.add(messageId);
                messageElement.classList.add('selected');
            }
            
            updateSelectionCounter();
        }

        function updateSelectionCounter() {
            const counter = document.getElementById('messageSelectionCounter');
            const count = document.getElementById('selectionCount');
            
            if (selectedMessages.size > 0) {
                count.textContent = selectedMessages.size;
                counter.classList.add('show');
            } else {
                counter.classList.remove('show');
            }
        }

        function hideSelectionCounter() {
            document.getElementById('messageSelectionCounter').classList.remove('show');
        }

        // Enhanced Send Message with Reply Support
      async function sendMessage(friendId) {
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messageArea = document.getElementById('messageArea');
    const text = messageInput.value.trim();

    if (!text || !currentAuthUser || !friendId) return;

    // Build message object
    const messageData = {
        text: text,
        senderId: currentAuthUser.uid,
        timestamp: { seconds: Date.now() / 1000 },
        tempId: `temp_${Date.now()}_${Math.random()}`
    };

    // Add reply data if replying
    if (replyToMessage) {
        messageData.replyTo = replyToMessage;
        cancelReply();
    }

    // Optimistic UI update
    const messageList = document.getElementById('messageList');
    if (messageList) {
        const messageHTML = createEnhancedMessageBubbleHTML(messageData, [messageData], 0);
        messageList.insertAdjacentHTML('beforeend', messageHTML);
        messageArea.scrollTop = messageArea.scrollHeight;
    }

    // Reset input
    sendBtn.disabled = true;
    messageInput.disabled = true;
    messageInput.value = '';
    messageInput.style.height = 'auto';

    try {
        if (currentAuthUser.uid.startsWith('demo-user')) {
            // Demo mode - simulate response
            setTimeout(() => {
                const demoResponse = {
                    id: `demo_${Date.now()}`,
                    text: getDemoResponse(text),
                    senderId: friendId,
                    timestamp: { seconds: (Date.now() + 1000) / 1000 }
                };
                
                const responseHTML = createEnhancedMessageBubbleHTML(demoResponse, [demoResponse], 0);
                messageList.insertAdjacentHTML('beforeend', responseHTML);
                messageArea.scrollTop = messageArea.scrollHeight;
                
                // Setup image loading and error handling
                setTimeout(() => {
                    setupImageLazyLoading();
                }, 100);
            }, 1500);
        } else {
            // Real Firebase operation with better error handling
            const chatId = getChatId(friendId);
            
            // Ensure chat document exists
            const chatRef = doc(db, "chats", chatId);
            const chatSnap = await getDoc(chatRef);
            
            if (!chatSnap.exists()) {
                // Create chat document first
                await setDoc(chatRef, {
                    participants: [currentAuthUser.uid, friendId],
                    createdAt: serverTimestamp(),
                    lastMessage: text,
                    lastMessageTime: serverTimestamp()
                });
            }

            // Add message
            const messagesRef = collection(db, "chats", chatId, "messages");
            await addDoc(messagesRef, {
                text: text,
                senderId: currentAuthUser.uid,
                timestamp: serverTimestamp(),
                delivered: true,
                read: false,
                replyTo: replyToMessage || null
            });

            // Update chat's last message
            await updateDoc(chatRef, {
                lastMessage: text,
                lastMessageTime: serverTimestamp()
            });

            updateLastMessage(friendId, text);
        }

    } catch (error) {
        console.error("Error sending message:", error);
        
        // Remove optimistic message on error
        const tempMessageEl = document.querySelector(`[data-temp-id="${messageData.tempId}"]`);
        if (tempMessageEl) {
            tempMessageEl.remove();
        }
        
        showNotification("Could not send message. Please try again.", 'error');
    } finally {
        sendBtn.disabled = false;
        messageInput.disabled = false;
        messageInput.focus();
        sendBtn.style.opacity = '0.6';
    }
}

        // Enhanced File Upload with Compression
        async function handleFileUpload(file) {
            if (!currentChatFriend) {
                showNotification('Please select a chat first', 'warning');
                return;
            }

            if (!file) {
                showNotification('No file selected', 'warning');
                return;
            }

            // Validate file size (max 50MB)
            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                showNotification('File too large. Maximum size is 50MB', 'error');
                return;
            }

            closeUploadModal();
            
            let processedFile = file;
            
            // Compress images before upload
            if (file.type.startsWith('image/')) {
                try {
                    processedFile = await compressImage(file);
                    showNotification('Image compressed and uploading...', 'info');
                } catch (error) {
                    console.error('Image compression failed:', error);
                    showNotification('Using original image', 'warning');
                }
            }

            try {
                if (currentAuthUser.uid.startsWith('demo-user')) {
                    // Create proper mock message with unique ID
                    const mockMessage = createMockFileMessage(processedFile);
                    mockMessage.id = `mock_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    const messageList = document.getElementById('messageList');
                    const messageArea = document.getElementById('messageArea');
                    
                    if (messageList && messageArea) {
                        const messageHTML = createEnhancedMessageBubbleHTML(mockMessage, [mockMessage], 0);
                        messageList.insertAdjacentHTML('beforeend', messageHTML);
                        messageArea.scrollTop = messageArea.scrollHeight;
                        
                        // Setup image loading and error handling
                        setTimeout(() => {
                            setupImageLazyLoading();
                        }, 100);
                    }
                    
                    showNotification('File uploaded successfully!', 'success');
                    return;
                }

                // Real upload to Cloudinary
                const uploadResult = await uploadToCloudinary(processedFile);
                
                if (uploadResult && uploadResult.secure_url) {
                    const chatId = getChatId(currentChatFriend.id);
                    const messagesRef = collection(db, "chats", chatId, "messages");

                    // Ensure all required fields have valid values
                    const messageData = {
                        type: processedFile.type?.startsWith('image/') ? 'image' : 'file',
                        fileName: processedFile.name || file?.name || `file_${Date.now()}`,
                        fileSize: processedFile.size || file?.size || 0,
                        fileUrl: uploadResult.secure_url,
                        imageUrl: processedFile.type?.startsWith('image/') ? uploadResult.secure_url : null,
                        senderId: currentAuthUser.uid,
                        timestamp: serverTimestamp(),
                        delivered: true,
                        read: false
                    };

                    // Validate required fields before saving
                    if (!messageData.fileName || messageData.fileName === 'undefined') {
                        messageData.fileName = `file_${Date.now()}`;
                    }

                    await addDoc(messagesRef, messageData);

                    showNotification('File uploaded successfully!', 'success');
                } else {
                    throw new Error('Upload failed - no URL returned');
                }

            } catch (error) {
                console.error('Error uploading file:', error);
                showNotification('Failed to upload file. Please try again.', 'error');
            }
        }

        // Image Compression Function
        async function compressImage(file, maxWidth = 1024, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob((blob) => {
                        // Preserve original file properties
                        blob.name = file.name || 'compressed_image.jpg';
                        blob.lastModified = file.lastModified || Date.now();
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Upload to Cloudinary function
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'Andrew Cares Village Hub');
            formData.append('resource_type', 'auto');

            const response = await fetch('https://api.cloudinary.com/v1_1/dkd6x857p/auto/upload', {
                method: 'POST',
                body: formData
            });

            return await response.json();
        }

        function createMockFileMessage(file) {
            const fileType = file.type.split('/')[0];
            const isImage = fileType === 'image';
            
            return {
                id: `mock_${Date.now()}`,
                type: isImage ? 'image' : 'file',
                fileName: file.name,
                fileSize: file.size,
                fileUrl: isImage ? URL.createObjectURL(file) : '#',
                imageUrl: isImage ? URL.createObjectURL(file) : null,
                senderId: currentAuthUser.uid,
                timestamp: { seconds: Date.now() / 1000 },
                delivered: true,
                read: false
            };
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function hideVoiceRecordingModal() {
            const modal = document.getElementById('voiceRecordingModal');
            if (modal) {
                modal.classList.remove('show');
            }
            
            // Clear intervals
            if (recordingState.timerInterval) {
                clearInterval(recordingState.timerInterval);
            }
            if (recordingState.visualizerInterval) {
                clearInterval(recordingState.visualizerInterval);
            }
        }

        function resetRecordingState() {
            recordingState.isRecording = false;
            recordingState.mediaRecorder = null;
            recordingState.audioChunks = [];
            recordingState.startTime = null;
            
            updateVoiceRecordingUI(false);
        }

        // Enhanced Voice Recording System
        let recordingState = {
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            startTime: null,
            timerInterval: null,
            visualizerInterval: null
        };

        window.startVoiceRecording = async function() {
            if (!currentChatFriend) return;

            if (recordingState.isRecording) {
                stopVoiceRecording();
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                recordingState.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });
                
                recordingState.audioChunks = [];
                recordingState.startTime = Date.now();
                recordingState.isRecording = true;

                // Setup recording events
                recordingState.mediaRecorder.ondataavailable = (event) => {
                    recordingState.audioChunks.push(event.data);
                };

                recordingState.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(recordingState.audioChunks, { type: 'audio/webm' });
                    handleVoiceMessage(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                    resetRecordingState();
                };

                // Start recording
                recordingState.mediaRecorder.start();
                
                // Show voice recording modal
                showVoiceRecordingModal();
                
                // Update UI
                updateVoiceRecordingUI(true);

            } catch (error) {
                console.error('Error accessing microphone:', error);
                showNotification('Could not access microphone. Please check permissions.', 'error');
                resetRecordingState();
            }
        };

      
      window.stopVoiceRecording = function() {
    if (recordingState.mediaRecorder && recordingState.mediaRecorder.state === 'recording') {
        recordingState.mediaRecorder.stop();
    }
    hideVoiceRecordingModal();
};
        window.cancelVoiceRecording = function() {
            if (recordingState.mediaRecorder) {
                recordingState.mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            hideVoiceRecordingModal();
            resetRecordingState();
            showNotification('Voice recording cancelled', 'info');
        };

async function handleVoiceMessage(audioBlob) {
    if (!currentChatFriend) return;

    try {
        const duration = Math.floor((Date.now() - recordingState.startTime) / 1000);
        const fileName = `voice_${Date.now()}.webm`;
        
        // Create voice message object
        const voiceMessage = {
            type: 'voice',
            senderId: currentAuthUser.uid,
            timestamp: { seconds: Date.now() / 1000 },
            duration: formatTime(duration),
            voiceUrl: '#', // Will be replaced with actual URL after upload
            waveform: generateWaveformData()
        };

        // Add to UI immediately for better UX
        const messageList = document.getElementById('messageList');
        if (messageList) {
            messageList.innerHTML += createEnhancedMessageBubbleHTML(voiceMessage, [voiceMessage], 0);
            document.getElementById('messageArea').scrollTop = document.getElementById('messageArea').scrollHeight;
        }

        if (currentAuthUser.uid.startsWith('demo-user')) {
            showNotification('Voice message sent! (Demo mode)', 'success');
            return;
        }

        // Upload to Cloudinary or your preferred service
        const formData = new FormData();
        formData.append('file', audioBlob, fileName);
        formData.append('upload_preset', 'Andrew Cares Village Hub');
        formData.append('resource_type', 'auto');

        const response = await fetch('https://api.cloudinary.com/v1_1/dkd6x857p/auto/upload', {
            method: 'POST',
            body: formData
        });

        const uploadResult = await response.json();

        if (uploadResult.secure_url) {
            // Save to Firestore
            const chatId = getChatId(currentChatFriend.id);
            const messagesRef = collection(db, "chats", chatId, "messages");

            await addDoc(messagesRef, {
                type: 'voice',
                voiceUrl: uploadResult.secure_url,
                duration: formatTime(duration),
                fileName: fileName,
                senderId: currentAuthUser.uid,
                timestamp: serverTimestamp(),
                delivered: true,
                read: false,
                waveform: generateWaveformData()
            });

            showNotification('Voice message sent!', 'success');
        }

    } catch (error) {
        console.error('Error sending voice message:', error);
        showNotification('Failed to send voice message', 'error');
    }
}
function showVoiceRecordingModal() {
    const modal = document.getElementById('voiceRecordingModal');
    if (!modal) return;

    modal.classList.add('show');
    
    // Start timer
    recordingState.timerInterval = setInterval(updateRecordingTimer, 1000);
    
    // Start visualizer animation
    startVoiceVisualizer();
}

function updateRecordingTimer() {
    const elapsed = Date.now() - recordingState.startTime;
    const minutes = Math.floor(elapsed / 60000);
    const seconds = Math.floor((elapsed % 60000) / 1000);
    
    const timerEl = document.getElementById('voiceRecordingTime');
    if (timerEl) {
        timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

function startVoiceVisualizer() {
    const bars = document.querySelectorAll('.voice-recording-bar');
    
    recordingState.visualizerInterval = setInterval(() => {
        bars.forEach(bar => {
            const height = Math.random() * 32 + 8;
            bar.style.height = `${height}px`;
        });
    }, 150);
}

function updateVoiceRecordingUI(isRecording) {
    const voiceBtn = document.getElementById('voiceBtn');
    const icon = voiceBtn.querySelector('i');
    
    if (isRecording) {
        icon.className = 'fas fa-stop';
        voiceBtn.style.color = 'var(--danger-color)';
        voiceBtn.dataset.tooltip = 'Stop recording';
    } else {
        icon.className = 'fas fa-microphone';
        voiceBtn.style.color = '';
        voiceBtn.dataset.tooltip = 'Voice note';
    }
}

function stopVoiceRecording() {
    if (recordingState.mediaRecorder && recordingState.mediaRecorder.state === 'recording') {
        recordingState.mediaRecorder.stop();
    }
    
    hideVoiceRecordingModal();
}







        // Location Sharing System
        window.shareLocation = async function() {
            closeUploadModal();
            
            const modal = document.getElementById('locationModal');
            modal.classList.add('show');
            
            try {
                const position = await getCurrentPosition();
                currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                await updateLocationPreview(currentLocation);
                document.getElementById('sendLocationBtn').disabled = false;
                
            } catch (error) {
                // Silently handle geolocation errors and use fallback location
                currentLocation = {
                    lat: 40.7128,
                    lng: -74.0060,
                    accuracy: 1000
                };
                
                await updateLocationPreview(currentLocation);
                document.getElementById('sendLocationBtn').disabled = false;
                
                document.getElementById('locationDetails').innerHTML = `
                    <h4>Using Default Location</h4>
                    <p>Location services unavailable. Using New York City coordinates.</p>
                `;
            }
        };

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                // Try with minimal settings to avoid network provider issues
                const options = {
                    enableHighAccuracy: false,
                    timeout: 5000,
                    maximumAge: 60000
                };
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve(position);
                    },
                    (error) => {
                        // Always reject to trigger fallback, don't try to handle here
                        reject(error);
                    },
                    options
                );
            });
        }

        async function updateLocationPreview(location) {
    const preview = document.getElementById('locationPreview');
    const details = document.getElementById('locationDetails');
    
    // Use OpenStreetMap - completely free, no API key needed
    const osmUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${location.lng-0.005},${location.lat-0.005},${location.lng+0.005},${location.lat+0.005}&layer=mapnik&marker=${location.lat},${location.lng}`;
    
    preview.innerHTML = `
        <div style="width: 100%; height: 200px; border-radius: 8px; overflow: hidden; position: relative;">
            <iframe 
                src="${osmUrl}" 
                style="width: 100%; height: 100%; border: none;"
                title="Location Map">
            </iframe>
            <div style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                📍 ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}
            </div>
        </div>
    `;
    
    details.innerHTML = `
        <h4>Current Location</h4>
        <p>Latitude: ${location.lat.toFixed(6)}<br>Longitude: ${location.lng.toFixed(6)}</p>
        <small>Accuracy: ±${Math.round(location.accuracy)}m</small>
    `;
}
        
        window.closeLocationModal = function() {
            document.getElementById('locationModal').classList.remove('show');
            currentLocation = null;
        };

        window.sendCurrentLocation = async function() {
            if (!currentChatFriend) return;
            
            // Ensure we have a location, use fallback if needed
            if (!currentLocation) {
                currentLocation = {
                    lat: 40.7128,
                    lng: -74.0060,
                    accuracy: 1000
                };
            }

            closeLocationModal();

            const locationMessage = {
                type: 'location',
                latitude: currentLocation.lat,
                longitude: currentLocation.lng,
                senderId: currentAuthUser.uid,
                timestamp: { seconds: Date.now() / 1000 }
            };

            try {
                if (currentAuthUser.uid.startsWith('demo-user')) {
                    const messageList = document.getElementById('messageList');
                    if (messageList) {
                        messageList.innerHTML += createEnhancedMessageBubbleHTML(locationMessage, [locationMessage], 0);
                        document.getElementById('messageArea').scrollTop = document.getElementById('messageArea').scrollHeight;
                    }
                    showNotification('Location shared!', 'success');
                    return;
                }

                const chatId = getChatId(currentChatFriend.id);
                const messagesRef = collection(db, "chats", chatId, "messages");

                await addDoc(messagesRef, {
                    ...locationMessage,
                    timestamp: serverTimestamp(),
                    delivered: true,
                    read: false
                });

                showNotification('Location shared!', 'success');

            } catch (error) {
                console.error('Error sharing location:', error);
                showNotification('Failed to share location', 'error');
            }
        };

      function createLocationMessageHTML(message) {
    return `
        <div class="location-message" onclick="openLocationInMap(${message.latitude}, ${message.longitude})">
            <div class="location-preview" style="width: 100%; height: 150px; background: linear-gradient(45deg, #4facfe, #00f2fe); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem;">
                <div style="text-align: center; color: white;">
                    <i class="fas fa-map-marker-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <div>Shared Location</div>
                </div>
            </div>
            <div class="location-info">
                <div class="location-name">📍 Location</div>
                <div class="location-address">${message.latitude.toFixed(6)}, ${message.longitude.toFixed(6)}</div>
            </div>
        </div>
    `;
}

        window.openLocationInMap = function(lat, lng) {
            const url = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}&zoom=15`;
            window.open(url, '_blank');
        };

        // Contact Sharing System
        window.shareContact = function() {
            closeUploadModal();
            
            const modal = document.getElementById('contactSearchModal');
            modal.classList.add('show');
            loadContactsForSharing();
        };

     async function loadContactsForSharing() {
    const resultsEl = document.getElementById('contactSearchResults');
    
    try {
        // In demo mode, show sample contacts
        if (currentAuthUser.uid.startsWith('demo-user')) {
            const sampleContacts = [
                { id: '1', name: 'John Doe', phone: '+1234567890', avatar: generateAvatar('John Doe') },
                { id: '2', name: 'Jane Smith', phone: '+0987654321', avatar: generateAvatar('Jane Smith') },
                { id: '3', name: 'Mike Johnson', phone: '+1122334455', avatar: generateAvatar('Mike Johnson') }
            ];
            
            displayContactSearchResults(sampleContacts);
            return;
        }
        
        // For real users, check if contacts collection exists first
        try {
            const contactsRef = collection(db, "users", currentAuthUser.uid, "contacts");
            const querySnapshot = await getDocs(contactsRef);
            
            const contacts = [];
            querySnapshot.forEach(doc => {
                contacts.push({ id: doc.id, ...doc.data() });
            });
            
            if (contacts.length === 0) {
                // Create sample contacts if none exist
                const sampleContacts = [
                    { id: 'sample1', name: 'Support Team', phone: '+1-800-SUPPORT', avatar: generateAvatar('Support Team') }
                ];
                displayContactSearchResults(sampleContacts);
            } else {
                displayContactSearchResults(contacts);
            }
            
        } catch (firestoreError) {
            console.log('No contacts collection found, showing default contacts');
            // Show default contacts if collection doesn't exist
            const defaultContacts = [
                { id: 'default1', name: 'Andrew Cares Support', phone: '+1-800-ANDREW', avatar: generateAvatar('Andrew Cares Support') }
            ];
            displayContactSearchResults(defaultContacts);
        }
        
    } catch (error) {
        console.error('Error loading contacts:', error);
        resultsEl.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--text-secondary);">Error loading contacts</p>';
    }
}


        function displayContactSearchResults(contacts) {
            const resultsEl = document.getElementById('contactSearchResults');
            
            if (contacts.length === 0) {
                resultsEl.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--text-secondary);">No contacts found</p>';
                return;
            }
            
            resultsEl.innerHTML = contacts.map(contact => `
                <div class="contact-search-item" onclick="shareSelectedContact('${contact.id}', '${escapeHtml(contact.name)}', '${contact.phone}', '${contact.avatar}')">
                    <img src="${contact.avatar}" alt="${escapeHtml(contact.name)}" class="contact-search-avatar">
                    <div class="contact-search-details">
                        <div class="contact-search-name">${escapeHtml(contact.name)}</div>
                        <div class="contact-search-phone">${contact.phone}</div>
                    </div>
                </div>
            `).join('');
        }

        window.shareSelectedContact = async function(contactId, name, phone, avatar) {
            if (!currentChatFriend) return;

            closeContactSearchModal();

            const contactMessage = {
                type: 'contact',
                contactId: contactId,
                contactName: name,
                contactPhone: phone,
                contactAvatar: avatar,
                senderId: currentAuthUser.uid,
                timestamp: { seconds: Date.now() / 1000 }
            };

            try {
                if (currentAuthUser.uid.startsWith('demo-user')) {
                    const messageList = document.getElementById('messageList');
                    if (messageList) {
                        messageList.innerHTML += createEnhancedMessageBubbleHTML(contactMessage, [contactMessage], 0);
                        document.getElementById('messageArea').scrollTop = document.getElementById('messageArea').scrollHeight;
                    }
                    showNotification('Contact shared!', 'success');
                    return;
                }

                const chatId = getChatId(currentChatFriend.id);
                const messagesRef = collection(db, "chats", chatId, "messages");

                await addDoc(messagesRef, {
                    ...contactMessage,
                    timestamp: serverTimestamp(),
                    delivered: true,
                    read: false
                });

                showNotification('Contact shared!', 'success');

            } catch (error) {
                console.error('Error sharing contact:', error);
                showNotification('Failed to share contact', 'error');
            }
        };

        window.closeContactSearchModal = function() {
            document.getElementById('contactSearchModal').classList.remove('show');
        };

        function createContactCardHTML(message) {
            return `
                <div class="contact-card" onclick="addContactFromCard('${message.contactId}', '${escapeHtml(message.contactName)}', '${message.contactPhone}')">
                    <div class="contact-header">
                        <img src="${message.contactAvatar}" alt="${escapeHtml(message.contactName)}" class="contact-avatar">
                        <div>
                            <div class="contact-name">${escapeHtml(message.contactName)}</div>
                            <div class="contact-phone">${message.contactPhone}</div>
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="contact-action-btn">Add Contact</button>
                        <button class="contact-action-btn">Message</button>
                    </div>
                </div>
            `;
        }

        window.addContactFromCard = function(contactId, name, phone) {
            showNotification(`Would add ${name} to contacts`, 'info');
        };

        // PDF Preview System using PDF.js
        function createPDFPreviewHTML(message) {
            return `
                <div class="pdf-preview" onclick="openPDFViewer('${message.fileUrl}', '${escapeHtml(message.fileName)}')">
                    <div class="pdf-preview-header">
                        <div class="pdf-preview-title">${escapeHtml(message.fileName)}</div>
                        <div class="pdf-preview-pages">${message.pageCount || '?'} pages</div>
                    </div>
                    <div class="pdf-preview-canvas" id="pdf-canvas-${message.id}">
                        <i class="fas fa-file-pdf" style="font-size: 3rem; color: var(--danger-color);"></i>
                    </div>
                </div>
            `;
        }

        window.openPDFViewer = function(pdfUrl, fileName) {
            if (currentAuthUser.uid.startsWith('demo-user') || pdfUrl === '#') {
                showNotification('PDF viewer would open in real app', 'info');
                return;
            }
            
            // Open PDF in new tab for now - full viewer could be implemented
            window.open(pdfUrl, '_blank');
        };

        // Enhanced Emoji System
        window.showEmojiPicker = function() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('show');
        };

        window.closeEmojiPicker = function() {
            document.getElementById('emojiPicker').classList.remove('show');
        };

        window.insertEmoji = function(emoji) {
            const messageInput = document.getElementById('messageInput');
            const cursorPos = messageInput.selectionStart;
            const textBefore = messageInput.value.substring(0, cursorPos);
            const textAfter = messageInput.value.substring(messageInput.selectionEnd);
            
            messageInput.value = textBefore + emoji + textAfter;
            messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
            messageInput.focus();
            
            // Trigger input event to update send button state
            messageInput.dispatchEvent(new Event('input'));
            
            closeEmojiPicker();
        };

        // Message Forwarding System
        window.forwardMessage = function(messageId) {
            closeMessageContextMenu();
            
            const modal = document.getElementById('forwardModal');
            modal.classList.add('show');
            
            // Load friends for forwarding
            loadFriendsForForwarding();
        };

        async function loadFriendsForForwarding() {
            const resultsEl = document.getElementById('forwardSearchResults');
            
            const friendsList = Array.from(friends.values());
            
            if (friendsList.length === 0) {
                resultsEl.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--text-secondary);">No friends to forward to</p>';
                return;
            }
            
            resultsEl.innerHTML = friendsList.map(friend => `
                <div class="contact-search-item" onclick="forwardMessageToFriend('${friend.id}')">
                    <img src="${friend.avatarUrl || generateAvatar(friend.name)}" alt="${escapeHtml(friend.name)}" class="contact-search-avatar">
                    <div class="contact-search-details">
                        <div class="contact-search-name">${escapeHtml(friend.name)}</div>
                        <div class="contact-search-phone">Forward message</div>
                    </div>
                </div>
            `).join('');
        }

        window.forwardMessageToFriend = function(friendId) {
            closeForwardModal();
            showNotification('Message forwarded!', 'success');
            
            // In real app, this would copy the message to the new chat
        };

        window.closeForwardModal = function() {
            document.getElementById('forwardModal').classList.remove('show');
        };

        // Message Deletion System
        window.showDeleteModal = function(messageId) {
            closeMessageContextMenu();
            
            // Store message ID for deletion
            window.pendingDeleteMessageId = messageId;
            
            const modal = document.getElementById('deleteModal');
            modal.classList.add('show');
        };

        window.closeDeleteModal = function() {
            document.getElementById('deleteModal').classList.remove('show');
            window.pendingDeleteMessageId = null;
        };

        window.deleteMessageForMe = async function() {
            const messageId = window.pendingDeleteMessageId;
            if (!messageId) return;

            try {
                // Remove from UI immediately
                const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageEl) {
                    messageEl.remove();
                }

                if (!currentAuthUser.uid.startsWith('demo-user')) {
                    // Mark as deleted in Firebase (for current user only)
                    const chatId = getChatId(currentChatFriend.id);
                    const messageRef = doc(db, "chats", chatId, "messages", messageId);
                    await updateDoc(messageRef, {
                        [`deletedFor.${currentAuthUser.uid}`]: true
                    });
                }

                showNotification('Message deleted', 'success');
                
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Could not delete message', 'error');
            } finally {
                closeDeleteModal();
            }
        };

        window.deleteMessageForEveryone = async function() {
            const messageId = window.pendingDeleteMessageId;
            if (!messageId) return;

            try {
                // Remove from UI immediately
                const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageEl) {
                    messageEl.innerHTML = '<div class="message-content" style="font-style: italic; color: var(--text-muted);">This message was deleted</div>';
                    messageEl.classList.add('deleted');
                }

                if (!currentAuthUser.uid.startsWith('demo-user')) {
                    // Delete completely from Firebase
                    const chatId = getChatId(currentChatFriend.id);
                    const messageRef = doc(db, "chats", chatId, "messages", messageId);
                    await deleteDoc(messageRef);
                }

                showNotification('Message deleted for everyone', 'success');
                
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Could not delete message', 'error');
            } finally {
                closeDeleteModal();
            }
        };

        // Chat Wallpaper System
        window.showChatMenu = function(friendId) {
            const menu = document.createElement('div');
            menu.className = 'message-context-menu show';
            menu.innerHTML = `
                <div class="context-menu-item" onclick="showWallpaperSelector()">
                    <i class="fas fa-image"></i>
                    Change Wallpaper
                </div>
                <div class="context-menu-item" onclick="exportChat()">
                    <i class="fas fa-download"></i>
                    Export Chat
                </div>
                <div class="context-menu-item" onclick="clearChatHistory()">
                    <i class="fas fa-trash"></i>
                    Clear History
                </div>
            `;
            
            menu.style.position = 'fixed';
            menu.style.top = '100px';
            menu.style.right = '20px';
            menu.style.zIndex = '1000';
            
            document.body.appendChild(menu);
            
            setTimeout(() => {
                document.addEventListener('click', function cleanup() {
                    menu.remove();
                    document.removeEventListener('click', cleanup);
                });
            }, 100);
        };

        window.showWallpaperSelector = function() {
            document.getElementById('wallpaperSelector').classList.add('show');
        };

        window.closeWallpaperSelector = function() {
            document.getElementById('wallpaperSelector').classList.remove('show');
        };

        window.selectWallpaper = function(wallpaper) {
            document.querySelectorAll('.wallpaper-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-wallpaper="${wallpaper}"]`).classList.add('selected');
            currentWallpaper = wallpaper;
        };

        window.applyWallpaper = function() {
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return;

            const wallpapers = {
                none: 'none',
                bubbles: 'linear-gradient(45deg, #667eea, #764ba2)',
                geometric: 'linear-gradient(45deg, #f093fb, #f5576c)',
                nature: 'linear-gradient(45deg, #4facfe, #00f2fe)',
                dark: 'linear-gradient(45deg, #2c3e50, #34495e)',
                sunset: 'linear-gradient(45deg, #ff9a9e, #fecfef)'
            };

            if (currentWallpaper === 'none') {
                messageArea.style.backgroundImage = 'none';
                messageArea.style.backgroundColor = 'var(--whatsapp-gray)';
            } else {
                messageArea.style.backgroundImage = wallpapers[currentWallpaper];
                messageArea.style.backgroundColor = 'transparent';
            }

            // Save preference
            localStorage.setItem('chatWallpaper', currentWallpaper);
            
            closeWallpaperSelector();
            showNotification('Wallpaper applied!', 'success');
        };

        function loadStoredWallpaper() {
            const stored = localStorage.getItem('chatWallpaper') || 'none';
            currentWallpaper = stored;
            
            // Apply immediately
            setTimeout(() => {
                const event = { target: { dataset: { wallpaper: stored } } };
                selectWallpaper(stored);
                applyWallpaper();
            }, 500);
        }

        // Message Scheduling System
        window.scheduleMessage = function() {
            const scheduleModal = document.getElementById('scheduleModal');
            const messageInput = document.getElementById('scheduleMessage');
            const dateInput = document.getElementById('scheduleDate');
            const timeInput = document.getElementById('scheduleTime');
            
            const text = messageInput.value.trim();
            const date = dateInput.value;
            const time = timeInput.value;
            
            if (!text || !date || !time) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            const scheduledDateTime = new Date(`${date}T${time}`);
            const now = new Date();
            
            if (scheduledDateTime <= now) {
                showNotification('Please select a future date and time', 'warning');
                return;
            }
            
            // In a real app, you'd save this to a scheduled messages collection
            showNotification(`Message scheduled for ${scheduledDateTime.toLocaleString()}`, 'success');
            closeScheduleModal();
            
            // Clear form
            messageInput.value = '';
            dateInput.value = '';
            timeInput.value = '';
        };

        window.closeScheduleModal = function() {
            document.getElementById('scheduleModal').classList.remove('show');
        };

        // Utility Functions
        function getChatId(friendId) {
            return currentAuthUser.uid < friendId
                ? `${currentAuthUser.uid}_${friendId}`
                : `${friendId}_${currentAuthUser.uid}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatMessageTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp.seconds * 1000);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            if (messageDate.getTime() === today.getTime()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function formatDateSeparator(dateKey) {
            const date = new Date(dateKey);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            if (messageDate.getTime() === today.getTime()) {
                return 'Today';
            } else if (messageDate.getTime() === yesterday.getTime()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString([], { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        }

        function groupMessagesByDate(messages) {
            const grouped = new Map();
            
            messages.forEach(message => {
                if (!message.timestamp) return;
                
                const date = new Date(message.timestamp.seconds * 1000);
                const dateKey = new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
                
                if (!grouped.has(dateKey)) {
                    grouped.set(dateKey, []);
                }
                grouped.get(dateKey).push(message);
            });
            
            return grouped;
        }

        function createStatusIconHTML(message) {
            if (message.read) {
                return '<i class="fas fa-check-double message-status-icon read" title="Read"></i>';
            } else if (message.delivered) {
                return '<i class="fas fa-check-double message-status-icon delivered" title="Delivered"></i>';
            } else {
                return '<i class="fas fa-check message-status-icon" title="Sent"></i>';
            }
        }

        function createTypingIndicatorHTML() {
            return `
                <div class="typing-indicator-bubble">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span style="font-size: 0.875rem; color: var(--text-secondary); margin-left: 0.5rem;">${escapeHtml(currentChatFriend?.name)} is typing...</span>
                </div>
            `;
        }

        function getEmptyStateHTML() {
            return `
                <div style="text-align: center; padding: 3rem 2rem; color: var(--text-secondary);">
                    <i class="fas fa-comment" style="font-size: 3rem; margin-bottom: 1.5rem; opacity: 0.3; color: var(--text-muted);"></i>
                    <h3 style="font-size: 1.25rem; margin-bottom: 0.75rem; color: var(--text-primary);">Start the conversation</h3>
                    <p style="line-height: 1.6;">Send the first message to ${escapeHtml(currentChatFriend?.name || 'your friend')}</p>
                </div>
            `;
        }

        function showErrorState() {
            const messageList = document.getElementById('messageList');
            if (messageList) {
                messageList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--danger-color);">Error loading messages. Please refresh.</div>';
            }
        }

       function setupImageLazyLoading() {
    const images = document.querySelectorAll('.message-image');
    
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                    }
                    img.classList.remove('lazy-image');
                    imageObserver.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px'
        });
        
        images.forEach(img => {
            if (img.getAttribute('loading') === 'lazy') {
                imageObserver.observe(img);
            }
        });
    } else {
        // Fallback for browsers without IntersectionObserver
        images.forEach(img => {
            if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
            }
            img.classList.remove('lazy-image');
        });
    }
}
            

        function setupVoiceMessagePlayers() {
            const voiceMessages = document.querySelectorAll('.voice-message[data-voice-url]');
            voiceMessages.forEach(vm => {
                const messageId = vm.dataset.messageId;
                const voiceUrl = vm.dataset.voiceUrl;
                
                // Setup click handlers are already in the HTML via onclick
            });
        }

        // Enhanced Typing Indicator
        function handleTypingIndicator() {
            if (!currentChatFriend || currentAuthUser.uid.startsWith('demo-user')) return;

            if (!isTyping) {
                isTyping = true;
                updateTypingStatus(currentChatFriend.id, true);
            }

            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }

            typingTimeout = setTimeout(() => {
                isTyping = false;
                updateTypingStatus(currentChatFriend.id, false);
            }, 1000);
        }

        async function updateTypingStatus(friendId, isTypingNow) {
            if (currentAuthUser.uid.startsWith('demo-user')) {
                console.log(`Demo: Typing status for ${friendId}: ${isTypingNow}`);
                return;
            }

            try {
                const chatId = getChatId(friendId);
                const typingRef = doc(db, "chats", chatId, "typing", currentAuthUser.uid);
                
                if (isTypingNow) {
                    await setDoc(typingRef, {
                        userId: currentAuthUser.uid,
                        userName: currentAuthUser.displayName || 'User',
                        timestamp: serverTimestamp(),
                        isTyping: true
                    });
                } else {
                    await deleteDoc(typingRef);
                }
            } catch (error) {
                console.error('Error updating typing status:', error);
            }
        }

        // Listen for typing indicators from other users
        function listenForTypingIndicators(friendId) {
            if (currentAuthUser.uid.startsWith('demo-user')) return;

            const chatId = getChatId(friendId);
            const typingRef = collection(db, "chats", chatId, "typing");
            
            return onSnapshot(typingRef, (snapshot) => {
                const typingUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId !== currentAuthUser.uid) {
                        typingUsers.push(data);
                    }
                });

                updateTypingIndicatorUI(typingUsers);
            });
        }

        function updateTypingIndicatorUI(typingUsers) {
            const messageList = document.getElementById('messageList');
            const existingIndicator = document.querySelector('.typing-indicator-bubble');
            
            if (existingIndicator) {
                existingIndicator.remove();
            }

            if (typingUsers.length > 0) {
                const indicator = document.createElement('div');
                indicator.className = 'message-bubble received typing-indicator-bubble';
                indicator.innerHTML = createTypingIndicatorHTML();
                messageList.appendChild(indicator);
                
                // Auto-scroll to show typing indicator
                document.getElementById('messageArea').scrollTop = document.getElementById('messageArea').scrollHeight;
            }
        }

        // Enhanced Online Status System
        async function updateOnlineStatus(isOnline) {
            if (currentAuthUser.uid.startsWith('demo-user')) return;

            try {
                const userRef = doc(db, "users", currentAuthUser.uid);
                await updateDoc(userRef, {
                    isOnline: isOnline,
                    lastSeen: serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating online status:', error);
            }
        }

        // Group Chat Functionality
        window.createGroupChat = function() {
            const modal = document.getElementById('createGroupModal');
            if (!modal) {
                // Create group chat modal if it doesn't exist
                createGroupChatModal();
            }
            document.getElementById('createGroupModal').classList.add('show');
            loadFriendsForGroup();
        };

        function createGroupChatModal() {
            const modalHTML = `
                <div id="createGroupModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Create Group Chat</h3>
                            <button class="modal-close" onclick="closeCreateGroupModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="groupName">Group Name</label>
                                <input type="text" id="groupName" placeholder="Enter group name" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="groupDescription">Description (Optional)</label>
                                <textarea id="groupDescription" placeholder="Enter group description" maxlength="200"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Select Members</label>
                                <div id="groupMembersList" class="group-members-list"></div>
                            </div>
                            <div class="selected-members" id="selectedMembers"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeCreateGroupModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="createGroup()">Create Group</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        async function loadFriendsForGroup() {
            const membersList = document.getElementById('groupMembersList');
            const friendsList = Array.from(friends.values());
            
            if (friendsList.length === 0) {
                membersList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No friends available</p>';
                return;
            }

            membersList.innerHTML = friendsList.map(friend => `
                <div class="group-member-item" onclick="toggleGroupMember('${friend.id}', '${escapeHtml(friend.name)}', '${friend.avatarUrl || generateAvatar(friend.name)}')">
                    <input type="checkbox" id="member-${friend.id}" class="member-checkbox">
                    <img src="${friend.avatarUrl || generateAvatar(friend.name)}" alt="${escapeHtml(friend.name)}" class="member-avatar">
                    <div class="member-info">
                        <div class="member-name">${escapeHtml(friend.name)}</div>
                        <div class="member-status">${friend.isOnline ? 'Online' : 'Offline'}</div>
                    </div>
                </div>
            `).join('');
        }

        let selectedGroupMembers = new Set();

        window.toggleGroupMember = function(memberId, memberName, memberAvatar) {
            const checkbox = document.getElementById(`member-${memberId}`);
            const selectedContainer = document.getElementById('selectedMembers');
            
            if (selectedGroupMembers.has(memberId)) {
                selectedGroupMembers.delete(memberId);
                checkbox.checked = false;
                document.getElementById(`selected-${memberId}`)?.remove();
            } else {
                selectedGroupMembers.add(memberId);
                checkbox.checked = true;
                
                const selectedMemberHTML = `
                    <div class="selected-member" id="selected-${memberId}">
                        <img src="${memberAvatar}" alt="${escapeHtml(memberName)}" class="selected-member-avatar">
                        <span class="selected-member-name">${escapeHtml(memberName)}</span>
                        <button class="remove-member" onclick="toggleGroupMember('${memberId}', '${escapeHtml(memberName)}', '${memberAvatar}')">&times;</button>
                    </div>
                `;
                selectedContainer.insertAdjacentHTML('beforeend', selectedMemberHTML);
            }
        };

        window.createGroup = async function() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupDescription = document.getElementById('groupDescription').value.trim();
            
            if (!groupName) {
                showNotification('Please enter a group name', 'warning');
                return;
            }
            
            if (selectedGroupMembers.size === 0) {
                showNotification('Please select at least one member', 'warning');
                return;
            }

            try {
                const groupId = `group_${Date.now()}_${currentAuthUser.uid}`;
                const participants = [currentAuthUser.uid, ...Array.from(selectedGroupMembers)];
                
                const groupData = {
                    id: groupId,
                    name: groupName,
                    description: groupDescription,
                    type: 'group',
                    participants: participants,
                    admins: [currentAuthUser.uid],
                    createdBy: currentAuthUser.uid,
                    createdAt: serverTimestamp(),
                    lastMessage: null,
                    lastMessageTime: serverTimestamp(),
                    avatar: generateGroupAvatar(groupName),
                    settings: {
                        allowMembersToAddOthers: false,
                        allowMembersToEditInfo: false,
                        disappearingMessages: false
                    }
                };

                if (currentAuthUser.uid.startsWith('demo-user')) {
                    // Demo mode - add to local friends list
                    friends.set(groupId, {
                        id: groupId,
                        name: groupName,
                        avatarUrl: generateGroupAvatar(groupName),
                        isOnline: true,
                        isGroup: true,
                        participants: participants.length
                    });
                    
                    renderConversationList();
                    showNotification('Group created successfully!', 'success');
                } else {
                    // Real Firebase creation
                    const chatRef = doc(db, "chats", groupId);
                    await setDoc(chatRef, groupData);
                    
                    // Add system message about group creation
                    const messagesRef = collection(db, "chats", groupId, "messages");
                    await addDoc(messagesRef, {
                        type: 'system',
                        content: `${currentAuthUser.displayName || 'User'} created the group "${groupName}"`,
                        timestamp: serverTimestamp(),
                        senderId: 'system'
                    });

                    showNotification('Group created successfully!', 'success');
                }
                
                closeCreateGroupModal();
                
            } catch (error) {
                console.error('Error creating group:', error);
                showNotification('Failed to create group', 'error');
            }
        };

        window.closeCreateGroupModal = function() {
            document.getElementById('createGroupModal').classList.remove('show');
            selectedGroupMembers.clear();
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
            document.getElementById('selectedMembers').innerHTML = '';
        };

        function generateGroupAvatar(groupName) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            const color = colors[groupName.length % colors.length];
            const initials = groupName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            
            return `data:image/svg+xml,${encodeURIComponent(`
                <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${color}"/>
                    <text x="20" y="26" font-family="Arial, sans-serif" font-size="14" font-weight="bold" 
                          text-anchor="middle" fill="white">${initials}</text>
                </svg>
            `)}`;
        }

        // Group Management Functions
        window.showGroupInfo = function(groupId) {
            if (currentAuthUser.uid.startsWith('demo-user')) {
                showNotification('Group info would show member list, settings, etc.', 'info');
                return;
            }
            
            // Load and display group information
            loadGroupInfo(groupId);
        };

        async function loadGroupInfo(groupId) {
            try {
                const chatRef = doc(db, "chats", groupId);
                const chatDoc = await getDoc(chatRef);
                
                if (chatDoc.exists()) {
                    const groupData = chatDoc.data();
                    displayGroupInfoModal(groupData);
                }
            } catch (error) {
                console.error('Error loading group info:', error);
                showNotification('Could not load group information', 'error');
            }
        }

        function displayGroupInfoModal(groupData) {
            const modalHTML = `
                <div id="groupInfoModal" class="modal show">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Group Information</h3>
                            <button class="modal-close" onclick="closeGroupInfoModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="group-info-header">
                                <img src="${groupData.avatar}" alt="${escapeHtml(groupData.name)}" class="group-info-avatar">
                                <div class="group-info-details">
                                    <h4>${escapeHtml(groupData.name)}</h4>
                                    <p>${groupData.participants.length} members</p>
                                    ${groupData.description ? `<p class="group-description">${escapeHtml(groupData.description)}</p>` : ''}
                                </div>
                            </div>
                            <div class="group-actions">
                                ${groupData.admins.includes(currentAuthUser.uid) ? `
                                    <button class="btn btn-primary" onclick="editGroupInfo('${groupData.id}')">Edit Group</button>
                                    <button class="btn btn-secondary" onclick="addGroupMembers('${groupData.id}')">Add Members</button>
                                ` : ''}
                                <button class="btn btn-danger" onclick="leaveGroup('${groupData.id}')">Leave Group</button>
                            </div>
                            <div class="group-members-section">
                                <h5>Members</h5>
                                <div id="groupMembersDisplay"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            loadGroupMembers(groupData.participants, groupData.admins);
        }

        async function loadGroupMembers(participantIds, adminIds) {
            const membersContainer = document.getElementById('groupMembersDisplay');
            
            try {
                const memberPromises = participantIds.map(async (userId) => {
                    if (currentAuthUser.uid.startsWith('demo-user')) {
                        return {
                            id: userId,
                            name: userId === currentAuthUser.uid ? 'You' : `User ${userId.substring(0, 8)}`,
                            avatar: generateAvatar(`User ${userId}`),
                            isAdmin: adminIds.includes(userId)
                        };
                    }
                    
                    const userRef = doc(db, "users", userId);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        return {
                            id: userId,
                            name: userData.displayName || userData.name || 'Unknown User',
                            avatar: userData.photoURL || generateAvatar(userData.displayName || 'User'),
                            isAdmin: adminIds.includes(userId)
                        };
                    }
                    return null;
                });

                const members = (await Promise.all(memberPromises)).filter(Boolean);
                
                membersContainer.innerHTML = members.map(member => `
                    <div class="group-member-display">
                        <img src="${member.avatar}" alt="${escapeHtml(member.name)}" class="member-display-avatar">
                        <div class="member-display-info">
                            <div class="member-display-name">${escapeHtml(member.name)}</div>
                            ${member.isAdmin ? '<div class="member-role">Admin</div>' : ''}
                        </div>
                        ${member.id !== currentAuthUser.uid && adminIds.includes(currentAuthUser.uid) ? `
                            <button class="btn btn-sm btn-danger" onclick="removeGroupMember('${member.id}')">Remove</button>
                        ` : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading group members:', error);
                membersContainer.innerHTML = '<p>Error loading members</p>';
            }
        }

        window.closeGroupInfoModal = function() {
            document.getElementById('groupInfoModal')?.remove();
        };

        window.leaveGroup = async function(groupId) {
            if (!confirm('Are you sure you want to leave this group?')) return;
            
            try {
                if (currentAuthUser.uid.startsWith('demo-user')) {
                    friends.delete(groupId);
                    renderConversationList();
                    showNotification('Left the group', 'success');
                    closeGroupInfoModal();
                    return;
                }

                const chatRef = doc(db, "chats", groupId);
                const chatDoc = await getDoc(chatRef);
                
                if (chatDoc.exists()) {
                    const groupData = chatDoc.data();
                    const updatedParticipants = groupData.participants.filter(id => id !== currentAuthUser.uid);
                    
                    await updateDoc(chatRef, {
                        participants: updatedParticipants
                    });
                    
                    // Add system message
                    const messagesRef = collection(db, "chats", groupId, "messages");
                    await addDoc(messagesRef, {
                        type: 'system',
                        content: `${currentAuthUser.displayName || 'User'} left the group`,
                        timestamp: serverTimestamp(),
                        senderId: 'system'
                    });
                }
                
                showNotification('Left the group', 'success');
                closeGroupInfoModal();
                
            } catch (error) {
                console.error('Error leaving group:', error);
                showNotification('Could not leave group', 'error');
            }
        };

        // Listen for online status changes
        function listenForOnlineStatus() {
            if (currentAuthUser.uid.startsWith('demo-user')) return;

            const friendIds = Array.from(friends.keys());
            friendIds.forEach(friendId => {
                const userRef = doc(db, "users", friendId);
                onSnapshot(userRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        updateFriendOnlineStatus(friendId, data.isOnline, data.lastSeen);
                    }
                });
            });
        }

        function updateFriendOnlineStatus(friendId, isOnline, lastSeen) {
            const conversationItem = document.querySelector(`[data-friend-id="${friendId}"]`);
            if (conversationItem) {
                const statusIndicator = conversationItem.querySelector('.online-indicator');
                if (statusIndicator) {
                    statusIndicator.classList.toggle('online', isOnline);
                    
                    if (!isOnline && lastSeen) {
                        const lastSeenTime = new Date(lastSeen.seconds * 1000);
                        const now = new Date();
                        const diffMinutes = Math.floor((now - lastSeenTime) / (1000 * 60));
                        
                        let statusText = 'Offline';
                        if (diffMinutes < 1) {
                            statusText = 'Just now';
                        } else if (diffMinutes < 60) {
                            statusText = `${diffMinutes}m ago`;
                        } else if (diffMinutes < 1440) {
                            statusText = `${Math.floor(diffMinutes / 60)}h ago`;
                        } else {
                            statusText = `${Math.floor(diffMinutes / 1440)}d ago`;
                        }
                        
                        statusIndicator.title = `Last seen ${statusText}`;
                    } else {
                        statusIndicator.title = 'Online';
                    }
                }
            }

            // Update chat header if this is the current chat
            if (currentChatFriend && currentChatFriend.id === friendId) {
                const chatStatus = document.querySelector('.chat-header .friend-status');
                if (chatStatus) {
                    chatStatus.textContent = isOnline ? 'Online' : 'Offline';
                    chatStatus.style.color = isOnline ? 'var(--success-color)' : 'var(--text-secondary)';
                }
            }
        }

        // Enhanced Read Receipts System
        async function markMessagesAsRead(messages) {
            if (currentAuthUser.uid.startsWith('demo-user')) return;

            const unreadMessages = messages.filter(msg => 
                msg.senderId !== currentAuthUser.uid && !msg.read
            );

            if (unreadMessages.length === 0) return;

            try {
                const chatId = getChatId(currentChatFriend.id);
                const batch = writeBatch(db);

                unreadMessages.forEach(message => {
                    const messageRef = doc(db, "chats", chatId, "messages", message.id);
                    batch.update(messageRef, {
                        read: true,
                        readAt: serverTimestamp(),
                        readBy: currentAuthUser.uid
                    });
                });

                await batch.commit();
                console.log(`Marked ${unreadMessages.length} messages as read`);
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        // Listen for read receipt updates
        function listenForReadReceipts(friendId) {
            if (currentAuthUser.uid.startsWith('demo-user')) return;

            const chatId = getChatId(friendId);
            const messagesRef = collection(db, "chats", chatId, "messages");
            const q = query(
                messagesRef,
                where("senderId", "==", currentAuthUser.uid),
                where("read", "==", true),
                orderBy("timestamp", "desc"),
                limit(10)
            );

            return onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "modified") {
                        const messageData = change.doc.data();
                        updateMessageReadStatus(change.doc.id, messageData.read, messageData.readAt);
                    }
                });
            });
        }

        function updateMessageReadStatus(messageId, isRead, readAt) {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
                const statusIcon = messageEl.querySelector('.message-status-icon');
                if (statusIcon && isRead) {
                    statusIcon.className = 'fas fa-check-double message-status-icon read';
                    statusIcon.title = `Read at ${new Date(readAt.seconds * 1000).toLocaleTimeString()}`;
                }
            }
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Cache Management
        async function cacheMessages(chatId, messages) {
            if (!dbCache) return;
            
            try {
                const transaction = dbCache.transaction(['messages'], 'readwrite');
                const store = transaction.objectStore('messages');
                
                messages.forEach(message => {
                    store.put({ ...message, chatId });
                });
                
            } catch (error) {
                console.error('Error caching messages:', error);
            }
        }

        async function loadMessagesFromCache(chatId) {
            if (!dbCache) return [];
            
            try {
                const transaction = dbCache.transaction(['messages'], 'readonly');
                const store = transaction.objectStore('messages');
                const index = store.index('chatId');
                const request = index.getAll(chatId);
                
                return new Promise((resolve) => {
                    request.onsuccess = () => {
                        resolve(request.result || []);
                    };
                    request.onerror = () => {
                        resolve([]);
                    };
                });
                
            } catch (error) {
                console.error('Error loading cached messages:', error);
                return [];
            }
        }

        // Load Older Messages (Pagination)
        async function loadOlderMessages() {
            if (!currentChatFriend || isLoadingMessages) return;
            
            isLoadingMessages = true;
            
            try {
                const chatId = getChatId(currentChatFriend.id);
                const messagesRef = collection(db, "chats", chatId, "messages");
                
                let q;
                if (lastVisibleMessage) {
                    q = query(
                        messagesRef, 
                        orderBy("timestamp", "desc"), 
                        startAfter(lastVisibleMessage),
                        limit(20)
                    );
                } else {
                    q = query(messagesRef, orderBy("timestamp", "desc"));
                }
                
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const olderMessages = [];
                    querySnapshot.forEach(doc => {
                        olderMessages.push({ id: doc.id, ...doc.data() });
                        lastVisibleMessage = doc;
                    });
                    
                    olderMessages.reverse();
                    
                    // Prepend to existing messages
                    const messageList = document.getElementById('messageList');
                    const existingContent = messageList.innerHTML;
                    
                    let olderHTML = '';
                    const groupedOlder = groupMessagesByDate(olderMessages);
                    
                    for (const [dateKey, dayMessages] of groupedOlder.entries()) {
                        olderHTML += `
                            <div class="date-separator">
                                <span>${formatDateSeparator(dateKey)}</span>
                            </div>
                        `;
                        
                        dayMessages.forEach((message, index) => {
                            olderHTML += createEnhancedMessageBubbleHTML(message, dayMessages, index);
                        });
                    }
                    
                    messageList.innerHTML = olderHTML + existingContent;
                    
                    showNotification(`Loaded ${olderMessages.length} older messages`, 'info');
                } else {
                    showNotification('No more messages to load', 'info');
                }
                
            } catch (error) {
                console.error('Error loading older messages:', error);
                showNotification('Could not load older messages', 'error');
            } finally {
                isLoadingMessages = false;
            }
        }

        // Link Preview Generation
        async function generateLinkPreview(messageId, text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = text.match(urlRegex);
            
            if (!urls || urls.length === 0) return;
            
            try {
                // In a real app, you'd use a service like Link Preview API
                // For demo, we'll create a mock preview
                const url = urls[0];
                const domain = new URL(url).hostname;
                
                const mockPreview = {
                    url: url,
                    title: `Preview for ${domain}`,
                    description: 'This is a mock link preview. In a real app, this would show actual page content.',
                    image: 'https://via.placeholder.com/400x200?text=Link+Preview',
                    domain: domain
                };
                
                // Update the message with preview
                setTimeout(() => {
                    const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageEl) {
                        const content = messageEl.querySelector('.message-content');
                        content.insertAdjacentHTML('afterend', createLinkPreviewHTML(mockPreview));
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error generating link preview:', error);
            }
        }

        function createLinkPreviewHTML(preview) {
            return `
                <div class="link-preview" onclick="openLink('${preview.url}')">
                    <img src="${preview.image}" alt="Link preview" class="link-preview-image">
                    <div class="link-preview-content">
                        <div class="link-preview-title">${escapeHtml(preview.title)}</div>
                        <div class="link-preview-description">${escapeHtml(preview.description)}</div>
                        <div class="link-preview-domain">${escapeHtml(preview.domain)}</div>
                    </div>
                </div>
            `;
        }

        window.openLink = function(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
        };

        // Additional Utility Functions
        window.copyMessageText = function(messageId) {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"] .message-content`);
            if (messageEl) {
                navigator.clipboard.writeText(messageEl.textContent).then(() => {
                    showNotification('Message copied to clipboard', 'success');
                }).catch(() => {
                    showNotification('Could not copy message', 'error');
                });
            }
            closeMessageContextMenu();
        };

        window.editMessage = function(messageId) {
            closeMessageContextMenu();
            showNotification('Message editing feature coming soon!', 'info');
        };

        window.showReactionPicker = function(messageId) {
            closeMessageContextMenu();
            
            // Quick reaction with most common emojis
            const quickReactions = ['👍', '❤️', '😊', '😂', '😮', '😢'];
            const reaction = quickReactions[Math.floor(Math.random() * quickReactions.length)];
            
            toggleReaction(messageId, reaction);
        };

        window.exportChat = function() {
            showNotification('Chat export feature coming soon!', 'info');
        };

        window.clearChatHistory = function() {
            showNotification('Clear history feature coming soon!', 'info');
        };

        // Camera Functions
        window.openCamera = async function() {
            closeUploadModal();
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' },
                    audio: false 
                });
                
                const modal = document.getElementById('cameraModal');
                const video = document.getElementById('cameraVideo');
                
                video.srcObject = stream;
                modal.classList.add('show');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                showNotification('Could not access camera', 'error');
            }
        };

        window.closeCamera = function() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            modal.classList.remove('show');
        };

        window.capturePhoto = function() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob((blob) => {
                const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
                handleFileUpload(file);
                closeCamera();
            }, 'image/jpeg', 0.8);
        };

        window.switchCamera = async function() {
            // This would switch between front/back camera
            showNotification('Camera switch feature coming soon!', 'info');
        };

        // Enhanced Notification System
        function showNotification(message, type = 'info', duration = 4000) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const backgrounds = {
                success: 'linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95))',
                error: 'linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95))',
                info: 'linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95))',
                warning: 'linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95))'
            };

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };

            notification.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i> ${message}`;
            
            Object.assign(notification.style, {
                position: 'fixed',
                top: '24px',
                right: '24px',
                padding: '1rem 1.5rem',
                borderRadius: '12px',
                color: 'white',
                fontWeight: '500',
                zIndex: '5000',
                opacity: '0',
                transform: 'translateX(100%) scale(0.95)',
                transition: 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                display: 'flex',
                alignItems: 'center',
                gap: '0.75rem',
                backdropFilter: 'blur(10px)',
                boxShadow: 'var(--shadow-lg)',
                maxWidth: '400px',
                fontSize: '0.9rem',
                background: backgrounds[type] || backgrounds.info
            });
            
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0) scale(1)';
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%) scale(0.95)';
                    setTimeout(() => notification.remove(), 400);
                }, duration);
            }, 100);
        }

        function getDemoResponse(originalMessage) {
            const responses = [
                "That's interesting! 🤔",
                "I see what you mean 👍",
                "Thanks for sharing that 😊",
                "How are you doing today? 😄",
                "That sounds great! 🎉",
                "I'm glad to hear from you 💚",
                "What do you think about that? 🤷‍♂️",
                "Hope you're having a good day! ☀️",
                "Tell me more about it 📝",
                "Really? That's amazing! 😲"
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }



        function updateLastMessage(friendId, text) {
            const conversationItem = document.querySelector(`[data-friend-id="${friendId}"]`);
            if (conversationItem) {
                const lastMessageEl = conversationItem.querySelector('.last-message .message-status');
                if (lastMessageEl) {
                    const preview = text.length > 30 ? text.substring(0, 30) + '...' : text;
                    lastMessageEl.textContent = `You: ${preview}`;
                }
                
                // Move to top of conversation list
                const parent = conversationItem.parentNode;
                parent.insertBefore(conversationItem, parent.firstChild);
            }
        }

        // Voice and Video Call Functions
        window.startVoiceCall = function(friendId) {
            const friend = friends.get(friendId);
            if (!friend) return;

            if (currentAuthUser.uid.startsWith('demo-user')) {
                showNotification(`Voice call would start with ${friend.name}`, 'info');
                return;
            }

            // Use Jitsi Meet for free voice calls
            const roomName = `andrewcares-voice-${currentAuthUser.uid}-${friendId}-${Date.now()}`;
            const jitsiUrl = `https://meet.jit.si/${roomName}#config.startAudioOnly=true`;
            
            window.open(jitsiUrl, '_blank');
            showNotification(`Starting voice call with ${friend.name}`, 'info');
        };

        window.startVideoCall = function(friendId) {
            const friend = friends.get(friendId);
            if (!friend) return;

            if (currentAuthUser.uid.startsWith('demo-user')) {
                showNotification(`Video call would start with ${friend.name}`, 'info');
                return;
            }

            // Use Jitsi Meet for free video calls
            const roomName = `andrewcares-video-${currentAuthUser.uid}-${friendId}-${Date.now()}`;
            const jitsiUrl = `https://meet.jit.si/${roomName}`;
            
            window.open(jitsiUrl, '_blank');
            showNotification(`Starting video call with ${friend.name}`, 'info');
        };

        // File and Media Functions
        window.showUploadModal = function() {
            document.getElementById('uploadModal').classList.add('show');
        };

        window.closeUploadModal = function() {
            document.getElementById('uploadModal').classList.remove('show');
        };

        window.selectFile = function(accept) {
            const input = document.getElementById('fileInput');
            input.accept = accept;
            input.click();
        };

        window.downloadFile = function(fileUrl, fileName) {
            if (fileUrl === '#') {
                showNotification('File download in demo mode', 'info');
                return;
            }
            
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.openImageViewer = function(imageUrl, fileName) {
            const modal = document.getElementById('imageViewerModal');
            const img = document.getElementById('imageViewerImg');
            const info = document.getElementById('imageViewerInfo');
            
            img.src = imageUrl;
            info.textContent = fileName || 'Image';
            modal.classList.add('show');
        };

        window.closeImageViewer = function() {
            document.getElementById('imageViewerModal').classList.remove('show');
        };

        window.downloadImage = function() {
            const img = document.getElementById('imageViewerImg');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = 'image.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Search functionality
        conversationSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const conversationItems = document.querySelectorAll('.conversation-item');
            
            conversationItems.forEach(item => {
                const name = item.querySelector('.convo-name').textContent.toLowerCase();
                const isVisible = name.includes(searchTerm);
                item.style.display = isVisible ? 'flex' : 'none';
            });
        });

        // File input handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        // Logout functionality
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            }).catch(error => {
                console.error('Error signing out:', error);
                showNotification('Error signing out', 'error');
            });
        });

        // Cleanup function
        function cleanup() {
            if (activeChatUnsubscribe) {
                activeChatUnsubscribe();
            }
            if (friendsUnsubscribe) {
                friendsUnsubscribe();
            }
            if (voicePlaybackSystem.currentAudio) {
                voicePlaybackSystem.currentAudio.pause();
            }
            if (recordingState.mediaRecorder && recordingState.isRecording) {
                recordingState.mediaRecorder.stop();
            }
        }

        // Handle browser back button on mobile
        window.addEventListener('popstate', (e) => {
            if (window.innerWidth <= 768 && messagingContainer.classList.contains('show-chat')) {
                e.preventDefault();
                showConversationList();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', cleanup);

        // Global function assignments
        window.sendMessage = sendMessage;

        // Update Header UI Function
        function updateHeaderUI() {
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            
            if (userNameEl && currentAuthUserData) {
                userNameEl.textContent = currentAuthUserData.displayName || currentAuthUserData.name || 'User';
            }
            
            if (userAvatarEl && currentAuthUserData) {
                userAvatarEl.src = currentAuthUserData.photoURL || generateAvatar(currentAuthUserData.displayName || 'User');
            }
            
            // Update online status
            updateOnlineStatus(true);
        }

        // Initialize the application
        console.log('Advanced messaging app with all features initialized');
        
        // Show welcome message in demo mode
        setTimeout(() => {
            if (currentAuthUser && currentAuthUser.uid.startsWith('demo-user')) {
                showNotification('Welcome to the demo! All features are functional.', 'info', 6000);
            }
        }, 2000);
    
    </script>
</body>
</html>