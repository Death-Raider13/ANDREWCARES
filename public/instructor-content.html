<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instructor Content Management - Andrew Cares Village</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #b38b00;
            --color-secondary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .content-card:hover {
            transform: translateY(-5px);
        }

        .btn-primary {
            background: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-primary:hover {
            background: #9a7600;
            border-color: #9a7600;
        }

        .modal-content {
            border-radius: 12px;
        }

        .form-control:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.2rem rgba(179, 139, 0, 0.25);
        }

        .session-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">Content Management</h1>
                    <p class="text-muted mb-0">Manage your courses, quizzes, and resources</p>
                </div>
                <div>
                    <span id="sessionStatus" class="session-status">Loading...</span>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <!-- Courses Card -->
            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-book text-primary me-2"></i>Courses</h3>
                    <button class="btn btn-primary btn-sm" onclick="openCreateModal('course')" id="createCourseBtn">
                        <i class="fas fa-plus"></i> Add Course
                    </button>
                </div>
                <div id="coursesList">
                    <p class="text-muted">Loading courses...</p>
                </div>
            </div>

            <!-- Quizzes Card -->
            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-question-circle text-primary me-2"></i>Quizzes</h3>
                    <button class="btn btn-primary btn-sm" onclick="openCreateModal('quiz')" id="createQuizBtn">
                        <i class="fas fa-plus"></i> Add Quiz
                    </button>
                </div>
                <div id="quizzesList">
                    <p class="text-muted">Loading quizzes...</p>
                </div>
            </div>

            <!-- Resources Card -->
            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-file-alt text-primary me-2"></i>Resources</h3>
                    <button class="btn btn-primary btn-sm" onclick="openCreateModal('resource')" id="createResourceBtn">
                        <i class="fas fa-plus"></i> Add Resource
                    </button>
                </div>
                <div id="resourcesList">
                    <p class="text-muted">Loading resources...</p>
                </div>
            </div>

            <!-- Livestream Card -->
            <div class="content-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-video text-primary me-2"></i>Livestream</h3>
                    <button class="btn btn-primary btn-sm" onclick="openCreateModal('livestream')" id="createLivestreamBtn">
                        <i class="fas fa-plus"></i> Start Stream
                    </button>
                </div>
                <div id="livestreamsList">
                    <p class="text-muted">Loading streams...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Content Modal -->
    <div class="modal fade" id="createContentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="contentForm">
                        <div id="formFields"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveContent()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
            authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
            projectId: "andrew-cares-village-f4cb6",
            storageBucket: "andrew-cares-village-f4cb6.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let currentSession = null;
        let currentContentType = null;

        // Initialize
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadSession();
            } else {
                window.location.href = 'login.html';
            }
        });

        function loadSession() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            
            if (!sessionId) {
                document.getElementById('sessionStatus').innerHTML = 
                    '<span class="status-expired">No Session Selected</span>';
                disableContentCreation();
                return;
            }

            db.collection('bookings').doc(sessionId).get().then(doc => {
                if (doc.exists) {
                    currentSession = { id: doc.id, ...doc.data() };
                    updateSessionStatus();
                    loadContent();
                }
            });
        }

        function updateSessionStatus() {
            const statusEl = document.getElementById('sessionStatus');
            const now = new Date();
            const sessionEnd = currentSession.sessionEnd?.toDate();
            
            if (sessionEnd && now > sessionEnd) {
                statusEl.innerHTML = '<span class="status-expired">Session Expired</span>';
                disableContentCreation();
            } else {
                statusEl.innerHTML = '<span class="status-active">Active Session</span>';
                enableContentCreation();
            }
        }

        function disableContentCreation() {
            ['createCourseBtn', 'createQuizBtn', 'createResourceBtn', 'createLivestreamBtn']
                .forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.disabled = true;
                        btn.title = 'Session expired - cannot create new content';
                    }
                });
        }

        function enableContentCreation() {
            ['createCourseBtn', 'createQuizBtn', 'createResourceBtn', 'createLivestreamBtn']
                .forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.disabled = false;
                        btn.title = '';
                    }
                });
        }

        function loadContent() {
            if (!currentSession) return;

            // Load courses
            db.collection('courses')
                .where('sessionId', '==', currentSession.id)
                .onSnapshot(snapshot => {
                    const coursesList = document.getElementById('coursesList');
                    if (snapshot.empty) {
                        coursesList.innerHTML = '<p class="text-muted">No courses yet</p>';
                        return;
                    }
                    
                    coursesList.innerHTML = '';
                    snapshot.forEach(doc => {
                        const course = doc.data();
                        coursesList.innerHTML += `
                            <div class="border-bottom pb-2 mb-2">
                                <h6>${course.title}</h6>
                                <p class="text-muted small mb-1">${course.description}</p>
                                <small class="text-secondary">${course.createdAt?.toDate().toLocaleDateString()}</small>
                            </div>
                        `;
                    });
                });

            // Load other content types similarly...
        }

        function openCreateModal(type) {
            if (!currentSession) return;
            
            currentContentType = type;
            const modal = new bootstrap.Modal(document.getElementById('createContentModal'));
            
            document.getElementById('modalTitle').textContent = `Create ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = getFormFields(type);
            
            modal.show();
        }

        function getFormFields(type) {
            const commonFields = `
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="contentTitle" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="contentDescription" rows="3"></textarea>
                </div>
            `;

            switch(type) {
                case 'course':
                    return commonFields + `
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea class="form-control" id="courseContent" rows="5"></textarea>
                        </div>
                    `;
                case 'quiz':
                    return commonFields + `
                        <div class="mb-3">
                            <label class="form-label">Questions (JSON format)</label>
                            <textarea class="form-control" id="quizQuestions" rows="5" placeholder='[{"question": "What is...?", "options": ["A", "B", "C"], "correct": 0}]'></textarea>
                        </div>
                    `;
                case 'resource':
                    return commonFields + `
                        <div class="mb-3">
                            <label class="form-label">Resource URL</label>
                            <input type="url" class="form-control" id="resourceUrl">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Resource Type</label>
                            <select class="form-control" id="resourceType">
                                <option value="document">Document</option>
                                <option value="video">Video</option>
                                <option value="link">Link</option>
                            </select>
                        </div>
                    `;
                case 'livestream':
                    return commonFields + `
                        <div class="mb-3">
                            <label class="form-label">Stream URL</label>
                            <input type="url" class="form-control" id="streamUrl">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Scheduled Time</label>
                            <input type="datetime-local" class="form-control" id="streamTime">
                        </div>
                    `;
            }
        }

        function saveContent() {
            if (!currentSession || !currentContentType) return;

            const title = document.getElementById('contentTitle').value;
            const description = document.getElementById('contentDescription').value;

            if (!title) {
                alert('Title is required');
                return;
            }

            const contentData = {
                title,
                description,
                sessionId: currentSession.id,
                instructorId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Add type-specific fields
            switch(currentContentType) {
                case 'course':
                    contentData.content = document.getElementById('courseContent').value;
                    break;
                case 'quiz':
                    try {
                        contentData.questions = JSON.parse(document.getElementById('quizQuestions').value || '[]');
                    } catch (e) {
                        alert('Invalid JSON format for questions');
                        return;
                    }
                    break;
                case 'resource':
                    contentData.url = document.getElementById('resourceUrl').value;
                    contentData.type = document.getElementById('resourceType').value;
                    break;
                case 'livestream':
                    contentData.streamUrl = document.getElementById('streamUrl').value;
                    contentData.scheduledTime = new Date(document.getElementById('streamTime').value);
                    contentData.isActive = true;
                    break;
            }

            // Save to Firestore
            const collection = currentContentType === 'livestream' ? 'livestreams' : `${currentContentType}s`;
            
            db.collection(collection).add(contentData).then(() => {
                bootstrap.Modal.getInstance(document.getElementById('createContentModal')).hide();
                alert(`${currentContentType.charAt(0).toUpperCase() + currentContentType.slice(1)} created successfully!`);
            }).catch(error => {
                console.error('Error saving content:', error);
                alert('Error saving content. Please try again.');
            });
        }
    </script>
        <!-- Hybrid AI Chat Widget -->
        <script src="js/advanced-hybrid-chat.js"></script>
    </body>
</html>

