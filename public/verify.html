<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Your Email - Andrew Cares Village</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #001F3F; --primary-light: #003366; --background-color: #F4F2ED;
            --text-primary: #333333; --text-secondary: #666666; --card-bg: #FFFFFF;
            --success-color: #4CAF50; --error-color: #f44336;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, var(--primary-color ), var(--primary-light)); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 500px; }
        .verify-card { background-color: var(--card-bg); border-radius: 12px; padding: 3rem; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); text-align: center; }
        .logo { font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--primary-color); text-decoration: none; font-weight: 700; margin-bottom: 1.5rem; display: block; }
        .card-icon { font-size: 3.5rem; color: var(--primary-color); margin-bottom: 1.5rem; }
        h1 { font-family: 'Cinzel', serif; font-size: 2rem; color: var(--text-primary); margin-bottom: 1rem; }
        p { color: var(--text-secondary); margin-bottom: 2rem; }
        .email-display { font-weight: 600; color: var(--text-primary); }
        .button-group { display: flex; flex-direction: column; gap: 1rem; }
        button, .button-link { width: 100%; padding: 0.85rem; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; }
        button:hover { background-color: var(--primary-light); }
        .button-link { background-color: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .button-link:hover { background-color: var(--primary-color); color: white; }
        .message { margin-top: 1.5rem; padding: 0.75rem; border-radius: 8px; display: none; }
        .message.show { display: block; }
        .error { background-color: #ffebee; color: var(--error-color); }
        .success { background-color: #e8f5e9; color: var(--success-color); }

        /* Responsive Design */
        @media (max-width: 575.98px) {
            body { padding: 12px; }
            .container { max-width: 100%; }
            .verify-card { padding: 2rem 1.5rem; }
            .logo { font-size: 1.25rem; }
            h1 { font-size: 1.5rem; }
            .card-icon { font-size: 2.5rem; }
            button, .button-link { padding: 0.75rem; font-size: 0.9rem; }
        }

        @media (min-width: 576px) and (max-width: 767.98px) {
            .container { max-width: 450px; }
            .verify-card { padding: 2.5rem; }
        }

        @media (min-width: 768px) and (max-width: 991.98px) {
            body { padding: 24px; }
            .container { max-width: 500px; }
        }

        /* Touch device improvements */
        @media (hover: none) and (pointer: coarse) {
            button:hover, .button-link:hover { transform: none; }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="verify-card">
            <a href="index.html" class="logo">Andrew Cares Village</a>
            <i class="fas fa-envelope-open-text card-icon"></i>
            <h1>Verify Your Email</h1>
            <p>We've sent a verification link to <strong id="emailDisplay" class="email-display">your email</strong>. Please check your inbox and click the link to activate your account.</p>
            <div class="button-group">
                <button id="resendBtn">Resend Verification Email</button>
                <a href="login.html" class="button-link">Back to Login</a>
            </div>
            <div id="message" class="message"></div>
        </div>
    </div>

   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, applyActionCode, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
        authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
        projectId: "andrew-cares-village-f4cb6",
        storageBucket: "andrew-cares-village-f4cb6.firebasestorage.app",
        messagingSenderId: "255087116955",
        appId: "1:255087116955:web:84360ee1f13888f9b83c3e"
    };

    const app = initializeApp(firebaseConfig );
    const auth = getAuth(app);

    const emailDisplay = document.getElementById('emailDisplay');
    const resendBtn = document.getElementById('resendBtn');
    const messageDiv = document.getElementById('message');

    function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.className = `message ${type} show`;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const actionCode = urlParams.get('oobCode');
    const email = urlParams.get('email');

    if (email) {
        emailDisplay.textContent = email;
    }

    if (mode === 'verifyEmail' && actionCode) {
        handleVerifyEmail(actionCode);
    }

    async function handleVerifyEmail(code) {
        try {
            await applyActionCode(auth, code);
            showMessage('Success! Your email has been verified. Redirecting you to the next step...', 'success');
            
            // **THE NEW CODE: Automatic Redirect**
            setTimeout(() => {
                window.location.href = 'charter.html';
            }, 3000); // Wait 3 seconds before redirecting

        } catch (error) {
            console.error("Verification Error:", error);
            showMessage('Invalid or expired verification link. Please request a new one.', 'error');
        }
    }

    resendBtn.addEventListener('click', async () => {
        // This logic remains the same, guiding the user to log in if they aren't already.
        if (!auth.currentUser) {
            showMessage("To resend, please try logging in first. We'll prompt you to verify if needed.", 'error');
            setTimeout(() => { window.location.href = 'login.html'; }, 3000);
            return;
        }
        
        try {
            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';
            await sendEmailVerification(auth.currentUser);
            showMessage('A new verification email has been sent.', 'success');
        } catch (error) {
            console.error("Resend Error:", error);
            showMessage('Failed to send new email. Please try again later.', 'error');
        } finally {
            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend Verification Email';
        }
    });
</script>
</body>
</html>
