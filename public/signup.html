<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sign Up - Andrew Cares Village</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@400;500;700&display=swap"
            rel="stylesheet">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <style>
        :root {
            --primary-color: #001F3F; --primary-light: #003366; --secondary-color: #2ECC40;
            --accent-color: #FF4136; --background-color: #F4F2ED; --text-primary: #333333;
            --text-secondary: #666666; --card-bg: #FFFFFF; --success-color: #4CAF50;
            --error-color: #f44336; --input-border: #E0E0E0; --input-focus: #B3D1FF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, var(--primary-color ), var(--primary-light)); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 480px; }
        .signup-card { background-color: var(--card-bg); border-radius: 12px; padding: 2.5rem; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); }
        .logo { text-align: center; margin-bottom: 2rem; }
        .logo a { font-family: 'Cinzel', serif; font-size: 2rem; color: var(--primary-color); text-decoration: none; font-weight: 700; }
        .welcome-text { text-align: center; margin-bottom: 2rem; color: var(--text-secondary); font-size: 1.1rem; }
        .form-group { margin-bottom: 1.5rem; position: relative; }
        label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        input { width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border: 2px solid var(--input-border); border-radius: 8px; font-size: 1rem; }
        input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--input-focus); }
        .password-requirements { margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary); }
        .password-requirements ul { list-style: none; padding: 0; }
        .password-requirements li { margin-top: 0.5rem; display: flex; align-items: center; }
        .password-requirements li i { margin-right: 0.5rem; }
        .password-requirements li.valid { color: var(--success-color); }
        .password-requirements li.invalid { color: var(--error-color); }
        button { width: 100%; padding: 0.85rem; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        button:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        .loading-spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; }
        button.loading .loading-spinner { display: inline-block; }
        button.loading span { visibility: hidden; }
        .message { margin-top: 1rem; padding: 0.75rem; border-radius: 8px; text-align: center; display: none; }
        .message.show { display: block; }
        .error { background-color: #ffebee; color: var(--error-color); }
        .success { background-color: #e8f5e9; color: var(--success-color); }
        .divider { display: flex; align-items: center; text-align: center; margin: 1.5rem 0; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--input-border); }
        .divider span { padding: 0 10px; color: var(--text-secondary); }
        .social-button { width: 100%; padding: 0.75rem; background-color: #fff; color: var(--text-primary); border: 2px solid var(--input-border); border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .social-button i { font-size: 1.2rem; }
        .links { margin-top: 1.5rem; text-align: center; }
        .links a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive Design */
        @media (max-width: 575.98px) {
            body {
                padding: 12px;
            }
            .container {
                max-width: 100%;
            }
            .signup-card {
                padding: 1.5rem;
            }
            .logo a {
                font-size: 1.5rem;
            }
            .welcome-text {
                font-size: 1rem;
            }
            input {
                padding: 0.6rem 0.6rem 0.6rem 2.2rem;
                font-size: 0.9rem;
            }
            button {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            .social-button {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
        }

        @media (min-width: 576px) and (max-width: 767.98px) {
            .container {
                max-width: 400px;
            }
            .signup-card {
                padding: 2rem;
            }
        }

        @media (min-width: 768px) and (max-width: 991.98px) {
            body {
                padding: 24px;
            }
            .container {
                max-width: 450px;
            }
        }

        @media (min-width: 992px) {
            body {
                padding: 32px;
            }
            .container {
                max-width: 480px;
            }
        }

        /* Touch device improvements */
        @media (hover: none) and (pointer: coarse) {
            button:hover, .social-button:hover {
                transform: none;
            }
            input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        /* Landscape orientation on small screens */
        @media (max-height: 600px) and (orientation: landscape) {
            body {
                padding: 8px;
                align-items: flex-start;
            }
            .signup-card {
                margin: 1rem 0;
                padding: 1.5rem;
            }
            .welcome-text {
                margin-bottom: 1rem;
            }
            .form-group {
                margin-bottom: 1rem;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
    </head>
    <body>
        <div class="container">
            <div class="signup-card">
                <div class="logo"><a href="index.html">Andrew Cares
                        Village</a></div>
                <div class="welcome-text">Join our community to access exclusive
                    resources.</div>
                <form id="signupForm">
                    <div class="form-group"><label for="name">Full
                            Name</label><div class="input-wrapper"><i
                                class="fas fa-user"></i><input type="text"
                                id="name" required></div></div>
                    <div class="form-group"><label for="email">Email
                            Address</label><div class="input-wrapper"><i
                                class="fas fa-envelope"></i><input type="email"
                                id="email" required></div></div>
                    <div class="form-group"><label
                            for="password">Password</label><div
                            class="input-wrapper"><i
                                class="fas fa-lock"></i><input type="password"
                                id="password" required></div>
                        <div class="password-requirements"><ul
                                id="requirements">
                                <li id="length"><i class="fas fa-circle"></i> At
                                    least 8 characters</li>
                                <li id="uppercase"><i class="fas fa-circle"></i>
                                    An uppercase letter</li>
                                <li id="number"><i class="fas fa-circle"></i> A
                                    number</li>
                            </ul></div>
                    </div>
                    <div class="form-group"><label for="confirmPassword">Confirm
                            Password</label><div class="input-wrapper"><i
                                class="fas fa-lock"></i><input type="password"
                                id="confirmPassword" required></div></div>
                    <button type="submit"><span>Create Account</span><div
                            class="loading-spinner"></div></button>
                    <div id="message" class="message"></div>
                </form>
                <div class="divider"><span>or</span></div>
                <div class="social-login">
                    <button type="button" id="googleSignIn"
                        class="social-button"><i class="fab fa-google"></i>
                        Continue with Google</button>
                </div>
                <div class="links"><a href="login.html">Already have an account?
                        Sign in</a></div>
            </div>
        </div>

        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc,serverTimestamp  } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
            authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
                projectId: "%REACT_APP_FIREBASE_PROJECT_ID%", 
            storageBucket: "andrew-cares-village-f4cb6.firebasestorage.app",
            messagingSenderId: "255087116955",
            appId: "1:255087116955:web:84360ee1f13888f9b83c3e"
        };

        const app = initializeApp(firebaseConfig );
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const signupForm = document.getElementById('signupForm');
        const messageDiv = document.getElementById('message');
        const googleSignInButton = document.getElementById('googleSignIn');
        const passwordInput = document.getElementById('password');

        function showMessage(message, type) {
            messageDiv.textContent = message;
            messageDiv.className = `message ${type} show`;
        }

        function validatePassword(password) {
            const reqs = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                number: /[0-9]/.test(password)
            };
            Object.keys(reqs).forEach(req => {
                const li = document.getElementById(req);
                if (li) {
                    li.className = reqs[req] ? 'valid' : 'invalid';
                    li.querySelector('i').className = reqs[req] ? 'fas fa-check-circle' : 'fas fa-times-circle';
                }
            });
            return Object.values(reqs).every(Boolean);
        }

        passwordInput.addEventListener('input', (e) => validatePassword(e.target.value));

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = passwordInput.value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitButton = signupForm.querySelector('button[type="submit"]');

            if (!validatePassword(password)) { showMessage('Please meet all password requirements.', 'error'); return; }
            if (password !== confirmPassword) { showMessage('Passwords do not match.', 'error'); return; }

            submitButton.classList.add('loading');
            submitButton.disabled = true;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                await createFirestoreUser(user, name, 'email');
                await sendEmailVerification(user);

                showMessage('Account created! Please check your email to verify your account.', 'success');
                setTimeout(() => { window.location.href = `verify.html?email=${encodeURIComponent(email)}`; }, 3000);

            } catch (error) {
                const errorMessage = error.code === 'auth/email-already-in-use' ? 'This email is already registered.' : 'Failed to create account.';
                showMessage(errorMessage, 'error');
            } finally {
                submitButton.classList.remove('loading');
                submitButton.disabled = false;
            }
        });

        googleSignInButton.addEventListener('click', async () => {
            googleSignInButton.disabled = true;
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists()) {
                    await createFirestoreUser(user, user.displayName, 'google');
                }
                
                window.location.href = 'home.html';
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showMessage("Could not sign in with Google. Please try again.", 'error');
            } finally {
                googleSignInButton.disabled = false;
            }
        });

        async function createFirestoreUser(user, name, method) {
            const userRef = doc(db, "users", user.uid);
            await setDoc(userRef, {
                uid: user.uid,
                name: name,
                email: user.email,
                avatarUrl: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(name )}&background=001F3F&color=fff`,
                createdAt: serverTimestamp(),
                membershipTier: 'apprentice',
                membershipStatus: 'active', // Automatically active for simplicity
                role: 'member',
                isBlocked: false,
                signupMethod: method
            });
        }
    </script>
    </body>
</html>
