<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Course Editor - Andrew Cares Village</title>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
            rel="stylesheet">
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cinzel:wght@400;500;600&display=swap"
            rel="stylesheet">
        <style>
        /* --- Enhanced Root Variables & Base Styles --- */
        :root {
            --background: #0f0f23;
            --background-secondary: #1a1a35;
            --surface: #252547;
            --surface-hover: #2d2d52;
            --primary: #6366f1;
            --primary-hover: #5855eb;
            --accent: #f59e0b;
            --accent-hover: #d97706;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #374151;
            --border-hover: #4b5563;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --glass-bg: rgba(37, 37, 71, 0.8);
            --glass-border: rgba(99, 102, 241, 0.2);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --glow-primary: 0 0 20px rgba(99, 102, 241, 0.3);
            --glow-accent: 0 0 20px rgba(245, 158, 11, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, var(--background-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- Glassmorphism Effects --- */
        .glass {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
        }

        /* --- Enhanced Layout --- */
        .editor-layout {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .sidebar {
            width: 360px;
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }

        .main-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- Enhanced Sidebar Header --- */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-hover) 100%);
            position: relative;
        }

        .sidebar-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-header a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-header a:hover {
            color: var(--primary);
        }

        /* --- Enhanced Curriculum List --- */
        .curriculum-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        .curriculum-list::-webkit-scrollbar {
            width: 6px;
        }

        .curriculum-list::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 3px;
        }

        .curriculum-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .section-item {
            margin-bottom: 1rem;
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-item:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .section-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--surface), var(--surface-hover));
            cursor: grab;
            transition: all 0.2s ease;
        }

        .section-header:hover {
            background: linear-gradient(135deg, var(--surface-hover), var(--primary));
        }

        .section-header span {
            font-weight: 500;
            flex: 1;
            margin-left: 0.75rem;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        .section-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.375rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .section-actions button:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .lessons-container {
            padding: 0.5rem;
        }

        .lesson-item {
            display: flex;
            align-items: center;
            padding: 0.875rem;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 0.25rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .lesson-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            transition: width 0.3s ease;
        }

        .lesson-item:hover {
            background: var(--surface-hover);
            transform: translateX(4px);
        }

        .lesson-item:hover::before {
            width: 3px;
        }

        .lesson-item.active {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: var(--glow-primary);
        }

        .lesson-item.active::before {
            width: 100%;
        }

        .lesson-item i {
            margin-right: 0.75rem;
            width: 16px;
            text-align: center;
        }

        /* --- Enhanced Sidebar Footer --- */
        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
            background: var(--surface);
        }

        .btn-add-section {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-add-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl), var(--glow-primary);
        }

        .btn-add-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-add-section:hover::before {
            left: 100%;
        }

        /* --- Enhanced Main Editor --- */
        .editor-toolbar {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .editor-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .editor-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: var(--text-secondary);
            animation: fadeIn 0.5s ease-in;
        }

        .editor-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .editor-placeholder h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        /* --- Enhanced Lesson Editor --- */
        .lesson-editor {
            display: none;
            animation: slideInRight 0.3s ease-out;
        }

        .lesson-editor.visible {
            display: block;
        }

        .lesson-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .lesson-header h3 {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            font-weight: 600;
            flex: 1;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-save {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .btn-save:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .btn-save:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Enhanced Content Blocks --- */
        .content-block {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .content-block:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .block-header {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, var(--surface), var(--surface-hover));
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: grab;
        }

        .block-title {
            font-weight: 500;
            flex: 1;
            margin-left: 0.75rem;
        }

        .block-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.375rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .block-actions button:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.1);
        }

        .block-content {
            padding: 1.5rem;
        }

        /* --- Enhanced Add Block Controls --- */
        .add-block-controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 2px dashed var(--border);
            border-radius: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .add-block-btn {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur();
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .add-block-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), var(--glow-primary);
        }

        .add-block-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.3s;
        }

        .add-block-btn:hover::before {
            left: 100%;
        }

        /* --- Professional Video Recorder Styles --- */
        .video-recorder {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: var(--shadow-xl);
        }

        .video-recorder.recording {
            border-color: var(--danger);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
        }

        .recorder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .recorder-title {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .recorder-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            background: var(--surface);
            font-size: 0.875rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-indicator.recording {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }

        .video-preview-container {
            position: relative;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            aspect-ratio: 16/9;
        }

        .video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.125rem;
        }

        .recorder-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .control-group {
            background: var(--surface);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border);
        }

        .control-group h4 {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .control-btn {
            background: var(--glass-bg);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .control-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .control-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .background-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .bg-option {
            aspect-ratio: 16/9;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s ease;
            background-size: cover;
            background-position: center;
        }

        .bg-option:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .bg-option.active {
            border-color: var(--primary);
            box-shadow: var(--glow-primary);
        }

        .bg-option.none {
            background: linear-gradient(45deg, transparent 40%, var(--border) 40%, var(--border) 60%, transparent 60%);
            background-size: 20px 20px;
        }

        .bg-option.blur {
            background: linear-gradient(135deg, var(--primary), var(--accent));
        }

        .record-button {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            width: 100%;
        }

        .record-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .record-button.recording {
            background: linear-gradient(135deg, var(--warning), #d97706);
            animation: pulse 2s infinite;
        }

        .record-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Enhanced Lesson Settings --- */
        .lesson-settings {
            margin-top: 2rem;
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .lesson-settings h4 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--surface);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .setting-item:hover {
            background: var(--surface-hover);
        }

        .setting-item input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .setting-item input[type="checkbox"]:checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .setting-item input[type="checkbox"]:checked::before {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 12px;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .setting-item label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* --- Video Block Enhancements --- */
        .video-block-preview {
            border-radius: 12px;
            overflow: hidden;
        }

        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            background: #000;
            border-radius: 12px;
        }

        .video-wrapper iframe,
        .video-wrapper video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* --- Utility Classes --- */
        .hidden { display: none !important; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        
        .slide-in { animation: slideInRight 0.3s ease-out; }

        /* --- Responsive Design --- */
        @media (max-width: 1024px) {
            .sidebar {
                width: 300px;
            }
            
            .recorder-controls {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
                position: absolute;
                z-index: 1000;
                height: 100%;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .editor-content {
                padding: 1rem;
            }
            
            .lesson-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
        }
    </style>
    </head>
    <body>
        <div class="editor-layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2 id="courseTitleHeader">Loading Course...</h2>
                    <a href="instructor.html">
                        <i class="fas fa-arrow-left"></i>
                        Back to Dojo
                    </a>
                </div>
                <div class="curriculum-list" id="curriculumList">
                    <div
                        style="text-align:center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading curriculum...</p>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button id="addSectionBtn" class="btn-add-section">
                        <i class="fas fa-plus"></i>
                        Add Section
                    </button>
                </div>
            </aside>

            <main class="main-editor">
                <div class="editor-toolbar">
                    <div class="toolbar-left">
                        <button id="sidebarToggle" class="control-btn"
                            style="display: none;">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button id="saveLessonBtn" class="btn-save"
                            style="display: none;">
                            <i class="fas fa-save"></i>
                            Save Lesson
                        </button>
                    </div>
                </div>

                <div class="editor-content">
                    <div id="editorPlaceholder" class="editor-placeholder">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>Welcome to the Course Editor</h3>
                        <p>Select a lesson from the sidebar to start editing, or
                            create a new section to get started.</p>
                    </div>

                    <div id="lessonEditor" class="lesson-editor">
                        <div class="lesson-header">
                            <h3 id="lessonTitleHeader"></h3>
                        </div>

                        <div id="contentBlockArea"></div>

                        <div class="add-block-controls">
                            <button class="add-block-btn" data-type="text">
                                <i class="fas fa-paragraph"></i>
                                Text Content
                            </button>
                            <button class="add-block-btn" data-type="video">
                                <i class="fas fa-video"></i>
                                Video/YouTube
                            </button>
                            <button class="add-block-btn" data-type="record">
                                <i class="fas fa-record-vinyl"></i>
                                Record Video
                            </button>
                            <button class="add-block-btn" data-type="file">
                                <i class="fas fa-paperclip"></i>
                                File Upload
                            </button>
                            <button class="add-block-btn" data-type="quiz">
                                <i class="fas fa-question-circle"></i>
                                Quiz Question
                            </button>
                        </div>

                        <div class="lesson-settings">
                            <h4>Lesson Settings</h4>
                            <div class="settings-grid">
                                <div class="setting-item">
                                    <input type="checkbox" id="allowComments">
                                    <label for="allowComments">Allow
                                        Comments</label>
                                </div>
                                <div class="setting-item">
                                    <input type="checkbox" id="isFreePreview">
                                    <label for="isFreePreview">Free
                                        Preview</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Professional Video Recorder Modal -->
        <div id="videoRecorderModal" class="modal-overlay"
            style="display: none;">
            <div class="modal-content"
                style="max-width: 90vw; max-height: 90vh; overflow-y: auto;">
                <div class="video-recorder">
                    <div class="recorder-header">
                        <h3 class="recorder-title">
                            <i class="fas fa-video"></i>
                            Professional Video Recorder
                        </h3>
                        <div class="recorder-status">
                            <div class="status-indicator"
                                id="recordingIndicator"></div>
                            <span id="recordingStatus">Ready to Record</span>
                            <span id="recordingTime"
                                style="display: none;">00:00</span>
                        </div>
                        <button id="closeRecorder" class="control-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="video-preview-container">
                        <video id="videoPreview" class="video-preview" autoplay
                            muted></video>
                        <canvas id="outputCanvas" class="video-preview"
                            style="display: none;"></canvas>
                        <div id="previewOverlay" class="preview-overlay">
                            <i class="fas fa-play-circle"
                                style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <div>Click "Start Camera" to begin</div>
                        </div>
                    </div>

                    <div class="recorder-controls">
                        <div class="control-group">
                            <h4>Camera & Microphone</h4>
                            <div class="control-buttons">
                                <button id="startCamera" class="control-btn">
                                    <i class="fas fa-camera"></i> Start Camera
                                </button>
                                <button id="toggleMicrophone"
                                    class="control-btn">
                                    <i class="fas fa-microphone"></i> Microphone
                                    On
                                </button>
                                <button id="switchCamera" class="control-btn"
                                    style="display: none;">
                                    <i class="fas fa-sync-alt"></i> Switch
                                    Camera
                                </button>
                            </div>
                        </div>

                        <div class="control-group">
                            <h4>Screen Sharing</h4>
                            <div class="control-buttons">
                                <button id="shareScreen" class="control-btn">
                                    <i class="fas fa-desktop"></i> Share Screen
                                </button>
                                <button id="shareWindow" class="control-btn">
                                    <i class="fas fa-window-maximize"></i> Share
                                    Window
                                </button>
                                <button id="shareTab" class="control-btn">
                                    <i class="fas fa-chrome"></i> Share Tab
                                </button>
                            </div>
                        </div>

                        <div class="control-group">
                            <h4>Virtual Background</h4>
                            <div class="control-buttons">
                                <button id="toggleBackground"
                                    class="control-btn">
                                    <i class="fas fa-magic"></i> Enable
                                    Background
                                </button>
                                <button id="backgroundSettings"
                                    class="control-btn">
                                    <i class="fas fa-cog"></i> Settings
                                </button>
                            </div>
                            <div class="background-selector">
                                <div class="bg-option none active"
                                    data-bg="none" title="No Background"></div>
                                <div class="bg-option blur" data-bg="blur"
                                    title="Blur Background"></div>
                                <div class="bg-option" data-bg="office"
                                    title="Office"
                                    style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNjAiIGhlaWdodD0iOTAiIGZpbGw9IiNmMGY0ZjgiLz48cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSIxMjAiIGhlaWdodD0iNTAiIGZpbGw9IiNkMWQ1ZGIiLz48L3N2Zz4=')"></div>
                                <div class="bg-option" data-bg="nature"
                                    title="Nature"
                                    style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNjAiIGhlaWdodD0iOTAiIGZpbGw9IiM2NmJiNmEiLz48Y2lyY2xlIGN4PSI4MCIgY3k9IjQ1IiByPSIyMCIgZmlsbD0iIzRjYWY1MCIvPjwvc3ZnPg==')"></div>
                            </div>
                        </div>

                        <div class="control-group">
                            <h4>Recording Quality</h4>
                            <div class="control-buttons">
                                <button class="control-btn"
                                    data-quality="720p">720p</button>
                                <button class="control-btn active"
                                    data-quality="1080p">1080p</button>
                                <button class="control-btn"
                                    data-quality="4k">4K</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <button id="recordButton" class="record-button">
                            <i class="fas fa-record-vinyl"></i>
                            Start Recording
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Modal Styles -->
        <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            max-width: 1200px;
            width: 100%;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>

        <!-- Libraries -->
        <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.10.0/tf.min.js"></script>

        <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAM8S_LtlBaqfp7WoU6xLdaEMIyW_cZHRc",
            authDomain: "andrew-cares-village-f4cb6.firebaseapp.com",
               projectId: "andrew-cares-village-f4cb6", 
            storageBucket: "andrew-cares-village-f4cb6.firebasestorage.app",
            messagingSenderId: "255087116955",
            appId: "1:255087116955:web:84360ee1f13888f9b83c3e"
        };

        const CLOUDINARY_CONFIG = { 
            cloudName: 'dkd6x857p', 
            uploadPreset: 'Andrew Cares Village Hub' 
        };

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentCourseId = null;
        let activeLessonId = null;
        let lessonsUnsubscribe = null;
        let quillInstances = {};
        
        // Video Recording State
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;
        let currentStream = null;
        let recordingStartTime = null;
        let recordingTimer = null;
        let backgroundEnabled = false;
        let bodySegmentationModel = null;
        let currentBackground = 'none';

        // --- DOM Elements ---
        const dom = {
            courseTitleHeader: document.getElementById('courseTitleHeader'),
            curriculumList: document.getElementById('curriculumList'),
            addSectionBtn: document.getElementById('addSectionBtn'),
            editorPlaceholder: document.getElementById('editorPlaceholder'),
            lessonEditor: document.getElementById('lessonEditor'),
            lessonTitleHeader: document.getElementById('lessonTitleHeader'),
            contentBlockArea: document.getElementById('contentBlockArea'),
            saveLessonBtn: document.getElementById('saveLessonBtn'),
            allowComments: document.getElementById('allowComments'),
            isFreePreview: document.getElementById('isFreePreview'),
            
            // Video Recorder Elements
            videoRecorderModal: document.getElementById('videoRecorderModal'),
            videoPreview: document.getElementById('videoPreview'),
            outputCanvas: document.getElementById('outputCanvas'),
            previewOverlay: document.getElementById('previewOverlay'),
            recordingIndicator: document.getElementById('recordingIndicator'),
            recordingStatus: document.getElementById('recordingStatus'),
            recordingTime: document.getElementById('recordingTime'),
            
            // Recorder Controls
            startCamera: document.getElementById('startCamera'),
            toggleMicrophone: document.getElementById('toggleMicrophone'),
            switchCamera: document.getElementById('switchCamera'),
            shareScreen: document.getElementById('shareScreen'),
            shareWindow: document.getElementById('shareWindow'),
            shareTab: document.getElementById('shareTab'),
            toggleBackground: document.getElementById('toggleBackground'),
            backgroundSettings: document.getElementById('backgroundSettings'),
            recordButton: document.getElementById('recordButton'),
            closeRecorder: document.getElementById('closeRecorder')
        };

        // --- Professional Video Recorder Class ---
        class ProfessionalVideoRecorder {
            constructor() {
                this.canvas = dom.outputCanvas;
                this.ctx = this.canvas.getContext('2d');
                this.video = dom.videoPreview;
                this.backgroundImage = null;
                this.animationId = null;
                this.isProcessing = false;
            }

           async initializeBodySegmentation() {
    try {
        // Remove the bodySegmentation dependency that's causing errors
        console.log('Body segmentation simplified - using canvas effects instead');
        return true;
    } catch (error) {
        console.error('Failed to initialize video processing:', error);
        return false;
    }
}

            async startCamera() {
                try {
                    const constraints = {
                        video: { 
                            width: { ideal: 1920 }, 
                            height: { ideal: 1080 },
                            facingMode: 'user'
                        },
                        audio: true
                    };

                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    dom.videoPreview.srcObject = currentStream;
                    dom.previewOverlay.style.display = 'none';
                    dom.startCamera.innerHTML = '<i class="fas fa-camera-retro"></i> Camera Active';
                    dom.startCamera.classList.add('active');
                    dom.switchCamera.style.display = 'inline-block';
                    dom.recordingStatus.textContent = 'Camera Ready';

                    // Initialize canvas
                    this.canvas.width = dom.videoPreview.videoWidth || 1920;
                    this.canvas.height = dom.videoPreview.videoHeight || 1080;

                    return true;
                } catch (error) {
                    console.error('Camera access failed:', error);
                    alert('Camera access denied. Please check permissions.');
                    return false;
                }
            }
async shareScreen() {
    try {
        if (!navigator.mediaDevices?.getDisplayMedia) {
            alert('Screen sharing not supported in this browser');
            return false;
        }

        const displayMediaOptions = {
            video: { 
                cursor: 'always',
                width: { ideal: 1920 }, 
                height: { ideal: 1080 }
            },
            audio: true
        };

        const screenStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
        
        // Stop previous stream
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        
        currentStream = screenStream;
        dom.videoPreview.srcObject = screenStream;
        dom.previewOverlay.style.display = 'none';
        dom.recordingStatus.textContent = 'Screen Sharing Active';

        // Update MediaRecorder if recording
        if (isRecording && mediaRecorder) {
            mediaRecorder.stop();
            // Restart with new stream
            setTimeout(() => {
                this.startRecording();
            }, 100);
        }

        screenStream.getVideoTracks()[0].addEventListener('ended', () => {
            this.stopCamera();
        });

        return true;
    } catch (error) {
        console.error('Screen sharing failed:', error);
        dom.recordingStatus.textContent = 'Screen sharing permission denied';
        return false;
    }
}
           async processVideoFrame() {
    if (!this.isProcessing && backgroundEnabled && this.video.videoWidth > 0) {
        this.isProcessing = true;
        
        try {
            // Set canvas dimensions to match video
            const videoWidth = this.video.videoWidth;
            const videoHeight = this.video.videoHeight;
            
            if (videoWidth > 0 && videoHeight > 0) {
                this.canvas.width = videoWidth;
                this.canvas.height = videoHeight;

                // Clear canvas first
                this.ctx.clearRect(0, 0, videoWidth, videoHeight);

                if (currentBackground === 'blur') {
                    // Apply blur effect
                    this.ctx.filter = 'blur(20px)';
                    this.ctx.drawImage(this.video, 0, 0, videoWidth, videoHeight);
                    this.ctx.filter = 'none';
                    
                    // Draw unblurred person (simplified - draws whole video over blurred background)
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.drawImage(this.video, 0, 0, videoWidth, videoHeight);
                    this.ctx.globalCompositeOperation = 'source-over';
                    
                } else if (currentBackground === 'office') {
                    // Office background
                    this.ctx.fillStyle = '#f0f4f8';
                    this.ctx.fillRect(0, 0, videoWidth, videoHeight);
                    
                    // Draw video with some transparency to blend
                    this.ctx.globalAlpha = 0.8;
                    this.ctx.drawImage(this.video, 0, 0, videoWidth, videoHeight);
                    this.ctx.globalAlpha = 1.0;
                    
                } else if (currentBackground === 'nature') {
                    // Nature background
                    this.ctx.fillStyle = '#66bb6a';
                    this.ctx.fillRect(0, 0, videoWidth, videoHeight);
                    
                    // Draw video with some transparency
                    this.ctx.globalAlpha = 0.8;
                    this.ctx.drawImage(this.video, 0, 0, videoWidth, videoHeight);
                    this.ctx.globalAlpha = 1.0;
                    
                } else {
                    // Default - just draw video
                    this.ctx.drawImage(this.video, 0, 0, videoWidth, videoHeight);
                }
            }
        } catch (error) {
            console.error('Video processing error:', error);
            // Fallback - just draw the video
            if (this.video.videoWidth > 0 && this.video.videoHeight > 0) {
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;
                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
            }
        }
        
        this.isProcessing = false;
    }

    if (backgroundEnabled) {
        this.animationId = requestAnimationFrame(() => this.processVideoFrame());
    }
}

            drawBackground() {
                if (currentBackground === 'blur') {
                    // Create blurred background
                    this.ctx.filter = 'blur(20px)';
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.filter = 'none';
                } else if (currentBackground === 'office' || currentBackground === 'nature') {
                    // Solid color backgrounds for demo
                    const colors = {
                        office: '#f0f4f8',
                        nature: '#66bb6a'
                    };
                    this.ctx.fillStyle = colors[currentBackground];
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                } else {
                    // Default solid background
                    this.ctx.fillStyle = '#1a1a35';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }
            }

            drawPersonWithMask(mask) {
                const imageData = this.ctx.createImageData(this.canvas.width, this.canvas.height);
                const videoCanvas = document.createElement('canvas');
                videoCanvas.width = this.canvas.width;
                videoCanvas.height = this.canvas.height;
                const videoCtx = videoCanvas.getContext('2d');
                videoCtx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                const videoData = videoCtx.getImageData(0, 0, this.canvas.width, this.canvas.height);

                for (let i = 0; i < mask.data.length; i++) {
                    const shouldShowPixel = mask.data[i] > 128; // Threshold for person detection
                    if (shouldShowPixel) {
                        const pixelIndex = i * 4;
                        imageData.data[pixelIndex] = videoData.data[pixelIndex];     // R
                        imageData.data[pixelIndex + 1] = videoData.data[pixelIndex + 1]; // G
                        imageData.data[pixelIndex + 2] = videoData.data[pixelIndex + 2]; // B
                        imageData.data[pixelIndex + 3] = 255; // A
                    }
                }

                this.ctx.putImageData(imageData, 0, 0);
            }

            toggleBackground() {
                backgroundEnabled = !backgroundEnabled;
                
                if (backgroundEnabled) {
                    dom.toggleBackground.innerHTML = '<i class="fas fa-magic"></i> Disable Background';
                    dom.toggleBackground.classList.add('active');
                    dom.outputCanvas.style.display = 'block';
                    dom.videoPreview.style.display = 'none';
                    this.processVideoFrame();
                } else {
                    dom.toggleBackground.innerHTML = '<i class="fas fa-magic"></i> Enable Background';
                    dom.toggleBackground.classList.remove('active');
                    dom.outputCanvas.style.display = 'none';
                    dom.videoPreview.style.display = 'block';
                    if (this.animationId) {
                        cancelAnimationFrame(this.animationId);
                        this.animationId = null;
                    }
                }
            }

          async startRecording() {
    if (!currentStream) {
        alert('Please start camera or screen sharing first.');
        return;
    }

    try {
        recordedChunks = [];
        
        // Always use the current active stream
        let streamToRecord = currentStream;
        
        // If background is enabled, use canvas stream but ensure it has audio
        if (backgroundEnabled && this.canvas.captureStream) {
            const canvasStream = this.canvas.captureStream(30);
            
            // Add audio from current stream if available
            const audioTracks = currentStream.getAudioTracks();
            if (audioTracks.length > 0) {
                audioTracks.forEach(track => canvasStream.addTrack(track));
            }
            
            streamToRecord = canvasStream;
        }

        // Check supported MIME types
        let mimeType = 'video/webm;codecs=vp9';
        if (!MediaRecorder.isTypeSupported(mimeType)) {
            mimeType = 'video/webm;codecs=vp8';
            if (!MediaRecorder.isTypeSupported(mimeType)) {
                mimeType = 'video/webm';
            }
        }

        const options = { mimeType: mimeType };
        mediaRecorder = new MediaRecorder(streamToRecord, options);

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = () => {
            this.handleRecordingComplete();
        };

        mediaRecorder.start(1000); // Record in 1-second chunks
        this.startRecordingUI();

    } catch (error) {
        console.error('Recording failed:', error);
        alert(`Recording failed: ${error.message}`);
    }
}

            stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
            }

            startRecordingUI() {
                isRecording = true;
                recordingStartTime = Date.now();
                
                dom.recordButton.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                dom.recordButton.classList.add('recording');
                dom.recordingIndicator.classList.add('recording');
                dom.recordingStatus.textContent = 'Recording';
                dom.recordingTime.style.display = 'inline';
                
                recordingTimer = setInterval(() => {
                    const elapsed = Date.now() - recordingStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    dom.recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            stopRecordingUI() {
                isRecording = false;
                
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                dom.recordButton.innerHTML = '<i class="fas fa-record-vinyl"></i> Start Recording';
                dom.recordButton.classList.remove('recording');
                dom.recordingIndicator.classList.remove('recording');
                dom.recordingStatus.textContent = 'Processing...';
                dom.recordingTime.style.display = 'none';
            }

            async handleRecordingComplete() {
                this.stopRecordingUI();
                
                try {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const file = new File([blob], `recording-${Date.now()}.webm`, { type: 'video/webm' });
                    
                    dom.recordingStatus.textContent = 'Uploading video...';
                    
                    const videoUrl = await this.uploadToCloudinary(file);
                    
                    if (videoUrl) {
                        // Add video block to lesson
                        this.addRecordedVideoBlock(videoUrl);
                        dom.recordingStatus.textContent = 'Video uploaded successfully!';
                        
                        // Close recorder after 2 seconds
                        setTimeout(() => {
                            this.closeRecorder();
                        }, 2000);
                    } else {
                        throw new Error('Upload failed');
                    }
                    
                } catch (error) {
                    console.error('Failed to process recording:', error);
                    dom.recordingStatus.textContent = 'Upload failed. Please try again.';
                }
            }
            // Add this method to the ProfessionalVideoRecorder class
handleStreamChange(newStream) {
    if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
        // Stop current recording
        mediaRecorder.stop();
        
        // Update stream
        currentStream = newStream;
        
        // Restart recording with new stream after a brief delay
        setTimeout(() => {
            this.startRecording();
        }, 200);
    } else {
        // Just update the stream
        currentStream = newStream;
        dom.videoPreview.srcObject = newStream;
    }
}

       async uploadToCloudinary(file) {
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
        
        const resourceType = file.type.startsWith('video/') ? 'video' : 
                            file.type.startsWith('image/') ? 'image' : 'raw';
        
        const response = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/${resourceType}/upload`, 
            { 
                method: 'POST', 
                body: formData,
                mode: 'cors'
            }
        );
        
        if (!response.ok) {
            const errorData = await response.text();
            console.error('Cloudinary error:', errorData);
            throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        return data.secure_url;
    } catch (error) {
        console.error("Upload error:", error);
        alert(`Upload failed: ${error.message}. Please check your Cloudinary settings.`);
        return null;
    }
}

            addRecordedVideoBlock(videoUrl) {
                const newBlock = {
                    id: `block_${Date.now()}`,
                    type: 'video',
                    url: videoUrl,
                    originalUrl: videoUrl,
                    videoType: 'recorded'
                };

                const blockEl = createBlockElement(newBlock);
                if (!dom.contentBlockArea.querySelector('.content-block')) {
                    dom.contentBlockArea.innerHTML = '';
                }
                dom.contentBlockArea.appendChild(blockEl);

                // Auto-save the lesson
                saveActiveLesson();
            }

            stopCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }

                dom.videoPreview.srcObject = null;
                dom.outputCanvas.style.display = 'none';
                dom.videoPreview.style.display = 'block';
                dom.previewOverlay.style.display = 'flex';
                dom.startCamera.innerHTML = '<i class="fas fa-camera"></i> Start Camera';
                dom.startCamera.classList.remove('active');
                dom.switchCamera.style.display = 'none';
                dom.recordingStatus.textContent = 'Ready to Record';

                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }

                backgroundEnabled = false;
                dom.toggleBackground.innerHTML = '<i class="fas fa-magic"></i> Enable Background';
                dom.toggleBackground.classList.remove('active');
            }

            closeRecorder() {
                this.stopCamera();
                if (isRecording) {
                    this.stopRecording();
                }
                dom.videoRecorderModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Initialize video recorder
        const videoRecorder = new ProfessionalVideoRecorder();

        // --- Main App Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const urlParams = new URLSearchParams(window.location.search);
                currentCourseId = urlParams.get('id');
                if (!currentCourseId) {
                    document.body.innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--danger);"><h1>Error: No Course ID provided</h1></div>';
                    return;
                }
                loadApplication();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadApplication() {
            try {
                const courseRef = doc(db, "courses", currentCourseId);
                const courseSnap = await getDoc(courseRef);
                
                if (!courseSnap.exists() || courseSnap.data().instructorId !== auth.currentUser.uid) {
                    document.body.innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--danger);"><h1>Access Denied</h1></div>';
                    return;
                }

                dom.courseTitleHeader.textContent = courseSnap.data().title;
                setupEventListeners();
                listenForCurriculumChanges();
                
                // Initialize body segmentation model in background
                videoRecorder.initializeBodySegmentation();
                
            } catch (error) {
                console.error("Error loading application:", error);
                document.body.innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--danger);"><h1>Error loading course editor</h1></div>';
            }
            // Initialize video recorder with error handling
try {
    videoRecorder.initializeBodySegmentation();
} catch (error) {
    console.warn('Video recorder initialization failed:', error);
    // Continue without video recording features
}
        }

        function setupEventListeners() {
            // Basic functionality
            dom.addSectionBtn.addEventListener('click', createNewSection);
            dom.saveLessonBtn.addEventListener('click', saveActiveLesson);
            dom.allowComments.addEventListener('change', saveActiveLesson);
            dom.isFreePreview.addEventListener('change', saveActiveLesson);

            // Add block buttons
            document.querySelectorAll('.add-block-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = btn.dataset.type;
                    if (type === 'record') {
                        openVideoRecorder();
                    } else {
                        addContentBlock(type);
                    }
                });
            });

            // Video recorder controls
            dom.startCamera.addEventListener('click', () => videoRecorder.startCamera());
            dom.shareScreen.addEventListener('click', () => videoRecorder.shareScreen());
            dom.shareWindow.addEventListener('click', () => videoRecorder.shareScreen());
            dom.shareTab.addEventListener('click', () => videoRecorder.shareScreen());
            
            dom.toggleMicrophone.addEventListener('click', toggleMicrophone);
            dom.toggleBackground.addEventListener('click', () => videoRecorder.toggleBackground());
            
            dom.recordButton.addEventListener('click', () => {
                if (isRecording) {
                    videoRecorder.stopRecording();
                } else {
                    videoRecorder.startRecording();
                }
            });
            
            dom.closeRecorder.addEventListener('click', () => videoRecorder.closeRecorder());

            // Background selector
            document.querySelectorAll('.bg-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    document.querySelectorAll('.bg-option').forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentBackground = option.dataset.bg;
                });
            });

            // Quality selector
            document.querySelectorAll('[data-quality]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-quality]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Responsive sidebar toggle
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (window.innerWidth <= 768) {
                sidebarToggle.style.display = 'block';
                sidebarToggle.addEventListener('click', () => {
                    dom.sidebar?.classList.toggle('open');
                });
            }

            // Close modal on overlay click
            dom.videoRecorderModal.addEventListener('click', (e) => {
                if (e.target === dom.videoRecorderModal) {
                    videoRecorder.closeRecorder();
                }
            });
        }

        function toggleMicrophone() {
            if (currentStream) {
                const audioTracks = currentStream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const enabled = !audioTracks[0].enabled;
                    audioTracks[0].enabled = enabled;
                    dom.toggleMicrophone.innerHTML = enabled ? 
                        '<i class="fas fa-microphone"></i> Microphone On' : 
                        '<i class="fas fa-microphone-slash"></i> Microphone Off';
                    dom.toggleMicrophone.classList.toggle('active', enabled);
                }
            }
        }

        function openVideoRecorder() {
            dom.videoRecorderModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            dom.recordingStatus.textContent = 'Ready to Record';
        }

        function listenForCurriculumChanges() {
            const q = query(collection(db, "courses", currentCourseId, "lessons"), orderBy("order", "asc"));
            if (lessonsUnsubscribe) lessonsUnsubscribe();
            
            lessonsUnsubscribe = onSnapshot(q, (snapshot) => {
                const lessons = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCurriculum(lessons);
            });
        }

        function renderCurriculum(lessons) {
            dom.curriculumList.innerHTML = '';
            const sections = {};

            // Group lessons by sections
            lessons.filter(l => l.type === 'section').forEach(s => {
                sections[s.id] = { ...s, lessons: [] };
            });

            lessons.filter(l => l.type === 'lesson').forEach(l => {
                if (sections[l.sectionId]) {
                    sections[l.sectionId].lessons.push(l);
                }
            });

            // Render sections and lessons
            Object.values(sections).sort((a, b) => a.order - b.order).forEach(section => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'section-item';
                sectionEl.dataset.sectionId = section.id;
                
                sectionEl.innerHTML = `
                    <div class="section-header">
                        <i class="fas fa-grip-vertical"></i>
                        <span>${section.title}</span>
                        <div class="section-actions">
                            <button class="btn-add-lesson" data-section-id="${section.id}">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                            <button class="btn-delete-section" data-section-id="${section.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;

                const lessonsContainer = document.createElement('div');
                lessonsContainer.className = 'lessons-container';
                
                section.lessons.sort((a, b) => a.order - b.order).forEach(lesson => {
                    const lessonEl = document.createElement('div');
                    lessonEl.className = 'lesson-item';
                    lessonEl.dataset.lessonId = lesson.id;
                    
                    if (lesson.id === activeLessonId) {
                        lessonEl.classList.add('active');
                    }
                    
                    lessonEl.innerHTML = `
                        <i class="fas fa-grip-vertical lesson-drag-handle"></i>
                        <i class="fas fa-play-circle"></i>
                        ${lesson.title}
                    `;
                    
                    lessonEl.onclick = () => openLessonInEditor(lesson.id);
                    lessonsContainer.appendChild(lessonEl);
                });

                sectionEl.appendChild(lessonsContainer);
                dom.curriculumList.appendChild(sectionEl);
            });

            // Add event listeners
            document.querySelectorAll('.btn-add-lesson').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    createNewLesson(e.currentTarget.dataset.sectionId);
                };
            });

            document.querySelectorAll('.btn-delete-section').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    deleteSection(e.currentTarget.dataset.sectionId);
                };
            });
            
            initializeSortable();
        }

        function initializeSortable() {
            // Section sorting
            new Sortable(dom.curriculumList, {
                animation: 150,
                handle: '.section-header',
                filter: '.lessons-container',
                onEnd: async (evt) => {
                    const sectionIds = Array.from(dom.curriculumList.querySelectorAll('.section-item'))
                        .map(el => el.dataset.sectionId);
                    await updateOrder(sectionIds);
                }
            });

            // Lesson sorting within sections
            document.querySelectorAll('.lessons-container').forEach(container => {
                new Sortable(container, {
                    animation: 150,
                    handle: '.lesson-drag-handle',
                    onEnd: async (evt) => {
                        const lessonIds = Array.from(evt.from.querySelectorAll('.lesson-item'))
                            .map(el => el.dataset.lessonId);
                        await updateOrder(lessonIds);
                    }
                });
            });
        }

        async function updateOrder(ids) {
            const batch = writeBatch(db);
            ids.forEach((id, index) => {
                const docRef = doc(db, "courses", currentCourseId, "lessons", id);
                batch.update(docRef, { order: index });
            });
            
            try {
                await batch.commit();
            } catch (error) {
                console.error("Error updating order:", error);
                alert('Failed to reorder items. Please try again.');
            }
        }

        async function createNewSection() {
            const sectionTitle = prompt("Enter a title for the new section:");
            if (!sectionTitle?.trim()) return;

            try {
                const sectionsQuery = query(
                    collection(db, "courses", currentCourseId, "lessons"), 
                    where("type", "==", "section")
                );
                const querySnapshot = await getDocs(sectionsQuery);
                const newOrder = querySnapshot.size;

                await addDoc(collection(db, "courses", currentCourseId, "lessons"), {
                    title: sectionTitle.trim(),
                    type: 'section',
                    order: newOrder,
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error creating section:", error);
                alert('Failed to create section. Please try again.');
            }
        }

        async function createNewLesson(sectionId) {
            const lessonTitle = prompt("Enter a title for the new lesson:");
            if (!lessonTitle?.trim()) return;

            try {
                const lessonsQuery = query(
                    collection(db, "courses", currentCourseId, "lessons"), 
                    where("sectionId", "==", sectionId)
                );
                const querySnapshot = await getDocs(lessonsQuery);
                const newOrder = querySnapshot.size;

                await addDoc(collection(db, "courses", currentCourseId, "lessons"), {
                    title: lessonTitle.trim(),
                    type: 'lesson',
                    sectionId: sectionId,
                    order: newOrder,
                    contentBlocks: [],
                    settings: { 
                        allowComments: true, 
                        isFreePreview: false 
                    },
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error creating lesson:", error);
                alert('Failed to create lesson. Please try again.');
            }
        }

        async function deleteSection(sectionId) {
            if (!confirm("Are you sure you want to delete this section and all its lessons? This cannot be undone.")) {
                return;
            }
            
            try {
                const batch = writeBatch(db);
                
                // Delete all lessons in the section
                const lessonsQuery = query(
                    collection(db, "courses", currentCourseId, "lessons"), 
                    where("sectionId", "==", sectionId)
                );
                const lessonsSnapshot = await getDocs(lessonsQuery);
                lessonsSnapshot.forEach(doc => batch.delete(doc.ref));
                
                // Delete the section
                batch.delete(doc(db, "courses", currentCourseId, "lessons", sectionId));
                
                await batch.commit();
                
                // Close editor if deleted lesson was active
                if (activeLessonId && lessonsSnapshot.docs.some(d => d.id === activeLessonId)) {
                    activeLessonId = null;
                    dom.lessonEditor.classList.remove('visible');
                    dom.editorPlaceholder.classList.remove('hidden');
                    dom.saveLessonBtn.style.display = 'none';
                }
            } catch (error) {
                console.error("Error deleting section:", error);
                alert("Failed to delete section. Please try again.");
            }
        }

        async function openLessonInEditor(lessonId) {
            // Auto-save current lesson before switching
            if (activeLessonId && activeLessonId !== lessonId) {
                await saveActiveLesson();
            }
            
            activeLessonId = lessonId;
            
            // Update UI
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.toggle('active', item.dataset.lessonId === lessonId);
            });
            
            try {
                const lessonSnap = await getDoc(doc(db, "courses", currentCourseId, "lessons", lessonId));
                if (lessonSnap.exists()) {
                    const data = lessonSnap.data();
                    
                    dom.lessonTitleHeader.textContent = data.title;
                    renderContentBlocks(data.contentBlocks || []);
                    dom.allowComments.checked = data.settings?.allowComments ?? true;
                    dom.isFreePreview.checked = data.settings?.isFreePreview ?? false;
                    
                    dom.editorPlaceholder.classList.add('hidden');
                    dom.lessonEditor.classList.add('visible');
                    dom.saveLessonBtn.style.display = 'block';
                }
            } catch (error) {
                console.error("Error loading lesson:", error);
                alert("Failed to load lesson. Please try again.");
            }
        }

        function renderContentBlocks(blocks) {
            dom.contentBlockArea.innerHTML = '';
            quillInstances = {};
            
            if (!blocks || blocks.length === 0) {
                dom.contentBlockArea.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>This lesson is empty</h3>
                        <p>Add some content using the buttons below!</p>
                    </div>
                `;
                return;
            }
            
            blocks.forEach((block, index) => {
                if (!block.id) {
                    block.id = `block_${Date.now()}_${index}`;
                }
                
                const blockEl = createBlockElement(block);
                dom.contentBlockArea.appendChild(blockEl);
                
                if (block.type === 'text') {
                    setTimeout(() => {
                        initializeQuill(`#editor-${block.id}`, block.content);
                    }, 100);
                }
            });
        }

        function createBlockElement(block) {
            const blockEl = document.createElement('div');
            blockEl.className = 'content-block';
            blockEl.dataset.blockId = block.id;
            blockEl.dataset.blockType = block.type;

            let contentHtml = '';
            let blockTitle = '';

            switch (block.type) {
                case 'text':
                    blockTitle = 'Text Content';
                    contentHtml = `<div id="editor-${block.id}"></div>`;
                    break;
                    
                case 'video':
                    blockTitle = block.videoType === 'recorded' ? 'Recorded Video' : 'Video Content';
                    
                    if (block.url) {
                        let videoPreview = '';
                        
                        if (block.videoType === 'youtube' || block.url.includes('youtube.com/embed')) {
                            videoPreview = `
                                <div class="video-wrapper">
                                    <iframe 
                                        src="${block.url}" 
                                        allowfullscreen
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                        loading="lazy"
                                        title="YouTube video player"
                                    ></iframe>
                                </div>
                            `;
                        } else {
                            videoPreview = `
                                <div class="video-wrapper">
                                    <video 
                                        src="${block.url}" 
                                        controls 
                                        preload="metadata"
                                        style="width: 100%; height: 100%;"
                                    >
                                        Your browser doesn't support HTML5 video.
                                    </video>
                                </div>
                            `;
                        }
                        
                        contentHtml = `
                            <div class="video-block-preview">
                                ${videoPreview}
                                <div style="margin-top: 1rem; text-align: center;">
                                    <button type="button" class="control-btn btn-edit-video">
                                        <i class="fas fa-edit"></i> Change Video
                                    </button>
                                </div>
                            </div>
                            <div class="video-block-placeholder" style="display: none;">
                                <input type="text" 
                                       class="video-url-input" 
                                       value="${block.originalUrl || block.url || ''}" 
                                       placeholder="Paste YouTube or video link here..." 
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; background: var(--surface); color: var(--text-primary);">
                                <div style="text-align: right;">
                                    <button type="button" class="control-btn btn-cancel-edit">
                                        Cancel
                                    </button>
                                    <button type="button" class="control-btn btn-apply-video" style="background: var(--primary); color: white;">
                                        Apply
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        contentHtml = `
                            <div class="video-block-placeholder">
                                <div style="text-align: center; padding: 2rem; border: 2px dashed var(--border); border-radius: 12px; background: var(--surface);">
                                    <i class="fas fa-video" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                                    <h4 style="margin: 0 0 10px 0; color: var(--text-secondary);">Add a Video</h4>
                                    <p style="margin: 0 0 15px 0; color: var(--text-muted); font-size: 14px;">Paste a YouTube URL or direct video link</p>
                                    <input type="text" 
                                           class="video-url-input" 
                                           placeholder="https://www.youtube.com/watch?v=..." 
                                           style="width: 100%; max-width: 400px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--background); color: var(--text-primary);">
                                </div>
                            </div>
                            <div class="video-block-preview" style="display: none;"></div>
                        `;
                    }
                    break;
                    
                case 'file':
                    blockTitle = 'File Attachment';
                    if (block.url) {
                        contentHtml = `
                            <div class="file-block-preview" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--surface); border-radius: 8px;">
                                <i class="fas fa-file-alt" style="font-size: 2rem; color: var(--primary);"></i>
                                <div style="flex: 1;">
                                    <strong>${block.name}</strong>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                        ${block.size ? `${(block.size / 1024).toFixed(2)} KB` : ''}
                                    </div>
                                </div>
                                <a href="${block.url}" target="_blank" class="control-btn">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        `;
                    } else {
                        contentHtml = `
                            <div class="file-block-placeholder" style="text-align: center; padding: 2rem; border: 2px dashed var(--border); border-radius: 12px; background: var(--surface); cursor: pointer;">
                                <input type="file" class="file-upload-input" style="display: none;">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                                <h4 style="margin: 0 0 10px 0; color: var(--text-secondary);">Upload a File</h4>
                                <p style="margin: 0; color: var(--text-muted);">Click here or drag and drop</p>
                            </div>
                        `;
                    }
                    break;
                    
                case 'quiz':
                    blockTitle = 'Quiz Question';
                    contentHtml = `
                        <div class="quiz-block">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Question</label>
                                <input type="text" 
                                       class="quiz-question-input" 
                                       value="${block.question || ''}" 
                                       placeholder="Enter your quiz question..."
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface); color: var(--text-primary);">
                            </div>
                            <div class="quiz-options-container">
                                ${(block.options || [{text:''},{text:''}]).map((opt, index) => `
                                    <div class="quiz-option" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--surface); border-radius: 6px;">
                                        <input type="radio" name="correct-answer-${block.id}" ${opt.isCorrect ? 'checked' : ''} style="margin: 0;">
                                        <input type="text" 
                                               value="${opt.text || ''}" 
                                               placeholder="Option ${index + 1}"
                                               style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--background); color: var(--text-primary);">
                                        <button class="delete-option-btn control-btn" style="background: var(--danger); color: white; width: 32px; height: 32px; padding: 0;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="add-option-btn control-btn" style="background: var(--primary); color: white; margin-top: 0.5rem;">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>
                    `;
                    break;
            }

            blockEl.innerHTML = `
                <div class="block-header">
                    <i class="fas fa-grip-vertical block-drag-handle"></i>
                    <span class="block-title">
                        <i class="fas fa-${getBlockIcon(block.type)}"></i>
                        ${blockTitle}
                    </span>
                    <div class="block-actions">
                        <button class="delete-block-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="block-content">${contentHtml}</div>
            `;
            
            // Add event listeners
            blockEl.querySelector('.delete-block-btn').onclick = () => {
                if (confirm('Are you sure you want to delete this block?')) {
                    blockEl.remove();
                    saveActiveLesson();
                }
            };
            
            // Type-specific event listeners
            setupBlockEventListeners(blockEl, block);
            
            return blockEl;
        }

        function getBlockIcon(type) {
            const icons = {
                text: 'paragraph',
                video: 'video',
                file: 'paperclip',
                quiz: 'question-circle'
            };
            return icons[type] || 'square';
        }

        function setupBlockEventListeners(blockEl, block) {
            const blockType = block.type;
            
            if (blockType === 'video') {
                const videoInput = blockEl.querySelector('.video-url-input');
                const editButtons = blockEl.querySelectorAll('.btn-edit-video');
                const applyButton = blockEl.querySelector('.btn-apply-video');
                const cancelButton = blockEl.querySelector('.btn-cancel-edit');
                
                // Store initial data
                if (block.url) {
                    blockEl.dataset.videoUrl = block.url;
                    blockEl.dataset.videoType = block.videoType || 'direct';
                    if (block.videoId) blockEl.dataset.videoId = block.videoId;
                    if (block.originalUrl) blockEl.dataset.originalUrl = block.originalUrl;
                }
                
                if (videoInput) {
                    let inputTimeout;
                    
                    const processInput = () => {
                        clearTimeout(inputTimeout);
                        inputTimeout = setTimeout(() => {
                            handleVideoUrlInput({ target: videoInput }, blockEl);
                        }, 500);
                    };
                    
                    videoInput.addEventListener('input', processInput);
                    videoInput.addEventListener('paste', () => setTimeout(processInput, 100));
                    videoInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleVideoUrlInput({ target: videoInput }, blockEl);
                        }
                    });
                }
                
                editButtons.forEach(btn => {
                    btn.addEventListener('click', showVideoEditMode.bind(null, blockEl));
                });
                
                if (applyButton) {
                    applyButton.addEventListener('click', () => {
                        if (videoInput) handleVideoUrlInput({ target: videoInput }, blockEl);
                    });
                }
                
                if (cancelButton) {
                    cancelButton.addEventListener('click', hideVideoEditMode.bind(null, blockEl));
                }
            }
            
            if (blockType === 'file') {
                const placeholder = blockEl.querySelector('.file-block-placeholder');
                const fileInput = blockEl.querySelector('.file-upload-input');
                
                if (placeholder) {
                    placeholder.onclick = () => fileInput?.click();
                }
                
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => handleFileUpload(e, blockEl));
                }
            }
            
            if (blockType === 'quiz') {
                const addOptionBtn = blockEl.querySelector('.add-option-btn');
                const deleteOptionBtns = blockEl.querySelectorAll('.delete-option-btn');
                
                if (addOptionBtn) {
                    addOptionBtn.addEventListener('click', (e) => {
                        addQuizOption(blockEl.querySelector('.quiz-options-container'));
                    });
                }
                
                deleteOptionBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (blockEl.querySelectorAll('.quiz-option').length > 2) {
                            e.target.closest('.quiz-option').remove();
                        } else {
                            alert('Quiz must have at least 2 options.');
                        }
                    });
                });
            }
        }

        function showVideoEditMode(blockEl) {
            const placeholder = blockEl.querySelector('.video-block-placeholder');
            const preview = blockEl.querySelector('.video-block-preview');
            const input = blockEl.querySelector('.video-url-input');
            
            placeholder.style.display = 'block';
            preview.style.display = 'none';
            
            if (input) {
                input.focus();
                input.select();
            }
        }

        function hideVideoEditMode(blockEl) {
            const placeholder = blockEl.querySelector('.video-block-placeholder');
            const preview = blockEl.querySelector('.video-block-preview');
            const input = blockEl.querySelector('.video-url-input');
            
            if (blockEl.dataset.originalUrl && input) {
                input.value = blockEl.dataset.originalUrl;
            }
            
            placeholder.style.display = 'none';
            preview.style.display = 'block';
        }

        function handleVideoUrlInput(event, blockEl) {
            const url = event.target.value.trim();
            const previewContainer = blockEl.querySelector('.video-block-preview');
            const placeholder = blockEl.querySelector('.video-block-placeholder');
            
            if (!url) {
                placeholder.style.display = 'block';
                previewContainer.style.display = 'none';
                previewContainer.innerHTML = '';
                delete blockEl.dataset.videoUrl;
                delete blockEl.dataset.videoType;
                delete blockEl.dataset.videoId;
                return;
            }
            
            // Enhanced YouTube URL patterns
            const youtubePatterns = [
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /(?:https?:\/\/)?(?:www\.)?youtube\.com\/v\/([a-zA-Z0-9_-]{11})/
            ];
            
            let youtubeId = null;
            for (const pattern of youtubePatterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    youtubeId = match[1];
                    break;
                }
            }
            
            if (youtubeId) {
                const embedUrl = `https://www.youtube.com/embed/${youtubeId}?rel=0&modestbranding=1&enablejsapi=0&controls=1&showinfo=0&fs=1`;
                
                previewContainer.innerHTML = `
                    <div class="video-wrapper">
                        <iframe 
                            src="${embedUrl}" 
                            allowfullscreen
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            loading="lazy"
                            title="YouTube video player"
                        ></iframe>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button type="button" class="btn-edit-video control-btn">
                            <i class="fas fa-edit"></i> Change Video
                        </button>
                    </div>
                `;
                
                blockEl.dataset.videoUrl = embedUrl;
                blockEl.dataset.videoType = 'youtube';
                blockEl.dataset.videoId = youtubeId;
                blockEl.dataset.originalUrl = url;
                
                placeholder.style.display = 'none';
                previewContainer.style.display = 'block';
                
                // Re-attach edit button listener
                const newEditBtn = previewContainer.querySelector('.btn-edit-video');
                if (newEditBtn) {
                    newEditBtn.addEventListener('click', () => showVideoEditMode(blockEl));
                }
                
            } else if (url.match(/\.(mp4|webm|ogg|mov|avi)(\?.*)?$/i)) {
                previewContainer.innerHTML = `
                    <div class="video-wrapper">
                        <video 
                            src="${url}" 
                            controls 
                            preload="metadata"
                            style="width: 100%; height: 100%;"
                        >
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button type="button" class="btn-edit-video control-btn">
                            <i class="fas fa-edit"></i> Change Video
                        </button>
                    </div>
                `;
                
                blockEl.dataset.videoUrl = url;
                blockEl.dataset.videoType = 'direct';
                blockEl.dataset.originalUrl = url;
                
                placeholder.style.display = 'none';
                previewContainer.style.display = 'block';
                 // Re-attach edit button listener
                const newEditBtn = previewContainer.querySelector('.btn-edit-video');
                if (newEditBtn) {
                    newEditBtn.addEventListener('click', () => showVideoEditMode(blockEl));
                }
                
            } else if (url.match(/\.(mp4|webm|ogg|mov|avi)(\?.*)?$/i)) {
                previewContainer.innerHTML = `
                    <div class="video-wrapper">
                        <video 
                            src="${url}" 
                            controls 
                            preload="metadata"
                            style="width: 100%; height: 100%;"
                        >
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        <button type="button" class="btn-edit-video control-btn">
                            <i class="fas fa-edit"></i> Change Video
                        </button>
                    </div>
                `;
                   blockEl.dataset.videoUrl = embedUrl;
                blockEl.dataset.videoType = 'youtube';
                blockEl.dataset.videoId = youtubeId;
                blockEl.dataset.originalUrl = url;
                
                placeholder.style.display = 'none';
                previewContainer.style.display = 'block';
                
                // Re-attach edit button listener
                const newEditBtn = previewContainer.querySelector('.btn-edit-video');
                if (newEditBtn) {
                    newEditBtn.addEventListener('click', () => showVideoEditMode(blockEl));
                }
                
            } else {
                // Invalid URL
                previewContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--danger); background: var(--surface); border-radius: 12px; border: 1px solid var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <h4 style="margin: 0 0 10px 0;">Invalid video URL</h4>
                        <p style="margin: 0 0 15px 0; font-size: 0.875rem;">Please enter a valid YouTube link or direct video file URL.</p>
                        <small style="color: var(--text-muted);">Supported: YouTube URLs, MP4, WebM, OGG, MOV, AVI</small>
                        <div style="margin-top: 1rem;">
                            <button type="button" class="btn-try-again control-btn" style="background: var(--primary); color: white;">
                                Try Again
                            </button>
                        </div>
                    </div>
                `;
                
                placeholder.style.display = 'none';
                previewContainer.style.display = 'block';
                
                const tryAgainBtn = previewContainer.querySelector('.btn-try-again');
                if (tryAgainBtn) {
                    tryAgainBtn.addEventListener('click', () => showVideoEditMode(blockEl));
                }
                
                delete blockEl.dataset.videoUrl;
                delete blockEl.dataset.videoType;
                delete blockEl.dataset.videoId;
            }
        }

        async function handleFileUpload(event, blockEl) {
            const file = event.target.files[0];
            if (!file) return;
            
            const placeholder = blockEl.querySelector('.file-block-placeholder');
            placeholder.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary); margin-bottom: 1rem;"></i>
                    <p>Uploading ${file.name}...</p>
                </div>
            `;
            
            try {
                const url = await uploadToCloudinary(file);
                
                if (url) {
                    blockEl.dataset.fileUrl = url;
                    blockEl.dataset.fileName = file.name;
                    blockEl.dataset.fileSize = file.size;
                    
                    blockEl.querySelector('.block-content').innerHTML = `
                        <div class="file-block-preview" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--surface); border-radius: 8px;">
                            <i class="fas fa-file-alt" style="font-size: 2rem; color: var(--primary);"></i>
                            <div style="flex: 1;">
                                <strong>${file.name}</strong>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                    ${(file.size / 1024).toFixed(2)} KB
                                </div>
                            </div>
                            <a href="${url}" target="_blank" class="control-btn">
                                <i class="fas fa-download"></i> Download
                            </a>
                        </div>
                    `;
                    
                    // Auto-save
                    saveActiveLesson();
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                placeholder.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Upload failed. Please try again.</p>
                        <button class="control-btn" onclick="this.closest('.file-block-placeholder').innerHTML = this.closest('.file-block-placeholder').dataset.originalContent">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function addQuizOption(container) {
            const blockId = container.closest('.content-block').dataset.blockId;
            const optionCount = container.children.length;
            const newOption = document.createElement('div');
            newOption.className = 'quiz-option';
            newOption.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--surface); border-radius: 6px;';
            
            newOption.innerHTML = `
                <input type="radio" name="correct-answer-${blockId}" style="margin: 0;">
                <input type="text" 
                       placeholder="Option ${optionCount + 1}"
                       style="flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--background); color: var(--text-primary);">
                <button class="delete-option-btn control-btn" style="background: var(--danger); color: white; width: 32px; height: 32px; padding: 0;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            newOption.querySelector('.delete-option-btn').addEventListener('click', (e) => {
                const allOptions = container.querySelectorAll('.quiz-option');
                if (allOptions.length > 2) {
                    newOption.remove();
                } else {
                    alert('Quiz must have at least 2 options.');
                }
            });
            
            container.appendChild(newOption);
        }

        function addContentBlock(type) {
            const newBlock = { 
                id: `block_${Date.now()}`, 
                type: type 
            };
            
            if (type === 'quiz') { 
                newBlock.question = ''; 
                newBlock.options = [{ text: '' }, { text: '' }]; 
            }
            
            const blockEl = createBlockElement(newBlock);
            
            if (!dom.contentBlockArea.querySelector('.content-block')) {
                dom.contentBlockArea.innerHTML = '';
            }
            
            dom.contentBlockArea.appendChild(blockEl);
            
            if (type === 'text') {
                setTimeout(() => {
                    initializeQuill(`#editor-${newBlock.id}`);
                }, 100);
            }
            
            // Auto-save after adding block
            setTimeout(() => saveActiveLesson(), 500);
        }

        function initializeQuill(selector, content = '') {
            try {
                const quill = new Quill(selector, { 
                    theme: 'snow', 
                    modules: { 
                        toolbar: [
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'header': 1 }, { 'header': 2 }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            ['link', 'image'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'align': [] }],
                            ['clean']
                        ] 
                    } 
                });
                
                if (content) {
                    quill.root.innerHTML = content;
                }
                
                quillInstances[selector.substring(1)] = quill;
                
                // Auto-save on content change
                quill.on('text-change', () => {
                    clearTimeout(window.quillSaveTimeout);
                    window.quillSaveTimeout = setTimeout(() => {
                        if (activeLessonId) {
                            saveActiveLesson();
                        }
                    }, 2000);
                });
                
                return quill;
            } catch (error) {
                console.error('Failed to initialize Quill:', error);
                return null;
            }
        }

       async function saveActiveLesson() {
    if (!activeLessonId) return;
    
    if (dom.saveLessonBtn.disabled) return;
    
    dom.saveLessonBtn.disabled = true;
    dom.saveLessonBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    try {
        const blocksData = [];
        const blockElements = dom.contentBlockArea.querySelectorAll('.content-block');
        
        blockElements.forEach((blockEl, index) => {
            const block = { 
                id: blockEl.dataset.blockId || `block_${Date.now()}_${index}`, 
                type: blockEl.dataset.blockType || 'text'
            };
            
            // Ensure all fields are defined
            if (block.type === 'text') {
                const quillEditor = quillInstances[`editor-${block.id}`];
                block.content = quillEditor ? quillEditor.root.innerHTML : '';
            } else if (block.type === 'video') {
                block.url = blockEl.dataset.videoUrl || '';
                block.originalUrl = blockEl.dataset.originalUrl || '';
                block.videoType = blockEl.dataset.videoType || 'direct';
                if (blockEl.dataset.videoId) {
                    block.videoId = blockEl.dataset.videoId;
                }
            } else if (block.type === 'file') {
                block.url = blockEl.dataset.fileUrl || '';
                block.name = blockEl.dataset.fileName || '';
                block.size = parseInt(blockEl.dataset.fileSize) || 0;
            } else if (block.type === 'quiz') {
                const questionInput = blockEl.querySelector('.quiz-question-input');
                block.question = questionInput ? questionInput.value : '';
                block.options = [];
                
                const optionElements = blockEl.querySelectorAll('.quiz-option');
                optionElements.forEach(optEl => {
                    const textInput = optEl.querySelector('input[type="text"]');
                    const radioInput = optEl.querySelector('input[type="radio"]');
                    block.options.push({
                        text: textInput ? textInput.value : '',
                        isCorrect: radioInput ? radioInput.checked : false
                    });
                });
            }
            
            blocksData.push(block);
        });
        
        const updateData = {
            contentBlocks: blocksData,
            settings: {
                allowComments: Boolean(dom.allowComments.checked),
                isFreePreview: Boolean(dom.isFreePreview.checked)
            },
            updatedAt: serverTimestamp()
        };
        
        await updateDoc(doc(db, "courses", currentCourseId, "lessons", activeLessonId), updateData);
        
        // Success feedback
        dom.saveLessonBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
        setTimeout(() => {
            dom.saveLessonBtn.innerHTML = '<i class="fas fa-save"></i> Save Lesson';
        }, 2000);
        
    } catch (error) {
        console.error("Error saving lesson:", error);
        dom.saveLessonBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Save Failed';
        setTimeout(() => {
            dom.saveLessonBtn.innerHTML = '<i class="fas fa-save"></i> Save Lesson';
        }, 3000);
    } finally {
        dom.saveLessonBtn.disabled = false;
    }
}

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
            
            const resourceType = file.type.startsWith('video/') ? 'video' : 
                                file.type.startsWith('image/') ? 'image' : 'raw';
            
            try {
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/${resourceType}/upload`, 
                    { method: 'POST', body: formData }
                );
                
                if (!response.ok) {
                    throw new Error(`Upload failed with status ${response.status}`);
                }
                
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error("Cloudinary upload error:", error);
                return null;
            }
        }

        // --- Initialize App ---
        console.log('Course Editor v2.0 - Enhanced with Professional Video Recording');
        
        // Add responsive handling
        function handleResize() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 768) {
                sidebarToggle.style.display = 'block';
            } else {
                sidebarToggle.style.display = 'none';
                sidebar?.classList.remove('open');
            }
        }

        window.addEventListener('resize', handleResize);
        handleResize();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    if (activeLessonId) {
                        saveActiveLesson();
                    }
                }
            }
        });

        // Auto-save before page unload
        window.addEventListener('beforeunload', (e) => {
            if (activeLessonId) {
                saveActiveLesson();
                e.preventDefault();
                e.returnValue = '';
            }
        });

        console.log('Enhanced Course Editor initialized successfully!');
    </script>
            <!-- Hybrid AI Chat Widget -->
        <script src="js/advanced-hybrid-chat.js"></script>
    </body>
</html>
